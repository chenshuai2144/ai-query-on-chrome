# ğŸ§[é—®é¢˜ | è·¯ç”±è®¾ç½®accessæ— æ•ˆï¼Œä¸€çº§èœå•æ˜¾ç¤º403,äºŒçº§èœå•ä»å¯ä»¥è¿›å…¥

`AI Reply`

### ğŸ§ é—®é¢˜æè¿°

routes.ts
ä¸€çº§èœå•è®¾ç½®æƒé™åæ˜¾ç¤º403
äºŒçº§è®¾ç½®æƒé™åèœå•ä¸è¿›è¡Œæ‹¦æˆªä¹Ÿä¸æ˜¾ç¤º403

ç›®å‰:ä½¿ç”¨ä»–äººçš„è§£å†³æ–¹æ¡ˆå‡æ— æ•ˆ

### ğŸ’» ç¤ºä¾‹ä»£ç 

![image](https://user-images.githubusercontent.com/81609796/199877099-0fde7a25-9a18-4616-8bc5-73ed23b17c73.png)
![image](https://user-images.githubusercontent.com/81609796/199877210-e36c755d-5e7a-4ae1-bd57-517209d7f9e4.png)
![1667530977799](https://user-images.githubusercontent.com/81609796/199876195-3a28998f-f087-4b01-a277-02f4a25e2bed.jpg)
![1667531149245](https://user-images.githubusercontent.com/81609796/199876371-642e57ae-f5be-416a-83f1-ee3e605f98cf.jpg)

### ğŸ æœŸæœ›ç»“æœ

äºŒçº§èœå•éšè—æˆ–è€…403

Â© ç‰ˆæœ¬ä¿¡æ¯
Ant Design Pro ç‰ˆæœ¬: "5.2.0",
umi ç‰ˆæœ¬: "^3.5.21",
"@ant-design/pro-layout": "^6.33.1",

æµè§ˆå™¨ç¯å¢ƒ
å¼€å‘ç¯å¢ƒ window

## wangxing0204

æ˜¯è¦å‡çº§umiåˆ°4ç‰ˆæœ¬?

## TmacZhou

Any comment for this bug, I also met this issue...

## wangmeijian

umi3çš„ç”¨æˆ·ï¼Œé™çº§@ant-design/pro-layout åˆ°6.26.0ç‰ˆæœ¬å¯è§£å†³

## chenshuai2144

> TAutomatically replying with ChatGPT can be attempted, but it cannot be guaranteed to be completely accurate and may not fully address all issues. Please feel free to reply if you have any further questions or concerns.
> æ­¤å›å¤åŸºäº ChatGPT è‡ªåŠ¨ç”Ÿæˆï¼Œå¯ä»¥å°è¯•ä¸‹æ–¹æ¡ˆï¼Œå®˜æ–¹äººå‘˜ä¼šåœ¨ä¸€å®šæ—¶é—´åç»§ç»­ç»§ç»­å¤„ç†ã€‚

ä½ å¥½ï¼Œæ„Ÿè°¢ä½ çš„æé—®ã€‚çœ‹èµ·æ¥ä½ çš„é—®é¢˜æ˜¯åœ¨ä½¿ç”¨ Ant Design Pro çš„æƒé™æ§åˆ¶æ—¶ï¼Œä¸€çº§èœå•è®¾ç½®è®¿é—®æƒé™åæ˜¾ç¤º 403ï¼Œä½†äºŒçº§èœå•è®¾ç½®æƒé™åä¸è¿›è¡Œæ‹¦æˆªä¹Ÿä¸æ˜¾ç¤º 403ã€‚ä»¥ä¸‹æ˜¯æˆ‘çš„ä¸€äº›æƒ³æ³•å’Œå»ºè®®ï¼š

é¦–å…ˆï¼Œæ ¹æ®ä½ æä¾›çš„ä¿¡æ¯ï¼Œæˆ‘æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æ˜æ˜¾çš„é—®é¢˜ï¼Œä½†æœ‰å‡ ä¸ªå¯èƒ½ä¼šå½±å“æƒé™æ§åˆ¶çš„å› ç´ éœ€è¦è€ƒè™‘ï¼š

1. æ˜¯å¦åœ¨è·¯ç”±è¡¨ä¸­æ­£ç¡®é…ç½®äº†æƒé™å­—æ®µ `access`ï¼Ÿä½ æä¾›çš„æˆªå›¾ä¸­æ²¡æœ‰æ˜¾ç¤ºå®Œæ•´çš„è·¯ç”±é…ç½®ï¼Œæ‰€ä»¥æ— æ³•ç¡®è®¤ã€‚

2. ä½ ä½¿ç”¨çš„ `@ant-design/pro-layout` ç‰ˆæœ¬æ˜¯å¦ä¸å…¶ä»–ä¾èµ–é¡¹å†²çªï¼Ÿä½ æä¾›çš„ä¿¡æ¯ä¸­åˆ—å‡ºçš„ç‰ˆæœ¬çœ‹èµ·æ¥æ²¡æœ‰é—®é¢˜ï¼Œä½†æˆ‘å»ºè®®ä½ æ£€æŸ¥ä¸€ä¸‹ä¾èµ–é¡¹çš„ç‰ˆæœ¬ï¼Œå¹¶æ ¹æ®éœ€è¦å‡çº§æˆ–é™çº§ç‰ˆæœ¬ä»¥æ¶ˆé™¤æ½œåœ¨çš„å†²çªã€‚

3. æ˜¯å¦æ­£ç¡®è®¾ç½®äº†å½“å‰ç”¨æˆ·çš„æƒé™ï¼Ÿåœ¨ä½ æä¾›çš„ä¿¡æ¯ä¸­ï¼Œæ²¡æœ‰è¯´æ˜å¦‚ä½•è®¾ç½®å½“å‰ç”¨æˆ·çš„æƒé™ã€‚ä½ åº”è¯¥é¦–å…ˆéªŒè¯æ²¡æœ‰æƒé™çš„ç”¨æˆ·æ˜¯å¦æ— æ³•è®¿é—®å—ä¿æŠ¤çš„è·¯ç”±ã€‚å¯ä»¥åœ¨æµè§ˆå™¨çš„å¼€å‘è€…å·¥å…·ä¸­æŸ¥çœ‹ä» API è¿”å›çš„æƒé™ä¿¡æ¯ï¼Œå¹¶ç¡®ä¿å®ƒä»¬æ­£ç¡®åæ˜ äº†ä½ åˆ†é…ç»™ç”¨æˆ·çš„å®é™…æƒé™ã€‚

å…·ä½“åœ°ï¼Œæˆ‘å»ºè®®ä½ æ£€æŸ¥ä»¥ä¸‹å†…å®¹ï¼š

1. ç¡®è®¤åœ¨è·¯ç”±è¡¨ä¸­é…ç½®äº†è®¿é—®æƒé™å­—æ®µ `access`ã€‚æ­£ç¡®çš„ç¤ºä¾‹å¦‚ä¸‹ï¼š

```javascript
{
  path: '/dashboard',
  name: 'dashboard',
  icon: 'dashboard',
  component: './Dashboard',
  access: 'canAdmin', // é…ç½®è®¿é—®æƒé™å­—æ®µ
},
```

2. æ£€æŸ¥ `Layout` ç»„ä»¶æ˜¯å¦æ­£ç¡®é…ç½®äº†è®¿é—®æƒé™ (`Authorized` ç»„ä»¶)ã€‚ç¤ºä¾‹ï¼š

```javascript
// src/layouts/BasicLayout.tsx
import { useModel } from 'umi';
import { Authorized } from '@@/plugin-authority';

export default (props: BasicLayoutProps) => {
  const { initialState } = useModel('@@initialState');

  return (
    <div>
      <Authorized
        authority={props.route!.access} // å‘ Authorized ç»„ä»¶ä¼ é€’æƒé™å­—æ®µ
        noMatch={<Exception type="403" />}
      >
        <p>å±•ç¤ºå†…å®¹</p>
      </Authorized>
    </div>
  );
};
```

æ³¨æ„ï¼šé€šè¿‡ `props.route!.access` ä¼ é€’è®¿é—®æƒé™å­—æ®µã€‚åœ¨æ¸²æŸ“è·¯ç”±ç»„ä»¶ä¸­ï¼Œ`props.route` è¡¨ç¤ºå½“å‰æ­£åœ¨æ¸²æŸ“çš„è·¯ç”±ã€‚å¦‚æœæ²¡æœ‰ç»™å‡ºè®¿é—®æƒé™å­—æ®µï¼Œåˆ™è¿”å› undefinedã€‚

3. ç¡®å®šå½“å‰ç”¨æˆ·çš„æƒé™æ­£ç¡®åæ˜ åœ¨ä» API ä¸­è·å–çš„æƒé™ä¿¡æ¯ä¸­ã€‚

ä¾‹å¦‚ï¼Œåœ¨ä½ çš„ `.umi/prod/pages.js` æ–‡ä»¶ä¸­åˆ›å»ºä¾›å®¢æˆ·ç«¯ä½¿ç”¨çš„æƒé™ä¿¡æ¯ï¼š

```javascript
// src/access.ts
export default {
  canAdmin: () => {
    const currentUser = getCurrentUser();
    return currentUser && currentUser.access === "admin";
  },
};
```

åœ¨ `.umirc.ts` ä¸­å°†æƒé™ä¿¡æ¯ä¼ é€’ç»™ `@plugin-authority` æ’ä»¶ï¼š

```typescript
export default {
  plugins: [['@umijs/plugin-layout', {}], ['@umijs/plugin-antd', {}], ['umi-plugin-react', {}]],
  layout: {
    ...,
    // å°†æƒé™ä¿¡æ¯ä¼ é€’ç»™æ’ä»¶
    authority: {
      // authority æ˜¯æ’ä»¶ä¸­çš„å…³é”®å­—
      // åˆå§‹åŒ–æƒé™
      // æ”¯æŒ initialState æ˜¯ä¸€ä¸ªå‡½æ•°æ—¶ï¼Œè¿›è¡Œæƒé™åˆå¹¶æˆ–è¦†ç›–
      // initialState: { permissions: ['user', 'admin'] },
      // æ”¯æŒ getCurrentAuthority æ˜¯ä¸€ä¸ªå‡½æ•°æ—¶ï¼Œä¸ä¼šè¿›è¡Œæƒé™ç®¡ç†
      // getCurrentAuthority: (...args) => Promise<'user' | 'admin'>,
      getInitialState: async () => {
        const fetchUserInfo = async () => {
          return {
            access: 'admin',
            ...,
          };
        };
        const currentUser = await fetchUserInfo();

        return {
          currentUser,
          // å°†æƒé™ä¿¡æ¯ä¼ é€’ç»™æ’ä»¶
          permissions: {
            ...access, // å¯¼å…¥ access.ts å†…å®¹
          },
        };
      },
    },
  },
  ...
}
```

ç„¶ååœ¨ä½ çš„ç»„ä»¶ä¸­ä½¿ç”¨ Authorized ç»„ä»¶æ¥å±•ç¤ºå†…å®¹ï¼Œç¤ºä¾‹ï¼š

```javascript
import { useModel } from "umi";
import { Authorized } from "@@/plugin-authority";

export default () => {
  const { initialState } = useModel("@@initialState");
  return (
    <div>
      <Authorized authority="canAdmin" noMatch={<Exception type="403" />}>
        <p>å¯ä»¥ admin è®¿é—®çš„å†…å®¹</p>
      </Authorized>
    </div>
  );
};
```

å¦‚æœä»ç„¶æ— æ³•è§£å†³é—®é¢˜ï¼Œå¯èƒ½éœ€è¦æ›´å¤šçš„ä¿¡æ¯ï¼Œä¾‹å¦‚æ•´ä¸ªè·¯ç”±è¡¨çš„é…ç½®ä»¥åŠå®é™…æƒé™ä¿¡æ¯ã€‚å¸Œæœ›è¿™äº›æç¤ºå¯ä»¥ä¸ºä½ æä¾›å¸®åŠ©ï¼Œè®©ä½ å¯ä»¥æ›´è½»æ¾åœ°è§£å†³é—®é¢˜ã€‚

## wangxing0204

> å¯¹äºè¿™ä¸ªé”™è¯¯çš„ä»»ä½•è¯„è®ºï¼Œæˆ‘ä¹Ÿé‡åˆ°äº†è¿™ä¸ªé—®é¢˜â€¦â€¦

æˆ‘æ˜¯ç”¨çš„é™çº§@ant-design/pro-layout åˆ°6.26.0ç‰ˆæœ¬,è§£å†³çš„

## wangxing0204

> umi3çš„ç”¨æˆ·ï¼Œé™çº§@ant-design/pro-layout åˆ°6.26.0ç‰ˆæœ¬å¯è§£å†³

æ„Ÿè°¢.

## wangxing0204

è¿˜æœ‰ä¸€ç§æ–¹å¼:é€šè¿‡menuDataRenderå»å¤„ç†
export const layout: RunTimeLayoutConfig = ({ initialState, setInitialState }) => {
const accessConfig = access(initialState); // è¿™é‡Œè°ƒç”¨æƒé™ ä¼ é€’æ•´ä¸ª initialState å¯¹è±¡

const menuDataRender = (menuData) => {
// éå†èœå•æ•°æ®
return menuData
.map((item) => {
const { access, children, ...rest } = item;
// åˆ¤æ–­æ˜¯å¦å…·æœ‰æƒé™
if (access && !accessConfig[access]) {
return null; // æ²¡æœ‰æƒé™åˆ™è¿”å› null
}

        // å¤„ç†å­èœå•
        if (children && children.length > 0) {
          const renderedChildren = menuDataRender(children); // é€’å½’å¤„ç†å­èœå•
          // å¦‚æœå­èœå•å…¨éƒ¨æ²¡æœ‰æƒé™ï¼Œåˆ™è¿”å› null
          if (renderedChildren.every((child) => child === null)) {
            return null;
          }
          return {
            ...rest,
            children: renderedChildren,
          };
        }

        return rest;
      })
      .filter(Boolean); // è¿‡æ»¤æ‰ä¸º null çš„èœå•é¡¹

};

return {
rightContentRender: () => <RightContent />,
disableContentMargin: false,
links: [],
menuHeaderRender: undefined,
// è‡ªå®šä¹‰ 403 é¡µé¢
// unAccessible: <div>unAccessible</div>,
// å¢åŠ ä¸€ä¸ª loading çš„çŠ¶æ€
childrenRender: (children, props) => {
// if (initialState?.loading) return <PageLoading />;
return (
<>
{children}
{!props.location?.pathname?.includes('/login') && (
<SettingDrawer
disableUrlParams
enableDarkTheme
settings={initialState?.settings}
onSettingChange={(settings) => {
setInitialState((preInitialState) => ({
...preInitialState,
settings,
}));
}}
/>
)}
</>
);
},
menuDataRender,
...initialState?.settings,
};
};
