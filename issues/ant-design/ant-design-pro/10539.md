# 🧐[问题 | question]antd pro 6 请求接口时添加全局loading

`AI Reply`

请求接口时添加全局loading
相应后进行关闭
多个接口会等待全部加载完或出现错误 关闭loading

## chenshuai2144

> TAutomatically replying with ChatGPT can be attempted, but it cannot be guaranteed to be completely accurate and may not fully address all issues. Please feel free to reply if you have any further questions or concerns.
> 此回复基于 ChatGPT 自动生成，可以尝试下方案，官方人员会在一定时间后继续继续处理。

您可以使用 `axios` 的 `interceptors` 配合 `loading` 组件来实现该需求。具体实现步骤如下：

1. 在全局中引入 `axios` 和 `loading` 组件

```javascript
import axios from "axios";
import { message, Spin } from "antd";
```

2. 创建全局请求 `loading`

```javascript
const loading = document.createElement("div");
loading.className = "my-loading-classname"; // 需要自定义 loading 样式名称

const loadingSpin = (
  <div className="my-loading-spin-classname">
    <Spin size="large" />
  </div>
);
ReactDOM.render(loadingSpin, loading);
document.body.appendChild(loading);
```

3. 配置 `axios` 的 `interceptors.request`

```javascript
let requestsCount = 0;
const shouldShowLoading = () => requestsCount === 0;

axios.interceptors.request.use(
  (config) => {
    if (shouldShowLoading()) {
      loading.style.display = "block";
    }
    requestsCount += 1;
    return config;
  },
  (error) => {
    return Promise.reject(error);
  },
);
```

4. 配置 `axios` 的 `interceptors.response`

```javascript
axios.interceptors.response.use(
  (response) => {
    requestsCount -= 1;
    if (shouldShowLoading()) {
      loading.style.display = "none";
    }
    return response;
  },
  (error) => {
    requestsCount -= 1;
    if (shouldShowLoading()) {
      loading.style.display = "none";
    }
    message.error("请求出错，请稍后重试！");
    return Promise.reject(error);
  },
);
```

5. 对于多个请求的情况，可以使用 `Promise.all` 来并行请求，并在所有请求完成或出错后关闭 `loading`

```javascript
Promise.all([request1, request2, request3])
  .then(() => {
    loading.style.display = "none";
  })
  .catch(() => {
    loading.style.display = "none";
    message.error("请求出错，请稍后重试！");
  });
```

6. 最后，别忘了在页面销毁时移除 `loading`：

```javascript
componentWillUnmount() {
  document.body.removeChild(loading);
}
```

完整代码如下：

```javascript
import axios from "axios";
import { message, Spin } from "antd";

const loading = document.createElement("div");
loading.className = "my-loading-classname";

const loadingSpin = (
  <div className="my-loading-spin-classname">
    <Spin size="large" />
  </div>
);
ReactDOM.render(loadingSpin, loading);
document.body.appendChild(loading);

let requestsCount = 0;
const shouldShowLoading = () => requestsCount === 0;

axios.interceptors.request.use(
  (config) => {
    if (shouldShowLoading()) {
      loading.style.display = "block";
    }
    requestsCount += 1;
    return config;
  },
  (error) => {
    return Promise.reject(error);
  }
);

axios.interceptors.response.use(
  (response) => {
    requestsCount -= 1;
    if (shouldShowLoading()) {
      loading.style.display = "none";
    }
    return response;
  },
  (error) => {
    requestsCount -= 1;
    if (shouldShowLoading()) {
      loading.style.display = "none";
    }
    message.error("请求出错，请稍后重试！");
    return Promise.reject(error);
  }
);

Promise.all([request1, request2, request3])
  .then(() => {
    loading.style.display = "none";
  })
  .catch(() => {
    loading.style.display = "none";
    message.error("请求出错，请稍后重试！");
  });

componentWillUnmount() {
  document.body.removeChild(loading);
}
```

希望以上内容能够帮助您解决问题。
