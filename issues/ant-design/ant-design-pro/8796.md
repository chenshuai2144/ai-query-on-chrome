# ğŸ§[é—®é¢˜]ant-design-proä½¿ç”¨umijs/plugin-qiankun useModel çˆ¶å­åº”ç”¨é€šä¿¡æ— æ³•åœ¨åˆ·æ–°åº”ç”¨æ—¶ä¿æŒæœ€æ–°çš„å…¨å±€æ•°æ®

`ğŸ™help wanted`,`AI Reply`

### ğŸ§ é—®é¢˜æè¿°

1. æœ€æ–°çš„v5 pro é¡¹ç›®ä¸ºå¾®å‰ç«¯ä¸»åº”ç”¨ï¼Œä½¿ç”¨useModelé€šä¿¡ã€‚çˆ¶å­åº”ç”¨é€šä¿¡æ— æ³•åœ¨åˆ·æ–°åº”ç”¨æ—¶ä¿æŒæœ€æ–°çš„å…¨å±€æ•°æ®ã€‚ç–‘æƒ‘æ€ä¹ˆæ ·setQiankunGlobalStateå¯ä»¥ä¿æŒåœ¨ç™»å½•ååˆ·æ–°é¡µé¢ä¸ä¼šå˜æˆåˆå§‹åŒ–çŠ¶æ€çš„stateã€‚
2. src/pages/Welcome.tsx ä½¿ç”¨ const { qiankunGlobalState, setQiankunGlobalState } = useModel('@@qiankunStateFromMaster'); æŠ¥é”™ TypeError: Cannot read property 'qiankunGlobalState' of undefined;
   é¡¹ç›®åœ°å€ [https://github.com/hanxzi/micro-app-umi-demo](https://github.com/hanxzi/micro-app-umi-demo)

### å¤ç°æ–¹å¼

æ‰“å¼€ä¸»åº”ç”¨http://localhost:8000/user/login ç”¨æˆ·åï¼šadmin å¯†ç ï¼šant.designç™»å½• åœ¨src/app.ts åˆå§‹åŒ–å…¨å±€qiankunGlobalStateå€¼{"slogan":"Hello initialState Main App"}ã€‚src/pages/user/Login/index.tsx ç™»å½•æ“ä½œä¿®æ”¹å…¨å±€ qiankunGlobalState ä¸º{"slogan":"Hello Login Qiankun"}ï¼Œç‚¹å‡»å·¦ä¾§èœå•å­åº”ç”¨sub-app-umi æ­£å¸¸è¾“å‡º{"slogan":"Hello Login Qiankun"}ã€‚æ‰‹åŠ¨åˆ·æ–°http://localhost:8000/sub-app-umiè·¯ç”± å­åº”ç”¨sub-app-umi è¾“å‡ºå˜æˆåˆå§‹åŒ–çŠ¶æ€{"slogan":"Hello initialState Main App"} ã€‚ ç‚¹å‡»ä¿®æ”¹å…¨å±€ stateè®¾ç½®æ–°çš„stateï¼Œåˆ·æ–°åä¹Ÿå›åˆ°æœ€åˆçŠ¶æ€å€¼ã€‚

### ğŸ’» ç¤ºä¾‹ä»£ç 

```bash
//main-app/src/app.ts
export const useQiankunStateForSlave =  () => {
  const [qiankunGlobalState, setQiankunGlobalState] = useState({"slogan":"Hello initialState  Main App"});
  return {
    qiankunGlobalState,
    setQiankunGlobalState,
  };
};
}
```

```bash
//main-app/src/pages/user/Login/index.tsx
const { initialState, setInitialState } = useModel('@@initialState');
  const { setQiankunGlobalState } = useModel('@@qiankunStateForSlave');
  const intl = useIntl();

  const fetchUserInfo = async () => {
    const userInfo = await initialState?.fetchUserInfo?.();
    if (userInfo) {
      await setInitialState((s) => ({
        ...s,
        currentUser: userInfo,
      }));
      setQiankunGlobalState({"slogan":"Hello Login Qiankun"})
    }
  };
}
}
```

```bash
//main-app/src/pages/Welcome.tsx
const { qiankunGlobalState, setQiankunGlobalState } = useModel('@@qiankunStateFromMaster');
return (
  <PageContainer>
    <Card>
      <div>{JSON.stringify(qiankunGlobalState)}</div>
    </Card>
  </PageContainer>
  }
```

```bash
//sub-app-umi/src/pages/index.tsx
export default function IndexPage() {
const { qiankunGlobalState, setQiankunGlobalState } = useModel('@@qiankunStateFromMaster');
return (
  <div>
    <div>{JSON.stringify(qiankunGlobalState)}</div>
    <button onClick={() => {setQiankunGlobalState({"slogan":"Hello Change App Umi"}) }}>ä¿®æ”¹å…¨å±€ state</button>
  </div>
);
}
```

### ğŸš‘ å…¶ä»–ä¿¡æ¯

<img width="552" alt="WX20210722-150355@2x" src="https://user-images.githubusercontent.com/15724884/126609359-d217d7f7-2476-445a-9895-896dd10a39b4.png">
<img width="612" alt="WX20210722-150309@2x" src="https://user-images.githubusercontent.com/15724884/126609364-f864969d-a129-400a-aea4-bc227d2f31ad.png">
<img width="647" alt="WX20210722-150238@2x" src="https://user-images.githubusercontent.com/15724884/126609367-163209ed-729a-47e9-84c0-8ecd5809e90c.png">
<img width="1092" alt="WX20210722-162034@2x" src="https://user-images.githubusercontent.com/15724884/126609486-7d4c6e16-de9c-4412-a33f-b44d18e1c4ed.png">

## niexq

@hanxzi è€å“¥ï¼Œæœ‰è§£å†³å—ï¼Ÿ

## chenshuai2144

> TAutomatically replying with ChatGPT can be attempted, but it cannot be guaranteed to be completely accurate and may not fully address all issues. Please feel free to reply if you have any further questions or concerns.
> æ­¤å›å¤åŸºäº ChatGPT è‡ªåŠ¨ç”Ÿæˆï¼Œå¯ä»¥å°è¯•ä¸‹æ–¹æ¡ˆï¼Œå®˜æ–¹äººå‘˜ä¼šåœ¨ä¸€å®šæ—¶é—´åç»§ç»­ç»§ç»­å¤„ç†ã€‚

ä½ å¥½ @hanxziï¼Œæ„Ÿè°¢ä½ çš„æé—®ã€‚æ ¹æ®ä½ æä¾›çš„ä¿¡æ¯ï¼Œæˆ‘åˆæ­¥åˆ¤æ–­æ˜¯å› ä¸ºåœ¨å­åº”ç”¨ sub-app-umi ä¸­ï¼Œç”±äºæ˜¯åœ¨åˆ·æ–°é¡µé¢æ—¶é‡æ–°åŠ è½½ï¼Œå¯¼è‡´å…¨å±€çŠ¶æ€å€¼è¢«é‡æ–°åˆå§‹åŒ–ã€‚

å¯¹äºè¿™ä¸ªé—®é¢˜ï¼Œè§£å†³æ–¹æ¡ˆæ˜¯åœ¨å­åº”ç”¨ä¸­ç›‘å¬ qiankun çš„åº”ç”¨ç”Ÿå‘½å‘¨æœŸå‡½æ•° `mount` å’Œ `unmount`ï¼Œåˆ†åˆ«åœ¨è¿™ä¸¤ä¸ªç”Ÿå‘½å‘¨æœŸå‡½æ•°ä¸­é€šè¿‡`setQiankunGlobalState()`ä¼ é€’key-valueå€¼åˆ°ä¸»åº”ç”¨ä¸­ã€‚ä¸»åº”ç”¨æœ‰æ›´æ–°æ—¶ï¼Œå­åº”ç”¨å¯ä»¥é€šè¿‡qiankunç”Ÿå‘½å‘¨æœŸå‡½æ•° `update`ä¸­å–å› `setGlobalState`ï¼Œæ‰§è¡Œæ›´æ–°stateã€‚

åŒæ—¶ï¼Œå»ºè®®ä½ å¯ä»¥æŸ¥é˜… `@umijs/plugin-qiankun` çš„å®˜æ–¹æ–‡æ¡£ä»¥åŠGithubä¸Šçš„ issuesï¼Œå­¦ä¹ æ›´å¤šå…³äºè¿™ä¸ªé—®é¢˜çš„è§£å†³æ–¹æ¡ˆã€‚

ä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š

```bash
// åœ¨çˆ¶åº”ç”¨ä¸­æ³¨å†Œç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°å¹¶æš´éœ²ç»™å­åº”ç”¨
export const qiankun = {
  // ...
  async mount(props) {
    // ...
    props.setGlobalState({
      myGlobalState: { ... },
      // other properties
    });
  },
  async unmount(props) {
    // ...
    props.setGlobalState({}); // clear global state
  },
  async update(props) {
    // ...
    const { setGlobalState } = props;
    setGlobalState({
      myGlobalState: { ... },
      // other properties
    });
  },
};

// åœ¨å­åº”ç”¨ä¸­è·å–å’Œæ›´æ–°å…¨å±€çŠ¶æ€
const { myGlobalState, setMyGlobalState } = useModel('@@qiankunStateForSlave');

useEffect(() => {
  props.onGlobalStateChange((initialGlobalState, prevGlobalState) => {
    // æ¯æ¬¡æ¥æ”¶åˆ°å…¨å±€çŠ¶æ€çš„æ›´æ–°éƒ½è§¦å‘æ­¤å¤„çš„å›è°ƒï¼Œæ›´æ–°æœ¬åœ° state
    setMyGlobalState(initialGlobalState.myGlobalState);
  });
});

// ä¿®æ”¹å…¨å±€çŠ¶æ€
setMyGlobalState({
  ...myGlobalState,
  myProp: myNewPropValue,
});

```

å¸Œæœ›ä»¥ä¸Šæ–¹æ¡ˆå¯¹ä½ æœ‰æ‰€å¸®åŠ©ã€‚æ„Ÿè°¢ä½ çš„ä½¿ç”¨ï¼
