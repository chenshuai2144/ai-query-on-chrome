# 🧐[问题]@chenshuai2144 请教一下打包优化，如何把umi中的lodash moment等抽离出来

### 🧐 问题描述

@chenshuai2144

请教一下打包优化，如何把umi中的lodash moment等抽离出来。打完包后umi.js文件最大。控制台也提示

```
The bundle size is significantly larger than recommended.
Consider reducing it with code splitting: https://umijs.org/docs/load-on-demand
You can also analyze the project dependencies using ANALYZE=1

```

### 💻 示例代码

### 安装包package.json

```
"dependencies": {
    "@ant-design/icons": "^4.7.0",
    "@ant-design/pro-card": "^1.18.6",
    "@ant-design/pro-descriptions": "^1.10.8",
    "@ant-design/pro-form": "^1.49.6",
    "@ant-design/pro-layout": "^6.31.3",
    "@ant-design/pro-table": "^2.59.2",
    "@pansy/react-amap": "^2.12.2",
    "@umijs/route-utils": "^2.0.3",
    "antd": "4.17.0",
    "classnames": "^2.3.1",
    "immutability-helper": "^3.1.1",
    "lodash": "^4.17.11",
    "moment": "^2.25.3",
    "omit.js": "^2.0.2",
    "qrcode.react": "^1.0.1",
    "rc-menu": "^9.0.13",
    "rc-util": "^5.14.0",
    "react": "^17.0.0",
    "react-dev-inspector": "^1.1.1",
    "react-dnd": "^14.0.4",
    "react-dnd-html5-backend": "^14.0.2",
    "react-dom": "^17.0.0",
    "react-helmet-async": "^1.0.4",
    "react-zmage": "^0.8.5-beta.37",
    "ts-md5": "^1.2.10",
    "umi": "^3.5.0",
    "umi-serve": "^1.9.10",
    "wangeditor": "^4.7.9",
    "xgplayer": "^2.31.3"
  },
  "devDependencies": {
    "@ant-design/pro-cli": "^2.0.2",
    "@playwright/test": "^1.16.3",
    "@types/express": "^4.17.0",
    "@types/history": "^4.7.2",
    "@types/jest": "^26.0.0",
    "@types/lodash": "^4.14.144",
    "@types/qrcode.react": "^1.0.2",
    "@types/react": "^17.0.0",
    "@types/react-dom": "^17.0.0",
    "@types/react-helmet": "^6.1.0",
    "@umijs/fabric": "^2.6.2",
    "@umijs/openapi": "^1.3.0",
    "@umijs/plugin-blocks": "^2.0.5",
    "@umijs/plugin-esbuild": "^1.0.1",
    "@umijs/plugin-openapi": "^1.2.0",
    "@umijs/preset-ant-design-pro": "^1.2.0",
    "@umijs/preset-dumi": "^1.1.7",
    "@umijs/preset-react": "^1.8.17",
    "@umijs/yorkie": "^2.0.3",
    "carlo": "^0.9.46",
    "compression-webpack-plugin": "^9.0.1",
    "cross-env": "^7.0.0",
    "cross-port-killer": "^1.1.1",
    "detect-installer": "^1.0.1",
    "enzyme": "^3.11.0",
    "eslint": "^7.1.0",
    "express": "^4.17.1",
    "file-loader": "^6.2.0",
    "gh-pages": "^3.0.0",
    "jsdom-global": "^3.0.2",
    "lint-staged": "^10.0.0",
    "mockjs": "^1.0.1-beta3",
    "prettier": "^2.3.2",
    "puppeteer-core": "^8.0.0",
    "stylelint": "^13.0.0",
    "swagger-ui-react": "^3.52.3",
    "typescript": "^4.2.2",
    "url-loader": "^4.1.1"
  },
```

### config.js配置文件

```
// https://umijs.org/config/
import { defineConfig } from 'umi';
import { join, resolve } from 'path';

import defaultSettings from './defaultSettings';
import proxy from './proxy';
import routes from './routes';

const { REACT_APP_ENV } = process.env;
const CompressionWebpackPlugin = require('compression-webpack-plugin');
const prod = process.env.NODE_ENV === 'production';
const assetDir = 'static/platform';
const prodGzipList = ['js', 'css'];

export default defineConfig({
  hash: true,
  // history: { type: 'hash' },
  antd: {},
  dva: {
    hmr: true
  },
  layout: {
    // https://umijs.org/zh-CN/plugins/plugin-layout
    // 移除国际化语言
    locale: false,
    // 侧边栏宽度
    siderWidth: 188,
    ...defaultSettings
  },
  // https://umijs.org/zh-CN/plugins/plugin-locale
  locale: {
    // default zh-CN
    default: 'zh-CN',
    antd: true,
    // default true, when it is true, will use `navigator.language` overwrite default
    baseNavigator: true
  },
  dynamicImport: {
    loading: '@ant-design/pro-layout/es/PageLoading'
  },
  targets: {
    ie: 11
  },
  // umi routes: https://umijs.org/docs/routing
  routes,
  // Theme for antd: https://ant.design/docs/react/customize-theme-cn
  theme: {
    'primary-color': defaultSettings.primaryColor,
    'root-entry-name': 'default'
  },
  // esbuild is father build tools
  // https://umijs.org/plugins/plugin-esbuild
  esbuild: {},
  title: false,
  ignoreMomentLocale: true,
  proxy: proxy[REACT_APP_ENV || 'dev'],
  manifest: {
    basePath: '/'
  },
  // Fast Refresh 热更新
  fastRefresh: {},
  openAPI: [
    {
      requestLibPath: 'import { request } from \'umi\'',
      // 或者使用在线的版本
      // schemaPath: "https://gw.alipayobjects.com/os/antfincdn/M%24jrzTTYJN/oneapi.json"
      schemaPath: join(__dirname, 'oneapi.json'),
      mock: false
    },
    {
      requestLibPath: 'import { request } from \'umi\'',
      schemaPath:
        'https://gw.alipayobjects.com/os/antfincdn/CA1dOm%2631B/openapi.json',
      projectName: 'swagger'
    }
  ],
  nodeModulesTransform: { type: 'none' },
  mfsu: {},
  webpack5: {},
  externals: prod
    ? {
      react: 'window.React',
      'react-dom': 'window.ReactDOM',
      // 'react-router-dom': 'ReactRouterDOM', //排除react route 一排除它就报　location　undefiend
      moment: 'moment',
      antd: 'antd',
      wangeditor: 'wangEditor'
    }
    : {},
  // 挂载外部第三方js
  scripts: [],
  chainWebpack: function(config: any, { webpack }: any) {
    if (prod) {
      config.plugin('compression-webpack-plugin').use(
        new CompressionWebpackPlugin({
          // filename: 文件名称，这里我们不设置，让它保持和未压缩的文件同一个名称
          algorithm: 'gzip', // 指定生成gzip格式
          test: new RegExp('\\.(' + prodGzipList.join('|') + ')$'), // 匹配哪些格式文件需要压缩
          threshold: 10240, //对超过10k的数据进行压缩
          minRatio: 0.6 // 压缩比例，值为0 ~ 1
        })
      );
      //指定css里的图片目录
      config.module
        .rule('less')
        .oneOf('css')
        .use('extract-css-loader')
        .tap(() => ({
          publicPath: '/',
          hmr: prod
        }));
      //修改js，js chunk文件输出目录
      config.output.filename(assetDir + '/js/[name].[hash:8].js').chunkFilename(assetDir + '/js/[name].[contenthash:8].chunk.js');
      //修改css输出目录
      config.plugin('extract-css').tap(() => [
        {
          filename: `${assetDir}/css/[name].[contenthash:8].css`,
          chunkFilename: `${assetDir}/css/[name].[contenthash:8].chunk.css`,
          ignoreOrder: true
        }
      ]);
      //修改图片输出目录
      config.module
        .rule('images')
        .test(/\.(png|jpe?g|gif|webp|ico)(\?.*)?$/)
        .use('url-loader')
        .loader(require.resolve('url-loader'))
        .tap((options: any) => {
          return {
            ...options,
            name: assetDir + '/images/[name].[hash:8].[ext]',
            fallback: {
              ...options.fallback,
              options: {
                name: assetDir + '/images/[name].[hash:8].[ext]',
                esModule: false
              }
            }
          };
        });
      //修改svg输出目录
      config.module
        .rule('svg')
        .test(/\.(svg)(\?.*)?$/)
        .use('file-loader')
        .loader(require.resolve('file-loader'))
        .tap((options: any) => ({
          ...options,
          name: assetDir + '/svg/[name].[hash:8].[ext]'
        }));
      //修改fonts输出目录
      config.module
        .rule('fonts')
        .test(/\.(eot|woff|woff2|ttf)(\?.*)?$/)
        .use('file-loader')
        .loader(require.resolve('file-loader'))
        .tap((options: any) => ({
          ...options,
          name: assetDir + '/fonts/[name].[hash:8].[ext]',
          fallback: {
            ...options.fallback,
            options: {
              name: assetDir + '/fonts/[name].[hash:8].[ext]',
              esModule: false
            }
          }
        }));
    }
    //处理moment 过滤掉不使用的国际化语言
    config
      .plugin('replace')
      .use(require('webpack').ContextReplacementPlugin)
      .tap(() => {
        return [/moment[/\\]locale$/, /zh-cn/];
      });
    //分包
    config.merge({
      optimization: {
        splitChunks: {
          chunks: 'all',
          minSize: 20000,
          minChunks: 5,
          automaticNameDelimiter: '.',
          cacheGroups: {
            vendor: {
              name: 'vendor',
              test: /[\\/]node_modules[\\/]/,
              priority: 10
            },
            //react相关
            reacts: {
              name: 'reacts',
              chunks: 'all',
              test: /[\\/]node_modules[\\/](react|react-dom|react-router|react-router-dom|react-zmage|react-dnd|react-dnd-html5-backend)[\\/]/,
              priority: 20
            },
            //ant
            antds: {
              name: 'antds',
              chunks: 'all',
              test: /[\\/]node_modules[\\/](@antd|antd)[\\/]/,
              priority: 30
            },
            //ant design
            antdesigns: {
              name: 'antdesigns',
              chunks: 'all',
              test: /[\\/]node_modules[\\/](@ant-design)[\\/]/,
              priority: 40
            },
            //rc-components组件
            rccomponents: {
              name: 'rccomponents',
              test: /[\\/]node_modules[\\/]_?rc-(.*)/,
              priority: 50,
              chunks: 'async'
            },
            //项目公共组件
            components: {
              name: 'chunk_components',
              chunks: 'async',
              test: resolve('src/components'), // can customize your rules
              minChunks: 3, // minimum common number
              priority: 55,
              reuseExistingChunk: true
            },
            //lodash
            lodashs: {
              name: 'lodashs',
              test: /[\\/]node_modules[\\/]lodash[\\/]/,
              chunks: 'async',
              priority: 60
            },
            //西瓜播放器
            xgplayer: {
              name: 'xgplayer',
              chunks: 'async',
              test: /[/]node_modules[/](xgplayer)[/]/,
              priority: 70
            },
            //其余异步加载包
            asynccommons: {
              chunks: 'async',
              minChunks: 2,
              name: 'asynccommons',
              priority: 9
            },
            //一些默认的
            default: {
              name: 'default',
              minChunks: 2,
              priority: -1,
              reuseExistingChunk: true
            }
          }
        }
      }
    });
  }
});
```

### 打包后文件大小信息

```
File                                         Size           Gzipped

dist/static/platform/js/umi.ffc3185c.js      1.2 MB         369.9 KB
dist/static/platform/js/asynccommons.0e      353.4 KB       84.2 KB
abd7f7.chunk.js
dist/static/platform/js/xgplayer.1d6732      333.7 KB       85.5 KB
57.chunk.js
dist/static/platform/js/antds.ffeed340.      279.2 KB       89.7 KB
chunk.js
dist/static/platform/js/antdesigns.014f      260.2 KB       75.7 KB
323d.chunk.js
dist/static/platform/js/rccomponents.47      255.7 KB       83.4 KB
3b0987.chunk.js
dist/static/platform/js/vendors.df2afe1      175.5 KB       50.2 KB
c.chunk.js
dist/static/platform/js/p__merchant__st      93.8 KB        24.0 KB
ore__EditStore.5c565e50.chunk.js
dist/static/platform/js/reacts.eebe5dc8      83.0 KB        22.3 KB
.chunk.js
dist/static/platform/js/t__plugin-layou      69.4 KB        23.3 KB
t__Layout.e00c34a0.chunk.js
dist/static/platform/js/chunk_component      46.6 KB        19.3 KB
s.7500bf69.chunk.js
dist/static/platform/js/p__marketing__p      16.2 KB        10.5 KB
latform__coupon__records.f1f4ced9.chunk
.js
dist/static/platform/js/p__merchant__en      15.5 KB        5.9 KB
tering.1b7d3472.chunk.js
dist/static/platform/js/p__system__perm      14.7 KB        3.7 KB
ission__rule__index.6401dbdf.chunk.js
dist/static/platform/js/p__goods__list.      14.5 KB        4.3 KB
e8da45b9.chunk.js
dist/static/platform/js/p__orders__list      13.4 KB        4.2 KB
.9dbc5a89.chunk.js
dist/static/platform/js/lodashs.731f9be      12.3 KB        4.4 KB
9.chunk.js
dist/static/platform/js/p__merchant__ad      11.9 KB        3.7 KB
min.9fc7d917.chunk.js
dist/static/platform/js/p__system__basi      11.0 KB        3.7 KB
c__pay.71f46cc0.chunk.js
dist/static/platform/js/p__system__user      10.6 KB        3.0 KB
__list.2dc61f54.chunk.js
dist/static/platform/js/p__member__tag.      10.5 KB        2.9 KB
b55b794d.chunk.js
dist/static/platform/js/p__system__perm      9.5 KB         3.0 KB
ission__menu__index.cce6ca48.chunk.js
dist/static/platform/js/p__orders__deta      9.2 KB         2.5 KB
il.34569b87.chunk.js
dist/static/platform/js/p__system__basi      9.0 KB         2.6 KB
c__system.ae0260ea.chunk.js
dist/static/platform/js/p__member__list      9.0 KB         3.2 KB
.061968b3.chunk.js
dist/static/platform/js/p__merchant__Ed      8.6 KB         2.7 KB
itMerchant.18220b92.chunk.js
dist/static/platform/js/p__orders__payi      8.6 KB         2.6 KB
ng.9aca18dc.chunk.js
dist/static/platform/js/p__goods__evalu      8.3 KB         2.9 KB
ations.18d38f6a.chunk.js
dist/static/platform/js/p__operate__gro      7.9 KB         2.5 KB
up.d39d0337.chunk.js
dist/static/platform/js/p__merchant__se      7.6 KB         2.6 KB
tting__classify.649998ee.chunk.js
dist/static/platform/js/p__system__perm      7.4 KB         2.7 KB
ission__role__index.98a84b8b.chunk.js
dist/static/platform/js/p__member__deta      7.1 KB         2.3 KB
il.5f793455.chunk.js
dist/static/platform/js/p__marketing__m      7.1 KB         2.5 KB
ember__signin.374b6bef.chunk.js
dist/static/platform/js/p__merchant__li      7.0 KB         2.3 KB
st.ebeade34.chunk.js
dist/static/platform/js/p__system__clas      6.9 KB         2.3 KB
sify__businessDistrict.45c63bbc.chunk.j
s
dist/static/platform/js/p__orders__sett      6.8 KB         2.3 KB
ing__afterSaleReason.85c37f67.chunk.js
dist/static/platform/js/p__system__clas      6.6 KB         2.3 KB
sify__region.fe29c951.chunk.js
dist/static/platform/js/p__merchant__se      6.5 KB         2.2 KB
tting__facilities.65061bc6.chunk.js
dist/static/platform/js/p__goods__class      6.4 KB         2.5 KB
ify.838c86e6.chunk.js
dist/static/platform/js/p__system__user      5.9 KB         2.4 KB
__department.dc19917d.chunk.js
dist/static/platform/js/p__goods__param      5.9 KB         2.0 KB
eterDetail.2f7966c2.chunk.js
dist/static/platform/js/p__orders__afte      5.8 KB         1.9 KB
rSale.fad283fb.chunk.js
dist/static/platform/js/p__merchant__st      5.6 KB         2.0 KB
ore.b4648011.chunk.js
dist/static/platform/js/p__system__basi      5.5 KB         2.1 KB
c__sms.1da0eafd.chunk.js
dist/static/platform/js/p__merchant__se      5.4 KB         1.9 KB
ttlement__list.f015ab88.chunk.js
dist/static/platform/js/p__marketing__p      5.0 KB         2.0 KB
latform__coupon__list.2902199f.chunk.js
dist/static/platform/js/p__system__log_      4.9 KB         1.5 KB
_error__index.54fa1832.chunk.js
dist/static/platform/js/p__user__Login.      4.8 KB         2.2 KB
b9f58c77.chunk.js
dist/static/platform/js/p__merchant__se      4.7 KB         1.8 KB
ttlement__BillDetail.fd07c97c.chunk.js
dist/static/platform/js/p__goods__servi      4.5 KB         1.9 KB
ng.096b67dc.chunk.js
dist/static/platform/js/p__merchant__se      4.4 KB         1.6 KB
tting__settlement.ee0ebda5.chunk.js
dist/static/platform/js/p__system__log_      4.2 KB         1.5 KB
_request__index.91967308.chunk.js
dist/static/platform/js/p__marketing__p      4.1 KB         1.5 KB
latform__payment__list.bef5dc22.chunk.j
s
dist/static/platform/js/p__orders__afte      4.0 KB         1.1 KB
rSaleDetail.cfa8e1d2.chunk.js
dist/static/platform/js/p__system__basi      3.8 KB         1.4 KB
c__mail.dda4b1d2.chunk.js
dist/static/platform/js/p__merchant__se      3.6 KB         1.5 KB
ttlement__Bill.f37fdbd3.chunk.js
dist/static/platform/js/p__marketing__m      3.4 KB         1.4 KB
ember__register.fefc5a80.chunk.js
dist/static/platform/js/p__goods__setti      3.3 KB         1.6 KB
ng.6476fd8d.chunk.js
dist/static/platform/js/p__Welcome.98f0      3.1 KB         1.4 KB
a083.chunk.js
dist/static/platform/js/p__member__bala      2.6 KB         1.2 KB
nce.e868d2a5.chunk.js
dist/static/platform/js/p__goods__param      2.1 KB         1.1 KB
eter.260b74ec.chunk.js
dist/static/platform/js/p__system__log_      2.0 KB         983.0 B
_sms.367e7ba0.chunk.js
dist/static/platform/js/p__system__log_      2.0 KB         1006.0 B
_login__index.a83485a8.chunk.js
dist/static/platform/js/p__404.5fa7670c      451.0 B        333.0 B
.chunk.js
dist/static/platform/js/p__merchant__se      407.0 B        303.0 B
tting__Basic.48fc9c8a.chunk.js
dist/static/platform/js/p__orders__sett      233.0 B        200.0 B
ing__express.f7d9a4ef.chunk.js
dist/static/platform/js/p__orders__sett      233.0 B        196.0 B
ing__transactionSettings.b0de43c5.chunk
.js
dist/static/platform/js/p__goods__revie      231.0 B        196.0 B
w.0555b1a5.chunk.js
dist/static/platform/js/p__goods__edit.      212.0 B        182.0 B
4dab86cc.chunk.js
dist/static/platform/js/p__marketing__p      212.0 B        180.0 B
latform__coupon__edit.e903ede6.chunk.js
dist/static/platform/js/p__goods__add.1      203.0 B        173.0 B
2c7e296.chunk.js
dist/static/platform/js/p__marketing__p      203.0 B        174.0 B
latform__coupon__add.a9475390.chunk.js
dist/static/platform/js/p__marketing__p      203.0 B        173.0 B
latform__payment__add.7cd88bb5.chunk.js
dist/static/platform/js/p__marketing__p      203.0 B        173.0 B
latform__payment__edit.62e873d6.chunk.j
s
dist/static/platform/css/antds.5687d708      310.2 KB       39.7 KB
.chunk.css
dist/static/platform/css/umi.c062ecb5.c      168.8 KB       21.2 KB
ss
dist/static/platform/css/asynccommons.a      32.4 KB        7.3 KB
825858c.chunk.css
dist/static/platform/css/antdesigns.323      24.1 KB        4.3 KB
f5d79.chunk.css
dist/static/platform/css/t__plugin-layo      7.7 KB         1.6 KB
ut__Layout.c6bf285a.chunk.css
dist/static/platform/css/p__merchant__e      7.4 KB         1.1 KB
ntering.7015dbb9.chunk.css
dist/static/platform/css/p__merchant__s      3.6 KB         984.0 B
tore__EditStore.29c33c65.chunk.css
dist/static/platform/css/p__orders__det      2.3 KB         758.0 B
ail.afb0d5f6.chunk.css
dist/static/platform/css/p__user__Login      1.7 KB         861.0 B
.50f24b5d.chunk.css
dist/static/platform/css/p__goods__para      1.2 KB         521.0 B
meterDetail.1570f0e5.chunk.css
dist/static/platform/css/p__Welcome.3f8      625.0 B        349.0 B
14cfa.chunk.css
dist/static/platform/css/p__goods__list      510.0 B        249.0 B
.68e8abfd.chunk.css
dist/static/platform/css/p__marketing__      496.0 B        262.0 B
member__signin.5d1b3c29.chunk.css
dist/static/platform/css/p__merchant__a      68.0 B         78.0 B
dmin.76ceaf5a.chunk.css
dist/static/platform/css/p__orders__lis      67.0 B         74.0 B
t.c2130356.chunk.css

```

### 🚑 其他信息

![image](https://user-images.githubusercontent.com/12706830/144349526-f15b6e64-bbab-4de1-9c83-1e6a358f7cfb.png)
![image](https://user-images.githubusercontent.com/12706830/144349543-fe1c3885-2a74-4249-9e8e-c11dfe06f8d7.png)

## xueerli

没配置chunks不会抱错吗？`chunks: [ 'vendor', 'reacts', ... , 'umi' ]`

## codedart2018

>

没配置它会自动识别，配置了必须和下面的一致。现在我的umi里还有antd @antd-design 我也不知道怎么抽出来了。你是如何配置的？

## chenshuai2144

直接用 https://umijs.org/zh-CN/config#externals
这个吧，不要挣扎了

## codedart2018

>

就是用了这个啊，现在umi.js还是有点大。1.2m
能不能出个完整的打包，能把vendor umi　没有压缩前变得只有300km以内

## ZengJun-cloud

借鉴一下打包

## ZengJun-cloud

@codedart2018 加了compression-webpack-plugin直接项目都起不来了 是咋回事

## codedart2018

>

compression-webpack-plugin 依赖装了嘛

## ZengJun-cloud

>

就是装了它，项目起不来
![1639550719999_2064E023-80CD-4f82-9EEF-027A296D5863](https://user-images.githubusercontent.com/52198079/146297613-25a252fd-fab3-4614-9fa9-64a5824e3c8e.png)

## codedart2018

删除node_modules重装，这个插件只是个打包压缩的。

## ZengJun-cloud

> 删除node_modules重装，这个插件只是个打包压缩的。

删过重装...依旧是这样

## codedart2018

> > 删除node_modules重装，这个插件只是个打包压缩的。
>
> 删过重装...依旧是这样

开启mfsu 删除　node_modules 删除 .umi

## ZengJun-cloud

> > > 删除node_modules重装，这个插件只是个打包压缩的。
> >
> > 删过重装...依旧是这样
>
> 开启mfsu 删除　node_modules 删除 .umi

哎，我再试试吧，这些操作都试过。每次重装node_modules要40+分钟。

## codedart2018

>

你要不去umi.js找找看。我到没遇到过这个。

## lijie1024512

大佬 后续还有优化么
