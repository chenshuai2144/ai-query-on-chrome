# Shadow DOM 下 Popconfirm 组件无法正常工作

`🐛 Bug`,`👷🏻‍♂️ Someone working on it`

### Reproduction link

[![Edit on CodeSandbox](https://codesandbox.io/static/img/play-codesandbox.svg)](https://codesandbox.io/s/ji-ben-antd-5-3-2-forked-tjow71?file=/index.tsx)

### Steps to reproduce

打开后直接点击按钮即可复现

### What is expected?

正常打开弹窗

### What is actually happening?

打不开，打开立即自动关闭了

| Environment | Info                  |
| ----------- | --------------------- |
| antd        | 5.3.2                 |
| React       | 18                    |
| System      | mac m1                |
| Browser     | chrome 111.0.5563.110 |

<!-- generated by ant-design-issue-helper. DO NOT REMOVE -->

## hewenguang

我开发的扩展 Circle 阅读助手就是基于 antd 组件的，近期注意到可以升级到 antd v5，按照教程顺利升级。当测试 Popconfirm 组件时发现有问题。

CodeSandbox 复现了打不开的问题，报错和我本地的报错不一致，猜测应该原因是一致的。

本地报错也提供如下，希望对于 bug 排查有帮助。问题都是 Popconfirm 组件导致的。

<img width="860" alt="截屏2023-03-23 23 19 54" src="https://user-images.githubusercontent.com/38025280/227251377-6a4884e9-4c1a-463b-ab0c-b96762d155e7.png">

## zombieJ

debug 了一下，点击触发 Popconfirm 的时候会添加 window 点击事件监听。此时由于点击元素是 shadow dom，所以它并不能拿到真实的 dom 节点，以至于弹层认为点了外部所以关关闭。可以先加个 stopPop：
https://codesandbox.io/s/ji-ben-antd-5-3-2-forked-9q8lyv?file=/demo.tsx

## hewenguang

强，确实可以临时解决！！！

## acyza

大概试了下，好像shadowroot下的所有dom的click事件target都是shadowroot宿主
或许可以用event中提供的一些坐标判断范围，但肯定没有target准确。

## zombieJ

fixed: https://codesandbox.io/s/ji-ben-antd-5-3-2-forked-hxh93q?file=/package.json

## RyzenPan

请问怎么解决，没看懂在哪里加stopPop？

## acyza

> 请问怎么解决，没看懂在哪里加stopPop？

https://github.com/ant-design/ant-design/issues/41428#issuecomment-1481466692
`stopPropagation`看这条评论的demo，或升级rc-trigger

## RyzenPan

> > 请问怎么解决，没看懂在哪里加stopPop？
>
> [#41428 (comment)](https://github.com/ant-design/ant-design/issues/41428#issuecomment-1481466692) `stopPropagation`看这条评论的demo，或升级rc-trigger

之后官方会解决是吧，大概什么时候发正式版？

## RyzenPan

> > 请问怎么解决，没看懂在哪里加stopPop？
>
> [#41428 (comment)](https://github.com/ant-design/ant-design/issues/41428#issuecomment-1481466692) `stopPropagation`看这条评论的demo，或升级rc-trigger

请问rc-trigger需要升级到哪个版本，我看现在最新的是5.3.4，跟仓库的tag版本不一致？

## yoyo837

在 @rc-component/trigger 了

## RyzenPan

> 在 @rc-component/trigger 了

请问怎么更新antd的@rc-component/trigger包了，我直接安装最新版在项目中，antd没有用到这个包，我用的是pnpm

## hewenguang

试试卸载 antd 后重新安装，这样相关的依赖会更新

## yoyo837

> > 在 @rc-component/trigger 了
>
> 请问怎么更新antd的@rc-component/trigger包了，我直接安装最新版在项目中，antd没有用到这个包，我用的是pnpm

目前最新版本的antd还剩俩包没有切换依赖, 其他的都切换了

![image](https://user-images.githubusercontent.com/6134547/234515334-5f2504d6-255a-4e6e-a013-33fcd8bb7ff4.png)
