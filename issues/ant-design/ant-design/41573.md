# 在ssr场景下使用antd页面会闪烁，用户体验非常差

`improvement`

### Reproduction link

[https://github.com/ant-design/create-next-app-antd.git](https://github.com/ant-design/create-next-app-antd.git)

### Steps to reproduce

git clone https://github.com/ant-design/create-next-app-antd.git
cd create-next-app-antd
tyarn
tyarn run build
tyarn start

### What is expected?

希望页面可以正常加载出来，不要闪烁

### What is actually happening?

打开页面后，页面会闪烁一下，这种体验真的非常糟糕，

| Environment | Info    |
| ----------- | ------- |
| antd        | 5.3.2   |
| React       | 18.2.0  |
| System      | windows |
| Browser     | chrome  |

---

https://github.com/ant-design/create-next-app-antd.git 是官方的演示示例，里面有这种问题。

<!-- generated by ant-design-issue-helper. DO NOT REMOVE -->

## kiner-tang

已经更新新的使用方式

- 相关 PR : https://github.com/ant-design/create-next-app-antd/pull/5
- 相关问题： https://github.com/ant-design/ant-design/issues/41559

  ## zombieJ

  @ideaviewes，试试最新的版本，如果有问题欢迎反馈哈

  ## ideaviewes

  @zombieJ ,您好，是把antd更新到最新的5.3.3吗？

  ## kiner-tang

  > @zombieJ ,您好，是把antd更新到最新的5.3.3吗？

不需要升级 antd ，只需要参考：https://github.com/ant-design/create-next-app-antd.git 这里给出的最新 demo 实现即可。相关文档我们正在写，之后会更新到 antd 的文档当中

## ideaviewes

@kiner-tang ，您好，我重新下clone了一下，还是同样的问题，闪烁一下，然后样式加载出来，感觉像是transition的锅

## kiner-tang

> @kiner-tang ，您好，我重新下clone了一下，还是同样的问题，闪烁一下，然后样式加载出来，感觉像是transition的锅

可以录个视频看看么？这边是不会闪烁的
![屏幕录制2023-03-31 14 06 43 mov](https://user-images.githubusercontent.com/10286961/229082451-68f751eb-5e36-47e8-9ca8-9b2046485a45.gif)

## ideaviewes

@kiner-tang ,您好
![image](https://user-images.githubusercontent.com/5431843/229085946-507ef8db-3709-4859-a814-509efa792c91.png)
![GIF 2023-3-31 17-41-46](https://user-images.githubusercontent.com/5431843/229085964-1dfb2fe7-a8a2-4648-b169-0c28cc6ebff5.gif)

## afc163

https://github.com/ant-design/create-next-app-antd/commits/main 你本地好像不是最新 commit。

## ideaviewes

@afc163
我又重新git clone https://github.com/ant-design/create-next-app-antd.git一份代码
![image](https://user-images.githubusercontent.com/5431843/229098697-3dcd09b2-6796-4fd1-8e3b-36b793fc52d4.png)

还是这样
![GIF 2023-3-31 18-36-07](https://user-images.githubusercontent.com/5431843/229098079-ad72a529-09e3-407f-b625-103781890299.gif)

## ideaviewes

@afc163 @kiner-tang
tyarn dev的确实不闪烁了
但是
tyarn run build
tyarn start的时候闪烁，您那边可以试一下
dev闪不闪都无所谓，start上线不能有这个问题吧

## kiner-tang

@ideaviewes 看看这个是否能够满足你的需求：

- https://github.com/ant-design/create-next-app-antd/pull/6

  ## ideaviewes

  @kiner-tang ,谢谢 有没有办法像是tailwindcss那样，直接把css抽取出来，或者是直接输出在页面上也行
  我看这个demo，处理后，生成了一个接近1M的css文件，antd.min.css
  感觉这样成本太大了

  ## kiner-tang

  > @kiner-tang ,谢谢 有没有办法像是tailwindcss那样，直接把css抽取出来，或者是直接输出在页面上也行 我看这个demo，处理后，生成了一个接近1M的css文件，antd.min.css 感觉这样成本太大了

我们目前正在讨论根据首屏页面使用到的 antd 组件按需抽取 css 样式，支持后，每个页面只会导入当前页面首屏渲染所需的 css，其他非首屏 css 则在运行时动态注入。

## ideaviewes

@kiner-tang ,嗯嗯，好的，超棒

## atom-shanghai

> > @kiner-tang ,谢谢 有没有办法像是tailwindcss那样，直接把css抽取出来，或者是直接输出在页面上也行 我看这个demo，处理后，生成了一个接近1M的css文件，antd.min.css 感觉这样成本太大了
>
> 我们目前正在讨论根据首屏页面使用到的 antd 组件按需抽取 css 样式，支持后，每个页面只会导入当前页面首屏渲染所需的 css，其他非首屏 css 则在运行时动态注入。
> 非常需要这个，目前样式闪烁非常不友好

## kiner-tang

@atom-shanghai @ideaviewes
可以先看看这个方案。使用这个方案，ssr 生成的样式将根据当前页面首屏渲染使用的 antd 组件按需抽取样式

- https://github.com/ant-design/create-next-app-antd/pull/6/files

  ## ideaviewes

  @kiner-tang ,这样可以，马上就要解决我的问题了，还有一点问题
  我使用了tailwindcss，antd抽取出来的css有一部分会冲突掉tailwindcss的样式，
  我看了下页面上的情况，tailwindcss生成的css文件在antd生成的style标签之前引用，所以被覆盖了一些样式
  这个应该不是antd的问题，您那边可以给我提供一些思路如何解决吗？
  实现的代码是这样的，自定义了\_document.tsx

```
import type { DocumentContext, DocumentInitialProps } from 'next/document'
import Document, { Html, Head, Main, NextScript } from 'next/document'
import { createCache, extractStyle, StyleProvider } from '@ant-design/cssinjs'

class MyDocument extends Document {
    static async getInitialProps(
        ctx: DocumentContext
    ): Promise<DocumentInitialProps> {
        const cache = createCache()
        const originalRenderPage = ctx.renderPage

        ctx.renderPage = () =>
            originalRenderPage({
                enhanceApp: (App) => (props) =>
                    (
                        <StyleProvider cache={cache}>
                            <App {...props} />
                        </StyleProvider>
                    ),
            })

        const initialProps = await Document.getInitialProps(ctx)
        return {
            ...initialProps,
            styles: (
                <>
                    {initialProps.styles}
                    {/* hacky code, `extractStyle` does not currently support returning JSX or related data. */}
                    <script
                        dangerouslySetInnerHTML={{
                            __html: `</script>${extractStyle(cache)}<script>`,
                        }}
                    />
                </>
            ),
        }
    }
    render() {
        return (
            <Html>
                <Head />
                <body>
                <Main />
                <NextScript />
                </body>
            </Html>
        )
    }
}

export default MyDocument

```

## MadCcc

@ideaviewes 是的这是我们一开始推荐的做法，这样会导致 html 文件太大，所以我们又推出了静态导出的方案。

## hemengke1997

> @ideaviewes 是的这是我们一开始推荐的做法，这样会导致 html 文件太大，所以我们又推出了静态导出的方案。

静态导出也会导致样式闪烁吧？ 我理解的是 只有把当前渲染页面的样式内联到html中才能避免这个问题

## ideaviewes

> > @ideaviewes 是的这是我们一开始推荐的做法，这样会导致 html 文件太大，所以我们又推出了静态导出的方案。
>
> 静态导出也会导致样式闪烁吧？ 我理解的是 只有把当前渲染页面的样式内联到html中才能避免这个问题

导致闪烁的原因为那个css是用js加上去的

## hemengke1997

> 导致闪烁的原因为那个css是用js加上去的

css外链是在客户端加载，跟js加载一样的道理呀，也会样式闪烁吧？（比如网络不好，css加载很慢）

## ideaviewes

@hemengke1997 ，不会，你可以尝试一下

## hemengke1997

> @hemengke1997 ，不会，你可以尝试一下

对对对，link会阻塞渲染，所以不会出现样式闪烁

## ideaviewes

@MadCcc ,也没有引用很多antd的组件，为什么会产生这么巨量的css呢？

## ideaviewes

所以有什么比较完美的方案吗，不会输入很大的css，然后又能跟tailwindcss结合的比较完美的

## MadCcc

> extractStyle

可以给个产物看看么

## ideaviewes

https://github.com/ideaviewes/extractstyle.git
tyarn
tyarn dev
可以看到生成的css非常长，我保存了下，164k，我仅仅是使用了antd的Row Col Menu组件，这里感觉应该是有问题

## atom-shanghai

这个有好的解决办法了吗？

## zombieJ

> https://github.com/ideaviewes/extractstyle.git tyarn tyarn dev 可以看到生成的css非常长，我保存了下，164k，我仅仅是使用了antd的Row Col Menu组件，这里感觉应该是有问题

看了一下生成的样式，它们分别是 Col、Row、Menu 和 Tooltip 的样式。其中 Menu 有使用过 Tooltip，所以这些提取的样式是符合预期的。

业界现在的方案基本都是 inline html 导出，这个就会导致 ssr 出的 html 里带着样式全都无法被 cache 掉。所以我们给 antd 加了一个静态全量导出的能力，一次性烘焙好完整的 css 文件。好处是和原生的 css 加载一样，一次使用全部缓存。缺点就是需要提前烘焙一下，如果用了动态主题就要多烘焙一点。

ref: https://ant.design/docs/react/customize-theme-cn#%E6%95%B4%E4%BD%93%E5%AF%BC%E5%87%BA

## ideaviewes

@zombieJ ,好的，谢谢
