# 表单中存在动态增删字段时，`form.validateFields` 不能正确校验

`unconfirmed`

### Reproduction link

[https://stackblitz.com/edit/react-rkv3ig?file=demo.tsx](https://stackblitz.com/edit/react-rkv3ig?file=demo.tsx)

### Steps to reproduce

在表单中插入一个条件展示的表单项后，`form.validateFields` 不能获取正确的表单校验结果：

```tsx
import React, { useEffect, useState } from "react";
import "./index.css";
import { Form, Input, Radio } from "antd";

const App: React.FC = () => {
  const [status, setStatus] = useState(false);
  const [form] = Form.useForm();
  const values = Form.useWatch([], form);

  useEffect(() => {
    console.log(values);
    form
      .validateFields({ validateOnly: true })
      .then(() => {
        setStatus(true);
      })
      .catch(() => {
        setStatus(false);
      });
  }, [values]);

  return (
    <>
      <Form form={form} initialValues={{ radio: 1 }}>
        <Form.Item name="radio">
          <Radio.Group>
            <Radio value={1}>1</Radio>
            <Radio value={2}>2</Radio>
            <Radio value={3}>3</Radio>
          </Radio.Group>
        </Form.Item>
        <Form.Item
          noStyle
          shouldUpdate={(prev, curr) => prev.radio !== curr.radio}
        >
          {({ getFieldValue }) =>
            getFieldValue("radio") === 3 && (
              <Form.Item
                required
                name="input"
                rules={[{ required: true, whitespace: true }]}
              >
                <Input />
              </Form.Item>
            )
          }
        </Form.Item>
      </Form>
      <div>Status: {JSON.stringify(status)}</div>
    </>
  );
};

export default App;
```

切换到 radio 3 后，在新增的 input 中输入任意内容使表单校验通过，此时切换至 radio 2 后表单会校验不通过，但符合预期的结果应该是校验通过，只有再次执行切换操作，切换到 radio 1 时表单校验才会通过。
同时，radio 3 下新增的 input 中已经存在能够通过表单校验的内容，再次切换会 radio 3 后表单校验仍不通过，符合预期的结果应该是校验通过，只有再次执行输入操作时表单校验才会重新通过。

### What is expected?

正确执行校验

### What is actually happening?

未能正确执行校验

| Environment | Info                                                                                                                                      |
| ----------- | ----------------------------------------------------------------------------------------------------------------------------------------- |
| antd        | 5.5.1                                                                                                                                     |
| React       | 18.2.0                                                                                                                                    |
| System      | MacOS 13.4                                                                                                                                |
| Browser     | 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36 Edg/114.0.1823.18' |

<!-- generated by ant-design-issue-helper. DO NOT REMOVE -->

![](https://github.com/ant-design/ant-design/assets/45777252/29aec6b8-dd36-4162-9de9-6e9edce512ae)

## ILoveChy

@wjq990112 第8行 `const values = Form.useWatch([], { preserve: true, form });` 这样就好了.
不过这个切换如果不加那个属性,也确实看起来和预期的不太一样,useWatch原来监听的只是注册字段,在radio消失的时候因为values检测到变化了,但是form还没反应过来?

## zombieJ

如 @ILoveChy 所述。切换时，Field 消失 values 变一次，Field 清空 values 变一次，导致前一次的校验过期了：

<img width="186" alt="截屏2023-05-30 09 47 13" src="https://github.com/ant-design/ant-design/assets/5378891/ea9cf68b-2507-4fbe-976e-12257f8e00ac">

而前一个变化由于有 `rules`，所以它的校验反而晚于后者。这里其实只要无视掉 OOD 的校验就行了：

https://stackblitz.com/edit/react-rkv3ig-dmcatu?file=demo.tsx

## wjq990112

> 如 @ILoveChy 所述。切换时，Field 消失 values 变一次，Field 清空 values 变一次，导致前一次的校验过期了：
>
> <img alt="截屏2023-05-30 09 47 13" width="186" src="https://user-images.githubusercontent.com/5378891/241828067-ea9cf68b-2507-4fbe-976e-12257f8e00ac.png">
> 而前一个变化由于有 `rules`，所以它的校验反而晚于后者。这里其实只要无视掉 OOD 的校验就行了：
>
> https://stackblitz.com/edit/react-rkv3ig-dmcatu?file=demo.tsx

这个行为不算是个 bug 吗？看起来不太符合预期
