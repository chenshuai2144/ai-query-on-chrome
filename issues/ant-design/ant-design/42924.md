# 5.x Popover çš„ onOpenChange è§¦å‘çš„æ—¶æœºå­˜åœ¨é—®é¢˜

`Inactive`,`unconfirmed`

### Reproduction link

[![Edit on CodeSandbox](https://codesandbox.io/static/img/play-codesandbox.svg)](https://codesandbox.io/s/ji-ben-antd-5-6-0-forked-5f031b)

4.x æ˜¯å¯ä»¥çš„
[![Edit on CodeSandbox](https://codesandbox.io/static/img/play-codesandbox.svg)](https://codesandbox.io/s/ji-ben-antd-4-24-10-forked-3ig570)

### Steps to reproduce

ç›®çš„æ˜¯ä¸ºäº†åœ¨ Popover å†…æ‰“å¼€ Modal æ—¶ï¼ŒPopover ä¸å…³é—­

1ã€æ‰“å¼€ Popover
2ã€æ‰“å¼€ Modal
3ã€å…³é—­ Modal

### What is expected?

Popover æ˜¯æ‰“å¼€çš„ã€‚ä¸”åœ¨ Modal æ‰“å¼€çš„æ—¶å€™ç‚¹å‡»ä»»æ„ä½ç½®ä¸åº”è§¦å‘ onOpenChangeã€‚

### What is actually happening?

Popover å…³é—­äº†ã€‚ä¸”åœ¨ Modal æ‰“å¼€çš„æ—¶å€™ç‚¹å‡»ä»»æ„ä½ç½®éƒ½ä¼šè§¦å‘ onOpenChangeã€‚

| Environment | Info    |
| ----------- | ------- |
| antd        | 5.6.1   |
| React       | lastest |
| System      | mac     |
| Browser     | chrome  |

---

discussion https://github.com/ant-design/ant-design/discussions/42863#discussioncomment-6118857

<!-- generated by ant-design-issue-helper. DO NOT REMOVE -->

## BoyYangzai

@linxianxi è€ƒè™‘ä½¿ç”¨ å—æ§ + useClickOutside è§£å†³å‘¢
åº”è¯¥ä¹ŸæŒºæ–¹ä¾¿çš„ ä¼ å…¥ ModelRef å’Œ PopoverRef æ•°ç»„

```typescript
import { MutableRefObject, useCallback, useEffect, useRef } from "react";

const defaultEvent = "click";
type RefType = Element | (() => Element | null) | null | undefined;

const useClickOutside = <T extends Element>(
  dom: RefType | RefType[],
  callback: (event: Event) => void,
  eventName: string = defaultEvent,
  listenerOptions?: boolean | AddEventListenerOptions,
) => {
  const callbackRef = useRef(callback);
  const targetRefs = useRef<RefType[]>([]);
  const element = useRef<T>();

  useEffect(() => {
    callbackRef.current = callback;
  }, [callback]);

  useEffect(() => {
    targetRefs.current = Array.isArray(dom) ? dom : [dom];
  }, [dom]);

  const eventHandler = useCallback(
    (e: Event) => {
      const isOutside = targetRefs.current.every((item) => {
        const el =
          typeof item === "function" ? item() : item || element.current;
        return !el?.contains(e.target as Node);
      });

      if (isOutside) {
        callbackRef.current(e);
      }
    },
    [element.current, targetRefs.current],
  );

  useEffect(() => {
    document.addEventListener(eventName, eventHandler, listenerOptions);
    return () => {
      document.removeEventListener(eventName, eventHandler, listenerOptions);
    };
  }, [eventName, listenerOptions, eventHandler]);

  return element as MutableRefObject<T>;
};

export default useClickOutside;
```

## linxianxi

æ€ä¹ˆå®ç°ä¸è°ˆï¼Œè¿™ä¸ª issue è°ˆçš„æ˜¯ bugã€‚

## linxianxi

@BoyYangzai ä½ å¯ä»¥åœ¨ codesandbox å°è¯•ç”¨ useClickAway å®ç°ä¸€ä¸‹

## BoyYangzai

@linxianxi æ™šç‚¹ä¸‹ç­çœ‹çœ‹

## BoyYangzai

@linxianxi @vaynevayne ç®€å•å®ç°äº†ä¸€ä¸‹ æ‹¿ä¸åˆ°PopOverå’ŒModalçš„çœŸå®domçš„refæœ‰ç‚¹éš¾é¡¶
https://codesandbox.io/s/ji-ben-antd-5-6-0-forked-63cy75?file=/demo.tsx
@zombieJ ç¨å¾®æœ‰ç‚¹å¤æ‚ è±†é…±ä½ æ€ä¹ˆçœ‹
å¦‚æœè¿™é‡Œçš„ ref èƒ½æ‹¿åˆ° popover çš„ ref å°±ç®€å•å¾ˆå¤šäº† æˆ‘ä¹Ÿè¦åŠ å…¥æ”¯æŒæ²¡æœ‰ blur çš„ä¸€æ–¹äº†(ç‹—å¤´ğŸ¤ª
![image](https://github.com/ant-design/ant-design/assets/94534613/e595c4de-0c1d-4753-9f75-f0ca2863c396)

## linxianxi

ä¸ä¸€å®šè¦ refï¼Œdocument.querySelector å°±èƒ½è·å–ã€‚è¿˜æ˜¯é‡ç‚¹å…³æ³¨ 5.x å’Œ 4.x è¡Œä¸ºä¸åŒçš„é—®é¢˜å§

## vaynevayne

å†…éƒ¨å¤„ç†onBlurçš„ä»£ç åœ¨å“ªé‡Œå•Šï¼Ÿèƒ½è´´ä¸ªè¿æ¥å— åˆ†æä¸€æ³¢

## zombieJ

v4 çš„ Popover åº•å±‚ç›‘å¬çš„æ˜¯ `mouseDown` äº‹ä»¶ï¼Œv5 ç›‘å¬çš„æ˜¯ `click` äº‹ä»¶ï¼Œæ‰€ä»¥ popover change å’Œ modal change æ—¶åºæ˜¯åçš„ã€‚æœ‰ç‚¹ä¸è®°å¾—ä¸ºå•¥è¿™ä¹ˆè°ƒæ•´äº†ã€‚

- v4: https://github.com/react-component/trigger/blob/5.x/src/index.tsx#L226
- v5: https://github.com/react-component/trigger/blob/master/src/hooks/useWinClick.ts#L67

  ## linxianxi

  v5 ç°åœ¨å®ç°è¿™ç§éœ€æ±‚æœ€ç®€å•çš„æ–¹å¼åº”è¯¥æ˜¯è¿™æ ·å§ï¼Œä½†æ˜¯æ„Ÿè§‰ä¹Ÿä¸æ˜¯å¾ˆä¼˜é›…ã€‚
  https://codesandbox.io/s/ji-ben-antd-5-6-0-forked-q5m93q

  ## vaynevayne

  popover æ¢æˆ select è¯•è¯•
  å†™äº†ä¸ª demo : https://stackblitz.com/edit/react-djm2de?file=index.tsx

  ## linxianxi

  > popover æ¢æˆ select è¯•è¯• å†™äº†ä¸ª demo : https://stackblitz.com/edit/react-djm2de?file=index.tsx

ä¸€æ ·çš„ https://codesandbox.io/s/kuo-zhan-cai-dan-antd-5-6-0-forked-jrhw9d

## linxianxi

@zombieJ ä¹Ÿæ²¡æ¯”è¾ƒå¥½çš„åŠæ³•äº†å§ï¼Œè¦ä¸è¦åœ¨æ–‡æ¡£é‡ŒåŠ ä¸ª demoï¼Ÿ

## vaynevayne

https://stackblitz.com/edit/react-djm2de?file=demo.tsx å¼¹çª—æ‰“å¼€æ—¶, ç‚¹ä¸€ä¸‹è¿™ä¸ªä¾‹å­é‡Œçš„modal , popover å°±å°±å…³é—­äº†, ä½ é‚£ä¸ªä¾‹å­é‡Œçš„é˜»æ­¢å…³é—­, å…³é”®ä»£ç æ˜¯ä»€ä¹ˆ?

## vaynevayne

https://github.com/react-component/select/pull/943 è¿™ä¸ªåŸå› ? @zombieJ

## zombieJ

> [react-component/select#943](https://github.com/react-component/select/pull/943) è¿™ä¸ªåŸå› ? @zombieJ

Popover ç»„ä»¶å’Œ Select ç»„ä»¶æ²¡æœ‰å…³ç³»ã€‚Select åº•å±‚æ²¡ç”¨ Popoverï¼ŒPopover åº•å±‚ä¹Ÿæ²¡ç”¨ Selectã€‚

## vaynevayne

> > [react-component/select#943](https://github.com/react-component/select/pull/943) è¿™ä¸ªåŸå› ? @zombieJ
>
> Popover ç»„ä»¶å’Œ Select ç»„ä»¶æ²¡æœ‰å…³ç³»ã€‚Select åº•å±‚æ²¡ç”¨ Popoverï¼ŒPopover åº•å±‚ä¹Ÿæ²¡ç”¨ Selectã€‚

çŸ¥é“äº†, æ²¡å…³ç³», åé¢æˆ‘ä¸æ˜¯æ‰¾åˆ°åŸå› è¿˜åœ¨ rc-select é‡Œæäº† pr å˜›, æ€ä¹ˆè¿˜çœ‹è¿™ä¸ªå•Š

## zombieJ

> v5 ç°åœ¨å®ç°è¿™ç§éœ€æ±‚æœ€ç®€å•çš„æ–¹å¼åº”è¯¥æ˜¯è¿™æ ·å§ï¼Œä½†æ˜¯æ„Ÿè§‰ä¹Ÿä¸æ˜¯å¾ˆä¼˜é›…ã€‚ https://codesandbox.io/s/ji-ben-antd-5-6-0-forked-q5m93q

ä¹Ÿæ˜¯è¿™ä¸ªæ€è·¯ï¼Œeffect å»¶è¿Ÿæ‰ visibleã€‚

## linxianxi

å›  rc-trigger å†…éƒ¨ useWinClick æ”¹æˆæ•è·äº†ï¼Œæ‰€ä»¥ç°åœ¨ä¸éœ€è¦ delay æ¥å¤„ç†äº†ã€‚
