# Tableæ€§èƒ½é—®é¢˜ï¼štableé‡ŒåŠ å…¥Popoverä¼šå¯¼è‡´å½“å‰é¡µé¢æ‰€æœ‰setState()å¡æ­»

`ğŸ¤” Need Reproduce`,`unconfirmed`

### Reproduction link

[![Edit on CodeSandbox](https://codesandbox.io/static/img/play-codesandbox.svg)](https://codesandbox.io/s/tuo-zhuai-shou-bing-lie-antd-5-7-3-forked-3rz22z?file=/demo.tsx)

### Steps to reproduce

å¦‚æœåœ¨tableçš„columnsé‡Œçš„ä¸€ä¸ªåˆ—é‡Œæ‰‹åŠ¨renderä¸€ä¸ªpopoverï¼Œé‚£ä¹ˆå½“tableæ•°æ®ç¨å¾®å¤šä¸€ç‚¹ç‚¹ï¼ˆå¤§æ¦‚40æ¡ï¼‰å°±ä¼šå¯¼è‡´å½“å‰é¡µé¢æ‰€æœ‰setState()å¡æ­»ã€‚

ä»¥ä¸‹æ˜¯å®˜æ–¹çš„å®ä¾‹ä»£ç ï¼Œä»…ä»…åšäº†ä¸€å°ç‚¹æ”¹åŠ¨ã€‚ï¼ˆå¦‚æœå¡é¡¿ä¸æ˜æ˜¾ï¼Œåªéœ€ç¨å¾®å¢åŠ æµ‹è¯•æ•°æ®å°±èƒ½å¤ç°ï¼‰ã€‚
å¯å°†ä¸‹é¢ä»£ç ç›´æ¥å¤åˆ¶åˆ°codesandboxé‡Œè¿è¡Œï¼Œä»£ç é‡ŒåŠ äº†ä¸€ä¸ªè¾“å…¥æ¡†ï¼Œè¿ç»­è¾“å…¥å†…å®¹å°±èƒ½å¤ç°å¡é¡¿ã€‚

```tsx
import React, { useState } from "react";
import "./index.css";
import { MenuOutlined, EditOutlined } from "@ant-design/icons";
import type { DragEndEvent } from "@dnd-kit/core";
import { DndContext } from "@dnd-kit/core";
import { restrictToVerticalAxis } from "@dnd-kit/modifiers";
import {
  arrayMove,
  SortableContext,
  useSortable,
  verticalListSortingStrategy,
} from "@dnd-kit/sortable";
import { CSS } from "@dnd-kit/utilities";
import { Table, Input, Popover, Button } from "antd";
import type { ColumnsType } from "antd/es/table";

interface DataType {
  key: string;
  name: string;
  age: number;
  address: string;
}

const columns: ColumnsType<DataType> = [
  {
    key: "sort",
  },
  {
    title: "Name",
    dataIndex: "name",
  },
  {
    title: "Age",
    dataIndex: "age",
  },
  {
    title: "Address",
    dataIndex: "address",
  },
  {
    title: "",
    dataIndex: "option",
    width: 70,
    render: (text: any, record: any, index: any) => [
      <div key="op">
        <Popover
          content={
            <div>
              <div>
                <Input
                  placeholder="è¯·è¾“å…¥åˆ†ç»„åç§°"
                  autoFocus
                  defaultValue={record.group_name}
                  id={`txt_group_${record.id}`}
                />
              </div>
              <div>
                <Button type="primary">æäº¤</Button>
              </div>
            </div>
          }
          title={false}
          trigger="click"
        >
          <EditOutlined
            onClick={(e: any) => {
              e.stopPropagation();
              e.preventDefault();
            }}
          />
        </Popover>
      </div>,
    ],
  },
];

interface RowProps extends React.HTMLAttributes<HTMLTableRowElement> {
  "data-row-key": string;
}

const Row = ({ children, ...props }: RowProps) => {
  const {
    attributes,
    listeners,
    setNodeRef,
    setActivatorNodeRef,
    transform,
    transition,
    isDragging,
  } = useSortable({
    id: props["data-row-key"],
  });

  const style: React.CSSProperties = {
    ...props.style,
    transform: CSS.Transform.toString(transform && { ...transform, scaleY: 1 }),
    transition,
    ...(isDragging ? { position: "relative", zIndex: 9999 } : {}),
  };

  return (
    <tr {...props} ref={setNodeRef} style={style} {...attributes}>
      {React.Children.map(children, (child) => {
        if ((child as React.ReactElement).key === "sort") {
          return React.cloneElement(child as React.ReactElement, {
            children: (
              <MenuOutlined
                ref={setActivatorNodeRef}
                style={{ touchAction: "none", cursor: "move" }}
                {...listeners}
              />
            ),
          });
        }
        return child;
      })}
    </tr>
  );
};

const App: React.FC = () => {
  const [dataSource, setDataSource] = useState([
    {
      key: "1",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "2",
      name: "Jim Green",
      age: 42,
      address: "London No. 1 Lake Park",
    },
    {
      key: "3",
      name: "Joe Black",
      age: 32,
      address: "Sidney No. 1 Lake Park",
    },
    {
      key: "4",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "5",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "6",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "7",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "8",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "9",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "10",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "11",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "12",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "13",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "14",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "15",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "16",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "17",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "18",
      name: "John Brown",
      age: 33,
      address: "normal text",
    },
    {
      key: "18",
      name: "John Brown",
      age: 33,
      address: "normal text",
    },
    {
      key: "18",
      name: "John Brown",
      age: 33,
      address: "normal text",
    },
    {
      key: "18",
      name: "John Brown",
      age: 33,
      address: "normal text",
    },
    {
      key: "18",
      name: "John Brown",
      age: 33,
      address: "normal text",
    },
    {
      key: "18",
      name: "John Brown",
      age: 33,
      address: "normal text",
    },
    {
      key: "18",
      name: "John Brown",
      age: 33,
      address: "normal text",
    },
    {
      key: "18",
      name: "John Brown",
      age: 33,
      address: "normal text",
    },
    {
      key: "18",
      name: "John Brown",
      age: 33,
      address: "normal text",
    },
    {
      key: "18",
      name: "John Brown",
      age: 33,
      address: "normal text",
    },
    {
      key: "18",
      name: "John Brown",
      age: 33,
      address: "normal text",
    },
    {
      key: "18",
      name: "John Brown",
      age: 33,
      address: "normal text",
    },
    {
      key: "1",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "2",
      name: "Jim Green",
      age: 42,
      address: "London No. 1 Lake Park",
    },
    {
      key: "3",
      name: "Joe Black",
      age: 32,
      address: "Sidney No. 1 Lake Park",
    },
    {
      key: "4",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "5",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "6",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "7",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "8",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "9",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "10",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "11",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "12",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "13",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "14",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "15",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "16",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
  ]);
  const [txt, setTxt] = useState();

  const onDragEnd = ({ active, over }: DragEndEvent) => {
    if (active.id !== over?.id) {
      setDataSource((previous) => {
        const activeIndex = previous.findIndex((i) => i.key === active.id);
        const overIndex = previous.findIndex((i) => i.key === over?.id);
        return arrayMove(previous, activeIndex, overIndex);
      });
    }
  };

  return (
    <>
      <Input.Search
        placeholder="è¾“å…¥å…³é”®å­—æŸ¥è¯¢ï¼šåˆ†ç»„åç§°"
        allowClear
        value={txt}
        onChange={(e) => setTxt(e.target.value)}
      />
      {txt}
      <DndContext modifiers={[restrictToVerticalAxis]} onDragEnd={onDragEnd}>
        <SortableContext
          // rowKey array
          items={dataSource.map((i) => i.key)}
          strategy={verticalListSortingStrategy}
        >
          <Table
            components={{
              body: {
                row: Row,
              },
            }}
            rowKey="key"
            columns={columns}
            dataSource={dataSource}
            pagination={false}
          />
        </SortableContext>
      </DndContext>
    </>
  );
};

export default App;
```

### What is expected?

åœ¨antd4é‡Œæ²¡æœ‰å‡ºç°è¯¥é—®é¢˜ï¼

### What is actually happening?

å¡é¡¿ï¼Œæµè§ˆå™¨è¿›ç¨‹å ç”¨çš„CPUç›´æ¥100%ã€‚

| Environment | Info      |
| ----------- | --------- |
| antd        | undefined |
| React       | 18        |
| System      | windows11 |
| Browser     | chorme    |

<!-- generated by ant-design-issue-helper. DO NOT REMOVE -->

## afc163

ä½ ç»™çš„ä¾‹å­è›®é¡ºæ»‘çš„ï¼Œæ²¡å‘ç°æ€§èƒ½é—®é¢˜ã€‚

## ygxw

> ä½ ç»™çš„ä¾‹å­è›®é¡ºæ»‘çš„ï¼Œæ²¡å‘ç°æ€§èƒ½é—®é¢˜ã€‚

https://codesandbox.io/s/tuo-zhuai-shou-bing-lie-antd-5-7-3-forked-466qtr?file=/demo.tsx

ä½ ä¸è¦é”®ç›˜ä¸Šä¸€ä¸ªä¸€ä¸ªè¾“å…¥ï¼Œæ•°æ®é‡ä¸å¤§çš„æ—¶å€™ï¼Œè¿™æ ·çœ‹ä¸å‡ºæ¥ã€‚
ä½ åœ¨è¾“å…¥æ¡†å†…ä¸€ç›´æŒ‰ç€ä¸€ä¸ªæŒ‰é”®å°±ä¼šå‘ç°é—®é¢˜ã€‚å¹¶ä¸”æ•°æ®é‡å¦‚æœå¾ˆå¤§ï¼Œä½ å°±æ˜¯ä¸€ä¸ªä¸€ä¸ªè¾“å…¥ä¹Ÿä¼šå¡ã€‚

## afc163

ä¸€ç›´æŒ‰ç€ä¸€ä¸ªé”®æˆ‘è¿™è¾¹å®æµ‹æ„Ÿè§‰ä¹Ÿè¿˜å¥½ã€‚

![Jul-30-2023 21-06-53](https://github.com/ant-design/ant-design/assets/507615/ca4a0676-5c50-4f7a-bee0-048e9c4988b7)

## ygxw

å¥½å§ï¼Œå¤ªå¥‡æ€ªäº†ï¼Œæˆ‘è¿™è¾¹å‡ ä¸ªåŒäº‹éƒ½è¯•äº†ï¼Œéƒ½å¡å¾—å¾ˆã€‚
æˆ‘å…ˆæŠŠè¿™ä¸ªtodoä¸€ä¸‹å§ï¼Œç°åœ¨å…¬å¸å¼€å‘è¿›åº¦å¤ªç´§äº†ï¼Œåé¢ç©ºäº†æˆ‘å†çœ‹çœ‹è¿™ä¸ªé—®é¢˜ã€‚
antdç”¨äº†2ä¸ªå¤§ç‰ˆæœ¬äº†ï¼Œä¸€ç›´è§‰å¾—å¾ˆæ£’ï¼Œå¾ˆæ”¯æŒï¼Œä¹Ÿä¸èƒ½ä¸€ç›´ç™½å«–ï¼Œä»¥åæœ‰æ—¶é—´ä¹Ÿæ„¿æ„å‚ä¸åˆ°è´¡çŒ®è€…é‡Œã€‚

## zombieJ

> å¥½å§ï¼Œå¤ªå¥‡æ€ªäº†ï¼Œæˆ‘è¿™è¾¹å‡ ä¸ªåŒäº‹éƒ½è¯•äº†ï¼Œéƒ½å¡å¾—å¾ˆã€‚

codesandbox ä¹Ÿå¡ä¹ˆï¼Ÿå¦‚æœæ˜¯æœºèƒ½é—®é¢˜ï¼Œå¯ä»¥è€ƒè™‘ç”¨ `startTransition` é™ä½æ¸²æŸ“å‹åŠ›ã€‚

## ygxw

> > å¥½å§ï¼Œå¤ªå¥‡æ€ªäº†ï¼Œæˆ‘è¿™è¾¹å‡ ä¸ªåŒäº‹éƒ½è¯•äº†ï¼Œéƒ½å¡å¾—å¾ˆã€‚
>
> codesandbox ä¹Ÿå¡ä¹ˆï¼Ÿå¦‚æœæ˜¯æœºèƒ½é—®é¢˜ï¼Œå¯ä»¥è€ƒè™‘ç”¨ `startTransition` é™ä½æ¸²æŸ“å‹åŠ›ã€‚

å¥½çš„ã€‚è°¢è°¢ã€‚
æˆ‘ä»¬éƒ½åœ¨codesandboxé‡Œæµ‹è¯•çš„ï¼Œè¿™ä¸ªåŠŸèƒ½ç°åœ¨è¿˜ä¸æ€¥ï¼Œæˆ‘åé¢æ…¢æ…¢çœ‹ä¸‹è¿™ä¸ªé—®é¢˜ã€‚ä¸ç„¶å…¶ä»–è¿›åº¦è·Ÿä¸ä¸Šäº†ã€‚

## linxianxi

å¡é¡¿åŸå› ï¼šå› ä¸º setTxt ä¸€ç›´æ”¹å˜ï¼Œå¯¼è‡´ Table ä¹Ÿè·Ÿç€ä¸€ç›´æ¸²æŸ“äº†ã€‚
è§£å†³æ–¹å¼1: å¯ä»¥ä¸ä½¿ç”¨ Input çš„å—æ§ï¼ˆä½ çš„ä¾‹å­ä¸­å« txtï¼‰ï¼Œä¸ä¼ å…¥ valueï¼Œç›´æ¥ onSearch çš„æ—¶å€™è¿›è¡ŒæŸ¥æ‰¾å³å¯ï¼Œå°±ä¸ä¼šä¸€ç›´è§¦å‘æ›´æ–°äº†ã€‚
è§£å†³æ–¹å¼2: æŠ½ç¦» Input ä¸ºç»„ä»¶ï¼Œè¿™ä¸ªç»„ä»¶è·Ÿ Table æ˜¯åŒçº§çš„äº†ï¼Œå†…éƒ¨çŠ¶æ€çš„æ”¹å˜æ¸²æŸ“ä¸ä¼šè§¦å‘ Table çš„æ¸²æŸ“ã€‚ https://codesandbox.io/s/tuo-zhuai-shou-bing-lie-antd-5-7-3-forked-cd3m8k

è¡¥å……ï¼šå¦‚æœéœ€æ±‚ä¸€å®šè¦åœ¨çˆ¶ç»„ä»¶è¿™é‡Œå®šä¹‰ input çš„ value å¹¶ä½¿ç”¨å—æ§ï¼Œå¯ä»¥è€ƒè™‘ç”¨ shouldCellUpdate æˆ– useTransition æ¥ä¼˜åŒ–æ€§èƒ½

## ygxw

> å¡é¡¿åŸå› ï¼šå› ä¸º setTxt ä¸€ç›´æ”¹å˜ï¼Œå¯¼è‡´ Table ä¹Ÿè·Ÿç€ä¸€ç›´æ¸²æŸ“äº†ã€‚ è§£å†³æ–¹å¼1: å¯ä»¥ä¸ä½¿ç”¨ Input çš„å—æ§ï¼ˆä½ çš„ä¾‹å­ä¸­å« txtï¼‰ï¼Œä¸ä¼ å…¥ valueï¼Œç›´æ¥ onSearch çš„æ—¶å€™è¿›è¡ŒæŸ¥æ‰¾å³å¯ï¼Œå°±ä¸ä¼šä¸€ç›´è§¦å‘æ›´æ–°äº†ã€‚ è§£å†³æ–¹å¼2: æŠ½ç¦» Input ä¸ºç»„ä»¶ï¼Œè¿™ä¸ªç»„ä»¶è·Ÿ Table æ˜¯åŒçº§çš„äº†ï¼Œå†…éƒ¨çŠ¶æ€çš„æ”¹å˜æ¸²æŸ“ä¸ä¼šè§¦å‘ Table çš„æ¸²æŸ“ã€‚ https://codesandbox.io/s/tuo-zhuai-shou-bing-lie-antd-5-7-3-forked-cd3m8k
>
> è¡¥å……ï¼šå¦‚æœéœ€æ±‚ä¸€å®šè¦åœ¨çˆ¶ç»„ä»¶è¿™é‡Œå®šä¹‰ input çš„ value å¹¶ä½¿ç”¨å—æ§ï¼Œå¯ä»¥è€ƒè™‘ç”¨ shouldCellUpdate æˆ– useTransition æ¥ä¼˜åŒ–æ€§èƒ½

æ”¶åˆ°ã€‚è°¢è°¢ã€‚è¿™ä¸¤ä¸ªè§£å†³æ–¹æ¡ˆå¯ä»¥ã€‚
æ‰‹åŠ¨ç‚¹èµï¼é¡ºä¾¿closeã€‚
