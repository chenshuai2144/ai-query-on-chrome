# Table性能问题：table里加入Popover会导致当前页面所有setState()卡死

`🤔 Need Reproduce`,`unconfirmed`

### Reproduction link

[![Edit on CodeSandbox](https://codesandbox.io/static/img/play-codesandbox.svg)](https://codesandbox.io/s/tuo-zhuai-shou-bing-lie-antd-5-7-3-forked-3rz22z?file=/demo.tsx)

### Steps to reproduce

如果在table的columns里的一个列里手动render一个popover，那么当table数据稍微多一点点（大概40条）就会导致当前页面所有setState()卡死。

以下是官方的实例代码，仅仅做了一小点改动。（如果卡顿不明显，只需稍微增加测试数据就能复现）。
可将下面代码直接复制到codesandbox里运行，代码里加了一个输入框，连续输入内容就能复现卡顿。

```tsx
import React, { useState } from "react";
import "./index.css";
import { MenuOutlined, EditOutlined } from "@ant-design/icons";
import type { DragEndEvent } from "@dnd-kit/core";
import { DndContext } from "@dnd-kit/core";
import { restrictToVerticalAxis } from "@dnd-kit/modifiers";
import {
  arrayMove,
  SortableContext,
  useSortable,
  verticalListSortingStrategy,
} from "@dnd-kit/sortable";
import { CSS } from "@dnd-kit/utilities";
import { Table, Input, Popover, Button } from "antd";
import type { ColumnsType } from "antd/es/table";

interface DataType {
  key: string;
  name: string;
  age: number;
  address: string;
}

const columns: ColumnsType<DataType> = [
  {
    key: "sort",
  },
  {
    title: "Name",
    dataIndex: "name",
  },
  {
    title: "Age",
    dataIndex: "age",
  },
  {
    title: "Address",
    dataIndex: "address",
  },
  {
    title: "",
    dataIndex: "option",
    width: 70,
    render: (text: any, record: any, index: any) => [
      <div key="op">
        <Popover
          content={
            <div>
              <div>
                <Input
                  placeholder="请输入分组名称"
                  autoFocus
                  defaultValue={record.group_name}
                  id={`txt_group_${record.id}`}
                />
              </div>
              <div>
                <Button type="primary">提交</Button>
              </div>
            </div>
          }
          title={false}
          trigger="click"
        >
          <EditOutlined
            onClick={(e: any) => {
              e.stopPropagation();
              e.preventDefault();
            }}
          />
        </Popover>
      </div>,
    ],
  },
];

interface RowProps extends React.HTMLAttributes<HTMLTableRowElement> {
  "data-row-key": string;
}

const Row = ({ children, ...props }: RowProps) => {
  const {
    attributes,
    listeners,
    setNodeRef,
    setActivatorNodeRef,
    transform,
    transition,
    isDragging,
  } = useSortable({
    id: props["data-row-key"],
  });

  const style: React.CSSProperties = {
    ...props.style,
    transform: CSS.Transform.toString(transform && { ...transform, scaleY: 1 }),
    transition,
    ...(isDragging ? { position: "relative", zIndex: 9999 } : {}),
  };

  return (
    <tr {...props} ref={setNodeRef} style={style} {...attributes}>
      {React.Children.map(children, (child) => {
        if ((child as React.ReactElement).key === "sort") {
          return React.cloneElement(child as React.ReactElement, {
            children: (
              <MenuOutlined
                ref={setActivatorNodeRef}
                style={{ touchAction: "none", cursor: "move" }}
                {...listeners}
              />
            ),
          });
        }
        return child;
      })}
    </tr>
  );
};

const App: React.FC = () => {
  const [dataSource, setDataSource] = useState([
    {
      key: "1",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "2",
      name: "Jim Green",
      age: 42,
      address: "London No. 1 Lake Park",
    },
    {
      key: "3",
      name: "Joe Black",
      age: 32,
      address: "Sidney No. 1 Lake Park",
    },
    {
      key: "4",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "5",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "6",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "7",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "8",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "9",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "10",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "11",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "12",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "13",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "14",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "15",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "16",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "17",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "18",
      name: "John Brown",
      age: 33,
      address: "normal text",
    },
    {
      key: "18",
      name: "John Brown",
      age: 33,
      address: "normal text",
    },
    {
      key: "18",
      name: "John Brown",
      age: 33,
      address: "normal text",
    },
    {
      key: "18",
      name: "John Brown",
      age: 33,
      address: "normal text",
    },
    {
      key: "18",
      name: "John Brown",
      age: 33,
      address: "normal text",
    },
    {
      key: "18",
      name: "John Brown",
      age: 33,
      address: "normal text",
    },
    {
      key: "18",
      name: "John Brown",
      age: 33,
      address: "normal text",
    },
    {
      key: "18",
      name: "John Brown",
      age: 33,
      address: "normal text",
    },
    {
      key: "18",
      name: "John Brown",
      age: 33,
      address: "normal text",
    },
    {
      key: "18",
      name: "John Brown",
      age: 33,
      address: "normal text",
    },
    {
      key: "18",
      name: "John Brown",
      age: 33,
      address: "normal text",
    },
    {
      key: "18",
      name: "John Brown",
      age: 33,
      address: "normal text",
    },
    {
      key: "1",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "2",
      name: "Jim Green",
      age: 42,
      address: "London No. 1 Lake Park",
    },
    {
      key: "3",
      name: "Joe Black",
      age: 32,
      address: "Sidney No. 1 Lake Park",
    },
    {
      key: "4",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "5",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "6",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "7",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "8",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "9",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "10",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "11",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "12",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "13",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "14",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "15",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
    {
      key: "16",
      name: "John Brown",
      age: 32,
      address: "normal text",
    },
  ]);
  const [txt, setTxt] = useState();

  const onDragEnd = ({ active, over }: DragEndEvent) => {
    if (active.id !== over?.id) {
      setDataSource((previous) => {
        const activeIndex = previous.findIndex((i) => i.key === active.id);
        const overIndex = previous.findIndex((i) => i.key === over?.id);
        return arrayMove(previous, activeIndex, overIndex);
      });
    }
  };

  return (
    <>
      <Input.Search
        placeholder="输入关键字查询：分组名称"
        allowClear
        value={txt}
        onChange={(e) => setTxt(e.target.value)}
      />
      {txt}
      <DndContext modifiers={[restrictToVerticalAxis]} onDragEnd={onDragEnd}>
        <SortableContext
          // rowKey array
          items={dataSource.map((i) => i.key)}
          strategy={verticalListSortingStrategy}
        >
          <Table
            components={{
              body: {
                row: Row,
              },
            }}
            rowKey="key"
            columns={columns}
            dataSource={dataSource}
            pagination={false}
          />
        </SortableContext>
      </DndContext>
    </>
  );
};

export default App;
```

### What is expected?

在antd4里没有出现该问题！

### What is actually happening?

卡顿，浏览器进程占用的CPU直接100%。

| Environment | Info      |
| ----------- | --------- |
| antd        | undefined |
| React       | 18        |
| System      | windows11 |
| Browser     | chorme    |

<!-- generated by ant-design-issue-helper. DO NOT REMOVE -->

## afc163

你给的例子蛮顺滑的，没发现性能问题。

## ygxw

> 你给的例子蛮顺滑的，没发现性能问题。

https://codesandbox.io/s/tuo-zhuai-shou-bing-lie-antd-5-7-3-forked-466qtr?file=/demo.tsx

你不要键盘上一个一个输入，数据量不大的时候，这样看不出来。
你在输入框内一直按着一个按键就会发现问题。并且数据量如果很大，你就是一个一个输入也会卡。

## afc163

一直按着一个键我这边实测感觉也还好。

![Jul-30-2023 21-06-53](https://github.com/ant-design/ant-design/assets/507615/ca4a0676-5c50-4f7a-bee0-048e9c4988b7)

## ygxw

好吧，太奇怪了，我这边几个同事都试了，都卡得很。
我先把这个todo一下吧，现在公司开发进度太紧了，后面空了我再看看这个问题。
antd用了2个大版本了，一直觉得很棒，很支持，也不能一直白嫖，以后有时间也愿意参与到贡献者里。

## zombieJ

> 好吧，太奇怪了，我这边几个同事都试了，都卡得很。

codesandbox 也卡么？如果是机能问题，可以考虑用 `startTransition` 降低渲染压力。

## ygxw

> > 好吧，太奇怪了，我这边几个同事都试了，都卡得很。
>
> codesandbox 也卡么？如果是机能问题，可以考虑用 `startTransition` 降低渲染压力。

好的。谢谢。
我们都在codesandbox里测试的，这个功能现在还不急，我后面慢慢看下这个问题。不然其他进度跟不上了。

## linxianxi

卡顿原因：因为 setTxt 一直改变，导致 Table 也跟着一直渲染了。
解决方式1: 可以不使用 Input 的受控（你的例子中叫 txt），不传入 value，直接 onSearch 的时候进行查找即可，就不会一直触发更新了。
解决方式2: 抽离 Input 为组件，这个组件跟 Table 是同级的了，内部状态的改变渲染不会触发 Table 的渲染。 https://codesandbox.io/s/tuo-zhuai-shou-bing-lie-antd-5-7-3-forked-cd3m8k

补充：如果需求一定要在父组件这里定义 input 的 value 并使用受控，可以考虑用 shouldCellUpdate 或 useTransition 来优化性能

## ygxw

> 卡顿原因：因为 setTxt 一直改变，导致 Table 也跟着一直渲染了。 解决方式1: 可以不使用 Input 的受控（你的例子中叫 txt），不传入 value，直接 onSearch 的时候进行查找即可，就不会一直触发更新了。 解决方式2: 抽离 Input 为组件，这个组件跟 Table 是同级的了，内部状态的改变渲染不会触发 Table 的渲染。 https://codesandbox.io/s/tuo-zhuai-shou-bing-lie-antd-5-7-3-forked-cd3m8k
>
> 补充：如果需求一定要在父组件这里定义 input 的 value 并使用受控，可以考虑用 shouldCellUpdate 或 useTransition 来优化性能

收到。谢谢。这两个解决方案可以。
手动点赞！顺便close。
