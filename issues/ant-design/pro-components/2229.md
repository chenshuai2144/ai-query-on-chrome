# 👑 [需求]ProTable 查询表格支持小齿轮配置筛选项，功能同表格操作小齿轮

`table`,`🎖️  featrue`,`AI Reply`

### 🥰 需求描述

高级表格带查询功能，希望增加小齿轮操作，能够配置搜索栏的搜索项。

![image](https://user-images.githubusercontent.com/33017970/111582617-0f1a0480-87f6-11eb-90b8-83ca94754528.png)

### 🧐 解决方案

### 🚑 其他信息

## chenshuai2144

> TAutomatically replying with ChatGPT can be attempted, but it cannot be guaranteed to be completely accurate and may not fully address all issues. Please feel free to reply if you have any further questions or concerns.
> 此回复基于 ChatGPT 自动生成，可以尝试下方案，官方人员会在一定时间后继续继续处理。

解决方案：

在 ProTable 中增加搜索列的配置项，使用户在点击小齿轮时可以设置搜索栏中的筛选条件。具体实现方法如下：

1. 在 ProTable 的 columns 中增加表头配置项 `search`，用于控制是否在小齿轮中显示该列筛选项。

```
columns: [
    {
        title: '姓名',
        dataIndex: 'name',
        search: true, // 增加 search 属性
    },
    ...
]
```

2. 给 ProTable 增加 `toolBarRender` 属性，用于自定义表格工具栏。

```
const renderSearchBar = (
    searchConfig: ProColumnType[]
): ((props: any, ref: any) => any) => {
    return (props: any, ref: any) => {
        const { onChange, onSubmit, values, collapse } = useCollapse(
            ...searchConfig
        );
        return (
            <QueryFilter
                onChange={onChange}
                onSubmit={onSubmit}
                values={values}
                collapse={collapse}
                placeholder="请输入关键字搜索"
            />
        );
    };
};

<ProTable
    ...,
    toolBarRender={(_, { searchConfig }) => [
        <Button
            key="search"
            type="text"
            icon={<SearchOutlined />}
            onClick={() => {
                setSearchDrawerVisible(true);
            }}
        >
            搜索
        </Button>,
        <Drawer
            key="drawer"
            visible={searchDrawerVisible}
            onClose={() => {
                setSearchDrawerVisible(false);
            }}
            width={360}
        >
            {renderSearchBar(searchConfig)}
        </Drawer>,
    ]}
/>
```

3. 在 `toolBarRender` 中，在点击搜索按钮时弹出一个抽屉，将 `searchConfig` 传入自定义的搜索组件中，根据 `search` 属性来决定是否显示该项。

```
const useCollapse = (...configs: ProColumnType[]) => {
    const [form] = Form.useForm();
    const [collapse, setCollapse] = useState<boolean>(true);
    const [values, setValues] = useState<any>({});

    const onChange = async () => {
        const values = await form.validateFields();
        setValues(values);
    };

    const resetFields = () => {
        form.resetFields();
    };

    const onSubmit = () => {
        onChange().then(() => {
            setCollapse(false);
        });
    };

    const searchConfig = configs.filter((config) => config.search);

    return {
        form,
        collapse,
        values,
        resetFields,
        onSubmit,
        onChange,
        searchConfig,
    };
};
```

4. 在搜索组件中根据 `searchConfig` 遍历筛选项，根据数据类型来渲染相应的表单组件，最终返回一个筛选表单。

```
const QueryFilter = (props: any) => {
    const { searchConfig } = props;

    return (
        <div className="query-filter">
            <Form form={props.form}>
                {searchConfig.map((config) => {
                    const { dataIndex, title, valueType } = config;
                    const key = dataIndex || title;
                    const type = valueType || 'text';

                    return (
                        <Form.Item key={key} label={title} name={key}>
                            {type === 'text' && <Input placeholder="请输入" />}
                            {type === 'select' && (
                                <Select placeholder="请选择">
                                    {config.valueEnum &&
                                        Object.keys(
                                            config.valueEnum
                                        ).map((value, index) => {
                                            return (
                                                <Select.Option
                                                    key={index}
                                                    value={value}
                                                >
                                                    {config.valueEnum[
                                                        value
                                                    ]}
                                                </Select.Option>
                                            );
                                        })}
                                </Select>
                            )}
                            {type === 'date' && (
                                <DatePicker placeholder="请选择" />
                            )}
                        </Form.Item>
                    );
                })}
            </Form>
            <div className="search-btn-group">
                <Button onClick={() => props.resetFields()}>重置</Button>
                <Button type="primary" onClick={() => props.onSubmit()}>
                    查询
                </Button>
            </div>
        </div>
    );
};
```

最终效果如下图所示：

![示例图](https://user-images.githubusercontent.com/33017970/111891999-5e5a6d80-8a45-11eb-9311-9d9d830988d2.png)

参考文档：

1. [Ant Design ProTable 高级表格开发教程](https://procomponents.ant.design/components/table-cn/)
2. [reactive-pro-table 的实现思路](https://zhuanlan.zhihu.com/p/323332987)
