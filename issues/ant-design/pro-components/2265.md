# 🐛[BUG] ProTable & EditableProTable 树形结构下编辑顶层数据重新reload()以后，如果数据顺序变更会导致Table 数据重复

`AI Reply`

### 🐛 bug

    ProTable 和 EditableProTable 组件，数据（10条）为树形结构， 编辑一级数据（最顶层的数据）成功后 tableRef.current.cancelEditable(key)  &  reloadAndRest()，此时如果接口返回数据（10条）顺序发生变更。则编辑的行会留在Table内，reload 出的新数据也会留在Table内，导致一个Table内出现 2行 一样的数据（共计11条数据）。

### 📷 复现步骤

1、树形结构的数据以及Table
2、编辑一级数据，即Table最顶层的数据。
3、编辑成功后，cancelEditable(key) & reloadAndRest() 接口返回的新数据顺序变更。

### 🏞 期望结果

重新reloadAndRest() 以后，编辑的行，不应该再出现在Table中，而是由新数据全部重新渲染覆盖。

### © 版本信息

- @ant-design/pro-table@2.30.6
- umi 版本
- Chrome
- win 10

## chenshuai2144

> TAutomatically replying with ChatGPT can be attempted, but it cannot be guaranteed to be completely accurate and may not fully address all issues. Please feel free to reply if you have any further questions or concerns.
> 此回复基于 ChatGPT 自动生成，可以尝试下方案，官方人员会在一定时间后继续继续处理。

### 💡 解决方案

根据描述，可以尝试先清空 Table 内已拥有的数据，再通过 reloadAndRest() 重新加载数据。

具体操作如下：

1. 在 Table 组件中，使用 rowKey 属性指定唯一标识符：
   ```
   <ProTable rowKey="id" ... />
   ```
2. 编辑成功后，先通过 `tableRef.current.clearSelectedAndRest()` 清空 Table 内已选择的数据，并重置状态。
3. 再通过 `tableRef.current.clear()’` 清空 Table 内已渲染的数据。

4. 最后调用 `tableRef.current.reloadAndRest()` 重新加载数据。

代码示例：

```
const tableRef = useRef();

<ProTable
  rowKey="id"
  ... //其他属性省略
  editable={{
    editableKeys,
    onSave: async (key, row) => {
      try {
        await saveRow(key, row);
        message.success('保存成功');
        tableRef.current.cancelEditable(key);
        tableRef.current.clearSelectedAndRest();
        tableRef.current.clear(); //清空已渲染数据
        tableRef.current.reloadAndRest();
      } catch (err) {
        message.error('保存失败');
      }
    },
  }}
  tableRef={tableRef}
/>
```

### 📚 参考文档

- [ProTable API - tableRef](https://protable.ant.design/api#tableref)

## chenshuai2144

一般都是key重复导致的
