# 🧐[BUG]ProFrom套EditableProTable如何进行表单验证

`table`,`📕 docs`,`AI Reply`

### 🧐 问题描述

我现在的代码只能做到非EditableProTable的表单验证，虽然我在EditableProTable上加了rules规则，但是点击submit提交的时候只能验证非EditableProTable的表单。EditableProTable表单的值只有在输入的时候能进行验证，focus后submit就无法验证，想请教下如何进行联动验证，我尝试过在EditableProTable加form，如果ProForm和EditableProTable都加from会有问题，如果只在EditableProTable上加from又会对FroFrom无法验证。 求解

### 💻 示例代码

```
import ProCard from '@ant-design/pro-card';
import { PageContainer } from '@ant-design/pro-layout';
import ProForm, { ProFormDigit, ProFormText } from '@ant-design/pro-form';
import { Form } from 'antd';
import React, { useState } from 'react';
import { EditableProTable, ProColumns } from '@ant-design/pro-table';
import FormFooter from '@/components/FormFooter';
import { errorMsg } from '@/utils/tool';
import '@/style/goods/parameter.less';

type DataSourceType = {
  id: React.Key;
  name?: string;
  value?: string;
};

const columns: ProColumns<DataSourceType>[] = [
  {
    title: '参数名称',
    dataIndex: 'name',
    width: '30%',
    formItemProps: {
      rules: [
        {
          required: true,
          message: '请填写参数名称'
        }
      ]
    },
    fieldProps: {
      allowClear: false
    }
  },
  {
    title: '参数值',
    dataIndex: 'value',
    formItemProps: {
      rules: [
        {
          required: true,
          message: '请填写参数值'
        }
      ]
    },
    fieldProps: {
      allowClear: false
    }
  },
  {
    title: '操作',
    width: 60,
    valueType: 'option'
  }
];

const Page = () => {
  const [useForm] = Form.useForm();
  const [paramsPreview, setParamsPreview] = useState<DataSourceType[]>([
    {
      id: 1,
      name: '',
      value: '这个活动真好玩'
    },
  ]);
  const [editableKeys, setEditableRowKeys] = useState<React.Key[]>(() =>
    paramsPreview.map((item) => item.id)
  );

  return (
    <PageContainer title={false} breadcrumbRender={false}>
      <ProCard style={{ background: '#f0f2f5' }} gutter={[16, 16]} bodyStyle={{ padding: 0 }}>
        <ProCard
          bordered
          headerBordered
          colSpan={{
            xl: '55%'
          }}
          title='添加商品参数'
          style={{ height: '100%' }}
        >
          <ProForm
            layout='horizontal'
            form={useForm}
            labelCol={{ span: 4 }}
            // wrapperCol={{ span: 20 }}
            // request={async () => {
            //   return { ...data };
            // }}
            onValuesChange={(values) => {
              if (values.params !== undefined) {
                setParamsPreview(values.params);
              }
            }}
            onFinishFailed={() => {
              errorMsg('表单验证失败');
            }}
            onFinish={async (values) => {
              console.log(values);
            }}
            // submitter={false}
          >
            <ProFormDigit name='id' hidden />
            <ProFormText width='md' name='name' label='商品参数名称' rules={[
              {
                required: true,
                message: '请填写商品参数名称'
              }]
            } />
            <ProForm.Item
              label='参数列表数据'
              name='params'
              initialValue={paramsPreview}
              trigger='onValuesChange'
            >
              <EditableProTable<DataSourceType>
                rowKey='id'
                cardProps={{ bodyStyle: { padding: 0, margin: 0 } }}
                toolBarRender={false}
                columns={columns}
                recordCreatorProps={{
                  newRecordType: 'dataSource',
                  position: 'top',
                  creatorButtonText: '添加商品参数',
                  record: () => ({
                    id: Date.now()
                  })
                }}
                editable={{
                  type: 'multiple',
                  editableKeys,
                  onChange: setEditableRowKeys,
                  actionRender: (row, _, dom) => {
                    return [dom.delete];
                  }
                }}
              />
            </ProForm.Item>

            <FormFooter form={useForm} />
          </ProForm>
        </ProCard>
        <ProCard bordered headerBordered title='商品参数预览' style={{ height: '100%' }}>
          {paramsPreview.map((item: DataSourceType, index) => {
            return (
              <div className='table-form-item' key={index}>
                <label className='table-form-item__label' style={{ width: 120 }}>{item.name}</label>
                <div className='table-form-item__content' style={{ marginLeft: 120 }}>{item.value}</div>
              </div>
            );
          })}
        </ProCard>
      </ProCard>
    </PageContainer>
  );
};

export default Page;
```

### 🚑 其他信息

![image](https://user-images.githubusercontent.com/12706830/133362508-ed764aed-fa5c-4155-a23d-fb6ff261ceed.png)

## submit只能对ProForm验证

![image](https://user-images.githubusercontent.com/12706830/133362558-5d467097-d76f-4b58-8304-371d61b09dde.png)

## 只有在change的时候会有验证

## chenshuai2144

https://procomponents.ant.design/components/editable-table#%E4%B8%8E-formitem-%E9%85%8D%E5%90%88

试试这个模式，给 编辑表格配置个 name

## codedart2018

> https://procomponents.ant.design/components/editable-table#%E4%B8%8E-formitem-%E9%85%8D%E5%90%88
>
> 试试这个模式，给 编辑表格配置个 name

加了也没有用的。验证不了，我把代码拷贝出来和在codesanbox上都试了不行的，这个应该算是一个bug吧。你们自己可以套一下Proform验证试下

```
import ProCard from '@ant-design/pro-card';
import { PageContainer } from '@ant-design/pro-layout';
import ProForm, { ProFormDigit, ProFormInstance, ProFormText } from '@ant-design/pro-form';
import React, { useRef, useState } from 'react';
import { EditableProTable, ProColumns } from '@ant-design/pro-table';
import { errorMsg } from '@/utils/tool';
import '@/style/goods/parameter.less';

type DataSourceType = {
  id: React.Key;
  title?: string;
  decs?: string;
  children?: DataSourceType[];
};

const defaultData: DataSourceType[] = [
  {
    id: '624748504',
    title: '活动名称一',
    decs: '这个活动真好玩'
  },
  {
    id: '624691229',
    title: '活动名称二',
    decs: '这个活动真好玩'
  }
];

const Page = () => {
  const [editableKeys, setEditableRowKeys] = useState<React.Key[]>(() =>
    defaultData.map((item) => item.id)
  );
  const [paramsPreview, setParamsPreview] = useState<DataSourceType[]>([]);
  const formRef = useRef<ProFormInstance<any>>();
  const columns: ProColumns<DataSourceType>[] = [
    {
      title: '活动名称',
      dataIndex: 'title',
      formItemProps: {
        rules: [
          {
            required: true,
            message: '此项是必填项'
          }
        ]
      },
      width: '30%'
    },
    {
      title: '描述',
      dataIndex: 'decs',
      formItemProps: {
        rules: [
          {
            required: true,
            message: '此项是必填项'
          }
        ]
      }
    },
    {
      title: '操作',
      valueType: 'option',
      width: 60
    }
  ];

  return (
    <PageContainer title={false} breadcrumbRender={false}>
      <ProCard style={{ background: '#f0f2f5' }} gutter={[16, 16]} bodyStyle={{ padding: 0 }}>
        <ProCard
          bordered
          headerBordered
          colSpan={{
            xl: '55%'
          }}
          title='添加商品参数'
          style={{ height: '100%' }}
        >
          <ProForm<{
            params: DataSourceType[];
          }>
            layout='horizontal'
            labelCol={{ span: 4 }}
            formRef={formRef}
            initialValues={{
              params: defaultData
            }}
            onFinishFailed={() => {
              errorMsg('表单验证失败');
            }}
            onFinish={async (values) => {
              console.log(values);
            }}
          >
            <ProFormDigit name='id' hidden />
            <ProFormText width='md' name='name' label='商品参数名称' rules={[
              {
                required: true,
                message: '请填写商品参数名称'
              }]
            } />
            <ProForm.Item label='参数列表数据'>
              <EditableProTable<DataSourceType>
                rowKey='id'
                maxLength={5}
                name='params'
                recordCreatorProps={{
                  newRecordType: 'dataSource',
                  position: 'top',
                  creatorButtonText: '添加商品参数',
                  record: () => ({
                    id: Date.now()
                  })
                }}
                columns={columns}
                editable={{
                  type: 'multiple',
                  editableKeys,
                  onChange: setEditableRowKeys,
                  actionRender: (row, _, dom) => {
                    return [dom.delete];
                  }
                }}
              />
            </ProForm.Item>
          </ProForm>
        </ProCard>
        <ProCard bordered headerBordered title='商品参数预览' style={{ height: '100%' }}>
          {paramsPreview.map((item: DataSourceType, index) => {
            return (
              <div className='table-form-item' key={index}>
                <label className='table-form-item__label' style={{ width: 120 }}>{item.name}</label>
                <div className='table-form-item__content' style={{ marginLeft: 120 }}>{item.value}</div>
              </div>
            );
          })}
        </ProCard>
      </ProCard>
    </PageContainer>
  );
};

export default Page;

```

![image](https://user-images.githubusercontent.com/12706830/133366598-c3f3d761-b29b-4744-b6d1-61e0d5fabdbd.png)

### 也就是说表格验证不了，onFinish就出结果了。正常是验证没有通过有阻塞，onFinish是不能打印的。

## puchunjie

这个只能在EditableProTable 上配置form实例，然后通过这个实例手动去触发表单检验

## leshalv

该怎么改，还是说这是个BUG？

## conviva-zyang

有什么解决方案吗？

## chenzhizhen

refer to #2210

## LoveEocding

解决方案： 使用Form.item rules 自定义事件验证，触发可编辑表格实例的验证。验证可行
![image](https://user-images.githubusercontent.com/29218661/147633450-f6270979-d8f0-47d8-abd3-889560f2ee1b.png)

## conviva-zyang

我是这么解决的，大家可以试试。我尝试给EditableProTable 加了editable={{ form: form }} form 来自useForm()， 在proForm submit的时候调用form.validateFields().

## Tinyuen

ProForm 还好，但是 ProForm 中有 ProFormList， ProFormList 中嵌套了 EditableProTable 怎么验证，愁死了......

## chenshuai2144

<ProForm.Item label='参数列表数据'> 在这里自己手写规则吧
