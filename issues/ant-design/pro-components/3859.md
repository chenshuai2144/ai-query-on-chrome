# ğŸ›[BUG] Pro-Table renderFormItem åœ¨ç‚¹å‡»é‡ç½®çš„æ—¶å€™é‡æ–°æ¸²æŸ“æœ‰é—®é¢˜

`â­•ï¸   bug`,`table`,`AI Reply`

### ğŸ› bug æè¿°

åœ¨ä½¿ç”¨ renderFormItem è‡ªå®šä¹‰è¡¨å•çš„æ—¶å€™ï¼ŒæœŸæœ›æ˜¯`campaign`è¿™ä¸ªè¡¨å•é¡¹æ ¹æ® `keyAccount`çš„æ˜¯å¦æœ‰å€¼åŠ¨æ€æ¸²æŸ“ï¼Œä½†åœ¨ä¸¤è€…è¡¨å•éƒ½æ¸²æŸ“å‡ºæ¥åç‚¹å‡»é‡ç½®æŒ‰é’®ï¼Œè¡¨å•å€¼æœ‰é‡ç½®åˆ°é»˜è®¤å€¼ï¼Œä½†`campaign`çš„è¡¨å•é¡¹æ²¡æœ‰å®Œå…¨æ¶ˆå¤±ï¼Œè€Œæ˜¯ç•™ä¸‹äº†ä¸€ä¸ªå• Label

### ğŸ“· å¤ç°æ­¥éª¤

1. å¡«å……é¡¹ç›®è¡¨å•å€¼ï¼ŒCampaignè¡¨å•é¡¹æ˜¾ç¤ºï¼Œå¡«å……Campaignè¡¨å•é¡¹å€¼
2. ç‚¹å‡»é‡ç½®æŒ‰é’®
3. è¡¨å•é‡ç½®ï¼Œä½†Campaignè¡¨å•é¡¹æœªå®Œå…¨æ¶ˆå¤±

### ğŸ æœŸæœ›ç»“æœ

Campaignè¡¨å•é¡¹å®Œå…¨æ¶ˆå¤±

### ğŸ’» å¤ç°ä»£ç 

```
const columns = [{
      title: CampaignMenu.Campaign,
      dataIndex: 'campaign',
      formItemProps: {
        preserve: false,
        shouldUpdate: true,
      },
      search: {
        transform: v => ({ campaignId: v.value }),
      },
      renderFormItem: ({ fieldProps }, _, form) => {
        const keyAccount = form.getFieldValue('keyAccount')
        if (!keyAccount) return null
        return (
          <RemoteSelect
            postData={{ keyAccountId: keyAccount.value }}
            url="/campaign/page"
            deps={[keyAccount.value]}
            {...fieldProps}
          />
        )
      },
      fieldProps: {
        placeholder: t('global.form.select', { name: CampaignMenu.Campaign }),
      },]
```

### Â© ç‰ˆæœ¬ä¿¡æ¯

```
"@ant-design/pro-form": "^1.40.0",
   "@ant-design/pro-layout": "^6.25.0",
   "@ant-design/pro-table": "^2.56.2",
"antd": "^4.17.0-alpha.2",Ã
```

### ğŸš‘ å…¶ä»–ä¿¡æ¯

å®æµ‹ä¸ä½¿ç”¨è‡ªå®šä¹‰ç»„ä»¶ï¼Œåªè¿”å›defaultRenderæˆ–false, ä¹Ÿä¼šæœ‰æ¬¡æƒ…å†µ

![image](https://user-images.githubusercontent.com/27920863/137880998-87255b61-6ebf-4cbe-b6c2-88c81cb025f3.png)

## luotongzhou

é™¤éè§¦å‘ form è¡¨å•çš„ onValuesChange äº‹ä»¶ï¼ŒCampaignè¡¨å•é¡¹æ‰ä¼šæŒ‰ç…§é¢„æœŸæ¶ˆå¤±ï¼Œä½†å¦‚ä½•è§¦å‘å‘¢ï¼Ÿform.setFeildsValue ä¸èƒ½è§¦å‘ onValuesChange äº‹ä»¶

## luotongzhou

é€šè¿‡ç¿»é˜…`SchemaForm`æºç å‘ç°ï¼ŒrenderFormItem æ˜¯ä¼šæ¯æ¬¡é‡æ–°æ¸²æŸ“çš„ï¼Œä½†æ˜¯

```
const domList = useMemo(() => {
    return genItems(columns, updateTime);
  }, [columns, genItems, updateTime]);
```

domList å¹¶æ²¡æœ‰é‡æ–°æ¸²æŸ“ï¼Œå› ä¸º

```
<Form
      formRef={formRef}
      form={form}
      {...rest}
      onInit={(...restValue) => {
        if (needRealUpdate) {
          updateFormRender(updateTime + 1);
        }
        rest?.onInit?.(...restValue);
      }}
      onValuesChange={(...restValue) => {
        if (needRealUpdate) {
          updateFormRender(updateTime + 1);
        }
        rest?.onValuesChange?.(...restValue);
      }}
    >
      {domList}
    </Form>
```

å¯ä»¥çœ‹åˆ°åŸºæœ¬ä¸Šåªæœ‰`onValuesChange`æ‰ä¼šé‡æ–°æ¸²æŸ“è¡¨å•ï¼Œè¿™ä¸ªæ—¶å€™æ‰ä¼šåˆ æ‰ ç•™ä¸‹çš„ Label
ç›¸å½“äºvaluesChangeçš„æ—¶å€™ forceUpdateäº†ä¸€æ¬¡ï¼Œä½†æ˜¯æ²¡æœ‰å…¶ä»–åŠæ³•ä»å¤–éƒ¨ forceUpdate

## luotongzhou

æ›´æ–°ï¼š
å› ä¸ºæˆ‘åœ¨ä»£ç é‡Œç”¨useMemoåŒ…è£¹äº† column é¡¹ï¼Œå¯¼è‡´ä¼ é€’åˆ° protable é‡Œ column ä¸€ç›´æ²¡æœ‰å˜åŒ–ï¼Œdomlist æ›´æ–°ä¹Ÿæ˜¯ä¾èµ– column çš„, æ‰€æœ‰æˆ‘åœ¨è‡ªå·±ä»£ç é‡Œç»´æŠ¤ä¸€ä¸ª updateNumber çš„ state å¹¶è®© useMemo ä¾èµ–å®ƒï¼Œåœ¨è¡¨å•çš„ reset çš„æ—¶å€™å»æ›´æ–° updateNumber æ¥èµ·åˆ° forceUpdate çš„ä½œç”¨

## chenshuai2144

åº”è¯¥ä¿®å¤æ‰äº†ï¼Œä½ å†è¯•è¯•ï¼Œæˆ‘ä»¬é‡å†™äº†è¿™ä¸ªæ¸²æŸ“å™¨

## luotongzhou

æ„Ÿè°¢è¿˜åœ¨å…³æ³¨è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘æ›´æ–°äº†åˆ°äº†æœ€æ–°ç‰ˆï¼Œä½†æœ‰ç§æƒ…å†µè¿™ä¸ªBUGè¿˜æ˜¯ä¼šå¤ç°ï¼Œå°±æ˜¯pro-table è‡ªå¸¦è¡¨å•searchçš„é‡ç½®æŒ‰é’®, ä¾ç„¶ä¼šå¯¹renderFormItem return ä¸ºnull çš„è¡¨å•é¡¹ç•™ä¸‹ä¸€ä¸ªç©ºç™½label
æˆ‘ä¹Ÿæ‰¾åˆ°äº†ä¿®å¤è¿™ä¸ªé—®é¢˜çš„commit è®°å½•ï¼Œç¡®å®æ²¡æœ‰å¯¹é‡ç½®æŒ‰é’®ç‚¹å‡»é‚£å—æœ‰ä»£ç ä¿®æ”¹ã€‚å°†å®˜ç½‘ä¾‹å­é‡Œçš„æœç´¢è¡¨å•è‡ªå®šä¹‰é‚£é‡Œçš„ä¾‹å­æ”¹ä¸€ä¸‹å°±å¯ä»¥å¤ç°ï¼Œcolumnsçš„å€¼æ”¹ä¸ºå¦‚ä¸‹

```
{
      title: 'çŠ¶æ€',
      dataIndex: 'state',
      valueType: 'select',
      request: async () => [
        {
          label: 'æœˆä»½',
          value: 1,
        },
        {
          label: 'å‘¨',
          value: 2,
        },
        {
          label: 'è‡ªå®šä¹‰',
          value: 3,
        },
        {
          label: 'ä¸å±•ç¤º',
          value: 4,
        },
      ],
    },
    {
      title: 'åŠ¨æ€è¡¨å•',
      key: 'direction',
      hideInTable: true,
      dataIndex: 'direction',
      renderFormItem: (item, { type, defaultRender, ...rest }, form) => {
        const stateType = form.getFieldValue('state');
        if (!stateType) {
          return null;
        }
        return (
          <MySelect
            {...rest}
            state={{
              type: stateType,
            }}
          />
        );
      },
    },
```

## yzwxk

> æ„Ÿè°¢è¿˜åœ¨å…³æ³¨è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘æ›´æ–°äº†åˆ°äº†æœ€æ–°ç‰ˆï¼Œä½†æœ‰ç§æƒ…å†µè¿™ä¸ªBUGè¿˜æ˜¯ä¼šå¤ç°ï¼Œå°±æ˜¯pro-table è‡ªå¸¦è¡¨å•searchçš„é‡ç½®æŒ‰é’®, ä¾ç„¶ä¼šå¯¹renderFormItem return ä¸ºnull çš„è¡¨å•é¡¹ç•™ä¸‹ä¸€ä¸ªç©ºç™½label æˆ‘ä¹Ÿæ‰¾åˆ°äº†ä¿®å¤è¿™ä¸ªé—®é¢˜çš„commit è®°å½•ï¼Œç¡®å®æ²¡æœ‰å¯¹é‡ç½®æŒ‰é’®ç‚¹å‡»é‚£å—æœ‰ä»£ç ä¿®æ”¹ã€‚å°†å®˜ç½‘ä¾‹å­é‡Œçš„æœç´¢è¡¨å•è‡ªå®šä¹‰é‚£é‡Œçš„ä¾‹å­æ”¹ä¸€ä¸‹å°±å¯ä»¥å¤ç°ï¼Œcolumnsçš„å€¼æ”¹ä¸ºå¦‚ä¸‹
>
> ```
> {
>       title: 'çŠ¶æ€',
>       dataIndex: 'state',
>       valueType: 'select',
>       request: async () => [
>         {
>           label: 'æœˆä»½',
>           value: 1,
>         },
>         {
>           label: 'å‘¨',
>           value: 2,
>         },
>         {
>           label: 'è‡ªå®šä¹‰',
>           value: 3,
>         },
>         {
>           label: 'ä¸å±•ç¤º',
>           value: 4,
>         },
>       ],
>     },
>     {
>       title: 'åŠ¨æ€è¡¨å•',
>       key: 'direction',
>       hideInTable: true,
>       dataIndex: 'direction',
>       renderFormItem: (item, { type, defaultRender, ...rest }, form) => {
>         const stateType = form.getFieldValue('state');
>         if (!stateType) {
>           return null;
>         }
>         return (
>           <MySelect
>             {...rest}
>             state={{
>               type: stateType,
>             }}
>           />
>         );
>       },
>     },
> ```

è¯•äº†ä¸‹2.68.3 æ˜¯å¯ä»¥æ­£å¸¸å·¥ä½œçš„ã€‚https://codesandbox.io/s/cha-xun-biao-ge-forked-r6nomp?file=/App.tsx

## luotongzhou

> @yzwxk

è¿˜æ˜¯å­˜åœ¨çš„ï¼Œä½ ç”¨æˆ‘ä¸Šé¢è´´çš„ columnsï¼Œä¿®æ”¹å€¼è®©åŠ¨æ€è¡¨å•æ˜¾ç¤ºåç‚¹é‡ç½®æŒ‰é’®å°±èƒ½å¤ç°

## lovewinders

æˆ‘ä¹Ÿç¢°åˆ°ç‚¹å‡»é‡ç½®åï¼Œlabelè¿˜åœ¨é—®é¢˜

## lovewinders

> åº”è¯¥ä¿®å¤æ‰äº†ï¼Œä½ å†è¯•è¯•ï¼Œæˆ‘ä»¬é‡å†™äº†è¿™ä¸ªæ¸²æŸ“å™¨

@chenshuai2144 è¯¥é—®é¢˜è¿˜å­˜åœ¨ä¿®æ”¹å€¼è®©åŠ¨æ€è¡¨å•æ˜¾ç¤ºåç‚¹é‡ç½®æŒ‰é’®å°±èƒ½å¤ç°

## chenshuai2144

> TAutomatically replying with ChatGPT can be attempted, but it cannot be guaranteed to be completely accurate and may not fully address all issues. Please feel free to reply if you have any further questions or concerns.
> æ­¤å›å¤åŸºäº ChatGPT è‡ªåŠ¨ç”Ÿæˆï¼Œå¯ä»¥å°è¯•ä¸‹æ–¹æ¡ˆï¼Œå®˜æ–¹äººå‘˜ä¼šåœ¨ä¸€å®šæ—¶é—´åç»§ç»­ç»§ç»­å¤„ç†ã€‚

å¾ˆæŠ±æ­‰ä¹‹å‰çš„å›ç­”æœ‰è¯¯ã€‚è¿™ä¸ªé—®é¢˜æ˜¯ç”±äº ProTable é»˜è®¤ä½¿ç”¨ `queryFilterOption="replace"` çš„æ–¹å¼é‡ç½®è¡¨å•ï¼Œè€Œä¸æ˜¯åŸºäº ProForm ç»„ä»¶çš„æ–¹å¼ã€‚æœ¬è´¨ä¸Šå®ƒä¼šè°ƒç”¨åç«¯æ¥è¿‡æ»¤æ•°æ®ã€‚è¿™ä¼šå¯¼è‡´å¦‚æœè¡¨å•é¡¹ä¸æ˜¯ç”±`formValueRender`æ¸²æŸ“çš„ï¼ˆåŒ…æ‹¬`renderFormItem`å‡½æ•°è¿”å›å€¼ä¸º null çš„è¡¨å•é¡¹ï¼‰ï¼Œå°±ä¼šäº§ç”Ÿè¿™ä¸ªé—®é¢˜ï¼Œå³ç‚¹å‡»é‡ç½®åå¯¹åº”è¡¨å•ç»„ä»¶æœªæˆåŠŸåˆ é™¤ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ ProTable ä¸Šä½¿ç”¨ `manualRequest` å±æ€§æ¥ç¦ç”¨é»˜è®¤çš„é‡ç½®è¡Œä¸ºï¼Œè½¬è€Œä½¿ç”¨ `ProForm` çš„ `resetFields` ç»„ä»¶çš„è¡Œä¸ºã€‚åœ¨æ¯æ¬¡è°ƒç”¨ `resetFields` æ—¶éƒ½ä¼šè§¦å‘ `formValuesChange` äº‹ä»¶ï¼Œä»è€Œå®Œæˆå…¨éƒ¨è¡¨å•é¡¹çš„æ¸…ç©ºï¼Œé¿å…äº†ä¹‹å‰å‡ºç°çš„é—®é¢˜ã€‚ä»¥ä¸‹ä»£ç ä½œä¸ºå‚è€ƒï¼š

```js
<ProTable
  // --------------------å‘ä¸ŠæŸ¥æ‰¾åˆ° ProTable å¤„ç†---------------------------
  manualRequest={true} // ç¦ç”¨ ProTable é»˜è®¤çš„è¯·æ±‚ï¼Œæ”¹ç”¨ form resetFields
  // --------------------å‘ä¸ŠæŸ¥æ‰¾åˆ° ProTable å¤„ç†---------------------------
/>

<ProForm
  form={form}
  initialValues={{}} // æ³¨å…¥åˆå§‹å€¼ä¸º {}
  onFormReset={ () => {
    requestRef.current({}) // æ‰‹åŠ¨è¯·æ±‚
  }}
/>
```

åŒæ—¶ï¼Œä¸ºäº†ç¡®ä¿åœ¨é‡ç½®æ—¶æ‰€æœ‰è¡¨å•é¡¹ç›®éƒ½èƒ½è¢«åˆ é™¤è€Œä¸æ˜¯åœç•™åœ¨ç©ºç™½æ ‡ç­¾ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥å¢åŠ ä¸€ä¸ªè¡¨å•å¼•ç”¨å®ä¾‹ï¼ˆ`formRef`ï¼‰çš„ useEffect react é’©å­å‡½æ•°ã€‚å®ƒå°†å¯¹ ProForm ç»„ä»¶æ¥æ”¶åˆ°çš„`onFormChange` äº‹ä»¶åšå‡ºæ›´æ”¹ï¼Œå°†æ‰€æœ‰è¡¨æ ¼å¸ƒå±€å…ƒç´ éƒ½åˆ é™¤ã€‚ä¸‹é¢æ˜¯å®Œæ•´ä»£ç çš„ç¤ºä¾‹ï¼š

```js
import React, { useRef, useEffect, useState } from "react";
import { Button } from "antd";
import ProTable, { ProColumns } from "@ant-design/pro-table";
import { ProForm, ProFormText } from "@ant-design/pro-form";

const columns: ProColumns<API.User>[] = [
  {
    title: "id",
    dataIndex: "id",
  },
  {
    title: "name",
    dataIndex: "name",
    renderFormItem: ({ fieldProps }) => {
      return <ProFormText {...fieldProps} />
    },
  },
  {
    title: "status",
    dataIndex: "status",
    valueEnum: {
      0: { text: "å…³é—­", status: "Default" },
      1: { text: "è¿è¡Œä¸­", status: "Processing" },
      2: { text: "å·²ä¸Šçº¿", status: "Success" },
      3: { text: "å¼‚å¸¸", status: "Error" },
    },
  },
];

export default () => {

  const [dataSource, setDataSource] = useState([])

  const formRef = useRef();

  useEffect(() => {
    requestRef.current({})
  }, []);

  useEffect(() => {  // ç”¨æ­¤ useEffect æ¸²æŸ“çš„ FormItem åœ¨é‡ç½®æ—¶ä¸€å®šä¼šè¢«æ¸…ç©º
    formRef.current?.setFields([]);
  }, [formRef]);

  const requestRef = useRef((params, sorter, filter) => {
    return Promise.resolve({
      data:[{"id":1,"name":"mike","status":1}],
      success: true
    });
  });

  return (
    <div>
      <ProTable<API.User>
        manualRequest={true} // æ‰‹åŠ¨ä½¿ç”¨form resetFields
        columns={columns}
        request={async (
          params = {},
          sort: any,
          filter: any
        ): Promise<API.List<API.User>> => {
          const result = await requestRef.current(params, sort, filter);
          setDataSource(result.data);
          return result
        }}
      />
      <ProForm
        ref={formRef} // ä¿å­˜è¡¨å•å®ä¾‹å¼•ç”¨
        initialValues={{}} // åˆå§‹å€¼ä¸ºç©ºå¯¹è±¡
        onFormReset={() => { // åœ¨ ProForm é‡ç½®æ—¶ å‘é€è¯·æ±‚
          requestRef.current({})
        }}
      />
    </div>
  );
};
```

å¸Œæœ›æˆ‘çš„å›ç­”èƒ½å¤Ÿå¸®åˆ°ä½ ã€‚

## zh19921205

æˆ‘ä¹Ÿé‡è§äº†pro-tableï¼Œæœç´¢åˆ—æœ‰3è¡Œå…±9ä¸ªï¼Œæœ€åä¸€ä¸ªé€‰æ‹©æ¡†ä¼šæœ‰è”åŠ¨æ•ˆæœï¼Œè”åŠ¨æ•ˆæœç”¨renderFormItemä¸­form.getFieldValueæ¥åˆ¤æ–­çš„ï¼Œå‡ºæ¥ç¬¬10ä¸ªåœ¨ç¬¬å››è¡Œç¬¬ä¸€ä¸ªï¼Œè¿™æ—¶å€™ç‚¹å‡»é‡ç½®ï¼Œå°±ä¼šå‡ºç°åªå‰©labelå ä½çš„æƒ…å†µï¼Œå¤„ç†åŠæ³•æ˜¯ç»™tableè®¾ç½®keyï¼Œé‡ç½®onResetäº‹ä»¶ä¿®æ”¹keyåˆ·æ–°ç»„ä»¶ã€‚

`const [refresh, setRefresh] = useState<number>(1);`

`const forceUpdate = () => {
    setRefresh(Math.random());
  };`

`<ProTable
      key={refresh}
      onReset={forceUpdate}
     ...
    />`
