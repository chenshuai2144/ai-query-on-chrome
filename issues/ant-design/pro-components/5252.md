# 🐛[BUG]EditableProTable 实时保存 + 有子列，修改 dataSource 时子列没有刷新

`table`,`📦  Need to reproduce`

### 🐛 bug 描述

<!--
详细地描述 bug，让大家都能理解
-->

EditableProTable 实时保存 + 有子列，修改 dataSource 时父列成功刷新，但凡是子列，都没有成功刷新

### 📷 复现步骤

<!--
清晰描述复现步骤，让别人也能看到问题，如果可能，尽量提供可执行代码，
如：https://codesandbox.io/ 在此处创建一个 codesandbox，方便我们更快的排查和复现问题
-->

修改前：
![image](https://user-images.githubusercontent.com/99939885/169246764-a36e2ab4-7878-41cd-8413-5773a900c283.png)

修改后：
![image](https://user-images.githubusercontent.com/99939885/169246860-297b4fca-55c6-4328-b661-832def047adf.png)
此时的 dataSource 里的 children 已经变化，但是没有刷新：
![image](https://user-images.githubusercontent.com/99939885/169247237-7c579bdf-b741-4d14-a50a-587cc2261c8f.png)

### 🏞 期望结果

<!--
描述你原本期望看到的结果
-->

子列的呈现与 datasource 一致

### 💻 复现代码

<!--
提供可复现的代码，仓库，或线上示例
-->

官网的案例，稍作修改：

```tsx
import React, { useState } from "react";
import type { ProColumns } from "@ant-design/pro-table";
import { EditableProTable } from "@ant-design/pro-table";

const waitTime = (time: number = 100) => {
  return new Promise((resolve) => {
    setTimeout(() => {
      resolve(true);
    }, time);
  });
};

type DataSourceType = {
  id?: React.Key;
  title?: string;
  decs?: string;
  state?: string;
  created_at?: string;
  update_at?: string;
  children?: DataSourceType[];
};

const defaultData: DataSourceType[] = [
  {
    id: 624748504,
    title: "活动名称一",
    decs: "这个活动真好玩",
    state: "open",
    created_at: "2020-05-26T09:42:56Z",
    update_at: "2020-05-26T09:42:56Z",
    children: [
      {
        id: 6246912293,
        title: "活动名称二",
        decs: "这个活动真好玩",
        state: "closed",
        created_at: "2020-05-26T08:19:22Z",
        update_at: "2020-05-26T08:19:22Z",
      },
    ],
  },
  {
    id: 624691229,
    title: "活动名称二",
    decs: "这个活动真好玩",
    state: "closed",
    created_at: "2020-05-26T08:19:22Z",
    update_at: "2020-05-26T08:19:22Z",
  },
];

const loopDataSourceFilter = (
  data: DataSourceType[],
  id: React.Key | undefined,
): DataSourceType[] => {
  return data
    .map((item) => {
      if (item.id !== id) {
        if (item.children) {
          const newChildren = loopDataSourceFilter(item.children, id);
          return {
            ...item,
            children: newChildren.length > 0 ? newChildren : undefined,
          };
        }
        return item;
      }
      return null;
    })
    .filter(Boolean) as DataSourceType[];
};
export default () => {
  const [dataSource, setDataSource] = useState<DataSourceType[]>(
    () => defaultData,
  );

  const columns: ProColumns<DataSourceType>[] = [
    {
      title: "活动名称",
      dataIndex: "title",
      formItemProps: (form, { rowIndex }) => {
        return {
          rules:
            rowIndex > 2 ? [{ required: true, message: "此项为必填项" }] : [],
        };
      },
      width: "30%",
    },
    {
      title: "状态",
      key: "state",
      dataIndex: "state",
      valueType: "select",
      valueEnum: {
        all: { text: "全部", status: "Default" },
        open: {
          text: "未解决",
          status: "Error",
        },
        closed: {
          text: "已解决",
          status: "Success",
        },
      },
    },
    {
      title: "描述",
      dataIndex: "decs",
      fieldProps: (from, { rowKey, rowIndex }) => {
        if (from.getFieldValue([rowKey || "", "title"]) === "不好玩") {
          return {
            disabled: true,
          };
        }
        if (rowIndex > 9) {
          return {
            disabled: true,
          };
        }
        return {};
      },
    },
    {
      title: "活动时间",
      dataIndex: "created_at",
      valueType: "date",
    },
    {
      title: "操作",
      valueType: "option",
      width: 200,
      render: (text, record) => [
        <a
          key="delete"
          onClick={() => {
            setDataSource(loopDataSourceFilter(dataSource, record.id));
          }}
        >
          删除
        </a>,
      ],
    },
  ];

  return (
    <>
      <button
        onClick={() => {
          setDataSource([
            {
              id: 624748504,
              title: "活动名称一 - 已修改",
              decs: "这个活动真好玩",
              state: "open",
              created_at: "2020-05-26T09:42:56Z",
              update_at: "2020-05-26T09:42:56Z",
              children: [
                {
                  id: 6246912293,
                  title: "活动名称二 - 已修改",
                  decs: "这个活动真好玩",
                  state: "closed",
                  created_at: "2020-05-26T08:19:22Z",
                  update_at: "2020-05-26T08:19:22Z",
                },
              ],
            },
            {
              id: 624691229,
              title: "活动名称二 - 已修改",
              decs: "这个活动真好玩",
              state: "closed",
              created_at: "2020-05-26T08:19:22Z",
              update_at: "2020-05-26T08:19:22Z",
            },
          ]);
        }}
      >
        修改 dataSource
      </button>
      <button
        onClick={() => {
          console.log("", dataSource);
        }}
      >
        打印 dataSource
      </button>
      <EditableProTable<DataSourceType>
        expandable={{
          defaultExpandAllRows: true,
        }}
        rowKey="id"
        recordCreatorProps={{
          position: "bottom",
          newRecordType: "dataSource",
          parentKey: () => 624748504,
          record: () => ({ id: (Math.random() * 1000000).toFixed(0) }),
        }}
        controlled
        columns={columns}
        value={dataSource}
        editable={{
          type: "multiple",
          editableKeys: [624748504, 6246912293, 624691229],
          onSave: async (rowKey, data, row) => {
            console.log(rowKey, data, row);
            await waitTime(2000);
          },
        }}
      />
    </>
  );
};
```

### © 版本信息

- pro-table 版本: [2.74.4]
- umi 版本: [3.5.0]
- 浏览器环境: [chrome]
- 开发环境 [windows]

### 🚑 其他信息

<!--
如截图等其他信息可以贴在这里
-->

## Dunqing

更新到最新版本再看看？
