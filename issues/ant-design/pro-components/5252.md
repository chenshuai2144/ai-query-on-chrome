# ğŸ›[BUG]EditableProTable å®æ—¶ä¿å­˜ + æœ‰å­åˆ—ï¼Œä¿®æ”¹ dataSource æ—¶å­åˆ—æ²¡æœ‰åˆ·æ–°

`table`,`ğŸ“¦  Need to reproduce`

### ğŸ› bug æè¿°

<!--
è¯¦ç»†åœ°æè¿° bugï¼Œè®©å¤§å®¶éƒ½èƒ½ç†è§£
-->

EditableProTable å®æ—¶ä¿å­˜ + æœ‰å­åˆ—ï¼Œä¿®æ”¹ dataSource æ—¶çˆ¶åˆ—æˆåŠŸåˆ·æ–°ï¼Œä½†å‡¡æ˜¯å­åˆ—ï¼Œéƒ½æ²¡æœ‰æˆåŠŸåˆ·æ–°

### ğŸ“· å¤ç°æ­¥éª¤

<!--
æ¸…æ™°æè¿°å¤ç°æ­¥éª¤ï¼Œè®©åˆ«äººä¹Ÿèƒ½çœ‹åˆ°é—®é¢˜ï¼Œå¦‚æœå¯èƒ½ï¼Œå°½é‡æä¾›å¯æ‰§è¡Œä»£ç ï¼Œ
å¦‚ï¼šhttps://codesandbox.io/ åœ¨æ­¤å¤„åˆ›å»ºä¸€ä¸ª codesandboxï¼Œæ–¹ä¾¿æˆ‘ä»¬æ›´å¿«çš„æ’æŸ¥å’Œå¤ç°é—®é¢˜
-->

ä¿®æ”¹å‰ï¼š
![image](https://user-images.githubusercontent.com/99939885/169246764-a36e2ab4-7878-41cd-8413-5773a900c283.png)

ä¿®æ”¹åï¼š
![image](https://user-images.githubusercontent.com/99939885/169246860-297b4fca-55c6-4328-b661-832def047adf.png)
æ­¤æ—¶çš„ dataSource é‡Œçš„ children å·²ç»å˜åŒ–ï¼Œä½†æ˜¯æ²¡æœ‰åˆ·æ–°ï¼š
![image](https://user-images.githubusercontent.com/99939885/169247237-7c579bdf-b741-4d14-a50a-587cc2261c8f.png)

### ğŸ æœŸæœ›ç»“æœ

<!--
æè¿°ä½ åŸæœ¬æœŸæœ›çœ‹åˆ°çš„ç»“æœ
-->

å­åˆ—çš„å‘ˆç°ä¸ datasource ä¸€è‡´

### ğŸ’» å¤ç°ä»£ç 

<!--
æä¾›å¯å¤ç°çš„ä»£ç ï¼Œä»“åº“ï¼Œæˆ–çº¿ä¸Šç¤ºä¾‹
-->

å®˜ç½‘çš„æ¡ˆä¾‹ï¼Œç¨ä½œä¿®æ”¹ï¼š

```tsx
import React, { useState } from "react";
import type { ProColumns } from "@ant-design/pro-table";
import { EditableProTable } from "@ant-design/pro-table";

const waitTime = (time: number = 100) => {
  return new Promise((resolve) => {
    setTimeout(() => {
      resolve(true);
    }, time);
  });
};

type DataSourceType = {
  id?: React.Key;
  title?: string;
  decs?: string;
  state?: string;
  created_at?: string;
  update_at?: string;
  children?: DataSourceType[];
};

const defaultData: DataSourceType[] = [
  {
    id: 624748504,
    title: "æ´»åŠ¨åç§°ä¸€",
    decs: "è¿™ä¸ªæ´»åŠ¨çœŸå¥½ç©",
    state: "open",
    created_at: "2020-05-26T09:42:56Z",
    update_at: "2020-05-26T09:42:56Z",
    children: [
      {
        id: 6246912293,
        title: "æ´»åŠ¨åç§°äºŒ",
        decs: "è¿™ä¸ªæ´»åŠ¨çœŸå¥½ç©",
        state: "closed",
        created_at: "2020-05-26T08:19:22Z",
        update_at: "2020-05-26T08:19:22Z",
      },
    ],
  },
  {
    id: 624691229,
    title: "æ´»åŠ¨åç§°äºŒ",
    decs: "è¿™ä¸ªæ´»åŠ¨çœŸå¥½ç©",
    state: "closed",
    created_at: "2020-05-26T08:19:22Z",
    update_at: "2020-05-26T08:19:22Z",
  },
];

const loopDataSourceFilter = (
  data: DataSourceType[],
  id: React.Key | undefined,
): DataSourceType[] => {
  return data
    .map((item) => {
      if (item.id !== id) {
        if (item.children) {
          const newChildren = loopDataSourceFilter(item.children, id);
          return {
            ...item,
            children: newChildren.length > 0 ? newChildren : undefined,
          };
        }
        return item;
      }
      return null;
    })
    .filter(Boolean) as DataSourceType[];
};
export default () => {
  const [dataSource, setDataSource] = useState<DataSourceType[]>(
    () => defaultData,
  );

  const columns: ProColumns<DataSourceType>[] = [
    {
      title: "æ´»åŠ¨åç§°",
      dataIndex: "title",
      formItemProps: (form, { rowIndex }) => {
        return {
          rules:
            rowIndex > 2 ? [{ required: true, message: "æ­¤é¡¹ä¸ºå¿…å¡«é¡¹" }] : [],
        };
      },
      width: "30%",
    },
    {
      title: "çŠ¶æ€",
      key: "state",
      dataIndex: "state",
      valueType: "select",
      valueEnum: {
        all: { text: "å…¨éƒ¨", status: "Default" },
        open: {
          text: "æœªè§£å†³",
          status: "Error",
        },
        closed: {
          text: "å·²è§£å†³",
          status: "Success",
        },
      },
    },
    {
      title: "æè¿°",
      dataIndex: "decs",
      fieldProps: (from, { rowKey, rowIndex }) => {
        if (from.getFieldValue([rowKey || "", "title"]) === "ä¸å¥½ç©") {
          return {
            disabled: true,
          };
        }
        if (rowIndex > 9) {
          return {
            disabled: true,
          };
        }
        return {};
      },
    },
    {
      title: "æ´»åŠ¨æ—¶é—´",
      dataIndex: "created_at",
      valueType: "date",
    },
    {
      title: "æ“ä½œ",
      valueType: "option",
      width: 200,
      render: (text, record) => [
        <a
          key="delete"
          onClick={() => {
            setDataSource(loopDataSourceFilter(dataSource, record.id));
          }}
        >
          åˆ é™¤
        </a>,
      ],
    },
  ];

  return (
    <>
      <button
        onClick={() => {
          setDataSource([
            {
              id: 624748504,
              title: "æ´»åŠ¨åç§°ä¸€ - å·²ä¿®æ”¹",
              decs: "è¿™ä¸ªæ´»åŠ¨çœŸå¥½ç©",
              state: "open",
              created_at: "2020-05-26T09:42:56Z",
              update_at: "2020-05-26T09:42:56Z",
              children: [
                {
                  id: 6246912293,
                  title: "æ´»åŠ¨åç§°äºŒ - å·²ä¿®æ”¹",
                  decs: "è¿™ä¸ªæ´»åŠ¨çœŸå¥½ç©",
                  state: "closed",
                  created_at: "2020-05-26T08:19:22Z",
                  update_at: "2020-05-26T08:19:22Z",
                },
              ],
            },
            {
              id: 624691229,
              title: "æ´»åŠ¨åç§°äºŒ - å·²ä¿®æ”¹",
              decs: "è¿™ä¸ªæ´»åŠ¨çœŸå¥½ç©",
              state: "closed",
              created_at: "2020-05-26T08:19:22Z",
              update_at: "2020-05-26T08:19:22Z",
            },
          ]);
        }}
      >
        ä¿®æ”¹ dataSource
      </button>
      <button
        onClick={() => {
          console.log("", dataSource);
        }}
      >
        æ‰“å° dataSource
      </button>
      <EditableProTable<DataSourceType>
        expandable={{
          defaultExpandAllRows: true,
        }}
        rowKey="id"
        recordCreatorProps={{
          position: "bottom",
          newRecordType: "dataSource",
          parentKey: () => 624748504,
          record: () => ({ id: (Math.random() * 1000000).toFixed(0) }),
        }}
        controlled
        columns={columns}
        value={dataSource}
        editable={{
          type: "multiple",
          editableKeys: [624748504, 6246912293, 624691229],
          onSave: async (rowKey, data, row) => {
            console.log(rowKey, data, row);
            await waitTime(2000);
          },
        }}
      />
    </>
  );
};
```

### Â© ç‰ˆæœ¬ä¿¡æ¯

- pro-table ç‰ˆæœ¬: [2.74.4]
- umi ç‰ˆæœ¬: [3.5.0]
- æµè§ˆå™¨ç¯å¢ƒ: [chrome]
- å¼€å‘ç¯å¢ƒ [windows]

### ğŸš‘ å…¶ä»–ä¿¡æ¯

<!--
å¦‚æˆªå›¾ç­‰å…¶ä»–ä¿¡æ¯å¯ä»¥è´´åœ¨è¿™é‡Œ
-->

## Dunqing

æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬å†çœ‹çœ‹ï¼Ÿ
