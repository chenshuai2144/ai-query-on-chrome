# EditableProTable实时保存的编辑表格可以实现拖拽移动吗

提问前先看看：

https://github.com/ryanhanwu/How-To-Ask-Questions-The-Smart-Way/blob/main/README-zh_CN.md

### 🔩 所属模块或组件

<!--
如果你的功能需求率属于某个功能模块或者是组件的，请在此处标明，如对`table`组件有功能需求，则注明：率属组件：ProTable
 -->

EditableProTable组件
可以实时保存的编辑表格
但是没看到这个组件可以实现拖拽

### 🥰 需求描述

<img width="978" alt="image" src="https://user-images.githubusercontent.com/45351947/169437126-57ae0cdd-b14e-4820-b977-a73344b5d28e.png">

<!--
详细地描述需求，让大家都能理解
-->

### ⛰ 功能需求适用场景

<!--
请简单描述一下这个新功能通常或可以应用在哪些场景下
-->

### 🧐 解决方案

<!--
如果你有解决方案，在这里清晰地阐述
-->

### 🚑 其他信息

<!--
如截图等其他信息可以贴在这里
-->

## chenshuai2144

可以结合用，但是数据处理起来会更麻烦，能绕过尽量绕过把

## mraiguo

> 可以结合用，但是数据处理起来会更麻烦，能绕过尽量绕过把

可以在官网放个demo吗？ 这个需求绕不过，而且感觉还算是挺常见的

## chenshuai2144

很难写，写出都是bug的demo没什么意义

## yzh990918

> 提问前先看看：
>
> https://github.com/ryanhanwu/How-To-Ask-Questions-The-Smart-Way/blob/main/README-zh_CN.md
>
> ### 🔩 所属模块或组件
>
> EditableProTable组件 可以实时保存的编辑表格 但是没看到这个组件可以实现拖拽
>
> ### 🥰 需求描述
>
> <img alt="image" width="978" src="https://user-images.githubusercontent.com/45351947/169437126-57ae0cdd-b14e-4820-b977-a73344b5d28e.png">
>
> ### ⛰ 功能需求适用场景
>
> ### 🧐 解决方案
>
> ### 🚑 其他信息

请问最后实现了吗

## sTeADone

基本照抄的https://juejin.cn/post/7166529533330817031
react-sortable-hoc不支持react18 需要用dnd-kit
另外拖拽行的样式也是照抄

```
// https://juejin.cn/post/7166529533330817031
// 基于dnd-kit实现Antd Table组件拖拽排序
import React,{ useState, useEffect }  from "react"
import { useSortable } from "@dnd-kit/sortable"
import { DndContext } from "@dnd-kit/core"
import {
  arrayMove,
  SortableContext,
  verticalListSortingStrategy
} from "@dnd-kit/sortable"
import { restrictToVerticalAxis } from "@dnd-kit/modifiers"
import { MenuOutlined } from "@ant-design/icons"
import { EditableProTable } from '@ant-design/pro-components';
import "./style.less"

function SortableItem(props) {
  const id = props["data-row-key"]
  const {
    attributes,
    listeners,
    setNodeRef,
    transform,
    transition,
    isDragging
  } = useSortable({
    id
  })

  const dragStyle = {
    transition,
    // transform: CSS.Translate.toString(transform),
    "--translate-x": `${transform?.x ?? 0}px`,
    "--translate-y": `${transform?.y ?? 0}px`
  }

  const { style, className, children, ...rest } = props
  const cls = [className, "dragItem", id && isDragging ? "dragOverlay" : null]
    .filter(c => c)
    .join(" ")

  return (
    <tr
      id={id}
      ref={setNodeRef}
      {...attributes}
      //{...listeners}
      className={cls}
      style={{ ...style, ...dragStyle }}
      {...rest}
      data-cypress="draggable-item"
    >
      {React.Children.map(children, child => {
        if (child.key === "sort") {
          return React.cloneElement(child, {
            additionalProps: {
              ...listeners,
              "data-cypress": "draggable-handle"
            }
          })
        }
        return child
      })}
    </tr>
  )
}

function DraggableTable({ value, onChange, columns, recordCreatorProps,rowKey="key", ...restProps }) {
  const [editableKeys, setEditableRowKeys] = useState([])
  useEffect(() => {
    setEditableRowKeys(value ? value.map((item, index) => (item[rowKey])) : [])
  }, [value]);

  const handleDragEnd = event => {
    const { active, over } = event
    console.log(active.id, over?.id)
    if (active.id !== over?.id) {
      const oldIndex = value.findIndex(item => item[rowKey] === active.id)
      const newIndex = value.findIndex(item => item[rowKey] === over?.id)

      const next = arrayMove(value, oldIndex, newIndex)
      onChange(next)
    }
  }

  //组件内部增加sort和action列
  columns = [
    {
      title: "Sort",
      dataIndex: "sort",
      width: 44,
      render: () => <MenuOutlined />,
      align: "center",
      editable: false
    },
    ...columns,
    {
      title: 'Action',
      width: 60,
      valueType: 'option',
    },
  ]

  return (
    <DndContext modifiers={[restrictToVerticalAxis]} onDragEnd={handleDragEnd} >
      <SortableContext
        items={value ? value.map(c => c[rowKey]) : [-1]}
        strategy={verticalListSortingStrategy}
      >
        <EditableProTable
          rowKey={rowKey}
          editable={{
            type: 'multiple',
            editableKeys,
            actionRender: (row, config, defaultDoms) => {
              return [defaultDoms.delete];
            }
          }}
          recordCreatorProps={{
            newRecordType: 'dataSource',
            position: 'bottom',
            record: () => ({
              [rowKey]: Date.now().toString(),
            }),
            ...recordCreatorProps
          }}
          value={value}
          columns={columns}
          pagination={false}
          components={{ body: { row: SortableItem } }}
          onChange={onChange}
          ghost
          {...restProps}
        />
      </SortableContext>
    </DndContext>
  )
}

export default DraggableTable;
```
