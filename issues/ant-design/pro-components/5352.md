# 🐛[BUG] Schema Form内嵌模式下（Embed）dependencies表单联动失效

`AI Reply`

提问前先看看：

https://github.com/ryanhanwu/How-To-Ask-Questions-The-Smart-Way/blob/main/README-zh_CN.md

### 🐛 bug 描述

使用BetaSchemaForm，layoutType为（Embed），columns中使用dependencies实现表单联动失效，返回的formRef调用方法取不到值

<!--
详细地描述 bug，让大家都能理解
-->

### 📷 复现步骤

表单1类型字段选择全部，状态字段不能正常联动
![image](https://user-images.githubusercontent.com/56418832/172606972-ad4a038a-ee62-4294-afb9-01b26b88685f.png)

<!--
清晰描述复现步骤，让别人也能看到问题，如果可能，尽量提供可执行代码，
如：https://codesandbox.io/ 在此处创建一个 codesandbox，方便我们更快的排查和复现问题
-->

### 🏞 期望结果

期望状态字段禁用

<!--
描述你原本期望看到的结果
-->

### 💻 复现代码

import type { ProFormColumnsType } from "@ant-design/pro-components";
import {
BetaSchemaForm,
ProForm,
ProFormSelect,
ProFormText
} from "@ant-design/pro-components";
import React from "react";

type DataItem = {
name: string;
state: string;
};
const valueEnum = [
{ label: "全部", value: "all1" },
{ label: "未解决", value: "open2" },
{ label: "未解决(已分配)", value: "assignees1" },
{ label: "已解决", value: "closed1" },
{ label: "解决中", value: "processing1" }
];

const columns: ProFormColumnsType<DataItem>[] = [
{
valueType: "select",
title: "类型",
dataIndex: "ksCustomer_status",
request: async () => valueEnum
},
{
valueType: "text",
title: "状态",
dataIndex: "ksCustomer_type",
dependencies: ["ksCustomer_status"], // 内嵌模式下（Embed）dependencies表单联动失效
fieldProps: (form, config) => {
if (form?.getFieldValue("ksCustomer_status") === "all1") {
console.log(1212121221);
return {
disabled: true,
placeholder: "disabled"
};
} else {
console.log(9999);
return {
placeholder: "normal"
};
}
}
},
{
valueType: "dependency",
fieldProps: {
name: ["ksCustomer_status"]
},
columns: ({ ksCustomer_status }) => {
return ksCustomer_status !== "all1"
? [
{
valueType: "text",
dataIndex: "currentTime",
width: "md"
}
]
: [];
}
}
];

export default () => {
return (
<ProForm>
<h1>ProForm </h1>
<ProFormText name="username" />
<ProFormSelect
name="select-multiple"
label="多选"
valueEnum={{
          red: "Red",
          green: "Green",
          blue: "Blue"
        }}
fieldProps={{
          mode: "multiple"
        }}
placeholder="Please select favorite colors"
rules={[
{
required: true,
message: "Please select your favorite colors!",
type: "array"
}
]}
/>
<h1>表单1 </h1>
<BetaSchemaForm<DataItem> layoutType="Embed" columns={columns} />
<h1>表单2</h1>
<BetaSchemaForm<DataItem>
layoutType="Embed"
columns={[
{
title: "创建时间",
key: "showTime",
dataIndex: "createName",
valueType: "date"
},
{
title: "分组",
valueType: "group",
columns: [
{
title: "标题",
width: "md",
dataIndex: "groupTitle",
formItemProps: {
rules: [
{
required: true,
message: "此项为必填项"
}
]
}
}
]
}
]}
/>
</ProForm>
);
};

<!--
提供可复现的代码，仓库，或线上示例
-->

### © 版本信息

"@ant-design/pro-components": "1.1.5",
"antd": "4.21.0",
"react": "18.1.0",
"react-dom": "18.1.0"

### 🚑 其他信息

复现地址： https://codesandbox.io/s/schema-biao-dan-forked-4mi57j?file=/App.tsx

<!--
如截图等其他信息可以贴在这里
-->

## chenshuai2144

> TAutomatically replying with ChatGPT can be attempted, but it cannot be guaranteed to be completely accurate and may not fully address all issues. Please feel free to reply if you have any further questions or concerns.
> 此回复基于 ChatGPT 自动生成，可以尝试下方案，官方员会在一定时间后继续继续处理。

感谢分享你的问题。根据你提供的信息，我发现问题出在 `BetaSchemaForm` 的 `Embed` 布局模式下，使用 `dependencies` 属性的表单联动会失效。经过我在代码中的测试，确实出现了这个问题。

我在 [Ant Design Pro issues](https://github.com/ant-design/ant-design-pro/issues/3198) 上找到了类似的问题。按照那个 issue 中的解决方案，我尝试修改了表单的实现方式，使用 `ProForm.Group` 和 `ProFormItem` 来替代 `BetaSchemaForm` 中的 `columns`，并在 `ProFormItem` 中使用 `ProFormFieldSet` 来实现嵌套，这样就可以正常实现表单联动。可以参考以下代码改动：

```jsx
import type { ProFormColumnsType } from "@ant-design/pro-components";
import {
  ProForm,
  ProFormSelect,
  ProFormText,
  ProFormDependency,
  ProFormFieldSet,
  ProFormDateTimePicker
} from "@ant-design/pro-components";
import React from "react";

type DataItem = {
  name: string;
  state: string;
};

const valueEnum = [
  { label: "全部", value: "all1" },
  { label: "未解决", value: "open2" },
  { label: "未解决(已分配)", value: "assignees1" },
  { label: "已解决", value: "closed1" },
  { label: "解决中", value: "processing1" }
];

export default () => {
  return (
    <ProForm>
      <h1>ProForm </h1>
      <ProFormText name="username" />
      <ProFormSelect
        name="select-multiple"
        label="多选"
        valueEnum={{
          red: "Red",
          green: "Green",
          blue: "Blue"
        }}
        fieldProps={{
          mode: "multiple"
        }}
        placeholder="Please select favorite colors"
        rules={[
          {
            required: true,
            message: "Please select your favorite colors!",
            type: "array"
          }
        ]}
      />
      <h1>表单1 </h1>
      <ProForm.Group>
        <ProFormSelect
          name="ksCustomer_status"
          label="类型"
          request={async () => valueEnum}
        />
        <ProFormItem
          dependencies={["ksCustomer_status"]}
          name="ksCustomer_type"
          label="状态"
        >
          <ProFormFieldSet>
            {(form) => {
              if (form?.getFieldValue("ksCustomer_status") === "all1") {
                console.log(1212121221);
                return <ProFormText disabled placeholder="disabled" />;
              } else {
                console.log(9999);
                return <ProFormText placeholder="normal" />;
              }
            }}
          </ProFormFieldSet>
        </ProFormItem>
        <ProFormDependency name={["ksCustomer_status"]}>
          {(ksCustomer_status) => {
            return ksCustomer_status !== "all1" ? (
              <ProFormDateTimePicker name="currentTime" label="时间" />
            ) : null;
          }}
        </ProFormDependency>
      </ProForm.Group>
      <h1>表单2</h1>
      <ProForm.Group>
        <ProFormDateTimePicker name="createName" label="创建时间" />
        <ProFormItem name="groupTitle" label="分组">
          <ProFormFieldSet>
            <ProFormText
              name="groupTitle"
              width="md"
              placeholder="请输入标题"
              rules={[
                {
                  required: true,
                  message: "此项为必填项"
                }
              ]}
            />
          </ProFormFieldSet>
        </ProFormItem>
      </ProForm.Group>
    </ProForm>
  );
};
```

希望我的回答可以帮助到你解决问题。如果还有任何问题，欢迎继续提出。
