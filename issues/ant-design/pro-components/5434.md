# ğŸ›[BUG]ã€BetaSchemaFormã€‘ã€valueType: 'treeSelect'ã€‘ã€treeCheckable: trueã€‘ã€treeNodeFilterProp: 'title'ã€‘ã€options: [{},{}]ã€‘ã€ä¸ç”Ÿæ•ˆã€‘

`â­•ï¸   bug`,`table`,`AI Reply`

### ã€BetaSchemaFormã€‘ã€valueType: 'treeSelect'ã€‘ã€treeCheckable: trueã€‘ã€treeNodeFilterProp: 'title'ã€‘ã€options: [{ title: 'a',value: 1 }, { title: 'b',value: 2 }]ã€‘ã€ä¸ç”Ÿæ•ˆã€‘

### é—®é¢˜ 1ï¼šæœç´¢ aï¼Œæ˜¾ç¤ºã€æš‚æ— æ•°æ®ã€‘

### é—®é¢˜ 2ï¼šå¦‚æœé€‰ä¸­ bï¼Œå† æœç´¢ aï¼Œæ§åˆ¶å°ä¼šæŠ¥é”™ï¼šã€Warning: Tree missing follow keys: '2'ã€‘ï¼Œå¹¶ä¸”é€‰æ‹©æ¡†ä¸æ˜¾ç¤º bï¼Œè€Œæ˜¯æ˜¾ç¤º 2

### é—®é¢˜ 3ï¼šå…¶ä»–å±æ€§ä¸å˜ï¼Œç§»é™¤ã€options: [{},{}]ã€‘ï¼Œå˜æˆï¼šã€request: async ()=> [{},{}]ã€‘ï¼Œæ¯æ¬¡è¾“å…¥ã€æœç´¢å…³é”®å­—ã€‘æ—¶ï¼Œéƒ½ä¼šå»è°ƒç”¨ request æ–¹æ³•ï¼Œæ¯æ¬¡éƒ½ä¼šæœ‰ä¸€ä¸ª loadingï¼Œå½±å“è¾“å…¥çš„ä½“éªŒï¼Œä½†æ˜¯è¿™ä¸ªæ—¶å€™ï¼Œæœç´¢ã€aã€‘ï¼Œå°±ä¼šæ˜¾ç¤ºã€aã€‘äº†ï¼Œå°±æ¢å¤æ­£å¸¸äº†

## bjtqti

æˆ‘ä¹Ÿé‡åˆ°ç±»ä¼¼é—®é¢˜ï¼ŒtreeNodeFilterProp å±æ€§ä¸èµ·ä½œç”¨

## chenshuai2144

è¿™issue å†™çš„ä¸ªå•¥å‘€ï¼Œçœ‹ä¹Ÿçœ‹ä¸æ‡‚ã€‚æç‚¹ä»£ç å§

## Cmc0

> è¿™issue å†™çš„ä¸ªå•¥å‘€ï¼Œçœ‹ä¹Ÿçœ‹ä¸æ‡‚ã€‚æç‚¹ä»£ç å§

@chenshuai2144 ä»£ç åœ°å€ï¼š[https://codesandbox.io/s/bold-voice-r629bk?file=/src/App.js](https://codesandbox.io/s/bold-voice-r629bk?file=/src/App.js)

## chenshuai2144

> TAutomatically replying with ChatGPT can be attempted, but it cannot be guaranteed to be completely accurate and may not fully address all issues. Please feel free to reply if you have any further questions or concerns.
> æ­¤å›å¤åŸºäº ChatGPT è‡ªåŠ¨ç”Ÿæˆï¼Œå¯ä»¥å°è¯•ä¸‹æ–¹æ¡ˆï¼Œå®˜æ–¹å‘˜ä¼šåœ¨ä¸€å®šæ—¶é—´åç»§ç»­ç»§ç»­å¤„ç†ã€‚

è°¢è°¢æä¾›ä»£ç ï¼

é—®é¢˜ 1 å’Œ é—®é¢˜ 2 çš„åŸå› æ˜¯ `treeNodeFilterProp` å±æ€§ä¸èµ·ä½œç”¨çš„åŸå› æ˜¯å› ä¸ºä½ ä¼ é€’ç»™ `BetaSchemaForm` çš„ `options` å†…å®¹æ ¼å¼ä¸ç¬¦åˆè¦æ±‚ï¼Œæ­£ç¡®çš„æ ¼å¼åº”è¯¥å½¢å¦‚ï¼š{ value: '1', label: '1', children: [] }ã€‚æ‰€ä»¥å½“ä½ ä½¿ç”¨ `treeSelect` ç»„ä»¶ä½œä¸ºè¾“å…¥æ§ä»¶æ—¶ï¼Œåº”è¯¥åœ¨æ”¹å˜æ•°æ®æºçš„æ ¼å¼åå†è¿›è¡Œæ¸²æŸ“ã€‚

è§£å†³æ–¹æ¡ˆï¼š

1. ä¿®æ”¹ `src/App.jsx` æ–‡ä»¶ï¼š

ä»£ç ï¼š

```jsx
import React, { useState } from "react";
import { BetaSchemaForm } from "@ant-design/pro-form";
import { Button } from "antd";

const dataSource = [
  { value: "1", label: "1", children: [] },
  { value: "2", label: "2", children: [] },
];

let lastDataSource = dataSource;

export default function App() {
  const [schemaData] = useState(() => {
    const t = [
      {
        label: "treeSelect",
        name: "treeSelect",
        valueType: "treeSelect",
        treeCheckable: true,
        treeNodeFilterProp: "label",
        options: lastDataSource,
      },
    ];
    return {
      initialValues: { treeSelect: ["2"] },
      schema: {
        type: "object",
        properties: {
          ...t.reduce(
            (pre, { name, label, ...rest }) => ({
              ...pre,
              [name]: {
                title: label,
                ...rest,
              },
            }),
            {},
          ),
        },
      },
      uiSchema: {},
      submitText: "ä¿å­˜",
    };
  });

  const requestData = async () => {
    return new Promise((resolve) => {
      setTimeout(() => {
        lastDataSource = [
          {
            value: "1",
            label: "a",
            children: [],
          },
          {
            value: "2",
            label: "b",
            children: [],
          },
        ];
        resolve(lastDataSource);
      }, 1000);
    });
  };

  return (
    <div className="App">
      <BetaSchemaForm
        schema={schemaData.schema}
        initialValues={schemaData.initialValues}
        uiSchema={schemaData.uiSchema}
        submitText={schemaData.submitText}
        layoutType="ModalLayout"
        onFinish={(values) => alert(JSON.stringify(values, null, 2))}
        request={{
          ...(typeof lastDataSource[0].value !== "undefined"
            ? { options: lastDataSource }
            : { request: requestData }),
        }}
      />
      <Button
        onClick={() => {
          lastDataSource = [];
        }}
      >
        é‡ç½®æ•°æ®æºä¸ºç©º
      </Button>
    </div>
  );
}
```

2. ä¿®æ”¹ `dataSource` çš„ç»“æ„ï¼Œä½¿å…¶ç¬¦åˆè¦æ±‚ï¼Œæ ¼å¼åº”è¯¥å½¢å¦‚ï¼š{ value: '1', label: '1', children: [] }ã€‚

ä»£ç ï¼š

```jsx
const dataSource = [
  { value: "1", label: "1", children: [] },
  { value: "2", label: "2", children: [] },
];
```

3. ç”¨å˜é‡ `lastDataSource` æ¥è®°å½• `options` çš„å€¼ã€‚

ä»£ç ï¼š

```jsx
let lastDataSource = dataSource;
```

è¿™æ ·å°±å¯ä»¥è§£å†³ `treeNodeFilterProp` å±æ€§ä¸èµ·ä½œç”¨çš„é—®é¢˜äº†ã€‚

å¯¹äºé—®é¢˜ 3ï¼Œåˆ™å¯ä»¥è€ƒè™‘ä½¿ç”¨ debounce è§£å†³ï¼Œå³è®¾ç½®ä¸€ä¸ªæ—¶é—´é˜ˆå€¼ï¼Œåœ¨æ—¶é—´é˜ˆå€¼å†…å¤šæ¬¡è¾“å…¥æ—¶ï¼Œåªä¼šå‘é€æœ€åä¸€æ¬¡è¾“å…¥çš„ç»“æœï¼Œä»¥å‡å°‘è¯·æ±‚æ¬¡æ•°ã€‚

ä»£ç ï¼š

```jsx
import React, { useState } from "react";
import { BetaSchemaForm } from "@ant-design/pro-form";
import { Button } from "antd";
import debounce from "lodash/debounce";

const dataSource = [...];

let lastDataSource = dataSource;
let searchPromise = null;

export default function App() {
  const [schemaData] = useState(() => {
    // ...
  });

  const requestData = async (name) => {
    // å¦‚æœä¸Šä¸€ä¸ªæœç´¢è¯·æ±‚è¿˜æœªå“åº”ï¼Œä¸Šä¸€æ¬¡çš„ Promise å°†ä¼šè¢« abortï¼Œå¹¶ä¸” Promise ä¸ä¼š resolveï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥ä½¿ç”¨ Promise.race æ–¹å¼å¤„ç† Promiseã€‚
    if (searchPromise && typeof searchPromise.abort === "function") {
      searchPromise.abort();
    }
    searchPromise = new Promise((resolve, reject) => {
      const abort = () => {
        reject({ message: "abort" });
      };
      const timer = setTimeout(() => resolve([{ label: "a", value: "1" }, { label: "b", value: "2" }]), 1000);
      abort.timer = timer;
      searchPromise.abort = abort;
    });

    const result = await Promise.race([searchPromise]);
    lastDataSource = result.map(({ label, value }) => ({ label, value, children: [] }));
    return lastDataSource;
  };

  const handleSearch = debounce((value, name) => {
    requestData(name).then(() => {
      return { options: lastDataSource };
    });
  }, 500);

  return (
    <div className="App">
      <BetaSchemaForm
        schema={schemaData.schema}
        initialValues={schemaData.initialValues}
        uiSchema={schemaData.uiSchema}
        submitText={schemaData.submitText}
        layoutType="ModalLayout"
        onFinish={(values) => alert(JSON.stringify(values, null, 2))}
        request={{
          ...(typeof lastDataSource[0].value !== "undefined" // è¿™é‡Œå¯ä»¥ä½¿ç”¨ lastDataSourceï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ options
            ? { options: lastDataSource }
            : { request: (name) => requestData(name) })
        }}
        search={(value, name) => {
          handleSearch(value, name);
        }}
      />
      <Button
        onClick={() => {
          lastDataSource = [];
        }}
      >
        é‡ç½®æ•°æ®æºä¸ºç©º
      </Button>
    </div>
  );
}
```

åœ¨è¿™ä¸ªè§£å†³æ–¹æ¡ˆä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† `Promise.race` æ–¹å¼å¯¹æœç´¢è¯·æ±‚è¿›è¡Œäº†å¤„ç†ã€‚å®ƒå¯ä»¥åœ¨æ—¶é—´é˜ˆå€¼å†…æœ€å¤šå‘é€ä¸€æ¬¡è¯·æ±‚ï¼Œæ¥å‡å°‘è¯·æ±‚å‘é€çš„æ¬¡æ•°ï¼Œä»è€Œæå‡æœç´¢çš„æ€§èƒ½ï¼Œè®©ç”¨æˆ·çš„è¾“å…¥æ›´åŠ é¡ºç•…ã€‚

## chenshuai2144

fetchDataOnSearch=false

é…ç½®è¿™ä¸ªå°±å¥½
