# 🐛[BUG] 在对Ant Design Vue的modal再次封装时，本地无问题，编译发布后发现，模态框的取消和右上角的关闭无法关闭模态框

`AI Reply`

### 🐛 bug 描述

在对Ant Design Vue的modal再次封装时，使用afterClose属性去修改父组件的绑定的visible，并重置内部的表单。但在本地测试无问题，编译发布后发现，模态框的取消和右上角的关闭无法关闭模态框。

### 📷 复现步骤

封装一个模态框

````
<template>

    <a-modal v-model:visible="visible"
             :title="title"
             @ok="handleModalOk"
             :confirm-loading="spinning"
             :afterClose="handleModalClose">
      <a-form
          :label-col="{ span: 4 }"
          :wrapper-col="{ span: 18 }"
          autocomplete="off"
          :model="formData"
          ref="form">
        <a-form-item :label="item.label" :name="item.prop" v-for="(item, index) in formItems" :rules="item.rules"
                     :key="item.prop">
          <a-input-password v-if="item.type==='password'" v-model:value="formData[item.prop]" autoComplete="true"/>
          <a-input v-else-if="item.type==='input'" v-model:value="formData[item.prop]" autoComplete="true"/>
          <slot v-else-if="item.type==='slot'" :name="item.prop"></slot>
        </a-form-item>
      </a-form>
    </a-modal>

</template>

<script setup>
import {ref} from 'vue'

const props = defineProps({
  title: {
    type: String, default: '',
  },
  visible: {
    type: Boolean, default: false
  },
  modalConfirm: {
    type: Function, default: async () => {
    }
  },
  formData: {
    type: Object, default: () => ({})
  },
  formItems: {
    type: Array, default: () => []
  }
})

const emit = defineEmits(['success', 'update:visible'])

let form = ref();

let spinning = ref(false);

const handleModalOk = async () => {
  spinning.value = true;
  try {
    await form.value.validateFields()
  } catch (error) {
    spinning.value = false;
    return;
  }

  try {
    await props.modalConfirm(JSON.parse(JSON.stringify(props.formData)))
  } catch (error) {
    spinning.value = false;
    console.error(error)
    return;
  }

  spinning.value = false;
  emit("update:visible", false);
  emit("success")
}

const handleModalClose = () => {
  emit("update:visible", false);
  form.value.resetFields()
  form.value.clearValidate()
}

</script>

<style scoped>

</style>

~~~~~
~~~~~
  <p-modal title="重置密码" v-model:visible="resetPasswordModal.visible" :modalConfirm="resetPassword"
    :formItems="resetPasswordModalFormItems" :formData="resetPasswordModal.data" @success="resetPasswordSuccess">
~~~~~

线上测试站点：http://portal.cloud.edusoho.cn/
账号：admin
密码：admin或admin1




  ## chenshuai2144

 > TAutomatically replying with ChatGPT can be attempted, but it cannot be guaranteed to be completely accurate and may not fully address all issues. Please feel free to reply if you have any further questions or concerns.
 > 此回复基于 ChatGPT 自动生成，可以尝试下方案，官方员会在一定时间后继续继续处理。

### 解决方案

根据您提供的信息，我们注意到您使用的是Ant Design Vue的modal进行二次封装，但改动了`afterClose`属性的行为，用它来主动隐藏模态框。

问题可能是由于修改该属性会干扰modal本身的关闭事件，导致关闭按钮和取消按钮无法正常关闭模态框。应该使用正常的v-model双向绑定的方式来控制Ant Design Vue的modal的显隐。

修改后的模态框组件如下:

```
<template>
  <a-modal v-model:visible="visible" :title="title" @ok="handleModalOk" :confirm-loading="spinning">
    <a-form :label-col="{ span: 4 }" :wrapper-col="{ span: 18 }" autocomplete="off" :model="formData" ref="form">
      <a-form-item
        :label="item.label"
        :name="item.prop"
        v-for="(item, index) in formItems"
        :rules="item.rules"
        :key="item.prop"
      >
        <a-input-password
          v-if="item.type==='password'"
          v-model:value="formData[item.prop]"
          autoComplete="true"
        />
        <a-input
          v-else-if="item.type==='input'"
          v-model:value="formData[item.prop]"
          autoComplete="true"
        />
        <slot v-else-if="item.type==='slot'" :name="item.prop"></slot>
      </a-form-item>
    </a-form>
  </a-modal>
</template>

<script setup>
import { ref, defineEmits } from "vue";

const props = defineProps({
  title: {
    type: String,
    default: "",
  },
  visible: {
    type: Boolean,
    default: false,
  },
  modalConfirm: {
    type: Function,
    default: async () => {},
  },
  formData: {
    type: Object,
    default: () => ({}),
  },
  formItems: {
    type: Array,
    default: () => [],
  },
});

const emit = defineEmits(["success", "update:visible"]);

let form = ref();

let spinning = ref(false);

const handleModalOk = async () => {
  spinning.value = true;
  try {
    await form.value.validateFields();
  } catch (error) {
    spinning.value = false;
    return;
  }

  try {
    await props.modalConfirm(JSON.parse(JSON.stringify(props.formData)));
  } catch (error) {
    spinning.value = false;
    console.error(error);
    return;
  }

  spinning.value = false;
  emit("update:visible", false);
  emit("success");
};

const handleCancel = () => {
  emit("update:visible", false);
  form.value.resetFields();
  form.value.clearValidate();
};

</script>
```
同时还需要在调用模态框的地方添加 `@cancel` 事件进行监听，用于处理取消按钮和右上角关闭按钮的事件。

修改后的组件使用方式示例：

```
<p-modal
  title="重置密码"
  v-model:visible="resetPasswordModal.visible"
  :modalConfirm="resetPassword"
  :formItems="resetPasswordModalFormItems"
  :formData="resetPasswordModal.data"
  @success="resetPasswordSuccess"
  @cancel="handleCancel"
></p-modal>
```

### 相关文档

Ant Design Vue Modal（中文文档）：https://www.antdv.com/components/modal-cn/

````
