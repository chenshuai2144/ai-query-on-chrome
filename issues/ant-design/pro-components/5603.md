# ğŸ›[BUG]BetaSchemaFormç»„ä»¶çš„paramså±æ€§ä¸formRefå±æ€§çš„å†²çªbug(^v1.1.12)

`â­•ï¸   bug`,`form`

æé—®å‰å…ˆçœ‹çœ‹ï¼š

https://github.com/ryanhanwu/How-To-Ask-Questions-The-Smart-Way/blob/main/README-zh_CN.md

### ğŸ› bug æè¿°

<!--
è¯¦ç»†åœ°æè¿° bugï¼Œè®©å¤§å®¶éƒ½èƒ½ç†è§£
-->

å˜¿ï¼Œæˆ‘æ­£åœ¨åšåŸºäºProComponentå°è£…ä¸€å¥—2Bçš„äº§å“è§£å†³æ–¹æ¡ˆï¼Œè¿™æ˜¾å¾—æˆ‘å¾ˆé…·ã€‚

ä½†åœ¨ä½¿ç”¨BetaSchemaFormç»„ä»¶æ—¶ï¼Œæˆ‘å‘ç°äº†è¿™æ ·çš„bugï¼š
å½“æˆ‘å°è¯•ä½¿ç”¨requestå±æ€§å’Œparamså±æ€§æ—¶ï¼Œå‘ç°å½“paramså†…å«æœ‰é—­åŒ…å˜é‡æ—¶ï¼Œä¼šå¼•å‘formRefçš„æ ‡è®°ä¸¢å¤±ã€‚

æˆ‘ä»”ç»†æ’æŸ¥è¿‡ï¼Œå‘ç°ä½¿ç”¨useStateï¼Œ useRefç­‰è¿”å›çš„é—­åŒ…å˜é‡å€¼æ—¶å°±ä¼šå¼•å‘è¿™ä¸ªé—®é¢˜ã€‚

æˆ‘åšäº†ä¸¤ä¸ªæç®€çš„å¤ç°demoï¼Œ è¯·åœ¨ä¸‹æ–¹çš„å¤ç°æ­¥éª¤è¿›è¡ŒæŸ¥çœ‹:

### ğŸ“· å¤ç°æ­¥éª¤

<!--
æ¸…æ™°æè¿°å¤ç°æ­¥éª¤ï¼Œè®©åˆ«äººä¹Ÿèƒ½çœ‹åˆ°é—®é¢˜ï¼Œå¦‚æœå¯èƒ½ï¼Œå°½é‡æä¾›å¯æ‰§è¡Œä»£ç ï¼Œ
å¦‚ï¼šhttps://codesandbox.io/ åœ¨æ­¤å¤„åˆ›å»ºä¸€ä¸ª codesandboxï¼Œæ–¹ä¾¿æˆ‘ä»¬æ›´å¿«çš„æ’æŸ¥å’Œå¤ç°é—®é¢˜
-->

- å¤ç°demo1

```tsx
import React, { useState, useEffect, useRef } from "react";
import { BetaSchemaForm } from "@ant-design/pro-components";

export default () => {
  const targetRef = useRef();
  const [requestLibData, setRequestLibData] = useState(0);
  useEffect(() => {
    // æ›´æ–°requestLibDataï¼Œå¹¶å¼•å‘reRender
    setTimeout(() => {
      setRequestLibData(1);
    });
  }, []);
  // æŸ¥çœ‹reRenderåçš„refæ ‡è®°
  useEffect(() => console.log("targetRef.current1", targetRef.current));
  return (
    <BetaSchemaForm
      request={async () => ({})}
      params={{ requestLibData }}
      columns={[]}
      formRef={targetRef}
    />
  );
};
```

![image](https://user-images.githubusercontent.com/44901373/180374151-5b65deef-9b12-49f7-b6f9-13cb95f9f842.png)

### ğŸ æœŸæœ›ç»“æœ

<!--
æè¿°ä½ åŸæœ¬æœŸæœ›çœ‹åˆ°çš„ç»“æœ
-->

ä¸¤æ¬¡targetRef.currentéƒ½åº”è¯¥æ˜¯æœ‰å€¼çš„ã€‚ä½†å¾ˆé—æ†¾å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œrefæ ‡è®°åé¦ˆç»™æˆ‘çš„æ˜¯nullã€‚

### ğŸ’» å¤ç°ä»£ç 

<!--
æä¾›å¯å¤ç°çš„ä»£ç ï¼Œä»“åº“ï¼Œæˆ–çº¿ä¸Šç¤ºä¾‹
-->

- å¤ç°demo2

```tsx
import { BetaSchemaForm } from "@ant-design/pro-components";
import React, { useState, useEffect, useRef } from "react";

export default () => {
  const fRef = useRef();
  // ä»…ç”¨æ¥å¼•å‘reRender
  const [renderCount, setRenderCount] = useState(0);

  const requestLibRef = useRef(0);

  useEffect(() => {
    setTimeout(() => {
      // paramså€¼æ›´æ–°
      requestLibRef.current = 1;
      // reRender
      setRenderCount(1);
    });
  }, []);

  useEffect(() => console.log("fRef.current1", fRef.current));

  return (
    <BetaSchemaForm
      request={async () => ({})}
      params={{ requestLibData: requestLibRef.current }}
      columns={[]}
      formRef={fRef}
    />
  );
};
```

è¿™å°†å¼•å‘åŒæ ·çš„è¡¨ç°
![image](https://user-images.githubusercontent.com/44901373/180375680-3ddd4307-84ca-4a54-b729-000bf0a06995.png)

### Â© ç‰ˆæœ¬ä¿¡æ¯

- ProComponents ç‰ˆæœ¬: v1.1.6 || v1.1.12
- umi ç‰ˆæœ¬: v3.5.26
- æµè§ˆå™¨ç¯å¢ƒ: 103.0.5060.114ï¼ˆæ­£å¼ç‰ˆæœ¬ï¼‰ (x86_64)
- å¼€å‘ç¯å¢ƒ [e.g. mac OS] 12.3.1 mac OS

### ğŸš‘ å…¶ä»–ä¿¡æ¯

<!--
å¦‚æˆªå›¾ç­‰å…¶ä»–ä¿¡æ¯å¯ä»¥è´´åœ¨è¿™é‡Œ
-->

æˆ‘é€šè¿‡å…¶ä»–æ–¹å¼ç»•è¿‡è¿™ä¸ªbugï¼Œè§£å†³äº†æˆ‘çš„éœ€æ±‚ã€‚
ä½†è¿™ä¸ªbugå¼•å‘äº†æˆ‘çš„å…´è¶£ï¼Œäºæ˜¯å°±åœ¨åˆšæ‰ï¼Œæˆ‘å¼€å§‹å°è¯•æŸ¥çœ‹æºç ä»¥ä¾¿æ‰¾åˆ°å®ƒçš„æ¥æºã€‚
ç„¶è€Œå¾ˆé—æ†¾çš„æ˜¯ï¼ŒformRefå±æ€§çš„å¤„ç†é€»è¾‘ä¸å¤ªå¤šæ— å…³ä»£ç è€¦åˆåˆ°äº†ä¸€èµ·ï¼Œè¿™ä½¿å¾—æˆ‘çš„è¿½è¸ªé­é‡äº†é˜»ç¢ã€‚
æˆ‘å°†åœ¨ä¸‹é¢çš„è¯„è®ºä¸­å»ºè®®ä¸€ç§ä»£ç ç»“æ„ï¼Œè¿™æ— å…³bugæœ¬èº«ã€‚

## melodyWxy

hiï¼Œæ­£å¦‚ä¸Šè¿°æåˆ°çš„ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾®ä¸è¶³é“çš„å»ºè®®ï¼Œæˆ–è€…è¯´æ˜¯å…³äºreactç»„ä»¶ä»£ç ç»“æ„è§„èŒƒçš„ä¸€äº›æ€è€ƒã€‚

èƒŒæ™¯ï¼š æˆ‘æ­£åœ¨åŸºäºProComponentå°è£…æ›´ä¸Šå±‚çš„è€¦åˆäº†ä¸šåŠ¡æ¨¡å‹çš„å¤ç”¨ä¸šåŠ¡ç»„ä»¶ã€‚

æˆ‘å°†ç»„ä»¶ä¸­èƒ¶æ°´å±‚ä»£ç çš„å¯¹æ¯ä¸ªå±æ€§çš„å¤„ç†ï¼Œéƒ½å°è£…æˆä¸ºäº†ç‹¬ç«‹çš„hookï¼Œæ¯ä¸ªæ–‡ä»¶éƒ½æ²¡æœ‰è¶…è¿‡150è¡Œï¼Œè¿™ä½¿å¾—æˆ‘å¯ä»¥è½»æ˜“çš„é€šè¿‡ç‹¬ç«‹çš„åŠŸèƒ½hookæ¥æ‰¾åˆ°è¿­ä»£æˆ‘çš„åŠŸèƒ½çš„ä»£ç åŒºå—ã€‚

ç¡®è®¤åŠŸèƒ½éœ€æ±‚ => ç¡®è®¤å¯¹åº”çš„prop => æ‰¾åˆ°å¯¹åº”çš„hook => è¿­ä»£å®ƒï¼æˆ–è€…debuggerï½

äºæ˜¯å•ä¸€ç»„ä»¶ä¸­ï¼Œæˆ‘çš„ä»£ç ç»“æ„æ˜¯è¿™æ ·å­çš„ï¼š
![image](https://user-images.githubusercontent.com/44901373/180379817-d10b5114-1d2b-4276-b54c-a1f30f81b745.png)

// index.tsx

```tsx
import React, {
  useRef,
  forwardRef,
  useImperativeHandle,
  ForwardRefExoticComponent,
  PropsWithoutRef,
  RefAttributes,
} from "react";

import {
  ActionType,
  ProFormInstance,
  ProTable,
} from "@ant-design/pro-components";
import { SPFormBase } from "../../../SPForm";

import {
  useAddRecordForm,
  useAddRecordWrap,
  useColumnsProp,
  useEditableProp,
  usePaginationProp,
  useRowKeyProp,
  useSearchProp,
  useToolBarRender,
} from "./effect";

import type { XtableBaseProps, XTableRef } from "./type";

export const SPTableBase: ForwardRefExoticComponent<
  PropsWithoutRef<XtableBaseProps> & RefAttributes<XTableRef>
> = forwardRef<XTableRef, XtableBaseProps>(
  (
    {
      autoRowEditConfig,
      autoAddRecordConfig,
      editable,
      search,
      pagination,
      toolBarRender,
      request,
      rowKey,
      columns,
      tableBaseMode,
      params,
      ...otherProps
    },
    ref,
  ) => {
    // å†…ç½®åŠŸèƒ½å¤„ç† - start
    const actionRef = useRef<ActionType>();
    const queryFormRef = useRef<ProFormInstance>();
    // const effectFormRef = useRef()
    const { addRecordWrapVisible, setAddRecordWrap } = useAddRecordWrap();
    const { mergeRecordFormType, mergeRecordFormColumns } = useAddRecordForm({
      recordFormType: autoAddRecordConfig?.recordFormType,
      columns,
      steps: autoAddRecordConfig?.steps,
    });
    // å†…ç½®åŠŸèƒ½å¤„ç† - end

    // å±æ€§å°è£…å¤„ç† - start
    const mergeSearch = useSearchProp({ search });
    const mergeColumns = useColumnsProp({
      columns,
      autoRowEditConfig,
      rowKey,
      tableBaseMode,
    });
    const mergeEditable = useEditableProp({
      editable,
      actionRef,
      request,
      autoRowEditConfig,
    });
    const mergePagination = usePaginationProp({ pagination });
    const mergeRowKey = useRowKeyProp({ rowKey });
    const mergeToolBarRender = useToolBarRender({
      toolBarRender,
      setAddRecordWrap,
      autoAddRecordConfig,
      addRecordWrapVisible,
      tableBaseMode,
    });
    // å±æ€§å°è£…å¤„ç† - end

    // refè½¬å‘
    useImperativeHandle(ref, () => ({
      tableAction: actionRef,
      queryForm: queryFormRef,
    }));
    return (
      <>
        <ProTable
          formRef={queryFormRef}
          params={params}
          dateFormatter="string"
          editable={mergeEditable}
          search={mergeSearch}
          actionRef={actionRef}
          pagination={mergePagination}
          cardBordered
          toolBarRender={mergeToolBarRender}
          request={request}
          columns={mergeColumns}
          rowKey={mergeRowKey}
          {...otherProps}
        />
        <SPFormBase
          layoutType={mergeRecordFormType}
          columns={mergeRecordFormColumns}
          visible={addRecordWrapVisible}
          drawerProps={
            mergeRecordFormType === "DrawerForm"
              ? {
                  title: autoAddRecordConfig?.formTitle || "æ–°å¢",
                  destroyOnClose: true,
                  onClose: () => setAddRecordWrap(false),
                }
              : undefined
          }
          modalProps={
            mergeRecordFormType === "ModalForm"
              ? {
                  title: autoAddRecordConfig?.formTitle || "æ–°å¢",
                  destroyOnClose: true,
                  onCancel: () => setAddRecordWrap(false),
                }
              : undefined
          }
          onFinish={async (values) => {
            await autoAddRecordConfig?.onSave(values);
            setAddRecordWrap(false);
            actionRef.current?.reload();
          }}
        />
      </>
    );
  },
);

export default SPTableBase;
```

æˆ–è®¸è´µå›¢é˜Ÿæœ‰æ›´å¥½çš„æ€è€ƒå’Œè§„èŒƒï¼Œä½†è¿™ä»…ä»…æ˜¯ä¸ªå»ºè®®ï¼ŒæœŸæœ›å¸¦ç»™å¤§å®¶æ›´å¤šçš„æ€è€ƒï½

## melodyWxy

æœ‰æœ¨æœ‰ç«¥é‹å¤„ç†ä¸€ä¸‹å‘€ã€‚

## xXAvoraXx

Is this problem fixing?

## melodyWxy

> Is this problem fixing?

no

## laosandegudai

> æœ‰æœ¨æœ‰ç«¥é‹å¤„ç†ä¸€ä¸‹å‘€ã€‚

è¯·é—®æ˜¯å¦‚ä½•å¤„ç†è¿™ä¸ªé—®é¢˜çš„ï¼Œæˆ‘ç›®å‰ä¹Ÿæ˜¯å‘ç°ä½¿ç”¨äº†requeståå°±ä¼šå‡ºç°formRefæ— æ³•ä½¿ç”¨ï¼Œå»æ‰requeståå°±æ­£å¸¸äº†ã€‚
