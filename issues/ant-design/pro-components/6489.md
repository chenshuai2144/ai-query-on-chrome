# 🧐[问题] Protable如何在toolbar中filter(轻量筛选)自动传入request中filter参数？

`⭕️   bug`,`table`,`AI Reply`

### 🧐 问题描述

官方文档中有示例 [Toolbar 自定义](https://procomponents.ant.design/components/table#toolbar-%E8%87%AA%E5%AE%9A%E4%B9%89)，其中配置Protable的toolbar属性中有一个单独`filter`

```ts
toolbar={{
        filter: (
          <LightFilter>
            <ProFormDatePicker name="startdate" label="响应日期" />
          </LightFilter>
        ),
        menu: {
          type: 'tab',
          activeKey: activeKey,
          items: [
            {
              key: 'tab1',
              label: <span>应用{renderBadge(99, activeKey === 'tab1')}</span>,
            },
            {
              key: 'tab2',
              label: <span>项目{renderBadge(30, activeKey === 'tab2')}</span>,
            },
            {
              key: 'tab3',
              label: <span>文章{renderBadge(30, activeKey === 'tab3')}</span>,
            },
          ],
          onChange: (key) => {
            setActiveKey(key as string);
          },
    }
}
```

另外在`columns`定义中又有设置表头`status`可进行筛选：

```ts
const columns: ProColumns<TableListItem>[] = [
  {
    title: '应用名称',
    dataIndex: 'name',
    render: (_) => <a>{_}</a>,
  },
  // .........
  {
    title: '状态',
    dataIndex: 'status',
    initialValue: 'all',
    filters: true,  // 这里定义表头可筛选
    onFilter: true,
    valueEnum: {
      all: { text: '全部', status: 'Default' },
      close: { text: '待发布', status: 'Default' },
      running: { text: '发布中', status: 'Processing' },
      online: { text: '发布成功', status: 'Success' },
      error: { text: '发布失败', status: 'Error' },
    },
  },
  // ........
];
```

![image](https://user-images.githubusercontent.com/56813612/211306077-15223844-62a7-4fec-a43b-1eaad8419a32.png)

我的问题是：request函数签名：`(params?: {pageSize,current},sort,filter) => {data,success,total}`

1、通过对某列的表头设置`filters=true`，然后再在表头上进行筛选（类似Excel中筛选），其中request函数参数`(filter)`能拿到筛选结果（上图粉色区域内）。但是设置toolbar中filter(轻量筛选组件X)后（上图绿色区域内），并不会自动触发request，就算当前选中它的值之后，点菜单栏里面的刷新按钮手动触发request，其中filter还是没有这个(轻量筛选组件X)的值，params参数中也没有？

2、`toolbar={filter: component}`和`search={filterType: 'light'}`两者区别？我查阅了大部分案例和亲自实践后得知：

- 两者都会显示在`toolbar`区域（上图绿框内）
- `search`会自动捕获结果并将其传入`request`的`params`参数，而非`filter`！

其实这两个问题就是`toolbar={filter: component}`筛选后，怎么把值传到`request`的`filter`参数内。麻烦开发者看下，谢谢您

### 💻 示例代码

```ts
import type { ProColumns } from '@ant-design/pro-components';
import { LightFilter, ProFormDatePicker, ProTable } from '@ant-design/pro-components';
import { Badge, Button } from 'antd';
import React, { useState } from 'react';

export type TableListItem = {
  key: number;
  name: string;
  containers: number;
  status: string;
  creator: string;
  createdAt: number;
};

const valueEnum = {
  0: 'close',
  1: 'running',
  2: 'online',
  3: 'error',
};

const tableListDataSource: TableListItem[] = [];

const creators = ['付小小', '曲丽丽', '林东东', '陈帅帅', '兼某某'];

for (let i = 0; i < 5; i += 1) {
  tableListDataSource.push({
    key: i,
    name: 'AppName',
    containers: Math.floor(Math.random() * 20),
    status: valueEnum[Math.floor(Math.random() * 10) % 4],
    createdAt: Date.now() - Math.floor(Math.random() * 2000),
    creator: creators[Math.floor(Math.random() * creators.length)],
  });
}

const columns: ProColumns<TableListItem>[] = [
  {
    title: '应用名称',
    dataIndex: 'name',
    render: (_) => <a>{_}</a>,
  },
  {
    title: '创建者',
    dataIndex: 'creator',
    valueEnum: {
      all: { text: '全部' },
      付小小: { text: '付小小' },
      曲丽丽: { text: '曲丽丽' },
      林东东: { text: '林东东' },
      陈帅帅: { text: '陈帅帅' },
      兼某某: { text: '兼某某' },
    },
  },
  {
    title: '状态',
    dataIndex: 'status',
    initialValue: 'all',
    filters: true,
    onFilter: true,
    valueEnum: {
      all: { text: '全部', status: 'Default' },
      close: { text: '待发布', status: 'Default' },
      running: { text: '发布中', status: 'Processing' },
      online: { text: '发布成功', status: 'Success' },
      error: { text: '发布失败', status: 'Error' },
    },
  },
  {
    title: '容器数量',
    dataIndex: 'containers',
    align: 'right',
    sorter: (a, b) => a.containers - b.containers,
  },
  {
    title: '操作',
    key: 'option',
    width: 120,
    valueType: 'option',
    render: (_, record) => [
      record.status === 'close' && <a key="link">发布</a>,
      (record.status === 'running' || record.status === 'online') && <a key="warn">停用</a>,
      record.status === 'error' && <a key="republish">重新发布</a>,
      <a
        key="republish"
        style={
          record.status === 'running'
            ? {
                color: 'rgba(0,0,0,.25)',
                cursor: 'not-allowed',
              }
            : {}
        }
      >
        监控
      </a>,
    ],
  },
];

const renderBadge = (count: number, active = false) => {
  return (
    <Badge
      count={count}
      style={{
        marginBlockStart: -2,
        marginInlineStart: 4,
        color: active ? '#1890FF' : '#999',
        backgroundColor: active ? '#E6F7FF' : '#eee',
      }}
    />
  );
};

export default () => {
  const [activeKey, setActiveKey] = useState<React.Key>('tab1');

  return (
    <ProTable<TableListItem>
      columns={columns}
      request={(params, sorter, filter) => {
        // 表单搜索项会从 params 传入，传递给后端接口。
        console.log(params, sorter, filter);
        return Promise.resolve({
          data: tableListDataSource,
          success: true,
        });
      }}
      toolbar={{
        filter: (
          <LightFilter>
            <ProFormDatePicker name="startdate" label="响应日期" />
          </LightFilter>
        ),
        menu: {
          type: 'tab',
          activeKey: activeKey,
          items: [
            {
              key: 'tab1',
              label: <span>应用{renderBadge(99, activeKey === 'tab1')}</span>,
            },
            {
              key: 'tab2',
              label: <span>项目{renderBadge(30, activeKey === 'tab2')}</span>,
            },
            {
              key: 'tab3',
              label: <span>文章{renderBadge(30, activeKey === 'tab3')}</span>,
            },
          ],
          onChange: (key) => {
            setActiveKey(key as string);
          },
        },
        actions: [
          <Button key="primary" type="primary">
            新建应用
          </Button>,
        ],
      }}
      rowKey="key"
      pagination={{
        showQuickJumper: true,
      }}
      search={false}
      dateFormatter="string"
      options={{
        setting: {
          draggable: true,
          checkable: true,
          checkedReset: false,
          extra: [<a key="confirm">确认</a>],
        },
      }}
    />
  );
};
```

### 🚑 其他信息

<!--
如截图等其他信息可以贴在这里
-->

## drsanwujiang

同样遇到了这个问题，toolbar的filter属性目前看来并不会产生实际效果

## jeryqwq

改为渲染函数， 传入一个formRef去处理获取filter表单的值？request的时候如果有的话再merge？

## chenshuai2144

> TAutomatically replying with ChatGPT can be attempted, but it cannot be guaranteed to be completely accurate and may not fully address all issues. Please feel free to reply if you have any further questions or concerns.
> 此回复基于 ChatGPT 自动生成，可以尝试下方案，官方员会在一定时间后继续继续处理。

是的，你可以通过将filter属性改为一个函数，函数接收一个参数对象，该参数对象包含一个 ref 引用和 update、submit、reset三个回调函数。你可以通过 ref 获取表单的值，然后在调用 request 函数的时候将其 merge 到原来的 filter 中。下面是修改的代码示例，部分代码解释详见注释。

```ts
import type { FilterDropdownProps } from '@ant-design/pro-table/lib/components/Filter';
import type { ProColumns } from '@ant-design/pro-table';
import {
  LightFilter,
  ProFormDatePicker,
  ProFormSelect,
  ProFormText,
} from '@ant-design/pro-form';
import { Badge, Button } from 'antd';
import React, { useEffect, useState } from 'react';
import { request } from 'umi';

export type TableListItem = {
  key: number;
  name: string;
  containers: number;
  status: string;
  creator: string;
  createdAt: number;
};

const valueEnum = {
  0: 'close',
  1: 'running',
  2: 'online',
  3: 'error',
};

const tableListDataSource: TableListItem[] = [];

const creators = ['付小小', '曲丽丽', '林东东', '陈帅帅', '兼某某'];

for (let i = 0; i < 5; i += 1) {
  tableListDataSource.push({
    key: i,
    name: 'AppName',
    containers: Math.floor(Math.random() * 20),
    status: valueEnum[Math.floor(Math.random() * 10) % 4],
    createdAt: Date.now() - Math.floor(Math.random() * 2000),
    creator: creators[Math.floor(Math.random() * creators.length)],
  });
}

const columns: ProColumns<TableListItem>[] = [
  {
    title: '应用名称',
    dataIndex: 'name',
    render: (_) => <a>{_}</a>,
  },
  {
    title: '创建者',
    dataIndex: 'creator',
    valueEnum: {
      all: { text: '全部' },
      付小小: { text: '付小小' },
      曲丽丽: { text: '曲丽丽' },
      林东东: { text: '林东东' },
      陈帅帅: { text: '陈帅帅' },
      兼某某: { text: '兼某某' },
    },
  },
  {
    title: '状态',
    dataIndex: 'status',
    initialValue: 'all',
    filters: true,
    onFilter: true,
    valueEnum: {
      all: { text: '全部', status: 'Default' },
      close: { text: '待发布', status: 'Default' },
      running: { text: '发布中', status: 'Processing' },
      online: { text: '发布成功', status: 'Success' },
      error: { text: '发布失败', status: 'Error' },
    },
  },
  {
    title: '容器数量',
    dataIndex: 'containers',
    align: 'right',
    sorter: (a, b) => a.containers - b.containers,
  },
  {
    title: '操作',
    key: 'option',
    width: 120,
    valueType: 'option',
    render: (_, record) => [
      record.status === 'close' && <a key="link">发布</a>,
      (record.status === 'running' || record.status === 'online') && <a key="warn">停用</a>,
      record.status === 'error' && <a key="republish">重新发布</a>,
      <a
        key="republish"
        style={
          record.status === 'running'
            ? {
                color: 'rgba(0,0,0,.25)',
                cursor: 'not-allowed',
              }
            : {}
        }
      >
        监控
      </a>,
    ],
  },
];

const renderBadge = (count: number, active = false) => {
  return (
    <Badge
      count={count}
      style={{
        marginBlockStart: -2,
        marginInlineStart: 4,
        color: active ? '#1890FF' : '#999',
        backgroundColor: active ? '#E6F7FF' : '#eee',
      }}
    />
  );
};

const LightFilterContainer: React.FC<FilterDropdownProps> = ({ ref, update, submit, reset }) => {
  const [params, setParams] = useState({})
  const getData = async () => {
    const resData = await request("https://run.mocky.io/v3/945fc6a5-6b7c-4f0a-9d2d-6d026a6c07b6")
    console.log(`resData`, resData)
  }

  const onFinish = async (values: any) => {
    console.log(`onFinish`, values)
    setParams(values)
    getData()
    submit()
  }

  const onCancel = () => {
    console.log(`onCancel`)
    reset()
  }

  useEffect(() => {
    console.log(`params`, params)
    update(params)
  }, [params, update])

  return (
    <LightFilter onFinish={onFinish} onReset={onCancel}>
      <ProFormText name="name" label="应用名称" />
      <ProFormSelect
        name="creator"
        label="创建者"
        options={[
          {
            value: '付小小',
            label: '付小小',
          },
          {
            value: '曲丽丽',
            label: '曲丽丽',
          },
          {
            value: '林东东',
            label: '林东东',
          },
          {
            value: '陈帅帅',
            label: '陈帅帅',
          },
          {
            value: '兼某某',
            label: '兼某某',
          },
        ]}
      />
      <ProFormSelect.Group name="status" label="状态" width="md" >
        <ProFormSelect.Option value="close">待发布</ProFormSelect.Option>
        <ProFormSelect.Option value="running">发布中</ProFormSelect.Option>
        <ProFormSelect.Option value="online">发布成功</ProFormSelect.Option>
        <ProFormSelect.Option value="error">发布失败</ProFormSelect.Option>
      </ProFormSelect.Group>
      <ProFormDatePicker name="startdate" label="响应日期" />
    </LightFilter>
  );
}

export default () => {
  const [activeKey, setActiveKey] = useState<React.Key>('tab1');
  const filterRef = React.useRef({}).current;  // 定义一个 ref

  return (
    <ProTable<TableListItem>
      columns={columns}
      request={(params, sorter, filter) => {
        console.log(`params`, params)
        console.log(`sorter`, sorter)
        console.log(`filter`, filter)

        // 通过 ref 获取表单的值
        const formValues = filterRef?.value?.getFieldsValue() ?? {}
        console.log(`formValues`, formValues)

        // 将 formValues merge 到 filter 中
        const mergedFilter = { ...filter, ...formValues }
        console.log(`mergedFilter`, mergedFilter)

        return Promise.resolve({
          data: tableListDataSource,
          success: true,
        });
      }}
      toolbar={{
        filter: filterRef,  // 将 filter 改为组件
        menu: {
          type: 'tab',
          activeKey: activeKey,
          items: [
            {
              key: 'tab1',
              label: <span>应用{renderBadge(99, activeKey === 'tab1')}</span>,
            },
            {
              key:


## mzcc666GtHb

如果search为false ,或者filtertype 是 light 的时候, formRef 获取不到


## chenshuai2144

后期一点拿是可以拿到了，filtertype=light 也是用的一个form


```
