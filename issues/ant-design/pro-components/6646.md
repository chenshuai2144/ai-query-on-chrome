# form的某些表单项获取不到最新的uesState数据，例如ProFormCascader

`AI Reply`

提问前先看看：

https://github.com/ryanhanwu/How-To-Ask-Questions-The-Smart-Way/blob/main/README-zh_CN.md

### 🧐 问题描述

点击列表更新params后，选择ProFormCascader的一项，在onChange里拿到的params是上一次的。
在antd的Cascader里拿到的是最新的。

### 💻 示例代码

```javascript
import { useEffect, useRef, useState } from "react";
import { ProFormCascader } from "@ant-design/pro-components";
import { Cascader } from "antd";

const Reference = () => {
  const [params, setParams] = useState({});
  const [list, setList] = useState([]);
  useEffect(() => {
    getList();
  }, []);
  const getList = async () => {
    const { data } = await getCategoryList();
    setList(data);
  };
  return (
    <>
      {list.map((item, index) => {
        return (
          <div
            key={index}
            onClick={() => {
              setParams({ ...params, value: item.value });
            }}
          >
            {item.label}
          </div>
        );
      })}
      <Cascader
        options={[
          {
            value: "zhejiang",
            label: "Zhejiang",
          },
        ]}
        onChange={(e) => {
          console.log(params);
        }}
      />
      <ProFormCascader
        fieldProps={{
          options: [
            {
              value: "zhejiang",
              label: "Zhejiang",
            },
          ],
          onChange: (e) => {
            console.log(params);
          },
        }}
      />
    </>
  );
};
export default Reference;
```

### 🚑 其他信息

版本
"@ant-design/pro-components": "^2.3.50"
"umi": "3.5.26"

## chenshuai2144

> TAutomatically replying with ChatGPT can be attempted, but it cannot be guaranteed to be completely accurate and may not fully address all issues. Please feel free to reply if you have any further questions or concerns.
> 此回复基于 ChatGPT 自动生成，可以尝试下方案，官方员会在一定时间后继续继续处理。

问题的根本在于ProFormCascader是一个表单的组件，当它的值发生改变时，会先将新的值保存到其对应表单的state中，而不是直接保存到父组件的state中。

为了实时获取最新的params，我们需要使用ProFormCascader自带的表单校验方法来获取最新的值。可以通过ref拿到ProForm插件实例的方式，在需要的时候主动去获取表单的数据。具体实现可以参考如下代码：

```javascript
import { useEffect, useRef, useState } from "react";
import { ProForm, ProFormCascader } from "@ant-design/pro-form";
import { Cascader } from "antd";

const MyForm = forwardRef((props, ref) => {
  return (
    <ProForm
      ref={ref}
      onFinish={(values) => {
        console.log("表单提交的值：", values);
      }}
    >
      <ProFormCascader
        name="test_cascader"
        label="级联选择器"
        rules={[
          {
            required: true,
            message: "请选择省市区",
          },
        ]}
        fieldProps={{
          options: [
            {
              value: "zhejiang",
              label: "Zhejiang",
              children: [
                {
                  value: "hangzhou",
                  label: "Hangzhou",
                  children: [
                    {
                      value: "xihu",
                      label: "West Lake",
                    },
                  ],
                },
              ],
            },
            {
              value: "jiangsu",
              label: "Jiangsu",
              children: [
                {
                  value: "nanjing",
                  label: "Nanjing",
                  children: [
                    {
                      value: "zhonghuamen",
                      label: "Zhong Hua Men",
                    },
                  ],
                },
              ],
            },
          ],
        }}
      />
    </ProForm>
  );
});

const Reference = () => {
  const [params, setParams] = useState({});
  const myFormRef = useRef(null);

  const handleClick = () => {
    myFormRef.current?.validateFields().then((values) => {
      console.log("当前表单的值：", values.test_cascader);
      setParams({
        value: values.test_cascader ? values.test_cascader.join("/") : "",
      });
    });
  };

  return (
    <>
      <div onClick={handleClick}>点击获取最新的值</div>
      <Cascader
        options={[
          {
            value: "zhejiang",
            label: "Zhejiang",
          },
        ]}
        onChange={(e) => {
          console.log(params);
        }}
      />
      <MyForm ref={myFormRef} />
    </>
  );
};

export default Reference;
```

在这个示例代码中，我们创建了一个<button>标签，来触发获取值的操作，点击蓝色字体可以看到live demo效果，相关的文档可以参考ProForm相关文档。

## chenshuai2144

hooks 中的数据是有一些延迟的，要注意 render 的时机和 setState 的时机配合
