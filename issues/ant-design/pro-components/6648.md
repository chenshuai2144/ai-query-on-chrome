# 🐛[BUG]ProForm的formRef或者form，调用getFieldInstance方法获取ProformText，只能得到undefined，但是Input就可以正确拿到值

`AI Reply`

### 🐛 bug 描述

ProForm的formRef，调用setFieldsValue正常，但是调用getFieldInstance方法获取ProformText，只能得到undefined

### 💻 复现代码

```
import { Button, Form, Input } from 'antd'
import { ProForm, ProFormText, ProFormInstance } from '@ant-design/pro-components';
import { useRef } from 'react'

export default () => {

    //const [form] = Form.useForm()
    const form =ProForm.useFormInstance()
    const formRef = useRef<ProFormInstance>()

    return (

        <>
            <ProForm
                form={form}
                formRef={formRef}
            >
                <Form.Item name='hello'>
                    <Input />
                </Form.Item>

                <ProFormText name='world' />
            </ProForm>ld
            <Button type='primary' onClick={() => {
                console.log('form=Form.useForm()获取到的值hello', form?.getFieldInstance('hello')) // 获取到input
                console.log('form=Form.useForm()获取到的值world', form?.getFieldInstance('world')) // undefined
                console.log('form=ProForm.useFormInstance()获取到的值hello', form?.getFieldInstance('hello')) // undefined
                console.log('form=ProForm.useFormInstance()获取到的值world', form?.getFieldInstance('world')) // undefined
                console.log('formRef获取到的值hello', formRef?.current?.getFieldInstance('hello')) // 获取到input
                console.log('formRef获取到的值world', formRef?.current?.getFieldInstance('world')) // undefined
            }}>获取</Button>
        </>

    )
}
```

### © 版本信息

- ProComponents 版本: ^2.3.54
- umi 版本
- 浏览器环境:Google Chrome
- 开发环境 win11

## chenshuai2144

> TAutomatically replying with ChatGPT can be attempted, but it cannot be guaranteed to be completely accurate and may not fully address all issues. Please feel free to reply if you have any further questions or concerns.
> 此回复基于 ChatGPT 自动生成，可以尝试下方案，官方员会在一定时间后继续继续处理。

### 🔍问题分析

根据提供的代码，我们可以看到存在 `form` 和 `formRef` 两个不同的表单实例。其中 `form` 是使用 `ProForm.useFormInstance()` 方法获取的，`formRef` 是使用 `useRef()` 创建的并将其传递到 `ProForm` 的 `formRef`属性上。

针对这个问题，我们需要查看 `getFieldInstance` 方法的实现过程，可以从 `@ant-design/pro-utils` 包中查看该方法的具体实现和内部实现是否存在错误。

同时我们需要考虑 ProFormText 组件和表单实例之间的关系，因为只有在 ProFormText 实例注册到表单实例时，才会正常获取其实例并使用 `getFieldInstance` 方法。

### 🌱 解决方案

我们可以尝试将 `form` 和 `formRef` 两个表单实例显式地声明为 `ProFormInstance` 类型，示例如下：

```jsx
import { Button, Form, Input } from 'antd';
import { ProForm, ProFormText } from '@ant-design/pro-components';
import type ProFormInstance from '@ant-design/pro-form/lib/interface';

const MyForm = () => {
  const formRef = useRef<ProFormInstance>(null);
  const [form] = ProForm.useFormInstance<ProFormInstance>();

  useEffect(() => {
    // 注册表单项，这里是在组件 mount 后注册
    formRef.current?.setFieldInstance('world', [null]);
  }, []);

  return (
    <ProForm form={form} formRef={formRef}>
      <Form.Item name="hello">
        <Input />
      </Form.Item>

      <ProFormText name="world" />
      <Button
        onClick={() => {
          console.log('form.getFieldInstance(hello)', form.getFieldInstance('hello'));
          console.log('form.getFieldInstance(world)', form.getFieldInstance('world'));
          console.log('formRef.getFieldInstance(hello)', formRef.current?.getFieldInstance('hello'));
          console.log('formRef.getFieldInstance(world)', formRef.current?.getFieldInstance('world'));
        }}
      >
        获取
      </Button>
    </ProForm>
  );
}

export default MyForm;
```

从代码中可以看到，我们需要在 `useEffect` 回调中为 `ProFormText` 注册到表单实例中，以确保能够正常获取其实例。此外，需要注意的是 `formRef.current` 可能为空，因此需要在调用方法时做好空值判断。

### 📚 文档参考

- @ant-design/pro-utils 的 getFieldInstance 方法实现
- @ant-design/pro-form 的 useFormInstance 方法
- @ant-design/pro-form 的 ProFormInstance 接口类型定义
