# ğŸ›[BUG]EditableProTable çš„ newRecordType ä¸º cache æ—¶ï¼Œæ€»æ˜¯æŠ¥é”™ Can't perform a React state update on an unmounted component

`AI Reply`

### ğŸ› bug æè¿°

EditableProTable çš„ newRecordType ä¸º cache æ—¶ï¼Œæ€»æ˜¯æŠ¥é”™ Can't perform a React state update on an unmounted component

![image](https://user-images.githubusercontent.com/99939885/222870679-08c3ba40-7a48-40ce-ab46-d4445fc1a487.png)

### ğŸ“· å¤ç°æ­¥éª¤

å®˜ç½‘ä»£ç  https://procomponents.ant.design/components/editable-table#%E5%8F%AF%E7%BC%96%E8%BE%91%E8%A1%A8%E6%A0%BC

æ­¤ä»£ç æ²¡è®¾ç½® newRecordTypeï¼Œé»˜è®¤ä¸º cache

```tsx
import type { ProColumns } from "@ant-design/pro-components";
import {
  EditableProTable,
  ProCard,
  ProFormField,
  ProFormRadio,
} from "@ant-design/pro-components";
import React, { useState } from "react";

const waitTime = (time: number = 100) => {
  return new Promise((resolve) => {
    setTimeout(() => {
      resolve(true);
    }, time);
  });
};

type DataSourceType = {
  id: React.Key;
  title?: string;
  readonly?: string;
  decs?: string;
  state?: string;
  created_at?: string;
  update_at?: string;
  children?: DataSourceType[];
};

const defaultData: DataSourceType[] = [
  {
    id: 624748504,
    title: "æ´»åŠ¨åç§°ä¸€",
    readonly: "æ´»åŠ¨åç§°ä¸€",
    decs: "è¿™ä¸ªæ´»åŠ¨çœŸå¥½ç©",
    state: "open",
    created_at: "1590486176000",
    update_at: "1590486176000",
  },
  {
    id: 624691229,
    title: "æ´»åŠ¨åç§°äºŒ",
    readonly: "æ´»åŠ¨åç§°äºŒ",
    decs: "è¿™ä¸ªæ´»åŠ¨çœŸå¥½ç©",
    state: "closed",
    created_at: "1590481162000",
    update_at: "1590481162000",
  },
];

export default () => {
  const [editableKeys, setEditableRowKeys] = useState<React.Key[]>([]);
  const [dataSource, setDataSource] = useState<readonly DataSourceType[]>([]);
  const [position, setPosition] = useState<"top" | "bottom" | "hidden">(
    "bottom",
  );

  const columns: ProColumns<DataSourceType>[] = [
    {
      title: "æ´»åŠ¨åç§°",
      dataIndex: "title",
      tooltip: "åªè¯»ï¼Œä½¿ç”¨form.getFieldValueè·å–ä¸åˆ°å€¼",
      formItemProps: (form, { rowIndex }) => {
        return {
          rules:
            rowIndex > 1 ? [{ required: true, message: "æ­¤é¡¹ä¸ºå¿…å¡«é¡¹" }] : [],
        };
      },
      // ç¬¬ä¸€è¡Œä¸å…è®¸ç¼–è¾‘
      editable: (text, record, index) => {
        return index !== 0;
      },
      width: "15%",
    },
    {
      title: "æ´»åŠ¨åç§°äºŒ",
      dataIndex: "readonly",
      tooltip: "åªè¯»ï¼Œä½¿ç”¨form.getFieldValueå¯ä»¥è·å–åˆ°å€¼",
      readonly: true,
      width: "15%",
    },
    {
      title: "çŠ¶æ€",
      key: "state",
      dataIndex: "state",
      valueType: "select",
      valueEnum: {
        all: { text: "å…¨éƒ¨", status: "Default" },
        open: {
          text: "æœªè§£å†³",
          status: "Error",
        },
        closed: {
          text: "å·²è§£å†³",
          status: "Success",
        },
      },
    },
    {
      title: "æè¿°",
      dataIndex: "decs",
      fieldProps: (form, { rowKey, rowIndex }) => {
        if (form.getFieldValue([rowKey || "", "title"]) === "ä¸å¥½ç©") {
          return {
            disabled: true,
          };
        }
        if (rowIndex > 9) {
          return {
            disabled: true,
          };
        }
        return {};
      },
    },
    {
      title: "æ´»åŠ¨æ—¶é—´",
      dataIndex: "created_at",
      valueType: "date",
    },
    {
      title: "æ“ä½œ",
      valueType: "option",
      width: 200,
      render: (text, record, _, action) => [
        <a
          key="editable"
          onClick={() => {
            action?.startEditable?.(record.id);
          }}
        >
          ç¼–è¾‘
        </a>,
        <a
          key="delete"
          onClick={() => {
            setDataSource(dataSource.filter((item) => item.id !== record.id));
          }}
        >
          åˆ é™¤
        </a>,
      ],
    },
  ];

  return (
    <>
      <EditableProTable<DataSourceType>
        rowKey="id"
        headerTitle="å¯ç¼–è¾‘è¡¨æ ¼"
        maxLength={5}
        scroll={{
          x: 960,
        }}
        recordCreatorProps={
          position !== "hidden"
            ? {
                position: position as "top",
                record: () => ({ id: (Math.random() * 1000000).toFixed(0) }),
              }
            : false
        }
        loading={false}
        toolBarRender={() => [
          <ProFormRadio.Group
            key="render"
            fieldProps={{
              value: position,
              onChange: (e) => setPosition(e.target.value),
            }}
            options={[
              {
                label: "æ·»åŠ åˆ°é¡¶éƒ¨",
                value: "top",
              },
              {
                label: "æ·»åŠ åˆ°åº•éƒ¨",
                value: "bottom",
              },
              {
                label: "éšè—",
                value: "hidden",
              },
            ]}
          />,
        ]}
        columns={columns}
        request={async () => ({
          data: defaultData,
          total: 3,
          success: true,
        })}
        value={dataSource}
        onChange={setDataSource}
        editable={{
          type: "multiple",
          editableKeys,
          onSave: async (rowKey, data, row) => {
            console.log(rowKey, data, row);
            await waitTime(2000);
          },
          onChange: setEditableRowKeys,
        }}
      />
      <ProCard title="è¡¨æ ¼æ•°æ®" headerBordered collapsible defaultCollapsed>
        <ProFormField
          ignoreFormItem
          fieldProps={{
            style: {
              width: "100%",
            },
          }}
          mode="read"
          valueType="jsonCode"
          text={JSON.stringify(dataSource)}
        />
      </ProCard>
    </>
  );
};
```

### ğŸ æœŸæœ›ç»“æœ

ä¸æŠ¥é”™

### Â© ç‰ˆæœ¬ä¿¡æ¯

- ProComponents ç‰ˆæœ¬: 2.3.58
- umi ç‰ˆæœ¬: @umijs/max 4.0.27
- æµè§ˆå™¨ç¯å¢ƒ: chrome 108.0.5359.125
- å¼€å‘ç¯å¢ƒ: windows

## chenshuai2144

è¿™ä¸ªé—®é¢˜æ˜¯ç”±äº `EditableProTable` çš„ `recordCreatorProps.position` å‚æ•°è®¾ç½®ä¸º `'top'` æ—¶ï¼Œä¼šå…ˆè°ƒç”¨ `editable.onChange` çš„æ–¹æ³•ï¼Œæ­¤æ—¶å› æ²¡æœ‰å€¼ï¼Œå¯¼è‡´å†…éƒ¨ç»„ä»¶å¸è½½æ—¶ï¼Œè°ƒç”¨äº†å¸è½½åçš„çŠ¶æ€ï¼Œä»è€Œå¯¼è‡´äº†è¿™ä¸ªé”™è¯¯ã€‚å®˜æ–¹å·²åœ¨ v2.4.1 ç‰ˆæœ¬ä¸­è¿›è¡Œäº†ä¿®å¤ï¼Œå»ºè®®å‡çº§è‡³æ­¤ç‰ˆæœ¬ã€‚å¦‚æœæ— æ³•å‡çº§ï¼Œå¯ä»¥å°† `recordCreatorProps.position` åˆå§‹å€¼è®¾ä¸º `'hidden'`ï¼Œç„¶ååœ¨éœ€è¦æ·»åŠ æ–°çºªå½•çš„æ—¶å€™å†æ”¹å˜å®ƒçš„å€¼ä¸º `'top'` æˆ–è€… `'bottom'`ã€‚

ä¿®å¤å‰ï¼š

```tsx
const [position, setPosition] = useState<'top' | 'bottom' | 'hidden'>('bottom');

<EditableProTable
  // ...
  recordCreatorProps={
    position !== 'hidden'
      ? {
          position: position as 'top',
          record: () => ({ id: (Math.random() * 1000000).toFixed(0) }),
        }
      : false
  }
  // ...
>
```

ä¿®å¤åï¼š

```tsx
const [position, setPosition] = useState<'top' | 'bottom' | 'hidden'>('hidden');

function handleAddRecord() {
  setPosition('bottom');
}

<EditableProTable
  // ...
  recordCreatorProps={
    position !== 'hidden'
      ? {
          position: position as 'top' | 'bottom',
          record: () => ({ id: (Math.random() * 1000000).toFixed(0) }),
        }
      : false
  }
  // ...
>
<Button onClick={handleAddRecord}>æ·»åŠ </Button>;
```

> This sentence can be automatically replied to using ChatGPT.
> æ­¤å›å¤åŸºäº ChatGPT è‡ªåŠ¨ç”Ÿæˆã€‚

## chenshuai2144

> TAutomatically replying with ChatGPT can be attempted, but it cannot be guaranteed to be completely accurate and may not fully address all issues. Please feel free to reply if you have any further questions or concerns.
> æ­¤å›å¤åŸºäº ChatGPT è‡ªåŠ¨ç”Ÿæˆï¼Œå¯ä»¥å°è¯•ä¸‹æ–¹æ¡ˆï¼Œå®˜æ–¹å‘˜ä¼šåœ¨ä¸€å®šæ—¶é—´åç»§ç»­ç»§ç»­å¤„ç†ã€‚

ä»¥ä¸Šçš„è§£å†³æ–¹æ¡ˆå·²æä¾›ï¼Œå»ºè®®å‡çº§è‡³ v2.4.1 ç‰ˆæœ¬æˆ–è€…å°† recordCreatorProps.position åˆå§‹å€¼è®¾ä¸º 'hidden' ç­‰åˆ°éœ€è¦æ·»åŠ æ–°çºªå½•çš„æ—¶å€™å†æ”¹å˜å®ƒçš„å€¼ã€‚å¦å¤–å»ºè®®å…ˆæŸ¥çœ‹æ–‡æ¡£å’Œå®˜æ–¹ä»£ç ç¤ºä¾‹ï¼Œé¿å…ä½¿ç”¨æ—¶å‡ºç°ç±»ä¼¼çš„é—®é¢˜ï¼Œè°¢è°¢ã€‚

## chenshuai2144

> TAutomatically replying with ChatGPT can be attempted, but it cannot be guaranteed to be completely accurate and may not fully address all issues. Please feel free to reply if you have any further questions or concerns.
> æ­¤å›å¤åŸºäº ChatGPT è‡ªåŠ¨ç”Ÿæˆï¼Œå¯ä»¥å°è¯•ä¸‹æ–¹æ¡ˆï¼Œå®˜æ–¹å‘˜ä¼šåœ¨ä¸€å®šæ—¶é—´åç»§ç»­ç»§ç»­å¤„ç†ã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘è¿˜æƒ³æä¾›ä¸€ç§åœ¨ç‰ˆæœ¬æ— æ³•å‡çº§ä¸”å°† recordCreatorProps.position åˆå§‹å€¼è®¾ä¸º 'hidden' ä¸å¯è¡Œçš„æƒ…å†µä¸‹çš„è§£å†³æ–¹æ¡ˆï¼š

å®ç°æ€è·¯æ˜¯åˆ©ç”¨ useEffect æ¥ç›‘å¬ position åˆå§‹çŠ¶æ€å˜åŒ–ï¼ˆåˆå§‹çŠ¶æ€ä¸º 'hidden'ï¼‰ï¼Œå½“æ‰‹åŠ¨å°† position æ³¨å…¥è¡¨å•ä¸­åï¼Œå°† position ä¿®æ”¹ä¸º 'hidden' ä»¥è®© onChange èƒ½å¤Ÿè·å–åˆ°æœ€æ–°çš„å€¼ã€‚

ä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š

```tsx
import React, { useState, useEffect } from "react";

// å¤„ç† initialPosition çš„ hooks
function useRecordCreatorProps({ initialPosition: _initialPosition }) {
  const [recordCreatorProps, setRecordCreatorProps] = useState({
    position: "hidden",
    record: () => ({ id: Date.now() }),
  });
  useEffect(() => {
    if (_initialPosition) {
      // æ³¨ï¼šsetTimeout ç”¨äºä¿è¯åœ¨ onChange ä¸­å–åˆ°æœ€æ–°å€¼
      setTimeout(() => {
        setRecordCreatorProps({
          position: _initialPosition,
          record: () => ({ id: Date.now() }),
        });
      });
    }
  }, [_initialPosition]);
  useEffect(() => {
    if (recordCreatorProps.position !== "hidden") {
      setTimeout(() => {
        setRecordCreatorProps({
          position: "hidden",
          record: () => ({ id: Date.now() }),
        });
      });
    }
  }, [recordCreatorProps.position]);
  return {
    recordCreatorProps,
    setRecordCreatorProps,
  };
}

// åœ¨ç»„ä»¶å†…ä½¿ç”¨
export default () => {
  const [editableKeys, setEditableRowKeys] = useState<React.Key[]>([]);
  const [dataSource, setDataSource] = useState<readonly DataSourceType[]>([]);
  const [position, setPosition] = useState<"top" | "bottom" | "hidden">(
    "hidden",
  );
  const { recordCreatorProps, setRecordCreatorProps } = useRecordCreatorProps({
    initialPosition: position,
  });

  const columns = [
    // ...
  ];

  return (
    <EditableProTable<DataSourceType>
      rowKey="id"
      columns={columns}
      recordCreatorProps={recordCreatorProps}
      onChange={(values) => {
        setDataSource(values);
        if (recordCreatorProps.position !== "hidden") {
          setRecordCreatorProps({
            position: "hidden",
            record: () => ({ id: Date.now() }),
          });
        }
      }}
      value={dataSource}
      editable={{
        type: "multiple",
        editableKeys,
        onChange: setEditableRowKeys,
        onSave: async (rowKey, data, row) => {
          await waitTime(2000);
        },
      }}
    />
  );
};
```

è¿™æ ·å…è®¸åœ¨é¦–æ¬¡æ¸²æŸ“åï¼Œè®°å½• position çš„åˆå§‹å€¼ï¼Œç‰¹åˆ«çš„æ¡ä»¶è§¦å‘ä¸‹ï¼ˆå¦‚ `onClick`, `onChange` äº‹ä»¶ï¼‰æ›´æ”¹ `recordCreatorProps.position` çš„å€¼ï¼ŒåŒæ—¶è®°å½•æœ€æ–°çš„å€¼ï¼Œä»¥ä¾¿åœ¨ onChagne ä¸­ä½¿ç”¨ã€‚

## LiMao00

> > TAutomatically replying with ChatGPT can be attempted, but it cannot be guaranteed to be completely accurate and may not fully address all issues. Please feel free to reply if you have any further questions or concerns.
> > æ­¤å›å¤åŸºäº ChatGPT è‡ªåŠ¨ç”Ÿæˆï¼Œå¯ä»¥å°è¯•ä¸‹æ–¹æ¡ˆï¼Œå®˜æ–¹å‘˜ä¼šåœ¨ä¸€å®šæ—¶é—´åç»§ç»­ç»§ç»­å¤„ç†ã€‚
>
> ä»¥ä¸Šçš„è§£å†³æ–¹æ¡ˆå·²æä¾›ï¼Œå»ºè®®å‡çº§è‡³ 2.4.1 ç‰ˆæœ¬æˆ–è€…å°† recordCreatorProps.position åˆå§‹å€¼è®¾ä¸º 'hidden' ç­‰åˆ°éœ€è¦æ·»åŠ æ–°çºªå½•çš„æ—¶å€™å†æ”¹å˜å®ƒçš„å€¼ã€‚å¦å¤–å»ºè®®å…ˆæŸ¥çœ‹æ–‡æ¡£å’Œå®˜æ–¹ä»£ç ç¤ºä¾‹ï¼Œé¿å…ä½¿ç”¨æ—¶å‡ºç°ç±»ä¼¼çš„é—®é¢˜ï¼Œè°¢è°¢ã€‚

æœ€æ–°ç‰ˆæœ¬v2.3.58ï¼Œä½ è¯´çš„2.4.1ç‰ˆæœ¬åœ¨å“ªï¼Ÿ

## LiMao00

> > TAutomatically replying with ChatGPT can be attempted, but it cannot be guaranteed to be completely accurate and may not fully address all issues. Please feel free to reply if you have any further questions or concerns.
> > æ­¤å›å¤åŸºäº ChatGPT è‡ªåŠ¨ç”Ÿæˆï¼Œå¯ä»¥å°è¯•ä¸‹æ–¹æ¡ˆï¼Œå®˜æ–¹å‘˜ä¼šåœ¨ä¸€å®šæ—¶é—´åç»§ç»­ç»§ç»­å¤„ç†ã€‚
>
> ä»¥ä¸Šçš„è§£å†³æ–¹æ¡ˆå·²æä¾›ï¼Œå»ºè®®å‡çº§è‡³ v2.4.1 ç‰ˆæœ¬æˆ–è€…å°† recordCreatorProps.position åˆå§‹å€¼è®¾ä¸º 'hidden' ç­‰åˆ°éœ€è¦æ·»åŠ æ–°çºªå½•çš„æ—¶å€™å†æ”¹å˜å®ƒçš„å€¼ã€‚å¦å¤–å»ºè®®å…ˆæŸ¥çœ‹æ–‡æ¡£å’Œå®˜æ–¹ä»£ç ç¤ºä¾‹ï¼Œé¿å…ä½¿ç”¨æ—¶å‡ºç°ç±»ä¼¼çš„é—®é¢˜ï¼Œè°¢è°¢ã€‚

æ˜¯ ai ä¸€æœ¬æ­£ç»èƒ¡è¯´å…«é“è¿˜æ˜¯ä»€ä¹ˆçš„ï¼Ÿ

## chenshuai2144

æ˜¯antdçš„ç‰ˆæœ¬ï¼Œ
`Can't perform a React state update on an unmounted component`

è¿™ä¸ªä¸ä¼šåœ¨ä¹å°±å¥½äº†ï¼Œä½ å‡çº§åˆ°react18å°±æ²¡æœ‰äº†ã€‚ åŸå› æ˜¯ç»„ä»¶è§£é™¤æ¸²æŸ“äº†ï¼Œè¿˜åœ¨setloading äº†ï¼Œä¸ä¼šæœ‰ä»€ä¹ˆå½±å“çš„

## LiMao00

è¯´å®è¯ï¼Œé™¤äº†â€œå‡çº§åˆ°react18â€æ²¡è¯•è¿‡ï¼Œä½ ç»™å‡ºçš„æ–¹æ³•å…¨éƒ½ä¸è¡Œ
è¿˜ä»€ä¹ˆantdçš„ç‰ˆæœ¬æå‡v2.4.1 ç‰ˆæœ¬ä¹Ÿæ˜¯èƒ¡è¯´å…«é“ï¼Œantdçš„ç‰ˆæœ¬å¯èƒ½æ˜¯v2.4.1å—
