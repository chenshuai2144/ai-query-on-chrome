# 🧐[问题]表单重复提交问题

`AI Reply`

提问前先看看：

https://github.com/ryanhanwu/How-To-Ask-Questions-The-Smart-Way/blob/main/README-zh_CN.md

### 🧐 问题描述

表单重复提交

ahooks useRequest进行提交防抖
结合ModalForm进行提交

### 💻 示例代码

https://codesandbox.io/s/repeat-phdsc0?file=/submit.tsx

### 🚑 其他信息

## chenshuai2144

> TAutomatically replying with ChatGPT can be attempted, but it cannot be guaranteed to be completely accurate and may not fully address all issues. Please feel free to reply if you have any further questions or concerns.
> 此回复基于 ChatGPT 自动生成，可以尝试下方案，官方人员会在一定时间后继续继续处理。

### 解决方案

表单重复提交问题可以通过以下几种方式解决：

#### 1. 前端处理

前端可以通过将提交按钮设置为 disabled，在提交请求发送之前添加一个锁来防止重复提交。也可以在发送请求后，判断服务器端响应的状态码，如果为成功状态码再进行下一步操作。

```jsx
import { useState } from "react";
import { useRequest } from "ahooks";
import { Modal, Button } from "antd";

export default function ModalForm() {
  const [isModalVisible, setIsModalVisible] = useState(false);
  const [submitting, setSubmitting] = useState(false);
  const [form] = Form.useForm();

  const { run } = useRequest(
    (values) =>
      new Promise((resolve) => {
        setTimeout(() => {
          resolve(values);
        }, 2000);
      }),
    {
      manual: true,
      onSuccess: () => {
        setIsModalVisible(false);
        setSubmitting(false);
        form.resetFields();
      },
    },
  );

  const handleSubmit = (values) => {
    setSubmitting(true);
    run(values);
  };

  return (
    <>
      <Button onClick={() => setIsModalVisible(true)}>打开 Modal</Button>
      <Modal
        title="表单"
        visible={isModalVisible}
        onCancel={() => setIsModalVisible(false)}
        footer={[
          <Button key="back" onClick={() => setIsModalVisible(false)}>
            取消
          </Button>,
          <Button
            key="submit"
            type="primary"
            onClick={() => form.submit()}
            disabled={submitting} // 添加提交按钮的 disabled 属性
          >
            提交
          </Button>,
        ]}
      >
        <Form
          form={form}
          onFinish={handleSubmit}
          // 在提交函数中添加锁，禁止重复提交
          onFinishFailed={() => {
            setSubmitting(false);
          }}
        >
          <Form.Item
            label="用户名"
            name="username"
            rules={[{ required: true, message: "请输入用户名" }]}
          >
            <Input />
          </Form.Item>
          <Form.Item
            label="密码"
            name="password"
            rules={[{ required: true, message: "请输入密码" }]}
          >
            <Input.Password />
          </Form.Item>
        </Form>
      </Modal>
    </>
  );
}
```

#### 2. 后端处理

后端可以在接收到提交请求时，生成一个唯一标识符，将该标识符存储在服务器端，同时将其作为响应的一部分返回给前端。

前端在接收到响应后，在下一次发送请求时，将该标识符作为参数添加到请求中，后端收到请求后，判断该标识符是否已经存在，以此判断是否为重复提交。

```jsx
import { useState } from "react";
import { useRequest } from "ahooks";
import { Modal, Button } from "antd";

export default function ModalForm() {
  const [isModalVisible, setIsModalVisible] = useState(false);
  const [submitting, setSubmitting] = useState(false);
  const [form] = Form.useForm();
  const [submitId, setSubmitId] = useState(null); // 添加标识符的状态

  const { run } = useRequest(
    (values, submitId) =>
      new Promise((resolve) => {
        setTimeout(() => {
          resolve(values);
        }, 2000);
      }).then((res) => {
        setSubmitId(null);
        return res;
      }),
    {
      manual: true,
      onSuccess: () => {
        setIsModalVisible(false);
        setSubmitting(false);
        form.resetFields();
      },
    },
  );

  const handleSubmit = (values) => {
    if (!submitId) {
      // 标识符不存在才进行提交
      setSubmitting(true);
      setSubmitId(Date.now()); // 设置标识符为当前时间戳
      run(values, submitId);
    }
  };

  return (
    <>
      <Button onClick={() => setIsModalVisible(true)}>打开 Modal</Button>
      <Modal
        title="表单"
        visible={isModalVisible}
        onCancel={() => setIsModalVisible(false)}
        footer={[
          <Button key="back" onClick={() => setIsModalVisible(false)}>
            取消
          </Button>,
          <Button
            key="submit"
            type="primary"
            onClick={() => form.submit()}
            disabled={submitting} // 添加提交按钮的 disabled 属性
          >
            提交
          </Button>,
        ]}
      >
        <Form
          form={form}
          onFinish={handleSubmit}
          // 在提交函数中添加锁，禁止重复提交
          onFinishFailed={() => {
            setSubmitting(false);
            setSubmitId(null);
          }}
        >
          <Form.Item
            label="用户名"
            name="username"
            rules={[{ required: true, message: "请输入用户名" }]}
          >
            <Input />
          </Form.Item>
          <Form.Item
            label="密码"
            name="password"
            rules={[{ required: true, message: "请输入密码" }]}
          >
            <Input.Password />
          </Form.Item>
          <input type="hidden" name="submitId" value={submitId} /> //
          将标识符作为参数添加到请求中
        </Form>
      </Modal>
    </>
  );
}
```

#### 参考文档

- [防止重复提交的方法](https://cn.bing.com/search?q=%E9%98%B2%E6%AD%A2%E9%87%8D%E5%A4%8D%E6%8F%90%E4%BA%A4%E7%9A%84%E6%96%B9%E6%B3%95&cvid=ac5e191bfdd14a43b2a99622555df1a3&aqs=edge..69i57.299j0j1&FORM=ANAB01&PC=EDGEDBB)
