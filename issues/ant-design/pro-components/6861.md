# @ant-design/pro-layout 服务器动态加载路由菜单报错 🐛[BUG]

`AI Reply`

### 🐛 bug 描述

![image](https://user-images.githubusercontent.com/20655248/228160761-30611450-8bc8-4beb-a5de-b4303e8d3832.png)
pageage.json 删除@ant-design/pro-layout 6.27.2版本，取@ant-design/pro-components里的layout版本，在node_modules里面看layout版本为7.6.0，结果动态加载路由菜单出现控制台报错，左侧的路由菜单出现异常， @ant-design/pro-layout 6.27.2版本不会出现控制台报错，7.6.0版本会出现控制台报错。如图

![image](https://user-images.githubusercontent.com/20655248/228161516-ead6cc0a-f818-425a-acf0-90ff4a2075c5.png)

代码如下

![image](https://user-images.githubusercontent.com/20655248/228161700-7af5a79e-02f1-4595-a34b-799be456f598.png)

### © 版本信息

- ProComponents 版本: [e.g. 5.0.0]
- umi 版本
- 浏览器环境
- 开发环境 [e.g. mac OS]

### 🚑 其他信息

<!--
如截图等其他信息可以贴在这里
-->

## chenshuai2144

> TAutomatically replying with ChatGPT can be attempted, but it cannot be guaranteed to be completely accurate and may not fully address all issues. Please feel free to reply if you have any further questions or concerns.
> 此回复基于 ChatGPT 自动生成，可以尝试下方案，官方人员会在一定时间后继续继续处理。

### 可能解决办法

尝试使用 @ant-design/pro-layout 最新版本（目前是 7.11.0），并查看相应的文档适配更新版本的 API。如果你不想更新版本，也可以按照下面的方法进行解决。

根据控制台的报错信息，大概可以判断问题出现在 ProMenu 组件中。这里有两种可能的解决办法：

#### 解决办法一

在使用 ProMenu 组件的地方，手动为其添加 onOpenChange 和 selectedKeys 两个属性。可参考下面的代码。

```jsx
import { useState } from 'react';
import { useIntl } from 'umi';
import { getMenuData, getPageTitle } from '@ant-design/pro-layout';
import ProMenu from '@ant-design/pro-menu';

const BasicLayout = (props) => {
  const {
    children,
    location = {
      pathname: '/',
    },
  } = props;
  const { formatMessage } = useIntl();
  const menuDataRef = useRef([]);
  const [collapsed, setCollapsed] = useState(false);
  const [openKeys, setOpenKeys] = useState<string[]>([]);
  const [selectedKeys, setSelectedKeys] = useState<string[]>([]);
  const menuData = useMemo(() => getMenuData(), []);
  useEffect(() => {
    const { query } = location;
    const isMatch = (pathname: string, breadcrumbMap: any) => {
      const pathKey = Object.keys(breadcrumbMap).find((key) => pathToRegexp(key).test(pathname));
      return breadcrumbMap[pathKey];
    };
    const pathname = getMenuMatchKeys(menuData, location.pathname)
      .map((item) => item.path)
      .filter((item) => item && !item.startsWith('#'))
      .join('') as string;
    const pageTitleInfo = getPageTitle({
      pathname,
      formatMessage,
      breadcrumb: getMenuData(),
      ...props,
    });
    // set page title
    document.title = pageTitleInfo.pageTitle || pageTitleInfo.title;
    menuDataRef.current = isMatch(pathname, breadcrumbMap)?.breadcrumb || [];
    setSelectedKeys([pathname]);
  }, [location.pathname]);
  const handleMenuCollapse = (payload: boolean) => {
    setCollapsed(payload);
  };
  const menu = useMemo(
    () => (
      <ProMenu
        style={{
          width: collapsed ? 80 : 256,
        }}
        title="Ant Design Pro"
        selectedKeys={selectedKeys}
        onOpenChange={setOpenKeys}
        request={{
          url: '/api/menus',
        }}
        {...props}
        menuData={menuData}
        collapsed={collapsed}
        location={location}
        isMobile={false}
        onCollapse={handleMenuCollapse}
      />
    ),
    [collapsed, location.pathname],
  );
  return (
    <div style={{ height: '100%' }}>
      {menu}
      <div style={{ height: 'calc(100vh - 64px)' }}>{children}</div>
    </div>
  );
};

export default BasicLayout;

```

#### 解决办法二

手动修改 ProMenu 组件的源码。目前这个问题在 ProMenu 的 issue 地址上已经有了修复，但还未合并到正式版中。如果你想体验此解决办法，请在 node_modules/@ant-design/pro-layout/lib/ProMenu.js 文件中找到下面这段代码

```js
controlledKeysChanged: function controlledKeysChanged(_, _ref) {
  var selectedKeys = _ref.selectedKeys;

  _this.setState({
    selectedKeys: selectedKeys,
  });
}
```

并修改为以下内容：

```js
controlledKeysChanged: function controlledKeysChanged(
  prevProps,
  { selectedKeys },
) {
  const { selectedKeys: selectedKeysPro } = this.props;
  if (
    selectedKeysPro !== undefined &&
    prevProps &&
    prevProps.selectedKeys === selectedKeysPro
  ) {
    // if it's not pro-components call, do not update
    return;
  }
  this.setState({
    selectedKeys,
  });
}
```

此方法需要手动修改源码并保存，不太友好。建议尝试第一种解决办法。

## chenshuai2144

key 相同了，处理一下你的数据吧，路径不要相同，或者 专门设置一个 key
