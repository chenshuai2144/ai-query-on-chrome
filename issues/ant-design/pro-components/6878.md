# 🐛[BUG] NextJs Prolayout Error 【Unhandled Runtime Error Error: Hydration failed because the initial UI does not match what was rendered on the server】

`AI Reply`

提问前先看看：

https://github.com/ryanhanwu/How-To-Ask-Questions-The-Smart-Way/blob/main/README-zh_CN.md

### 🐛 bug 描述

Unhandled Runtime Error
Error: Hydration failed because the initial UI does not match what was rendered on the server.

See more info here: https://nextjs.org/docs/messages/react-hydration-error

### 📷 复现步骤

```

import React, {useState} from "react";
import {ProConfigProvider} from "@ant-design/pro-provider";
import {ProLayout} from "@ant-design/pro-layout";

export default function Home() {
  const [pathname, setPathname] = useState('/list/sub-page/sub-sub-page1');

  return (
      <ProLayout />
  );
}

```

### 🏞 期望结果

无报错

### 💻 复现代码

```

import React, {useState} from "react";
import {ProConfigProvider} from "@ant-design/pro-provider";
import {ProLayout} from "@ant-design/pro-layout";

export default function Home() {
  const [pathname, setPathname] = useState('/list/sub-page/sub-sub-page1');

  return (
      <ProLayout />
  );
}

```

### © 版本信息

- ProComponents 版本: [e.g. 4.0.0] 4.2
- umi 版本 nan
- 浏览器环境 chrome
- 开发环境 [e.g. mac OS] windows

```
    "@ant-design/pro-components": "^2.4.4",
    "@types/node": "18.15.11",
    "@types/react": "18.0.31",
    "@types/react-dom": "18.0.11",
    "eslint": "8.37.0",
    "eslint-config-next": "13.2.4",
    "next": "13.2.4",
    "react": "18.2.0",
    "react-dom": "18.2.0",
    "typescript": "5.0.3"
```

### 🚑 其他信息

```
Unhandled Runtime Error
Error: Hydration failed because the initial UI does not match what was rendered on the server.

See more info here: https://nextjs.org/docs/messages/react-hydration-error

Call Stack
throwOnHydrationMismatch
node_modules\react-dom\cjs\react-dom.development.js (12507:0)
tryToClaimNextHydratableInstance
node_modules\react-dom\cjs\react-dom.development.js (12520:0)
updateHostComponent
node_modules\react-dom\cjs\react-dom.development.js (19902:0)
beginWork
node_modules\react-dom\cjs\react-dom.development.js (21618:0)
HTMLUnknownElement.callCallback
node_modules\react-dom\cjs\react-dom.development.js (4164:0)
Object.invokeGuardedCallbackDev
node_modules\react-dom\cjs\react-dom.development.js (4213:0)
invokeGuardedCallback
node_modules\react-dom\cjs\react-dom.development.js (4277:0)
beginWork$1
node_modules\react-dom\cjs\react-dom.development.js (27451:0)
performUnitOfWork
node_modules\react-dom\cjs\react-dom.development.js (26557:0)
workLoopSync
node_modules\react-dom\cjs\react-dom.development.js (26466:0)
renderRootSync
node_modules\react-dom\cjs\react-dom.development.js (26434:0)
performConcurrentWorkOnRoot
node_modules\react-dom\cjs\react-dom.development.js (25738:0)
workLoop
node_modules\scheduler\cjs\scheduler.development.js (266:0)
flushWork
node_modules\scheduler\cjs\scheduler.development.js (239:0)
performWorkUntilDeadline
node_modules\scheduler\cjs\scheduler.development.js (533:0)
<unknown>
chrome-extension://ibnejdfjmmkpcnlpebklmnkoeoihofec/dist/pageHook.js (22:13552)
h
chrome-extension://ibnejdfjmmkpcnlpebklmnkoeoihofec/dist/pageHook.js (22:13667)
s
chrome-extension://ibnejdfjmmkpcnlpebklmnkoeoihofec/dist/pageHook.js (22:13025)
```

## chenshuai2144

> TAutomatically replying with ChatGPT can be attempted, but it cannot be guaranteed to be completely accurate and may not fully address all issues. Please feel free to reply if you have any further questions or concerns.
> 此回复基于 ChatGPT 自动生成，可以尝试下方案，官方人员会在一定时间后继续继续处理。

这个错误是 React 的服务端渲染和客户端渲染导致的 UI 不一致，需要对渲染过程有一定的认识才能够深刻理解。在 Next.js 中，有时候组件的渲染是在客户端完成的，有时候则是在服务器进行。这种情况称为服务端渲染和客户端渲染。

通常来说，使用服务端渲染的情况多是用于更好的 SEO。而客户端渲染则可以带来良好的用户体验和降低服务器负载。

回到错误本身，这种错误通常是由客户端和服务端渲染出现了差异而导致的，客户端补充了渲染过程中缺失的部分。通常是因为客户端渲染的组件部分与服务端渲染的组件不同，导致客户端的渲染结果和服务端不同，从而引起了这个错误。

解决方法：

1. 尝试尝试减少客户端渲染组件的差异，建议使用相同的依赖环境，以及在渲染时传入完全相同的 props。

2. 尝试使用 noSsr 组件或者 disableHydration，这两种方式可以控制在客户端渲染的时候，是否忽略某些细节，直接渲染出正确的结果。具体使用方法及示例可以参考官方文档：https://nextjs.org/docs/api-reference/next/head

3. 如果以上方式均未能解决问题，可以考虑对代码做出重构，调整服务端渲染和客户端渲染的方式。

以下是示例代码：

```jsx
import React, { useState } from "react";
import dynamic from "next/dynamic";
// 使用动态加载的方式，可以使部分组件在客户端渲染完成后再执行
const ProLayout = dynamic(() => import("@ant-design/pro-layout"), {
  ssr: false,
});

export default function Home() {
  const [pathname, setPathname] = useState("/list/sub-page/sub-sub-page1");

  return <ProLayout />;
}
```

注意：以上代码无法直接在浏览器端执行，需要使用 Next.js 进行服务端渲染。

参考文档：

1. Next.js 官方文档 https://nextjs.org/docs/messages/react-hydration-error
2. React 的同构渲染策略 https://www.javascriptcn.com/read-14190.html
3. Using Dynamic imports with next/dynamic https://nextjs.org/docs/advanced-features/dynamic-import

## DirectStack

这个方法解决了我的问题，使用nextjs开发spa应用，感谢！
