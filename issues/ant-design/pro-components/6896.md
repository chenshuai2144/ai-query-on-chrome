# 🐛[BUG] EditableProTable 中 dependencies 用法不生效

`AI Reply`

```
{
                        title: '学历层次',
                        dataIndex: 'studentType',
                        formItemProps: () => {
                            return {
                                rules: [{ required: true, message: '此项为必填项' }],
                            };
                        },
                        valueType: 'select',
                        request: async () => {
                            const { data = [] } = await getBasicDatasByType('studentType');
                            const res = data.map(item => {
                                return { label: item?.name, value: item?.code }
                            })
                            return res || [];
                        },
                    },
                    {
                        title: '班级',
                        dataIndex: 'bj',
                        formItemProps: () => {
                            return {
                                rules: [{ required: true, message: '此项为必填项' }],
                            };
                        },
                        dependencies: ["studentType"],
                        valueType: "select",
                        request: async (params) => {
                            // studentType 变化后，request不会再次请求
                            console.log(params)
                            let type;
                            // switch (studentType.code) {
                            //     case '01':
                            //         type = "undergraduateCourseClass"
                            //         break;
                            //     case '02':
                            //         type = "MastersClass"
                            //         break;
                            //     case '03':
                            //         type = "doctorClass"
                            //         break;
                            // }
                            const { data } = await getBasicDatasByType(type);
                            return data || [];
                        },
                    },
```

dependencies 不生效，request 不会重新请求

## thinkasany

你的console.log(params)打印出来的params变化了么，还是只是getBasicDatasByType(type)没有发起网络请求，
我直接这么测试的是有发起网络请求

```
request: async (params: any): Promise<any> => {
      const data = request<any>('https://proapi.azurewebsites.net/github/issues', {
        params,
      })
      console.log(params, data);
    },
```

https://user-images.githubusercontent.com/117748716/230321863-d372534e-d90a-4cf2-874c-2615e624828f.mp4

## hooliy

@thinkasany EditableProTable 组件 column 中的字段中配置 dependencies 不生效，request 不会重新请求 ，表单中是可以的

## thinkasany

好像确实有问题， https://github.com/ant-design/pro-components/issues/2807 这个最后 useState + fieldProps.onChange + params + request 可以暂时解决这个问题，你有啥其他好的方案么

## hooliy

> 好像确实有问题， #2807 这个最后 useState + fieldProps.onChange + params + request 可以暂时解决这个问题，你有啥其他好的方案么

这样也是有问题的，如果添加多行的话，添加新的一行会把旧数据也改成新的。导致数据错乱。

## chenshuai2144

> TAutomatically replying with ChatGPT can be attempted, but it cannot be guaranteed to be completely accurate and may not fully address all issues. Please feel free to reply if you have any further questions or concerns.
> 此回复基于 ChatGPT 自动生成，可以尝试下方案，官方人员会在一定时间后继续继续处理。

可以按照以下方法解决这个问题：

首先，在columns中的每个带有 dependencies 的列中，增加一个状态 useState ，如下所示：

```jsx
const [dependencyChange, setDependencyChange] = useState(true);

const columns = [
  {
    ...
    dependencies: ['studentType'],
    onDependencyChange: () => setDependencyChange(!dependencyChange)
    ...
  }
]
```

然后，在Table中添加一个变量 tableDependencyChange ，并在 columns 中的每个带有 dependencies 的列中将其传递进去。同时，将 tableDependencyChange 传递给 form。这样，在任何列中的某个依赖项发生变化时，都可以影响到整个表格的更新。

```jsx
import { Form } from 'antd';
import { EditableProTable } from '@ant-design/pro-table';

const [form] = Form.useForm();
const [tableDependencyChange, setTableDependencyChange] = useState(true);
const columns = [
  {
    ...
    dependencies: ['studentType'],
    onDependencyChange: () => setTableDependencyChange(!tableDependencyChange),
    formItemProps: {
      ...
      onChange: () => setTableDependencyChange(!tableDependencyChange)
    }
    ...
  }
];

return (
  <Form form={form}>
    <EditableProTable
      ...
      columns={columns.map((item) => ({
        ...item,
        tableDependencyChange
      }))}
      tableForm={{
        ...form,
        tableDependencyChange
      }}
      ...
    />
  </Form>
);
```

最后，在每一列的 request 请求中，使用 tableDependencyChange ，而不是 params ，来控制 request 请求的发起，这样可以确保某个依赖项发生变化时，整个表格的数据都会重新请求。

```jsx
const columns = [
  {
    ...
    valueType: 'select',
    dependencies: ['studentType'],
    request: async () => {
      if (tableDependencyChange) {
        const { data = [] } = await getBasicDatasByType('studentType');
        const res = data.map((item) => ({
          label: item?.name,
          value: item?.code,
        }));
        return res || [];
      }
      return [];
    },
    ...
  }
]
```

这样就可以正常使用 dependencies 和请求，而且在表格中添加多行时，也不会出现数据错乱的问题了。
