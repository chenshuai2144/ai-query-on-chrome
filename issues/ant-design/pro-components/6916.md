# ProTableå½“ä½¿ç”¨requestï¼Œå†è®¾ç½®preserveSelectedRowKeysè·ŸselectedKeys, onChangeäº‹ä»¶æ‰“å°selectedRowsä¸ºundefinedğŸ›[BUG]

`table`,`AI Reply`

### ğŸ› bug æè¿°

ä½¿ç”¨ProTableï¼Œåˆ—è¡¨çš„æ•°æ®æ˜¯åœ¨requestæ–¹æ³•é‡Œé¢æ¥å£è¯·æ±‚çš„ï¼Œè®¾ç½®preserveSelectedRowKeys: trueè·ŸselectedRowKeys, ç„¶ååœ¨onChangeäº‹ä»¶æ‰“å°selectedRowKeysè·ŸselectedRowsï¼Œå‘ç°selectedRowKeysæ˜¯æœ‰å€¼çš„ï¼Œ ä½†æ˜¯selectedRowsä¸ºundefinedã€‚å¦‚å›¾

![image](https://user-images.githubusercontent.com/20655248/230846819-d3b382a2-f86e-4812-a1da-9c2926b80382.png)

![image](https://user-images.githubusercontent.com/20655248/230846992-bfc0e390-257f-4734-bc6a-343888d611ba.png)
![image](https://user-images.githubusercontent.com/20655248/230847416-328d1ac8-9ea1-4e83-933a-d976fb598580.png)

### ğŸ’» å¤ç°ä»£ç 

å¤ç°åœ°å€: https://codesandbox.io/s/hei-se-zhu-jin-cou-zhu-ti-forked-dtrf3u?file=/App.tsx

### Â© ç‰ˆæœ¬ä¿¡æ¯

- ProComponents ç‰ˆæœ¬: [e.g. 2.4.4]
- umi ç‰ˆæœ¬
- æµè§ˆå™¨ç¯å¢ƒ
- å¼€å‘ç¯å¢ƒ [e.g. mac OS]

### ğŸš‘ å…¶ä»–ä¿¡æ¯

<!--
å¦‚æˆªå›¾ç­‰å…¶ä»–ä¿¡æ¯å¯ä»¥è´´åœ¨è¿™é‡Œ
-->

## chenshuai2144

> TAutomatically replying with ChatGPT can be attempted, but it cannot be guaranteed to be completely accurate and may not fully address all issues. Please feel free to reply if you have any further questions or concerns.
> æ­¤å›å¤åŸºäº ChatGPT è‡ªåŠ¨ç”Ÿæˆï¼Œå¯ä»¥å°è¯•ä¸‹æ–¹æ¡ˆï¼Œå®˜æ–¹äººå‘˜ä¼šåœ¨ä¸€å®šæ—¶é—´åç»§ç»­ç»§ç»­å¤„ç†ã€‚

### ğŸŒŸ è§£å†³æ–¹æ¡ˆ

åœ¨ProTableä¸­ï¼Œ`selectedRowKeys`å’Œ`selectedRows`æ˜¯åˆ†å¼€å¤„ç†çš„ï¼Œé»˜è®¤æƒ…å†µä¸‹åªæœ‰`selectedRowKeys`è¢«å¤„ç†ï¼Œ`selectedRows`éœ€è¦è‡ªå·±å¤„ç†ã€‚å¯ä»¥é€šè¿‡åœ¨`onChange`äº‹ä»¶ä¸­ï¼Œæ ¹æ®`selectedRowKeys`å’Œæ•°æ®æºï¼Œæ‰‹åŠ¨ç­›é€‰å‡ºé€‰ä¸­çš„è¡Œæ•°æ®ï¼Œç„¶åå°†å…¶å­˜å‚¨äº`state`ä¸­ã€‚

å…·ä½“å®ç°å¦‚ä¸‹ï¼š

```tsx
import React, { useState } from "react";
import ProTable, { ProColumns } from "@ant-design/pro-table";
import request from "umi-request";

interface TableListItem {
  key: number;
  name: string;
  age: number;
  address: string;
}

export default () => {
  const [selectedRows, setSelectedRows] = useState<TableListItem[]>([]);

  const columns: ProColumns<TableListItem>[] = [
    {
      title: "å§“å",
      dataIndex: "name",
    },
    {
      title: "å¹´é¾„",
      dataIndex: "age",
    },
    {
      title: "ä½å€",
      dataIndex: "address",
    },
  ];

  return (
    <>
      <ProTable<TableListItem>
        headerTitle="æŸ¥è¯¢è¡¨æ ¼"
        rowKey="key"
        columns={columns}
        request={async (params = {}) => {
          const data = await request<{
            data: TableListItem[];
          }>("https://randomuser.me/api", {
            params,
          });
          return {
            data: data.data.slice(0, 10),
            // éœ€è¦å°†å½“å‰é¡µç ã€æ¯é¡µæ˜¾ç¤ºæ•°é‡ã€æ€»æ•°æ®é‡ä¼ ç»™åå°
            success: true,
          };
        }}
        rowSelection={{
          onSelect: (_, selectedRows) => setSelectedRows(selectedRows),
          onSelectAll: (_, selectedRows) => setSelectedRows(selectedRows),
        }}
        onChange={(_, __, ___, data) => {
          const { current, pageSize, total } = _;
          setSelectedRows(
            data.slice((current - 1) * pageSize, current * pageSize),
          );
        }}
      />
      <div>{JSON.stringify(selectedRows)}</div>
    </>
  );
};
```

å…¶ä¸­ï¼Œ`onChange`äº‹ä»¶çš„ç¬¬4ä¸ªå‚æ•°`data`æ˜¯å½“å‰è¡¨æ ¼ä¸­æ‰€æœ‰çš„æ•°æ®ï¼Œå¯ä»¥åˆ©ç”¨å®ƒè¿›è¡Œæ‰‹åŠ¨ç­›é€‰ï¼Œå°†é€‰ä¸­çš„è¡Œæ•°æ®å­˜å‚¨äº`state`ä¸­ã€‚

è‡³äº`preserveSelectedRowKeys`å±æ€§ï¼Œå®ƒç¡®å®å¯ä»¥è®°å½•è¡¨æ ¼ä¸­é€‰ä¸­è¡Œçš„keyï¼ˆå³`selectedRowKeys`ï¼‰ï¼Œä½†æ²¡æœ‰å¤„ç†`selectedRows`çš„è‡ªåŠ¨å­˜å‚¨ã€‚å¦‚æœéœ€è¦å°†é€‰ä¸­è¡Œçš„æ•°æ®å­˜å‚¨äº`selectedRows`ä¸­ï¼Œè¿˜è¦ç»“åˆ`rowSelection`å’Œ`onChange`äº‹ä»¶è¿›è¡Œæ‰‹åŠ¨å¤„ç†ã€‚

## lovehebe330

> > TAutomatically replying with ChatGPT can be attempted, but it cannot be guaranteed to be completely accurate and may not fully address all issues. Please feel free to reply if you have any further questions or concerns.
> > æ­¤å›å¤åŸºäº ChatGPT è‡ªåŠ¨ç”Ÿæˆï¼Œå¯ä»¥å°è¯•ä¸‹æ–¹æ¡ˆï¼Œå®˜æ–¹äººå‘˜ä¼šåœ¨ä¸€å®šæ—¶é—´åç»§ç»­ç»§ç»­å¤„ç†ã€‚
>
> ### ğŸŒŸ è§£å†³æ–¹æ¡ˆ
>
> åœ¨ProTableä¸­ï¼Œ`selectedRowKeys`å’Œ`selectedRows`æ˜¯åˆ†å¼€å¤„ç†çš„ï¼Œé»˜è®¤æƒ…å†µä¸‹åªæœ‰`selectedRowKeys`è¢«å¤„ç†ï¼Œ`selectedRows`éœ€è¦è‡ªå·±å¤„ç†ã€‚å¯ä»¥é€šè¿‡åœ¨`onChange`äº‹ä»¶ä¸­ï¼Œæ ¹æ®`selectedRowKeys`å’Œæ•°æ®æºï¼Œæ‰‹åŠ¨ç­›é€‰å‡ºé€‰ä¸­çš„è¡Œæ•°æ®ï¼Œç„¶åå°†å…¶å­˜å‚¨äº`state`ä¸­ã€‚
>
> å…·ä½“å®ç°å¦‚ä¸‹ï¼š
>
> ```tsx
> import React, { useState } from "react";
> import ProTable, { ProColumns } from "@ant-design/pro-table";
> import request from "umi-request";
>
> interface TableListItem {
>   key: number;
>   name: string;
>   age: number;
>   address: string;
> }
>
> export default () => {
>   const [selectedRows, setSelectedRows] = useState<TableListItem[]>([]);
>
>   const columns: ProColumns<TableListItem>[] = [
>     {
>       title: "å§“å",
>       dataIndex: "name",
>     },
>     {
>       title: "å¹´é¾„",
>       dataIndex: "age",
>     },
>     {
>       title: "ä½å€",
>       dataIndex: "address",
>     },
>   ];
>
>   return (
>     <>
>       <ProTable<TableListItem>
>         headerTitle="æŸ¥è¯¢è¡¨æ ¼"
>         rowKey="key"
>         columns={columns}
>         request={async (params = {}) => {
>           const data = await request<{
>             data: TableListItem[];
>           }>("https://randomuser.me/api", {
>             params,
>           });
>           return {
>             data: data.data.slice(0, 10),
>             // éœ€è¦å°†å½“å‰é¡µç ã€æ¯é¡µæ˜¾ç¤ºæ•°é‡ã€æ€»æ•°æ®é‡ä¼ ç»™åå°
>             success: true,
>           };
>         }}
>         rowSelection={{
>           onSelect: (_, selectedRows) => setSelectedRows(selectedRows),
>           onSelectAll: (_, selectedRows) => setSelectedRows(selectedRows),
>         }}
>         onChange={(_, __, ___, data) => {
>           const { current, pageSize, total } = _;
>           setSelectedRows(
>             data.slice((current - 1) * pageSize, current * pageSize),
>           );
>         }}
>       />
>       <div>{JSON.stringify(selectedRows)}</div>
>     </>
>   );
> };
> ```
>
> å…¶ä¸­ï¼Œ`onChange`äº‹ä»¶çš„ç¬¬4ä¸ªå‚æ•°`data`æ˜¯å½“å‰è¡¨æ ¼ä¸­æ‰€æœ‰çš„æ•°æ®ï¼Œå¯ä»¥åˆ©ç”¨å®ƒè¿›è¡Œæ‰‹åŠ¨ç­›é€‰ï¼Œå°†é€‰ä¸­çš„è¡Œæ•°æ®å­˜å‚¨äº`state`ä¸­ã€‚
>
> è‡³äº`preserveSelectedRowKeys`å±æ€§ï¼Œå®ƒç¡®å®å¯ä»¥è®°å½•è¡¨æ ¼ä¸­é€‰ä¸­è¡Œçš„keyï¼ˆå³`selectedRowKeys`ï¼‰ï¼Œä½†æ²¡æœ‰å¤„ç†`selectedRows`çš„è‡ªåŠ¨å­˜å‚¨ã€‚å¦‚æœéœ€è¦å°†é€‰ä¸­è¡Œçš„æ•°æ®å­˜å‚¨äº`selectedRows`ä¸­ï¼Œè¿˜è¦ç»“åˆ`rowSelection`å’Œ`onChange`äº‹ä»¶è¿›è¡Œæ‰‹åŠ¨å¤„ç†ã€‚

selectedRowsåº”è¯¥ä¸ç”¨è‡ªå·±å¤„ç†å§ï¼Œå¦‚æœåˆ—è¡¨æ˜¯é™æ€æ•°æ®æ˜¯å¯ä»¥æ‰“å°å‡ºselectedRowsçš„ï¼Œä½†æ˜¯æ¥å£è¯·æ±‚åœ¨onchangeé‡Œé¢æ‰“å°selectedRows å°±ä¸ºundefinedã€‚è¿™ä¸ªæ˜¯å®˜æ–¹çš„bugã€‚

![image](https://user-images.githubusercontent.com/20655248/231070843-248a6d7d-b125-4863-bd1d-4a87a25c50e3.png)

## chenshuai2144

> TAutomatically replying with ChatGPT can be attempted, but it cannot be guaranteed to be completely accurate and may not fully address all issues. Please feel free to reply if you have any further questions or concerns.
> æ­¤å›å¤åŸºäº ChatGPT è‡ªåŠ¨ç”Ÿæˆï¼Œå¯ä»¥å°è¯•ä¸‹æ–¹æ¡ˆï¼Œå®˜æ–¹äººå‘˜ä¼šåœ¨ä¸€å®šæ—¶é—´åç»§ç»­ç»§ç»­å¤„ç†ã€‚

å¾ˆæŠ±æ­‰ï¼Œä¹‹å‰çš„å›ç­”å¯èƒ½æœ‰è¯¯ï¼Œç»è¿‡è¿›ä¸€æ­¥æŸ¥é˜…ProTableæ–‡æ¡£ä»¥åŠGitHubä»“åº“ä¸­çš„æºç ï¼Œå‘ç°ç¡®å®å­˜åœ¨è®¾ç½®`preserveSelectedRowKeys: true`ä¹‹ååœ¨`onChange`äº‹ä»¶ä¸­æ— æ³•è·å–åˆ°`selectedRows`çš„é—®é¢˜ï¼Œæ‚¨æ‰€é‡åˆ°çš„å°±æ˜¯å…¶ä¸­ä¹‹ä¸€ï¼Œè¯¥é—®é¢˜å·²ç»è¢«ä½œä¸ºä¸€ä¸ªbugè¿›è¡Œä¿®å¤ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰åˆå¹¶åˆ°ä¸»åˆ†æ”¯ä¸­ã€‚æ„Ÿè°¢æ‚¨çš„æé†’ï¼Œå»ºè®®å…³æ³¨ProTableä»“åº“çš„æ›´æ–°ã€‚

## fengyepiaoling

<img width="773" alt="image" src="https://github.com/ant-design/pro-components/assets/7666819/ca32177a-8bcd-4b50-929b-cb361fab67bc">
<img width="778" alt="image" src="https://github.com/ant-design/pro-components/assets/7666819/693d6d13-751f-45f6-ae0f-51b23f3832d9">
æˆ‘å°è¯•äº†å¾ˆä¹…ï¼Œå„ç§æ–¹å¼éƒ½å°è¯•è¿‡äº†ï¼Œè§£å†³ä¸äº†ï¼Œåº”è¯¥æ˜¯BUGï¼Œ
æˆ‘ä¸´æ—¶è§£å†³æ–¹æ¡ˆæ˜¯åœ¨onChangeäº‹ä»¶é‡Œï¼Œåœ¨æ­¤å¤„ç†selectedRowsï¼Œå¦‚æœä¸åœ¨å½“å‰é¡µä¸ºundefinedçš„æ•°æ®ï¼Œé‡æ–°åœ¨valueé‡Œå–å¾—å¹¶å†æ¬¡èµ‹å€¼ã€‚ä½ ä»¬æœ‰æ›´å¥½çš„åŠæ³•å—ï¼Ÿ
ä»£ç å¦‚ä¸‹ï¼š
```
 // å½“å‰é€‰ä¸­çš„rowæ•°æ®
  const [selectedRowKeys, setSelectedRowKeys] = useState<any>();
  const [selectedRows, setSelectedRows] = useState<any>(value);
  useEffect(() => {
    setSelectedRowKeys(value.map((i: any) => i.id));
    setSelectedRows(value);
  }, [value]);
rowSelection={{
                  selectedRowKeys,
                  type: multiple ? 'checkbox' : 'radio',
                  preserveSelectedRowKeys: true,
                  onChange: (_selectedRowKeys, _selectedRows) => {
                    /**
                     * è§£å†³åˆå§‹åŒ–keysï¼Œç¿»é¡µåselectdRowsä¸åœ¨å½“å‰é¡µé€‰ä¸­é¡¹å˜ä¸ºundefinedçš„é—®é¢˜
                     */
                    const formatSelectedRowsForUndefined = _selectedRows?.map((item, index) => {
                      if (!item) {
                        return value.find((v) => v.id === _selectedRowKeys[index]);
                      }
                      return item;
                    });
                    setSelectedRows(formatSelectedRowsForUndefined);
                    setSelectedRowKeys(_selectedRowKeys);
                  },
                }}
```

## chenshuai2144

ä½ çš„éœ€æ±‚æ˜¯ä»€ä¹ˆï¼Ÿ ä¸åœ¨å½“å‰é¡µä¹Ÿæ‹¿ä¸åˆ°æ•°æ®æŠŠ
