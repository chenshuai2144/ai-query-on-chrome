# ğŸ§[é—®é¢˜] å‰ç«¯æ¥æ”¶æ•°æ®ï¼Œèœå•åŠ¨æ€ç”Ÿæˆäº†ï¼Œä½†æ˜¯component å¤±æ•ˆäº†ï¼Œè®¿é—®404

æé—®å‰å…ˆçœ‹çœ‹ï¼š

https://github.com/ryanhanwu/How-To-Ask-Questions-The-Smart-Way/blob/main/README-zh_CN.md

### ğŸ§ é—®é¢˜æè¿°

å‰ç«¯æ¥æ”¶æ•°æ®ï¼Œèœå•åŠ¨æ€ç”Ÿæˆäº†ï¼Œä½†æ˜¯component å¤±æ•ˆäº†ï¼Œè®¿é—®404

<img width="651" alt="image" src="https://user-images.githubusercontent.com/42695882/235657753-c4608687-23cf-4799-bb72-55cd73553238.png">

<!--
è¯¦ç»†åœ°æè¿°é—®é¢˜ï¼Œè®©å¤§å®¶éƒ½èƒ½ç†è§£
-->

`// è¿è¡Œæ—¶é…ç½®
import Footer from '@/components/Footers';
import { GithubAction, Wechat } from '@/components/RightContent';
import AvatarDropdown from '@/components/RightContent/AvatarDropdown';
import \* as AllIcons from '@ant-design/icons';
import { AlipayCircleFilled, GitlabFilled } from '@ant-design/icons';
import type { MenuDataItem } from '@ant-design/pro-components';
import {
Settings as LayoutSettings,
SettingDrawer,
} from '@ant-design/pro-components';

import { RunTimeLayoutConfig, history } from '@umijs/max';
import defaultSettings from '../config/defaultSettings';
import Icon from './components/Icon';
import { SysMenuType } from './repository/system/SysMenu';
import { SysUserType } from './repository/system/sysUser';
import { requestConfig } from './requestConfig';
import { queryCurrentUserMenus } from './services/system/sysMenuService';
import { queryCurrentUser } from './services/system/sysUserService';

const loginPath = '/user/login';

export interface ExtendedMenuDataItem extends MenuDataItem {
component?: string;
}

const loopMenuItem = (menus: SysMenuType.MenuItem[]): ExtendedMenuDataItem[] =>
menus.map(({ icon, routes, ...item }) => ({
...item,
icon: icon && <Icon name={icon as keyof typeof AllIcons} />,
children: routes && loopMenuItem(routes),
component: item.component,
}));

// å…¨å±€åˆå§‹åŒ–æ•°æ®é…ç½®ï¼Œç”¨äº Layout ç”¨æˆ·ä¿¡æ¯å’Œæƒé™åˆå§‹åŒ–
// æ›´å¤šä¿¡æ¯è§æ–‡æ¡£ï¼šhttps://umijs.org/docs/api/runtime-config#getinitialstate
export async function getInitialState(): Promise<{
currentUser?: SysUserType.CurrentUser;
settings?: Partial<LayoutSettings>;
fetchUserMenus?: () => Promise<ExtendedMenuDataItem[] | undefined>;
menuData?: ExtendedMenuDataItem[];
fetchUserInfo?: () => Promise<SysUserType.CurrentUser | undefined>;
}> {
const fetchUserInfo = async () => {
try {
const response = await queryCurrentUser();
return response.data;
} catch (error) {
history.push(loginPath);
}
return undefined;
};

const fetchUserMenus = async () => {
try {
const response = await queryCurrentUserMenus();
return loopMenuItem(response.data || []);
} catch (error) {
history.push(loginPath);
}
return undefined;
};

// å¦‚æœä¸æ˜¯ç™»å½•é¡µé¢ï¼Œæ‰§è¡Œ
const { location } = history;
if (location.pathname !== loginPath) {
const currentUser = await fetchUserInfo();
const currentUserMenus = await fetchUserMenus();
return {
menuData: currentUserMenus,
fetchUserInfo,
currentUser,
settings: defaultSettings as Partial<LayoutSettings>,
};
}

return {
menuData: [],
fetchUserMenus,
fetchUserInfo,
settings: defaultSettings as Partial<LayoutSettings>,
};
}

export const layout: RunTimeLayoutConfig = ({
initialState,
setInitialState,
}) => {
return {
menu: {
locale: false,
},
//è®¾ç½®å¤´åƒå’Œç™»å…¥åç§°
avatarProps: {
src: initialState?.currentUser?.headUrl,
title: initialState?.currentUser?.username,
render: (\_: any, avatarChildren: any) => {
return <AvatarDropdown>{avatarChildren}</AvatarDropdown>;
},
},
postMenuData: () => {
return initialState?.menuData || [];
},

    onPageChange: () => {
      const { location } = history;
      // å¦‚æœæ²¡æœ‰ç™»å½•ï¼Œé‡å®šå‘åˆ° login
      if (!initialState?.currentUser && location.pathname !== loginPath) {
        history.push(loginPath);
      }
    },

    // è®¾ç½®æ˜¾ç¤ºå›¾æ ‡
    actionsRender: () => [
      <GithubAction key="github" />,
      <GitlabFilled key="gitlabFilled" />,
      <Wechat key="wechatFilled" />,
      <AlipayCircleFilled key="alipayCircleFilled" />,
    ],

    // è®¾ç½®é¡µè„š
    footerRender: () => <Footer />,
    // é…ç½®é»˜è®¤setting å±æ€§
    childrenRender: (children) => {
      return (
        <>
          {children}
          <SettingDrawer
            disableUrlParams
            enableDarkTheme
            settings={initialState?.settings}
            onSettingChange={(settings: Partial<LayoutSettings>) => {
              setInitialState((preInitialState) => ({
                ...preInitialState,
                settings,
              }));
            }}
          />
        </>
      );
    },
    ...initialState?.settings,

};
};

/\*\*

- @name request é…ç½®ï¼Œå¯ä»¥é…ç½®é”™è¯¯å¤„ç†
- å®ƒåŸºäº axios å’Œ ahooks çš„ useRequest æä¾›äº†ä¸€å¥—ç»Ÿä¸€çš„ç½‘ç»œè¯·æ±‚å’Œé”™è¯¯å¤„ç†æ–¹æ¡ˆã€‚
- @doc https://umijs.org/docs/max/request#é…ç½®
  \*/
  export const request = {
  ...requestConfig,
  };
  `

## chenshuai2144

èœå•å’Œè·¯ç”±æ˜¯ä¸¤ä¸ªä¸œè¥¿

èœå•åªæ˜¯ menu ç»„ä»¶çš„æ•°æ®ï¼Œè€Œè·¯ç”±ä¼šå½±å“ buildï¼Œä¸€èˆ¬æ¥è¯´éƒ½æ˜¯å†™æ­»çš„ã€‚

èœå•å¯ä»¥åœ¨è¿™é‡Œä½¿ç”¨ï¼Œè·¯ç”±éœ€è¦å†™æ­»
https://pro.ant.design/zh-CN/docs/advanced-menu
