# ğŸ›[BUG] BetaSchemaForm ä½¿ç”¨ request è·å–æ•°æ®, ä¼šå¯¼è‡´ formRef çš„æ–¹æ³•ä¸¢å¤±

### ğŸ› bug æè¿°

ä½¿ç”¨ BetaSchemaForm çš„ **request** è·å–æ•°æ®, ä¼šå¯¼è‡´ FormInstance çš„æ–¹æ³•ä¸¢å¤±, è·å– formRef.current æ˜¯ä¸€ä¸ªç©º Object.
ä½†æ˜¯å¦‚æœé€šè¿‡ initialValues èµ‹å€¼åˆ™æ²¡æœ‰æ­¤é—®é¢˜.

### ğŸ“· å¤ç°æ­¥éª¤

ä½¿ç”¨ BetaSchemaForm çš„ request è·å–æ•°æ®, å¹¶é€šè¿‡ onValuesChange ç›‘å¬è§¦å‘ formInstance çš„ setFieldsValue.
é€šè¿‡è¾“å…¥æ¡†ä¿®æ”¹, ä¼šè§¦å‘: `formRef.current?.setFieldsValue is not a function`

### ğŸ æœŸæœ›ç»“æœ

åœ¨ä½¿ç”¨ request è·å–æ•°æ®æ—¶, èƒ½æ­£å¸¸è·å– ref çš„æ–¹æ³•

### ğŸ’» å¤ç°ä»£ç 

https://codesandbox.io/s/antd-pro-form-ref-bug-j8y5un?file=/App.tsx

æˆ–è€…æ ¸å¿ƒä»£ç :

```TypeScript
import type {
  ProFormColumnsType,
  ProFormInstance
} from "@ant-design/pro-components";
import { BetaSchemaForm } from "@ant-design/pro-components";
import React from "react";

type DataItem = {
  title: string;
};

const columns: ProFormColumnsType<DataItem>[] = [{
  title: "æ ‡é¢˜",
  dataIndex: "title"
}];

export default () => {
  const formRef = React.useRef<ProFormInstance<DataItem>>();
  return (
    <BetaSchemaForm<DataItem>
      formRef={formRef}
      request={() => ({
        title: "èš‚èšè®¾è®¡æœ‰é™å…¬å¸"
      })}
      onValuesChange={(_, values) => {
        formRef.current?.setFieldsValue({ title: values.title + "!" });
      }}
      columns={columns}
    />
  );
};
```

### Â© ç‰ˆæœ¬ä¿¡æ¯

- ProComponents ç‰ˆæœ¬: 2.4.12

### ğŸš‘ å…¶ä»–ä¿¡æ¯

## hadesy

ModalFormåŒæ ·æœ‰é—®é¢˜ï¼Œè²Œä¼¼è·Ÿè¿™ä¸ªæ”¹åŠ¨æœ‰å…³ç³»
https://github.com/ant-design/pro-components/commit/06721c310adde229ce5bcf92bf3ce59100e713df#diff-d86203524813bab4cca2d473195acbabce09a751687e117fa19deaa076053a9bR118

è¿™é‡Œé™„ä¸Štest code

```
  it('ğŸ“¦ ModelForm get formRef when use request', async () => {
    const formRef = createRef<FormInstance>();
    const wrapper = render(
        <ModalForm
            open
            formRef={formRef}
            request={async (params) => {
              return params;
            }}
            params={{
              name: 'test',
            }}
        >
          <ProFormText name="name"/>
        </ModalForm>,
    );
    await waitTime(100);
    expect(formRef.current?.getFieldValue("name")).toBe("test");
    wrapper.unmount();
  });
```

@chenshuai2144

## mxsl-gr

å‘ç°ä¸¤å‘¨äº†, æçš„ bug issue ä¸€ç‚¹å›åº”éƒ½æ²¡æœ‰, å¤§æ¦‚ç‡è¿™ä¸ªé¡¹ç›®åæœŸæ´»è·ƒåº¦ä¼šå¾ˆä½äº†, é—®äº†ä¸€ä¸‹é›†å›¢çš„åŒå­¦, èš‚èšå†…éƒ¨ç›®å‰ä¸ä½¿ç”¨è¿™å¥—ä¸œè¥¿...åæœŸæˆ‘ä¹Ÿè€ƒè™‘æ•´ä½“æ›¿æ¢æ‰...

## mxsl-gr

> ModalFormåŒæ ·æœ‰é—®é¢˜ï¼Œè²Œä¼¼è·Ÿè¿™ä¸ªæ”¹åŠ¨æœ‰å…³ç³» [06721c3#diff-d86203524813bab4cca2d473195acbabce09a751687e117fa19deaa076053a9bR118](https://github.com/ant-design/pro-components/commit/06721c310adde229ce5bcf92bf3ce59100e713df#diff-d86203524813bab4cca2d473195acbabce09a751687e117fa19deaa076053a9bR118)
>
> è¿™é‡Œé™„ä¸Štest code
>
> ```
>   it('ğŸ“¦ ModelForm get formRef when use request', async () => {
>     const formRef = createRef<FormInstance>();
>     const wrapper = render(
>         <ModalForm
>             open
>             formRef={formRef}
>             request={async (params) => {
>               return params;
>             }}
>             params={{
>               name: 'test',
>             }}
>         >
>           <ProFormText name="name"/>
>         </ModalForm>,
>     );
>     await waitTime(100);
>     expect(formRef.current?.getFieldValue("name")).toBe("test");
>     wrapper.unmount();
>   });
> ```
>
> @chenshuai2144

ä¸´æ—¶å¤„ç†çš„è¯, å¯ä»¥è‡ªå·±åˆå§‹åŒ–ä¸€ä¸ª state, è·å–æ•°æ®ä¹‹åé€šè¿‡ initialValues ç›®å‰å¯ä»¥ä¸´æ—¶ç»•è¿‡è¿™ä¸ª Bug

## Seven777Z

@chenshuai2144

## Seven777Z

StepsFormçš„formMapRefä¹Ÿæœ‰æ­¤é—®é¢˜

## chenshuai2144

å¥½å•¦ï¼Œæœ€è¿‘å­©å­å‡ºç”Ÿï¼Œæ—¶é—´å°‘äº†å¾ˆå¤šã€‚hhh

## mxsl-gr

> å¥½å•¦ï¼Œæœ€è¿‘å­©å­å‡ºç”Ÿï¼Œæ—¶é—´å°‘äº†å¾ˆå¤šã€‚hhh

å°å­©ç¡®å®ä¼šå¾ˆåƒç²¾åŠ›å’Œæ—¶é—´, å“ˆå“ˆå“ˆ

## JackRoy1992

å•¥æ—¶å€™ä¿®å¤äº†ï¼Œ@ä¸‹æˆ‘

## hadesy

@JackRoy1992 2.5.0ä¿®äº†
