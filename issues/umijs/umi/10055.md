# [Bug] CentOS max setup fatal - Error

  <!--
感谢您向我们反馈问题，为了高效的解决问题，我们期望你能提供以下信息：
-->

## What happens?

max setup
fatal - Error: Cannot find module 'react-dom/package.json' from '/opt/app-root'

## Mini Showcase Repository(REQUIRED)

> Please provide a [minimal reproduction](https://stackoverflow.com/help/minimal-reproducible-example) then upload to your GitHub. 请提供 [最小重现](https://stackoverflow.com/help/minimal-reproducible-example)，并上传到你的 GitHub 仓库

<!-- 为节约大家的时间，无复现步骤的 ISSUE 会被关闭，提供之后再 REOPEN -->
<!-- YOUR_REPOSITORY_URL on github or stackbliz -->

## How To Reproduce

npm install
**Steps to reproduce the behavior:** 1. 2.

**Expected behavior** 1. 2.

```
{
  "name": "ant-design-pro",
  "version": "6.0.0-beta.1",
  "private": true,
  "description": "An out-of-box UI solution for enterprise applications",
  "scripts": {
    "analyze": "cross-env ANALYZE=1 max build",
    "build": "max build",
    "build:dev": "cross-env REACT_APP_ENV=dev UMI_ENV=dev max build",
    "build:pre": "cross-env REACT_APP_ENV=pre UMI_ENV=pre max build",
    "build:pro": "cross-env REACT_APP_ENV=pro UMI_ENV=pro max build",
    "build:qas": "cross-env REACT_APP_ENV=qas UMI_ENV=qas max build",
    "deploy": "npm run build && npm run gh-pages",
    "dev": "npm run start:dev",
    "gh-pages": "gh-pages -d dist",
    "i18n-remove": "pro i18n-remove --locale=zh-CN --write",
    "postinstall": "max setup",
    "lint": "npm run lint:js && npm run lint:prettier && npm run tsc",
    "lint-staged": "lint-staged",
    "lint-staged:js": "eslint --ext .js,.jsx,.ts,.tsx ",
    "lint:fix": "eslint --fix --cache --ext .js,.jsx,.ts,.tsx --format=pretty ./src ",
    "lint:js": "eslint --cache --ext .js,.jsx,.ts,.tsx --format=pretty ./src",
    "lint:prettier": "prettier -c --write \"src/**/*\" --end-of-line auto",
    "openapi": "max openapi",
    "playwright": "playwright install && playwright test",
    "prepare": "husky install",
    "prettier": "prettier -c --write \"src/**/*\"",
    "serve": "umi-serve",
    "start": "cross-env UMI_ENV=dev max dev",
    "start:dev": "cross-env REACT_APP_ENV=dev MOCK=none UMI_ENV=dev max dev",
    "start:no-mock": "cross-env MOCK=none UMI_ENV=dev max dev",
    "start:pre": "cross-env REACT_APP_ENV=pre UMI_ENV=dev max dev",
    "start:test": "cross-env REACT_APP_ENV=test MOCK=none UMI_ENV=dev max dev",
    "test:e2e": "node ./tests/run-tests.js",
    "tsc": "tsc --noEmit"
  },
  "lint-staged": {
    "**/*.{js,jsx,ts,tsx}": "npm run lint-staged:js",
    "**/*.{js,jsx,tsx,ts,less,md,json}": [
      "prettier --write"
    ]
  },
  "browserslist": [
    "> 1%",
    "last 2 versions",
    "not ie <= 10"
  ],
  "dependencies": {
    "@ant-design/icons": "4.7.0",
    "@ant-design/pro-components": "2.3.13",
    "@umijs/route-utils": "2.1.3",
    "antd": "4.23.3",
    "classnames": "2.3.2",
    "dayjs": "1.11.6",
    "lodash": "4.17.21",
    "moment": "2.29.4",
    "omit.js": "2.0.2",
    "rc-menu": "9.6.4",
    "rc-util": "5.24.4",
    "react": "17.0.0",
    "react-dev-inspector": "1.8.1",
    "react-dom": "17.0.0",
    "react-helmet-async": "1.3.0"
  },
  "devDependencies": {
    "@ant-design/pro-cli": "2.1.0",
    "@playwright/test": "1.26.1",
    "@types/classnames": "2.3.1",
    "@types/express": "4.17.14",
    "@types/history": "4.7.11",
    "@types/lodash": "4.14.186",
    "@types/react": "17.0.0",
    "@types/react-dom": "17.0.0",
    "@types/react-helmet": "6.1.5",
    "@umijs/fabric": "2.11.1",
    "@umijs/max": "4.0.24",
    "@umijs/openapi": "1.7.0",
    "cross-env": "7.0.3",
    "cross-port-killer": "1.4.0",
    "detect-installer": "1.0.2",
    "eslint": "7.32.0",
    "gh-pages": "3.2.0",
    "husky": "7.0.4",
    "lint-staged": "10.0.0",
    "mockjs": "1.1.0",
    "prettier": "2.7.1",
    "swagger-ui-dist": "4.14.2",
    "typescript": "4.8.4",
    "umi-presets-pro": "1.0.5",
    "umi-serve": "1.9.11"
  },
  "engines": {
    "node": ">=14",
    "pnpm": ">=7"
  }
}
```

```
--->正在执行npm install...
npm WARN deprecated @types/classnames@2.3.1: This is a stub types definition. classnames provides its own type definitions, so you do not need this installed.
npm WARN deprecated querystring@0.2.1: The querystring API is considered Legacy. new code should use the URLSearchParams API instead.
npm WARN deprecated @stylelint/postcss-markdown@0.36.2: Use the original unforked package instead: postcss-markdown
npm WARN deprecated request@2.88.2: request has been deprecated, see https://github.com/request/request/issues/3142
npm WARN deprecated multer@1.4.4: Multer 1.x is affected by CVE-2022-24434. This is fixed in v1.4.4-lts.1 which drops support for versions of Node.js before 6. Please upgrade to at least Node.js 6 and version 1.4.4-lts.1 of Multer. If you need support for older versions of Node.js, we are open to accepting patches that would fix the CVE on the main 1.x release line, whilst maintaining compatibility with Node.js 0.10.
npm WARN deprecated core-js@2.6.12: core-js@<3.23.3 is no longer maintained and not recommended for usage due to the number of issues. Because of the V8 engine whims, feature detection in old core-js versions could cause a slowdown up to 100x even if nothing is polyfilled. Some versions have web compatibility issues. Please, upgrade your dependencies to the actual version of core-js.
npm WARN deprecated log4js@1.1.1: 1.x is no longer supported. Please upgrade to 6.x or higher.
npm WARN deprecated har-validator@5.1.5: this library is no longer supported
npm WARN deprecated uuid@3.4.0: Please upgrade  to version 7 or higher.  Older versions may use Math.random() in certain circumstances, which is known to be problematic.  See https://v8.dev/blog/math-random for details.
npm WARN deprecated flatten@1.0.3: flatten is deprecated in favor of utility frameworks such as lodash.
npm WARN deprecated core-js@3.22.4: core-js@<3.23.3 is no longer maintained and not recommended for usage due to the number of issues. Because of the V8 engine whims, feature detection in old core-js versions could cause a slowdown up to 100x even if nothing is polyfilled. Some versions have web compatibility issues. Please, upgrade your dependencies to the actual version of core-js.
npm WARN deprecated @formatjs/intl-unified-numberformat@3.3.7: We have renamed the package to @formatjs/intl-numberformat
npm WARN deprecated @formatjs/intl-utils@2.3.0: the package is rather renamed to @formatjs/ecma-abstract with some changes in functionality (primarily selectUnit is removed and we don't plan to make any further changes to this package
npm WARN deprecated intl-messageformat-parser@3.6.4: We've written a new parser that's 6x faster and is backwards compatible. Please use @formatjs/icu-messageformat-parser
npm WARN deprecated streamroller@0.4.1: 0.x is no longer supported. Please upgrade to 3.x or higher.
npm WARN deprecated sourcemap-codec@1.4.8: Please use @jridgewell/sourcemap-codec instead
npm WARN deprecated react-native-swipeout@2.3.6: Package no longer supported. Use at your own risk or consider using https://github.com/software-mansion/react-native-gesture-handler
npm WARN deprecated date-format@0.0.0: 0.x is no longer supported. Please upgrade to 4.x or higher.
npm WARN deprecated stable@0.1.8: Modern JS already guarantees Array#sort() is a stable sort, so this library is deprecated. See the compatibility table on MDN: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/sort#browser_compatibility
npm WARN deprecated querystring@0.2.0: The querystring API is considered Legacy. new code should use the URLSearchParams API instead.
npm WARN deprecated core-js@1.2.7: core-js@<3.23.3 is no longer maintained and not recommended for usage due to the number of issues. Because of the V8 engine whims, feature detection in old core-js versions could cause a slowdown up to 100x even if nothing is polyfilled. Some versions have web compatibility issues. Please, upgrade your dependencies to the actual version of core-js.
npm WARN deprecated sane@4.1.0: some dependency vulnerabilities fixed, support for node < 10 dropped, and newer ECMAScript syntax/features added
npm WARN deprecated source-map-resolve@0.5.3: See https://github.com/lydell/source-map-resolve#deprecated
npm WARN deprecated resolve-url@0.2.1: https://github.com/lydell/resolve-url#deprecated
npm WARN deprecated urix@0.1.0: Please see https://github.com/lydell/urix#deprecated
npm WARN deprecated source-map-url@0.4.1: See https://github.com/lydell/source-map-url#deprecated
> puppeteer-core@1.12.2 install /opt/app-root/src/node_modules/puppeteer-core
> node install.js
> core-js@3.26.1 postinstall /opt/app-root/src/node_modules/@babel/register/node_modules/core-js
> node -e "try{require('./postinstall')}catch(e){}"
Thank you for using core-js ( https://github.com/zloirock/core-js ) for polyfilling JavaScript standard library!
The project needs your help! Please consider supporting of core-js:
> https://opencollective.com/core-js
> https://patreon.com/zloirock
> bitcoin: bc1qlea7544qtsmj2rayg0lthvza9fau63ux0fstcz
Also, the author of core-js ( https://github.com/zloirock ) is looking for a good job -)
> core-js@3.22.4 postinstall /opt/app-root/src/node_modules/@umijs/babel-preset-umi/node_modules/core-js
> node -e "try{require('./postinstall')}catch(e){}"
> core-js@3.22.4 postinstall /opt/app-root/src/node_modules/@umijs/max-plugin-openapi/node_modules/core-js
> node -e "try{require('./postinstall')}catch(e){}"
> esbuild@0.14.36 postinstall /opt/app-root/src/node_modules/@umijs/max-plugin-openapi/node_modules/esbuild
> node install.js
> core-js@3.22.4 postinstall /opt/app-root/src/node_modules/@umijs/preset-umi/node_modules/core-js
> node -e "try{require('./postinstall')}catch(e){}"
> core-js@2.6.12 postinstall /opt/app-root/src/node_modules/core-js
> node -e "try{require('./postinstall')}catch(e){}"
Thank you for using core-js ( https://github.com/zloirock/core-js ) for polyfilling JavaScript standard library!
The project needs your help! Please consider supporting of core-js on Open Collective or Patreon:
> https://opencollective.com/core-js
> https://www.patreon.com/zloirock
Also, the author of core-js ( https://github.com/zloirock ) is looking for a good job -)
> core-js-pure@3.26.1 postinstall /opt/app-root/src/node_modules/core-js-pure
> node -e "try{require('./postinstall')}catch(e){}"
> esbuild@0.15.18 postinstall /opt/app-root/src/node_modules/esbuild
> node install.js
> es5-ext@0.10.62 postinstall /opt/app-root/src/node_modules/es5-ext
>  node -e "try{require('./_postinstall')}catch(e){}" || exit 0
> @umijs/bundler-vite@4.0.0-canary.20220628.2 postinstall /opt/app-root/src/node_modules/@umijs/max-plugin-openapi/node_modules/@umijs/bundler-vite
> node scripts/linkDeps.js
> ant-design-pro@6.0.0-beta.1 postinstall /opt/app-root/src
> max setup
fatal - Error: Cannot find module 'react-dom/package.json' from '/opt/app-root'
    at Function.resolveSync [as sync] (/opt/app-root/src/node_modules/@umijs/utils/compiled/resolve/index.js:1:12304)
    at resolveProjectDep (/opt/app-root/src/node_modules/@umijs/preset-umi/dist/features/configPlugins/configPlugins.js:36:58)
    at configPlugins_default (/opt/app-root/src/node_modules/@umijs/preset-umi/dist/features/configPlugins/configPlugins.js:44:24)
    at Service.initPlugin (/opt/app-root/src/node_modules/@umijs/core/dist/service/service.js:352:40)
    at Service.run (/opt/app-root/src/node_modules/@umijs/core/dist/service/service.js:218:18)
    at processTicksAndRejections (internal/process/task_queues.js:95:5)
    at async Service.run2 (/opt/app-root/src/node_modules/umi/dist/service/service.js:58:12)
    at async run (/opt/app-root/src/node_modules/umi/dist/cli/cli.js:55:7) {
  code: 'MODULE_NOT_FOUND'
}
fatal - A complete log of this run can be found in:
fatal - /opt/app-root/src/node_modules/.cache/logger/umi.log
fatal - Consider reporting a GitHub issue on https://github.com/umijs/umi/issues
npm ERR! code ELIFECYCLE
npm ERR! errno 1
npm ERR! ant-design-pro@6.0.0-beta.1 postinstall: `max setup`
npm ERR! Exit status 1
npm ERR!
npm ERR! Failed at the ant-design-pro@6.0.0-beta.1 postinstall script.
npm ERR! This is probably not a problem with npm. There is likely additional logging output above.
npm ERR! A complete log of this run can be found in:
npm ERR!     /opt/app-root/src/.npm/_logs/2022-12-13T03_36_02_538Z-debug.log
error: build error: non-zero (13) exit code from harbor.test.shccs.com.cn/m8cloud/m8-src-builder-nodejs-nginx-git@sha256:fbf582a19a75b4c6f9584f4bb414acc115823ba440db4952a8f461909f550212
```

<!-- 请提供复现链接/步骤，错误日志以及相关配置 -->

## Context

- **Umi Version**:4.0.24
- **Node Version**:14.16.1
- **Platform**:CentOS 7.9.2009
- ## baihech

  切换node16+yarn，仍有此bug，构建失败。
  Ubuntu Mac Windows 无bug。

  ## fz6m

  1. 试试 pnpm ，npm 的权限可能不够

2. 试试源码不要放到 `src` 下面，换一个名字

## baihech

> 1. 试试 pnpm ，npm 的权限可能不够
> 2. 试试源码不要放到 `src` 下面，换一个名字

环境问题，环境变量设置错了，从项目根目录执行了。。。。
应该从/opt/app-root/src/node_modules 执行，运维系统里多设置了环境变量，从/opt/app-root/开始了，吐血了

## zffocussss

升级到 4.0.52

## Redxym

> > 1. 试试 pnpm ，npm 的权限可能不够
> > 2. 试试源码不要放到 `src` 下面，换一个名字
>
> 环境问题，环境变量设置错了，从项目根目录执行了。。。。 应该从/opt/app-root/src/node_modules 执行，运维系统里多设置了环境变量，从/opt/app-root/开始了，吐血了
> 没有看懂，方便再解释一下不，现在遇到了一样的问题

## Redxym

> > > 1. 试试 pnpm ，npm 的权限可能不够
> > > 2. 试试源码不要放到 `src` 下面，换一个名字
> >
> > 环境问题，环境变量设置错了，从项目根目录执行了。。。。 应该从/opt/app-root/src/node_modules 执行，运维系统里多设置了环境变量，从/opt/app-root/开始了，吐血了
> > 没有看懂，方便再解释一下不，现在遇到了一样的问题

找到解决方案了，原先使用的node版本是14.6.0， 升级到14.17.3重新进行npm install就可以了
