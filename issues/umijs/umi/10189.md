# umi4 å­ç›®å½•éƒ¨ç½² -ç¼ºå°‘ç›¸å…³æ–‡æ¡£ [Bug]

<!--
æ„Ÿè°¢æ‚¨å‘æˆ‘ä»¬åé¦ˆé—®é¢˜ï¼Œä¸ºäº†é«˜æ•ˆçš„è§£å†³é—®é¢˜ï¼Œæˆ‘ä»¬æœŸæœ›ä½ èƒ½æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š
-->

## What happens?

<!-- A clear and concise description of what the bug is. -->
<!-- æ¸…æ™°çš„æè¿°ä¸‹é‡åˆ°çš„é—®é¢˜ã€‚-->

"@umijs/max": "^4.0.33"
ant-design-pro : 6.0.0.beta.1 (æœ€æ–°ç‰ˆæœ¬é»˜è®¤åˆ†æ”¯)

åœ¨ä½¿ç”¨å­ç›®å½•çš„æƒ…å†µä¸‹

```ts
import { history } from "@umijs/max";

// app.tsx ä¸­ç”¨æ¥æ£€æŸ¥å½“å‰é¡µé¢æ˜¯å¦éœ€è¦ç™»å½•
console.log("WITHELIST currentPath: ", location.pathname.toLowerCase());
```

umi 3 ï¼š history.location.pathname æ˜¾ç¤ºä¸º "/login"
umi 4 ï¼šhistory.location.pathname æ˜¾ç¤ºä¸º "/sea/login"

## Mini Showcase Repository(REQUIRED)

> Please provide a [minimal reproduction](https://stackoverflow.com/help/minimal-reproducible-example) then upload to your GitHub. è¯·æä¾› [æœ€å°é‡ç°](https://stackoverflow.com/help/minimal-reproducible-example)ï¼Œå¹¶ä¸Šä¼ åˆ°ä½ çš„ GitHub ä»“åº“

<!-- ä¸ºèŠ‚çº¦å¤§å®¶çš„æ—¶é—´ï¼Œæ— å¤ç°æ­¥éª¤çš„ ISSUE ä¼šè¢«å…³é—­ï¼Œæä¾›ä¹‹åå† REOPEN -->
<!-- YOUR_REPOSITORY_URL on github or stackbliz -->

https://github.com/ant-design/ant-design-pro/issues/10471

## How To Reproduce

**Steps to reproduce the behavior:** 1. 2.

**Expected behavior** 1. 2.

<!-- è¯·æä¾›å¤ç°é“¾æ¥/æ­¥éª¤ï¼Œé”™è¯¯æ—¥å¿—ä»¥åŠç›¸å…³é…ç½® -->

## Context

æˆ‘çš„é…ç½®å¦‚ä¸‹
config.local.ts

```ts
{
  base: '/sea/',
  outputPath: 'dist/sea',
  publicPath: '/sea/',
  manifest: { basePath: '/sea' },
  define: {
    API_BASE_URL: 'http://localhost:2919/SalesPortal',
    CLIENT_ROOT: 'http://localhost:1688/sea',
    CLIENT_ID: 'sea_client',
    SKIP_LOGIN_PAGE: false,
    LOGIN_PAGE: '/user/login',
    DISABLE_LANGSELECT: true,
    PUBLIC_PATH: '/sea/'
  },
  locale: { default: 'en-US' },
  layout: { title: 'sea (Testing)' },
  headScripts: [ { src: '/sea/scripts/loading.js', async: true } ]
}
```

ä¸”å¼€å¯ runtimePublicPath:{} åæ‰“ä¸å¼€é¡µé¢ï¼Œä»¥ä¸Šé—®é¢˜åœ¨ exportStatic æœªå¼€å¯çš„æƒ…å†µä¸‹æµ‹è¯•

- **Umi Version**:"@umijs/max": "^4.0.33"
- **Node Version**:
- **Platform**:

## hyzx86

runtimePublicPathå¼€å¯å æŠ¥é”™å¦‚ä¸‹ï¼š
![image](https://user-images.githubusercontent.com/15613121/210180414-9c5a6228-771d-4079-89e2-ace9535fdb25.png)

## hyzx86

æ›´æ–°é…ç½®

```diff
 {
  base: '/sea/',
  outputPath: 'dist/sea',
- publicPath: `${currentConfg.publicPathPrefix}/`,
- manifest: {
-     basePath: currentConfg.publicPathPrefix,
- }
  define: {
    API_BASE_URL: 'http://localhost:2919/SalesPortal',
    CLIENT_ROOT: 'http://localhost:1688/sea',
    CLIENT_ID: 'sea_client',
    SKIP_LOGIN_PAGE: false,
    LOGIN_PAGE: '/sea/user/login',
    DISABLE_LANGSELECT: true,
    PUBLIC_PATH: '/sea/'
  },
  locale: { default: 'en-US' },
  layout: { title: 'sea (Testing)' },
  headScripts: [ { src: '/scripts/loading.js', async: true } ],
+  writeToDisk: true,
+ runtimePublicPath: {}
}
```

å˜æˆäº†

http://localhost:1688/sea/sea/user/login?redirect=/sea/

## hyzx86

```diff

 {
  base: '/sea/',
-  outputPath: 'dist/sea',
- publicPath: `${currentConfg.publicPathPrefix}/`,
- manifest: {
-     basePath: currentConfg.publicPathPrefix,
- }
  define: {
    API_BASE_URL: 'http://localhost:2919/SalesPortal',
    CLIENT_ROOT: 'http://localhost:1688/sea',
    CLIENT_ID: 'sea_client',
    SKIP_LOGIN_PAGE: false,
    LOGIN_PAGE: '/sea/user/login',
    DISABLE_LANGSELECT: true,
    PUBLIC_PATH: '/sea/'
  },
  locale: { default: 'en-US' },
  layout: { title: 'sea (Testing)' },
  headScripts: [ { src: '/scripts/loading.js', async: true } ],
+ reactRouter5Compat: {},
- writeToDisk: true,
+ runtimePublicPath: {}
}
```

ä¾æ—§æ˜¯ http://localhost:1688/sea/sea/

![image](https://user-images.githubusercontent.com/15613121/210181342-25f4deb6-e303-4c93-8d4c-ca60b8d93ff1.png)

## fz6m

1. `runtimePublicPath` æ˜¯ qiankun ç”¨çš„ï¼Œä¸äº†è§£æœºåˆ¶çš„æ—¶å€™ï¼Œè‡ªå·±ä¸éœ€è¦é…ç½®ã€‚

2. `base: '/sea/'` æ„å‘³ç€ä½ è¦åœ¨ `http://domain.com/sea/*` æä¾›ä½ çš„å†…å®¹ï¼Œè¿™ä¸€èˆ¬åœ¨ nginx ä¸­æ˜¯ `location /sea` å†åš `try_files` ã€‚

3. `publicPath: '/sea/'` æ„å‘³ç€èµ„æºä¼šä» `http://domain.com/sea/umi.js` è¿™ä¸ªå±‚çº§è¿›è¡ŒåŠ è½½ã€‚

4. `outputPath: 'dist/sea'` æ„å‘³ç€äº§ç‰©ä¼šæ”¾åˆ° `dist/sea/*` ã€‚

æ ¹æ® 2ã€3ã€4 çš„è®¾å®šï¼Œä»¥ `dist/*` ä¸ºåŸºå‡†æä¾›èµ„æºï¼Œå¦‚æœæ˜¯ `/sea/*` éœ€è¦å…ˆè¯•æ¢æ˜¯å¦æœ‰å®ä½“èµ„æºï¼Œè‹¥æ— ï¼Œå†é‡å†™åˆ° `/sea/index.html` ä¸Šï¼Œè¯·è‡ªè¡Œæ£€æŸ¥èµ„æºæ˜¯å¦‚ä½•æä¾›çš„ï¼Œè·¯ç”±æ˜¯å¦æ­£ç¡®ï¼Œæ˜¯å¦ç¬¦åˆ SPA è§„èŒƒç­‰ã€‚

## hyzx86

æ„Ÿè°¢ç­”å¤ï¼š

> 1. runtimePublicPath æ˜¯ qiankun ç”¨çš„ï¼Œä¸äº†è§£æœºåˆ¶çš„æ—¶å€™ï¼Œè‡ªå·±ä¸éœ€è¦é…ç½®ã€‚

å…³äºè¿™ç‚¹ç¡®å®ä¸æ¸…æ¥šï¼Œå› ä¸ºæ–‡æ¡£ä¸Šæ²¡æœ‰ä»»ä½•è¯´æ˜ï¼Œæˆ‘å¯ä»¥æäº¤PR å®Œå–„ä¸‹æ–‡æ¡£ï¼Œä½†æ˜¯è¿™ä¸ªæè¿°æ€ä¹ˆæ ·å†™æ‰æ›´å‡†ç¡®ï¼Ÿ
https://umijs.org/docs/api/config#runtimepublicpath

ä½†æ˜¯ `@umijs/max` ä¸ `umi` ä¸­å¯¼å‡ºçš„

`history.location.pathname` ä¸ä¸€è‡´çš„æƒ…å†µç®—æ˜¯bugå—ï¼Ÿ

## hyzx86

useLocation().pathname è¾“å‡º æ­£å¸¸
ä½†
history.location.pathname è¾“å‡ºä¼šå¤šä¸€ä¸ªå­ç›®å½•

æ¯”å¦‚ åœ¨ ä½¿ç”¨ app.tsx .getInitialState() æˆ–è€…å…¶å®ƒéç»„ä»¶å†…è°ƒç”¨æ—¶æ— æ³•ä½¿ç”¨ useLocation

## fz6m

`history.location.pathname` å’Œ `useLocation` ä¸ä¸€æ ·æ˜¯ä¸€äº›å†å²é—®é¢˜ï¼Œç›®å‰å¯ä»¥è‡ªå·±æŠŠ base çš„éƒ¨åˆ†å®šä¹‰æˆç¯å¢ƒå˜é‡å†è‡ªå·±æ‹¼ä¸€ä¸‹æˆ–è€… trim ä¸‹ï¼š

```ts
// .umirc.ts

export default {
  base: "/some/",
  define: {
    BASE_URL: "/some",
  },
};
```

```ts
// use
history.location.pathname.slice(BASE_URL.length);
```

```ts
// typings.d.ts
declare global {
  const BASE_URL: string;
}
```

æ–‡æ¡£ä¸ç”¨ä¿®æ”¹ï¼Œå†™çš„æ²¡é—®é¢˜ï¼Œä½¿ç”¨ `runtimePublicPath` çš„æ—¶å€™æ˜¯åœ¨ runtime ä¿®æ”¹ publicPath ï¼Œä½ è¿™ä¸ªåœºæ™¯æ˜¯å›ºå®šçš„ `publicPath` ï¼Œæ‰€ä»¥å’Œè¿™ä¸ªé€‰é¡¹æ— å…³ã€‚

## hyzx86

å¥½çš„ï¼Œéå¸¸æ„Ÿè°¢ï¼ŒæŒ‰ç…§ä½ çš„è¯´æ˜ï¼Œé‡æ–°å°è¯•ä¸‹

## hyzx86

å¯ä»¥äº†ï¼Œ

```ts
{
  base: '/sea/',
  outputPath: 'dist/sea',
  publicPath: '/sea/',
  manifest: { basePath: '/sea' },
  define: {
    API_BASE_URL: 'http://localhost:2919/SalesPortal',
    CLIENT_ROOT: 'http://localhost:8000/sea',
    CLIENT_ID: 'sea_client',
    SKIP_LOGIN_PAGE: false,
    LOGIN_PAGE: '/user/login',
    DISABLE_LANGSELECT: true,
    PUBLIC_PATH: '/sea/'
  },
  headScripts: [ { src: '/sea/scripts/loading.js', async: true } ],
}
```

ä¸»è¦æ˜¯ history.location.pathname çš„é—®é¢˜ï¼Œè‡ªå·±å°è£…äº†ä¸ªå‡½æ•° æ›¿æ¢æ•´ä¸ªé¡¹ç›®é‡Œé¢çš„ pathname å°±å¥½äº†
ä½†æœ‰ç‚¹è®©äººå›°æƒ‘çš„æ˜¯ ï¼Œè¿™ä¸ªhistory è¯´æ˜¯æ”¹äº†ã€‚ã€‚åˆæ²¡å®Œå…¨æ”¹
history.push("/aaa/bbb")
å®é™…è·³è½¬çš„æ˜¯ /sea/aaa/bbb

ä¸è¿‡å¥½åœ¨æ˜¯åè€…ï¼Œä¸ç„¶è¿˜è¦å†å¤„ç†ä¸‹ history.push

## hyzx86

å…³è” pull
https://github.com/umijs/umi/pull/9529

## buquan

> `history.location.pathname` å’Œ `useLocation` ä¸ä¸€æ ·æ˜¯ä¸€äº›å†å²é—®é¢˜ï¼Œç›®å‰å¯ä»¥è‡ªå·±æŠŠ base çš„éƒ¨åˆ†å®šä¹‰æˆç¯å¢ƒå˜é‡å†è‡ªå·±æ‹¼ä¸€ä¸‹æˆ–è€… trim ä¸‹ï¼š
>
> ```ts
> // .umirc.ts
>
> export default {
>   base: "/some/",
>   define: {
>     BASE_URL: "/some",
>   },
> };
> ```
>
> ```ts
> // use
> history.location.pathname.slice(BASE_URL.length);
> ```
>
> ```ts
> // typings.d.ts
> declare global {
>   const BASE_URL: string;
> }
> ```
>
> æ–‡æ¡£ä¸ç”¨ä¿®æ”¹ï¼Œå†™çš„æ²¡é—®é¢˜ï¼Œä½¿ç”¨ `runtimePublicPath` çš„æ—¶å€™æ˜¯åœ¨ runtime ä¿®æ”¹ publicPath ï¼Œä½ è¿™ä¸ªåœºæ™¯æ˜¯å›ºå®šçš„ `publicPath` ï¼Œæ‰€ä»¥å’Œè¿™ä¸ªé€‰é¡¹æ— å…³ã€‚

è¯·é—®qiankun-plugin 2+ ç»™ä¸»åº”ç”¨è®¾ç½®baseå’Œpublicpathå¯¼è‡´å­åº”ç”¨çš„bootstrapå¤šäº†ä¸€ä¸ª/ è¿™æ˜¯ä¸ºå•¥ï¼Œ
æ¯”å¦‚ baseå’ŒpublicPathéƒ½è®¾ç½®äº† `/uat/` , ä½†æ˜¯å­åº”ç”¨çš„bootstrapçš„baseæ‰“å°çš„æ˜¯`/uat//mypath`

## fz6m

æ—§ç‰ˆæœ¬ä¸ç»´æŠ¤äº†ï¼Œå¦‚æœ‰éœ€æ±‚ï¼Œå»ºè®®å‡çº§ umi4

## hyzx86

ç»§ç»­è¯·æ•™ä¸‹ã€‚ã€‚

Umi4 æ‰“åŒ… çš„antd
æœ‰åŠæ³•æ”¯æŒç§Ÿæˆ·åç§°çš„è™šæ‹Ÿç›®å½•å—ï¼Ÿ

https://baidu.com/ç§Ÿæˆ·1
https://baidu.com/ç§Ÿæˆ·2

æ€ä¹ˆé…ç½®å‘€ï¼Ÿ
ç°åœ¨çš„æƒ…å†µæ˜¯ ä¸‹åˆ—é…ç½®

```
  base: '/sea/',
  outputPath: 'dist/sea',
  publicPath: '/sea/',
  manifest: { basePath: '/sea' },
```

åå‘ä»£ç†å·²ç»åšäº†é‡å†™ï¼Œ
ä½†æ˜¯ ä¸€æ—¦ è°ƒç”¨ history.push ï¼Œå®ƒå°±è·‘åˆ° æ‰“åŒ…çš„è·¯å¾„ä¸‹äº†
æ¯”å¦‚ è®¿é—®ï¼š
http://baidu.com/tenant1
æ£€æŸ¥åˆ°ç”¨æˆ·æœªç™»å½•
è°ƒç”¨ history.push(â€˜/loginâ€™)

æµè§ˆå™¨ä¼šè·³åˆ° ï¼š
http://baidu.com/sea/login

## fz6m

history.push æ˜¯ SPA å†…éƒ¨çš„è·¯ç”±è·³è½¬ï¼Œæ²¡æ³•è·³å…¶ä»–çš„åº”ç”¨ï¼Œå¦‚æœè·³å…¶ä»–çš„åº”ç”¨ä½ å¯ä»¥è€ƒè™‘æŠŠæ ¹åŸŸååšæˆå¾®å‰ç«¯åŸºåº§ï¼Œä¸‹å‘æˆ–è€…å…¨å±€ç»™ä¸€ä¸ªå…¨å±€çš„ history ï¼Œç„¶åä¸åŒå­åº”ç”¨ç”¨è¿™ä¸ªå…¨å±€ history å°±å¯ä»¥è·³å…¶ä»–åº”ç”¨äº†ã€‚

å¦åˆ™åªèƒ½è®¾å®š `location.href` åˆ·æ–°é¡µé¢è·³å…¶ä»–çš„åº”ç”¨å†…é¡µé¢ã€‚

## hyzx86

æ„Ÿè°¢ç­”å¤ï¼Œ
ä½†æ˜¯æˆ‘æ³¨æ„åˆ°æ’ä»¶é‡Œé¢æœ‰è¿™ä¹ˆä¸€æ®µä»£ç 
è¿™ä¸œè¥¿èƒ½è¿è¡Œæ—¶æ›´æ–°å—ï¼Ÿ

      return { ...h.location, pathname: h.location.pathname.replace(new RegExp(`^${basename}`), '/') };

```ts
export function createHistory(opts: any) {
  let h;
  if (opts.type === "hash") {
    h = createHashHistory();
  } else if (opts.type === "memory") {
    h = createMemoryHistory(opts);
  } else {
    h = createBrowserHistory();
  }
  if (opts.basename) {
    basename = opts.basename;
  }

  history = {
    ...h,
    push(to, state) {
      h.push(patchTo(to, h), state);
    },
    replace(to, state) {
      h.replace(patchTo(to, h), state);
    },
    get location() {
      //return h.location;
      return {
        ...h.location,
        pathname: h.location.pathname.replace(new RegExp(`^${basename}`), "/"),
      };
    },
    get action() {
      return h.action;
    },
  };

  return h;
}
```

![image](https://user-images.githubusercontent.com/15613121/229039856-3697a6f6-1a41-4049-9334-885a211ccb5e.png)

## hyzx86

ç¼ºå°‘ basename ç›¸å…³æ–‡æ¡£å’Œ tså£°æ˜
è‡ªå·±åšäº†ä¸ªpatch

```
diff --git a/templates/history.tpl b/templates/history.tpl
index aa291cb17035bbc954f459431bdd9d67790c3eb7..2ea6c1e44fcc55fa770061ce8897ef619b8ca28e 100644
--- a/templates/history.tpl
+++ b/templates/history.tpl
@@ -1,5 +1,6 @@
 import { createHashHistory, createMemoryHistory, createBrowserHistory } from '{{{ historyPath }}}';
 import type { UmiHistory } from './historyIntelli';
+import { isFunction } from 'lodash';

 let history: UmiHistory;
 let basename: string = '/';
@@ -12,8 +13,12 @@ export function createHistory(opts: any) {
   } else {
     h = createBrowserHistory();
   }
-  if (opts.basename) {
-    basename = opts.basename;
+  if(opts.basename){
+    if (!isFunction(opts.basename)) {
+      basename = opts.basename;
+    } else {
+      basename = opts.basename()
+    }
   }

   history = {
@@ -25,7 +30,8 @@ export function createHistory(opts: any) {
       h.replace(patchTo(to, h), state);
     },
     get location() {
-      return h.location;
+      //return h.location;
+      return { ...h.location, pathname: h.location.pathname.replace(new RegExp(`^${basename}`), '/') };
     },
     get action() {
       return h.action;
```

## hyzx86

å‘ƒã€‚ã€‚ã€‚ è¿™ä¸ªbasename å¹¶ä¸æ˜¯æ¥è‡ªäº config.ts çš„ history å±æ€§çš„ã€‚ã€‚
è¦å» umi.ts æ–‡ä»¶é‡Œé¢æ”¹ ğŸ¤£

## fz6m

å¦‚æœ‰æ–°é—®é¢˜ï¼Œè¯·å†å¼€ issue ã€‚
