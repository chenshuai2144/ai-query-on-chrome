# bug(preset-umi): icon don't work

现象就是 按照文档描述 https://umijs.org/docs/api/config#icons 配置如下

```ts
    icons: {
        autoInstall: {},
        alias: {
            home: 'fa:home'
        }
    },
```

（一个小问题，`autoInstall`现在joi定义为object了，不知是手滑还是为了以后扩展，看代码这里似乎应该是boolean。不过此处不太重要）

这样的配置后，我们随便搞个配置式路由(约定式路由不知生成的路由文件什么样子，不知有没有此问题）

```ts
    {
        path: '/test',
        component: 'welcome'
    },
```

这个路由定义的相当简单，它会在 `src/.umi/core/route.tsx`里类似如下的内容

```ts
'5': React.lazy(() => import(/* webpackChunkName: "p__welcome" */'@/pages/welcome.tsx')),
'6': React.lazy(() => import( './EmptyRoute')),
```

我们在welcome.tsx里使用icons, 按道理它应该很好的工作，但实际上是一点卵用没有。。
具体调试细节不表了，最后定位问题似乎是 esbuild没有正确的识别到我们的alias，即没有把 '@'转为 ‘src’，但是如下的代码确实把config里的alias传给esbuild的`esbuildAliasPlugin`插件了，但是不知道为什么没生效。

https://github.com/umijs/umi/blob/00e503c8a516850eb6e9b6b4732065ef36eb8cd8/packages/preset-umi/src/features/icons/icons.ts#L40-L57

验证：
此时，我们*手动将生成的route.ts*的 含有alias的部分修改为如下

```ts
'5': React.lazy(() => import(/* webpackChunkName: "p__welcome" */'../../pages/welcome.tsx')),
'6': React.lazy(() => import( './EmptyRoute')),
```

就能可正常工作了

## rozbo

补上快速调试，在以下位置插入
https://github.com/umijs/umi/blob/00e503c8a516850eb6e9b6b4732065ef36eb8cd8/packages/preset-umi/src/features/icons/esbuildPlugins/esbuildCollectIconPlugin.ts#L11-L13

```ts
console.log(args.path);
```

即可发现输出
xxx\src\.umi\umi.ts
xxx\src\.umi\core\route.tsx
xxx\src\.umi\core\history.ts
xxx\src\.umi\core\plugin.ts
xxx\src\.umi\core\polyfill.ts
xxx\src\.umi\core\EmptyRoute.tsx

即，同样的属于 route.tsx的依赖中的 `import( './EmptyRoute'))`就成功的被 esbuild处理，而使用了 alias的 `import(/* webpackChunkName: "p__welcome" */'../../pages/welcome.tsx'))`则直接被esbuild无视了。。。

## rozbo

望文生义了，原来`esbuildAliasPlugin`不是第三方的插件，继续分析又定位一个bug点如下
https://github.com/umijs/umi/blob/00e503c8a516850eb6e9b6b4732065ef36eb8cd8/packages/preset-umi/src/features/icons/esbuildPlugins/esbuildAliasPlugin.ts#L41-L45
此处判断 alias的路径是不是绝对路径时，只兼容了 mac/linux，windows用户此处是盘符而非 '/'

然而此bug修正后，依然没有卵用

## rozbo

自己实现一个 esbuild的插件

```ts
build.onResolve({ filter: /.*/ }, async (args) => {
  console.log("adsf", args);
  const path = await resolve(args.importer, args.path.replace(filter, value));
  return {
    path,
  };
});
```

用于打印所有的import，然鹅，根本没有输出任何路由相关的导入。这说明 esbuild根本就没有调用 `onResolve` ，那么显然有且只有一个唯一解:

esbuild 应该是不支持 import里放注释的。

## rozbo

这个魔术注释好像webpack在动态打包时会用到，还不能随意去掉。。所以，到这里似乎已经走入了死胡同了。
这可如何是好呢，（交给你们了，我跑路了
