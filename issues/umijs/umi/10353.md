# [Bug] MPA模式报错

  <!--
感谢您向我们反馈问题，为了高效的解决问题，我们期望你能提供以下信息：
-->

## What happens?

新建UMI项目，配置MPA后启动报错

## Mini Showcase Repository(REQUIRED)

https://github.com/HuangRan/umi-mpa-bug.git

## How To Reproduce

1. yarn create umi
2. 配置MPA
3. yarn start
4. 报错
5. UMI配置
   ![image](https://user-images.githubusercontent.com/8411877/215474791-6d7a9d02-b6c6-43b1-8d68-1eb1b91ccc8d.png)
6. 报错信息
7. ![image](https://user-images.githubusercontent.com/8411877/215474872-cc89eed5-b70a-4aa2-991d-dc0e9de8fa5e.png)

## Context

- **Umi Version**:4.0.47
- **Node Version**:16.17.0
- **Platform**:windows

  ## fz6m

  最小复现里不符合 mpa 的约定目录格式。

FYI：

- 新 MPA 文档：https://umi-git-fork-moeyc-docs-mpa-imporve-chencheng.vercel.app/docs/guides/mpa

- mpa 的示例：[examples/mpa](https://github.com/umijs/umi/tree/master/examples/mpa)

## HuangRan

> 最小复现里不符合 mpa 的约定目录格式。
>
> FYI：
>
> - 新 MPA 文档：https://umi-git-fork-moeyc-docs-mpa-imporve-chencheng.vercel.app/docs/guides/mpa
> - mpa 的示例：[examples/mpa](https://github.com/umijs/umi/tree/master/examples/mpa)

还是不行，按照excample进行陪之后，又报了新的错误
![image](https://user-images.githubusercontent.com/8411877/215490636-223a3ba0-ffe2-4607-b9e5-d0bb1963d587.png)
目录结构：
![image](https://user-images.githubusercontent.com/8411877/215490700-a6225a41-c02e-433d-b4d8-80089c424d27.png)
umi配置：
![image](https://user-images.githubusercontent.com/8411877/215490820-352ed202-40b7-4cc3-abe3-e3539e735285.png)

最小复现已经重新提交了

## fz6m

1. 配置文件调整：

```diff
import { defineConfig } from "umi";

export default defineConfig({
  npmClient: 'yarn',
  mpa:{
    getConfigFromEntryFile:true,
    layout:'@/layouts',
-   template:'templates/default.html',
+   template:'src/templates/default.html',
    entry:{
      p1:{describe:'p1'},
      p2:{describe:'p2'}
    },
  }
});
```

2. layout 文件调整（在 mpa 中没有 react router ，layout 要通过 children 访问）：

```ts
// src/layouts/index.tsx

export default function Layout({ children }) {
  return (
    <div>
      {children}
    </div>
  );
}
```

经过以上两个调整我是可以跑起来的，访问 `http://localhost:8000/p1.html` 。

## HuangRan

> 1. 配置文件调整：
>
> ```diff
> import { defineConfig } from "umi";
>
> export default defineConfig({
>   npmClient: 'yarn',
>   mpa:{
>     getConfigFromEntryFile:true,
>     layout:'@/layouts',
> -   template:'templates/default.html',
> +   template:'src/templates/default.html',
>     entry:{
>       p1:{describe:'p1'},
>       p2:{describe:'p2'}
>     },
>   }
> });
> ```
>
> 2. layout 文件调整（在 mpa 中没有 react router ，layout 要通过 children 访问）：
>
> ```ts
> // src/layouts/index.tsx
>
> export default function Layout({ children }) {
>   return (
>     <div>
>       {children}
>     </div>
>   );
> }
> ```
>
> 经过以上两个调整我是可以跑起来的，访问 `http://localhost:8000/p1.html` 。

这边找到原因了，似乎是getConfigFromEntryFile 引起的。将其设置为false即可。如果设置为true，将会报以下错误：
![image](https://user-images.githubusercontent.com/8411877/215699066-fd1e657e-f242-4b30-9d7c-6a2a82863f45.png)
似乎是virtual-entry没有拼接正确的路径导致的

## wangyunlong0418

![image](https://user-images.githubusercontent.com/27914380/222197143-19682322-c72f-4ac5-a3a2-ebe1bec7b0a6.png)

为什么启动之后就是404，官方的example也是404

"umi": "^4.0.53",

## fz6m

mpa 是独立的页面，需要以 `路由.html` 访问。
