# Cannot find module 'webpack/lib/TemplatedPathPlugin'

<!--
æ„Ÿè°¢æ‚¨å‘æˆ‘ä»¬åé¦ˆé—®é¢˜ï¼Œä¸ºäº†é«˜æ•ˆçš„è§£å†³é—®é¢˜ï¼Œæˆ‘ä»¬æœŸæœ›ä½ èƒ½æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š
-->

## What happens?

æˆ‘åœ¨é›†æˆ @dr.pogodin/babel-plugin-react-css-modules è¿™ä¸ªbabelæ’ä»¶çš„æ—¶å€™ï¼Œç¼–è¯‘ä¼šæŠ¥é”™

```bash
fatal - Error: ERROR in ./src/.umi-production/umi.ts
Module build failed (from ./node_modules/.pnpm/registry.npmmirror.com+@umijs+bundler-webpack@4.0.52_typescript@4.9.5/node_modules/@umijs/bundler-webpack/compiled/babel-loader/index.js):
Error: [BABEL]: Cannot find module 'webpack/lib/TemplatedPathPlugin'
```

æˆ‘åœ¨bundler-webpackä»£ç ä¸­ä¼¼ä¹æ²¡æ‰¾åˆ°TemplatedPathPluginã€‚
https://github.com/umijs/umi/blob/master/packages/bundler-webpack/package.json

æ˜¯é¢„æ‰“åŒ…çš„webpackæœ‰ä»€ä¹ˆæ²¡ä¾èµ–è¿›æ¥å—ï¼Ÿ

è¿™æ˜¯æˆ‘å’Œåº“ä½œè€…çš„å¯¹è¯
https://github.com/birdofpreyru/babel-plugin-react-css-modules/issues/37

## Mini Showcase Repository(REQUIRED)

<!-- ä¸ºèŠ‚çº¦å¤§å®¶çš„æ—¶é—´ï¼Œæ— å¤ç°æ­¥éª¤çš„ ISSUE ä¼šè¢«å…³é—­ï¼Œæä¾›ä¹‹åå† REOPEN -->
<!-- YOUR_REPOSITORY_URL on github or stackbliz -->

## How To Reproduce

```bash
pnpm build
```

## Context

- **Umi Version**:
  "umi": "^4.0.52"
- **Node Version**:
  node -v v16.19.0
- **Platform**:
  mac

## fz6m

éœ€è¦åœ¨ [è¿™ä¸ªæ–‡ä»¶](https://github.com/umijs/umi/blob/master/packages/bundler-webpack/bundles/webpack/packages/deepImports.json) é‡Œé¢åŠ ä¸€ä¸‹è¿™ä¸¤é¡¹ï¼š

```diff
+  'webpack/lib/TemplatedPathPlugin',
+  'webpack/lib/util/createHash'
```

ä¹‹åæ‰§è¡Œä¸€ä¸‹é¢„æ‰“åŒ…ï¼š

```bash
  pnpm build:deps --dep ./bundles/webpack/bundle
```

PR Welcome

## beilo

@fz6m é¢„æ‰“åŒ…å¥½äº†ã€‚æˆ‘è¯¥æ€ä¹ˆæ“ä½œæ‰èƒ½æœ¬åœ°éªŒè¯å‘€ï¼Ÿ

æƒ³éªŒè¯ä¸‹çœ‹çœ‹ï¼Œä½†æ˜¯ä¸çŸ¥é“å’‹ç”¨ğŸ˜‚

## fz6m

æ‹·è´ä¸€ä¸‹ `packages/umi/bin/umi.js` çš„å®Œæ•´è·¯å¾„ï¼Œç„¶ååˆ°ä½ çš„é¡¹ç›®æ ¹ç›®å½•è¿è¡Œï¼š

```bash
  node ${full-path} dev
```

å¦‚æœä½ ç”¨çš„æ˜¯ max å°±å» copy max çš„è·¯å¾„ã€‚

## beilo

@fz6m å¥½å¥‡æ€ªã€‚æˆ‘æ‰§è¡Œäº†é¢„æ‰“åŒ…å
packages\bundler-webpack\compiled\webpack\deepImports.json

```diff
 + "webpack/lib/TemplatedPathPlugin",
 + "webpack/lib/util/createHash"
```

æœ‰å˜æ›´
packages\bundler-webpack\compiled\webpack\index.js
// æ–°å¢
packages\bundler-webpack\compiled\webpack\lazy-compilation-node.js
packages\bundler-webpack\compiled\webpack\lazy-compilation-web.js

è¿˜æ˜¯æ²¡æœ‰TemplatedPathPluginè¿™ä¸ªå…³é”®å­—
å¹¶ä¸”åœ¨demoé¡¹ç›®æ‰§è¡Œï¼Œè¿˜æ˜¯æ‰¾ä¸åˆ°

```bash
node C:\Users\leip\Desktop\umi\packages\umi\bin\umi.js dev

Cannot find module 'C:\Users\leip\Desktop\umi\packages\bundler-webpack\compiled\webpack\TemplatedPathPlugin'
Require stack:
- C:\Users\leip\Desktop\umi-codemao-mobile\node_modules\.pnpm\registry.npmmirror.com+@dr.pogodin+babel-plugin-react-css-modules@6.9.3\node_modules\@dr.pogodin\babel-plugin-react-css-modules\dist\getLocalIdent.js
- C:\Users\leip\Desktop\umi-codemao-mobile\node_modules\.pnpm\registry.npmmirror.com+@dr.pogodin+babel-plugin-react-css-modules@6.9.3\node_modules\@dr.pogodin\babel-plugin-react-css-modules\dist\requireCssModule.js
- C:\Users\leip\Desktop\umi-codemao-mobile\node_modules\.pnpm\registry.npmmirror.com+@dr.pogodin+babel-plugin-react-css-modules@6.9.3\node_modules\@dr.pogodin\babel-plugin-react-css-modules\dist\index.js
```

## fz6m

çœ‹äº†ä¸€ä¸‹ï¼Œæ²¡æ‰¾åˆ°å¾ˆå¥½çš„è§£å†³æ–¹æ¡ˆï¼Œå› ä¸ºè¿™ä¸ª babel æ’ä»¶ç”¨äº†æ·±å±‚å¯¼å…¥ webpack å†…éƒ¨çš„ä¸œè¥¿ï¼š

```ts
// https://github.com/birdofpreyru/babel-plugin-react-css-modules/blob/master/src/getLocalIdent.js

import TemplatedPathPlugin from "webpack/lib/TemplatedPathPlugin";
import createHash from "webpack/lib/util/createHash";
```

è€Œ webpack æ²¡æœ‰å…¬å¼€è¿™ä¸¤ä¸ªæ–¹æ³•ï¼ŒåŒæ—¶ umi ä¸æä¾›éå…¬å¼€æ–¹æ³•çš„ webpack å¯¼å‡ºï¼Œæ‰€ä»¥å°±æ‰¾ä¸åˆ°ã€‚

ç›®å‰æƒ³åˆ°çš„ä¸€ä¸ªæ¯”è¾ƒ hack çš„è§£å†³æ–¹æ³•æ˜¯ï¼š

```bash
  pnpm add -D webpack
```

```ts
// .umirc.ts

import path from "path";

function webpackDeepPathImportWorkaround() {
  const webpackPath = path.join(__dirname, "./node_modules/webpack/lib");
  const mod = require("module");
  const resolveFilename = mod._resolveFilename;
  const hookPropertyMap = new Map();
  hookPropertyMap.set(
    "webpack/lib/TemplatedPathPlugin",
    path.join(webpackPath, "./TemplatedPathPlugin.js"),
  );
  hookPropertyMap.set(
    "webpack/lib/util/createHash",
    path.join(webpackPath, "./util/createHash.js"),
  );
  mod._resolveFilename = function (
    request: string,
    parent: any,
    isMain: boolean,
    options: any,
  ) {
    const hookResolved = hookPropertyMap.get(request);
    if (hookResolved) request = hookResolved;
    return resolveFilename.call(mod, request, parent, isMain, options);
  };
}
webpackDeepPathImportWorkaround();

// åœ¨è¿™è¡Œå¯¼å…¥ä¸Šé¢æ·»åŠ è¿™ä¸ªå‡½æ•° â†‘
const {
  getLocalIdent,
  generateScopedNameFactory,
} = require("@dr.pogodin/babel-plugin-react-css-modules/utils");
```

## beilo

@fz6m éå¸¸æ„Ÿè°¢ï¼ï¼ï¼
