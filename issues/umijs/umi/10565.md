# Cannot find module 'webpack/lib/TemplatedPathPlugin'

<!--
感谢您向我们反馈问题，为了高效的解决问题，我们期望你能提供以下信息：
-->

## What happens?

我在集成 @dr.pogodin/babel-plugin-react-css-modules 这个babel插件的时候，编译会报错

```bash
fatal - Error: ERROR in ./src/.umi-production/umi.ts
Module build failed (from ./node_modules/.pnpm/registry.npmmirror.com+@umijs+bundler-webpack@4.0.52_typescript@4.9.5/node_modules/@umijs/bundler-webpack/compiled/babel-loader/index.js):
Error: [BABEL]: Cannot find module 'webpack/lib/TemplatedPathPlugin'
```

我在bundler-webpack代码中似乎没找到TemplatedPathPlugin。
https://github.com/umijs/umi/blob/master/packages/bundler-webpack/package.json

是预打包的webpack有什么没依赖进来吗？

这是我和库作者的对话
https://github.com/birdofpreyru/babel-plugin-react-css-modules/issues/37

## Mini Showcase Repository(REQUIRED)

<!-- 为节约大家的时间，无复现步骤的 ISSUE 会被关闭，提供之后再 REOPEN -->
<!-- YOUR_REPOSITORY_URL on github or stackbliz -->

## How To Reproduce

```bash
pnpm build
```

## Context

- **Umi Version**:
  "umi": "^4.0.52"
- **Node Version**:
  node -v v16.19.0
- **Platform**:
  mac

## fz6m

需要在 [这个文件](https://github.com/umijs/umi/blob/master/packages/bundler-webpack/bundles/webpack/packages/deepImports.json) 里面加一下这两项：

```diff
+  'webpack/lib/TemplatedPathPlugin',
+  'webpack/lib/util/createHash'
```

之后执行一下预打包：

```bash
  pnpm build:deps --dep ./bundles/webpack/bundle
```

PR Welcome

## beilo

@fz6m 预打包好了。我该怎么操作才能本地验证呀？

想验证下看看，但是不知道咋用😂

## fz6m

拷贝一下 `packages/umi/bin/umi.js` 的完整路径，然后到你的项目根目录运行：

```bash
  node ${full-path} dev
```

如果你用的是 max 就去 copy max 的路径。

## beilo

@fz6m 好奇怪。我执行了预打包后
packages\bundler-webpack\compiled\webpack\deepImports.json

```diff
 + "webpack/lib/TemplatedPathPlugin",
 + "webpack/lib/util/createHash"
```

有变更
packages\bundler-webpack\compiled\webpack\index.js
// 新增
packages\bundler-webpack\compiled\webpack\lazy-compilation-node.js
packages\bundler-webpack\compiled\webpack\lazy-compilation-web.js

还是没有TemplatedPathPlugin这个关键字
并且在demo项目执行，还是找不到

```bash
node C:\Users\leip\Desktop\umi\packages\umi\bin\umi.js dev

Cannot find module 'C:\Users\leip\Desktop\umi\packages\bundler-webpack\compiled\webpack\TemplatedPathPlugin'
Require stack:
- C:\Users\leip\Desktop\umi-codemao-mobile\node_modules\.pnpm\registry.npmmirror.com+@dr.pogodin+babel-plugin-react-css-modules@6.9.3\node_modules\@dr.pogodin\babel-plugin-react-css-modules\dist\getLocalIdent.js
- C:\Users\leip\Desktop\umi-codemao-mobile\node_modules\.pnpm\registry.npmmirror.com+@dr.pogodin+babel-plugin-react-css-modules@6.9.3\node_modules\@dr.pogodin\babel-plugin-react-css-modules\dist\requireCssModule.js
- C:\Users\leip\Desktop\umi-codemao-mobile\node_modules\.pnpm\registry.npmmirror.com+@dr.pogodin+babel-plugin-react-css-modules@6.9.3\node_modules\@dr.pogodin\babel-plugin-react-css-modules\dist\index.js
```

## fz6m

看了一下，没找到很好的解决方案，因为这个 babel 插件用了深层导入 webpack 内部的东西：

```ts
// https://github.com/birdofpreyru/babel-plugin-react-css-modules/blob/master/src/getLocalIdent.js

import TemplatedPathPlugin from "webpack/lib/TemplatedPathPlugin";
import createHash from "webpack/lib/util/createHash";
```

而 webpack 没有公开这两个方法，同时 umi 不提供非公开方法的 webpack 导出，所以就找不到。

目前想到的一个比较 hack 的解决方法是：

```bash
  pnpm add -D webpack
```

```ts
// .umirc.ts

import path from "path";

function webpackDeepPathImportWorkaround() {
  const webpackPath = path.join(__dirname, "./node_modules/webpack/lib");
  const mod = require("module");
  const resolveFilename = mod._resolveFilename;
  const hookPropertyMap = new Map();
  hookPropertyMap.set(
    "webpack/lib/TemplatedPathPlugin",
    path.join(webpackPath, "./TemplatedPathPlugin.js"),
  );
  hookPropertyMap.set(
    "webpack/lib/util/createHash",
    path.join(webpackPath, "./util/createHash.js"),
  );
  mod._resolveFilename = function (
    request: string,
    parent: any,
    isMain: boolean,
    options: any,
  ) {
    const hookResolved = hookPropertyMap.get(request);
    if (hookResolved) request = hookResolved;
    return resolveFilename.call(mod, request, parent, isMain, options);
  };
}
webpackDeepPathImportWorkaround();

// 在这行导入上面添加这个函数 ↑
const {
  getLocalIdent,
  generateScopedNameFactory,
} = require("@dr.pogodin/babel-plugin-react-css-modules/utils");
```

## beilo

@fz6m 非常感谢！！！
