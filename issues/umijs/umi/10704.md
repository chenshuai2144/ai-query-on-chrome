# 模块联邦相关配置（mf），在生产环境报错

## What happens?

umi4，下载官方仓库examples文件夹下的 mf-remote 和 mf-host 文件夹；

分别`npm run dev`，然后运行，没有任何问题，可以工作；

然而运行 `npm run build`, 然后使用http-server分别起服务以后，会报错，mf-host提示`Shared module is not available for eager consumption`， mf-remote能正常获取到。

这个我理解是加载顺序的问题，但已经按照官方仓库配置了eager，按道理不应该再次出现。

## Mini Showcase Repository(REQUIRED)

参照官方仓库/examples下的mf-remote和mf-host即可复现。

我自己也建了一个仓库

https://github.com/lisleyang/umi-mf-issue

## How To Reproduce

cd mf-remote && npm run build
cd mf-remote/dist && http-server . -p 9000

cd mf-host && npm run build
cd mf-host/dist && http-server .

此时会报错

`Shared module is not available for eager consumption`

## Context

- **Umi Version**: 4
- **Node Version**: 14.20
- **Platform**: mac

  ## lisleyang

  @txp1035 大佬，应该不是端口的问题，remote.js是能拿到的。

您能帮忙跟进一下这个问题么？我们在dev环境已经构建了一些组件，准备上线发现了这个问题。

需要的话您可以私聊我

## txp1035

> @txp1035 大佬，应该不是端口的问题，remote.js是能拿到的。
>
> 您能帮忙跟进一下这个问题么？我们在dev环境已经构建了一些组件，准备上线发现了这个问题。
>
> 需要的话您可以私聊我

![image](https://user-images.githubusercontent.com/9554297/223699738-2c7e9ca6-35ca-448a-bab9-77441f3ee617.png)
在看，你的错误码和我这个一样不

## lisleyang

@txp1035 一模一样，感谢🙏

## fz6m

有空可以看下这个问题 @stormslowly 🌹

## lisleyang

@txp1035 @stormslowly 两位大佬，这个bug现在有进度了么？我理解，这个解决不了，umi的整个mf相关功能是无法使用的。

我们团队这边，在npm run dev的时候开发了几周的组件，现在部署不了，很崩溃。

## stormslowly

这个需要在 entry 变成异步启动 避免 我看下怎么配置好弄

## lisleyang

@stormslowly 感谢，我看webpack的文档也是建议这种思路，而不是绑定eager。
现在eager有问题，但是确实没在umi的文档找到怎么异步起动。

## stormslowly

> @stormslowly 感谢，我看webpack的文档也是建议这种思路，而不是绑定eager。 现在eager有问题，但是确实没在umi的文档找到怎么异步起动。

你先这么配置下

在 host 端 新建 .umirc.prod.ts or config/config.prod.ts  
内容

```ts
export {
mfsu:false
}
```

重新构建 host 端，然后试试

原先有个假设是 production 环境是没有 mfsu 的，应该 production 构建时，这个配置还在，
mf 插件就认为不需要异步 entry 了，（ 因为 mfsu 会异步 entry）

## lisleyang

@stormslowly

试了下确实可以。

那我是不是可以这样，根据环境变量，来区分mfsu的配置。如果生产环境的话就关闭mfsu，这样不会影响mf的功能。

这样的话对构建结果会不会有其他影响？没有的话我们就先这么救急，后面您在慢慢看下。

## stormslowly

你就这么配置就行 umi 会根据环境变量来合并对应的环境的配置文件，如果你在 dev 阶段 `*.prod.ts` 是不生效的, （mfsu 还是正常用）
`*.prod.ts` 文件提交到代码库即可。

如果没问题了就 close issue 吧

## lisleyang

明白，那我关了

## fz6m

感觉是一个坑，建议在源码根本解决掉：https://github.com/umijs/umi/pull/10721#issuecomment-1463761121

## liangchaofei

> 明白，那我关了

方便加个联系方式吗
