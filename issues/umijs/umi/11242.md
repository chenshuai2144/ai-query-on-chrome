# [Bug] 在 esmodule 中 import 其他包时无法正确解析

  <!--
感谢您向我们反馈问题，为了高效的解决问题，我们期望你能提供以下信息：
-->

## What happens?

**1. 在 node_modules 中有一个 type=module 的包，假设为 '@scope/a'，在 app.ts 按如下方式引入：**

app.ts

```typescript
import A from "@scope/a";
```

**2. 而在 '@scope/a' 中的 esmodule 脚本中通过 import 语句引入了包 `m`：**

@scope/a/dist/index.es.js

```javascript
//...
import M from 'm';
const L = M.create({//...})
//...
```

**3. 此时引入后报错，M 上没有 create 方法：**

报错：
![CleanShot 2023-06-06 at 21 23 40@2x](https://github.com/umijs/umi/assets/17818522/4112ac16-82e2-44f0-bb8d-4d38b0289576)

**4. 打印 M 后发现引入的内容为：**

<img width="322" alt="CleanShot 2023-06-06 at 21 24 15@2x" src="https://github.com/umijs/umi/assets/17818522/582c08f5-a08e-4c7d-87b3-ee2903d56169">

**5. 但是如果直接在 app.ts 中引入 'm' 库，或者是将 '@scope/a' 中的 index.es.js 直接放到 src 中引入，都能够得到正常的默认导出；**

请问该问题可以通过什么样的配置解决吗？

## Mini Showcase Repository(REQUIRED)

抱歉，内部项目短期内不太好提供复现库，如果通过上面信息不好推断问题所在我再想办法创建一个类似项目吧🙏🏻

## How To Reproduce

**Steps to reproduce the behavior:** 1. 2.

**Expected behavior** 1. 2.

'@scope/a' 中的 `import M from 'm'` 语句可以正常引入其默认导出

## Context

- **Umi Version**: 4.0.47
- **Node Version**: 16.4.2
- **Platform**: macOS 11.4

  ## fz6m

  你需要自己处理好 es 互操作的问题（指什么时候取 default 什么时候取本身），你需要用 tsc 或者 father 这样的打包器打包你的 `@scope/a` 这个包，生成的代码里会自动添加胶水代码用于解决 es 互操作问题，这样你无需关心他是不是 esmodule 打包而成的，也就是无需关心导出在不在 default 上的问题。

umi 不会处理 node_modules 里面的代码的 es 互操作问题，这需要包开发者自己就解决。

## shockw4ver

> 你需要自己处理好 es 互操作的问题（指什么时候取 default 什么时候取本身），你需要用 tsc 或者 father 这样的打包器打包你的 `@scope/a` 这个包，生成的代码里会自动添加胶水代码用于解决 es 互操作问题，这样你无需关心他是不是 esmodule 打包而成的，也就是无需关心导出在不在 default 上的问题。
>
> umi 不会处理 node_modules 里面的代码的 es 互操作问题，这需要包开发者自己就解决。

但是如果把文件复制到 src 目录下直接引用，编译就符合预期了，有办法让 node_modules 里的包被视为普通文件引入吗

## fz6m

你是这个包的作者的话，你要在这个包构建上就解决这个问题，不然任何人都是没法用你这个包的。

可以尝试用 [`extraBabelIncludes`](https://umijs.org/docs/api/config#extrababelincludes) 这个选项配上你的包名看看有效没，我没试过。

## shockw4ver

> 你是这个包的作者的话，你要在这个包构建上就解决这个问题，不然任何人都是没法用你这个包的。
>
> 可以尝试用 [`extraBabelIncludes`](https://umijs.org/docs/api/config#extrababelincludes) 这个选项配上你的包名看看有效没，我没试过。

有尝试过 extraBabelIncludes，但还是会有相同问题；
这个包在其他 webpack 系下的项目是 ok 的，现在是想使用 umi 重构整个项目，然后遇到了这个问题；

另外还发现一种方式也能跑通：

1. 将这个包的 type 从 module 改为 commonjs；
2. 同时通过 alias 将它定位到 cjs 格式的文件上（包同时产出了 cjs 和 es 两种格式，通过 package.json 的 exports 定向）；

第一步还不能缺少，否则会报 `export 'default' (imported as 'A') was not found in '@scope/a' (module has no exports)`，所以像是编译系统对 type=module 的包有另外处理？

## fz6m

需要给一个最小复现才能排查问题。
