# layouts/index.tsx无效

## layouts/index.tsx没有渲染

下面这段文字是官方文档的描述，但发现并么有效果。
不管我在config中有没有开启layout配置，
已经在app.tsx中有没有开启layout，
都无法正常渲染
我本是想自己渲染路由的，实在行不通

> 然后在 src/layouts/index 中通过 props.children 渲染子路由，

```tsx
export default (props) => {
  console.log("layout渲染===这段文字没有被打印");
  return <div style={{ padding: 20 }}>{props.children}</div>;
};
```

这样，访问 /list 和 /admin 就会带上 src/layouts/index 这个 layout 组件。

A clear and concise description of what the bug is.

## app.tsx

```tsx
/** 库 */
import React from "react";
import { history } from "umi";

/** 国际化，不需要在config配置，否则需要在 src/locales 中配置对应路由等变量 */
import zhCN from "antd/es/locale/zh_CN";
import { ConfigProvider } from "antd";

// import { getMenuData } from "@ant-design/pro-layout";

/** 组件--antd优先 */
// import { RightRender } from "@/layouts";

/** 本地utils、模块 */
// import router from "@/router";
// import logo from "@/assets/logo-small.png";
import { getRoutePathMap } from "@/utils/getMap";
import defaultSettings, { DefaultSettings } from "../config/defaultSettings";

export async function getInitialState(): Promise<{
  currentUser?: any;
  settings?: DefaultSettings;
}> {
  // 如果是登录页面，不执行
  if (history.location.pathname !== "/user/login") {
    try {
      // const currentUser = await queryCurrent();
      return {
        // currentUser,
        settings: defaultSettings,
      };
    } catch (error) {
      history.push("/user/login");
    }
  }
  return {
    settings: defaultSettings,
  };
}

// export function patchRoutes({ routes }) {
//     merge(routes, extraRoutes);
// }

/** 在初始加载和路由切换时做一些事情--比如用于做埋点统计/比如用于设置标题 */
export function onRouteChange({
  matchedRoutes,
  location,
  routes,
  action,
}: {
  matchedRoutes: any;
  location: any;
  routes: any;
  action: any;
}) {
  // 页面title配置
  document.title = "昂司配送后台管理系统";
  // console.log(location, routes);
  try {
    const { pathname } = location;
    const patern = getRoutePathMap(routes).filter(
      (path: string) => path === pathname,
    );
    /** 地址不完全匹配跳转404 */
    if (patern.length === 0) {
      history.push("/404");
    }
  } catch (error) {
    console.log(error);
  }
}

/** render覆写 render，会直接阻断所有的运行时 */
export function render(oldRender: any) {
  const userInfo = JSON.parse(sessionStorage.getItem("userInfo") || "{}");
  if (userInfo.token) {
    oldRender();
  } else {
    history.push("/user/login");
    oldRender();
  }
}

/** 修改交给 react-dom 渲染时的根组件 */
// export function rootContainer(container,args:{routes，全量路由配置,plugin，运行时插件机制，history，history 实例}) {
export function rootContainer(container: any) {
  // 比如用于在外面包一个 Provider
  const ThemeProvider = () => (
    <div id="root-out">
      <ConfigProvider locale={zhCN}>{container}</ConfigProvider>
    </div>
  );
  return React.createElement(ThemeProvider, null, container);
}
```

- **Umi Version**:
- **Node Version**:
- **Platform**:

```json
    "@amap/amap-jsapi-types": "^0.0.4",
    "@ant-design/pro-layout": "^5.0.9",
    "@ant-design/pro-table": "^2.2.7",
    "@types/jest": "^25.2.1",
    "@types/react": "^16.9.34",
    "@umijs/hooks": "^1.9.2",
    "@umijs/preset-react": "1.x",
    "@umijs/test": "^3.1.1",
    "antd-dayjs-webpack-plugin": "^1.0.0",
    "cross-env": "^7.0.2",
    "html2canvas": "^1.0.0-rc.5",
    "lint-staged": "^10.0.7",
    "postcss-px-to-viewport": "^1.1.1",
    "prettier": "^2.0.5",
    "react": "^16.12.0",
    "react-amap": "^1.2.8",
    "react-dom": "^16.12.0",
    "stylus": "^0.54.7",
    "stylus-loader": "^3.0.2",
    "ts-md5": "^1.2.7",
    "typescript": "^3.8.3",
    "umi": "^3.1.1",
    "yorkie": "^2.0.0"
```

## xiaohuoni

layouts/index 是约定式才会自动生效的，配置式是需要自己引用的。提问题，最好附上重现demo。至少附上你的配置。

## haoyinag

上面是app配置。下面是config配置

```ts
import { defineConfig } from "umi";

//屏幕自适应--使用于移动端
// const pxtoviewport = require("postcss-px-to-viewport");
import AntdDayjsWebpackPlugin from "antd-dayjs-webpack-plugin";

// import webpackConfig from './webpack.config'

import proxy from "./proxy";

const env = process.env.NODE_ENV;
const { API_ENV } = process.env;
// import logo from '/src/asset/logo.svg';

/** 把路由文件放在src下是为了方便按模块拆分组装路由表，而且方便通过请求配置access */
import routes from "../src/router";

let configParams: any = {
  // title: 'site.title',
  hash: true,
  base: "/",
  history: { type: "hash" },
  /** 如果生产环境也是/，页面会白屏 */
  publicPath: env === "development" ? "/" : "./",
  favicon: "/public/favicon.ico",
  define: {
    API_ENV,
  },
  // mock: false, // mock开关
  /** 开启dva */
  dva: {
    hmr: true, // 热更新
    immer: true, // 是否启用 immer 以方便修改 reducer
    skipModelValidate: false, // 是否跳过 model 验证
    extraModels: [], // 配置额外到 dva model
  },
  /** 启用antd */
  antd: {
    dark: false, // 开启暗色主题
    compact: false, // 开启紧凑主题
  },
  analyze: {
    analyzerMode: "server",
    analyzerPort: 8888,
    openAnalyzer: true,
    // generate stats file while ANALYZE_DUMP exist
    generateStatsFile: false,
    statsFilename: "stats.json",
    logLevel: "info",
    defaultSizes: "parsed", // stat  // gzip
  },
  routes,
  headScripts: [`console.log("页面加载");`],
  /** 浏览器兼容 */
  targets: {
    // { chrome: 49, firefox: 64, safari: 10, edge: 13, ios: 10 }
    ie: 11,
  },
  /** 开启按需加载 */
  dynamicImport: {
    loading: "@/Loading", // 全局loading组件
  },
  /** 主题配置 */
  theme: {
    // ...darkTheme,
    // 'primary-color': defaultSettings.primaryColor,
  },
  /** 忽略 moment 的 locale 文件，用于减少尺寸 */
  ignoreMomentLocale: true,
  // lessLoader: {}
  /** 设置 node_modules 目录下依赖文件的编译方式, */
  nodeModulesTransform: {
    type: "none",
  },
  /** 只在 umi build 时会生成，配置是否需要生成额外用于描述产物的 manifest 文件，默认会生成 asset-manifest.json */
  manifest: {
    basePath: "/", // 给所有文件路径加前缀
  },
  postcssLoader: {},
  proxy: proxy.dev,
  extraPostCSSPlugins: [],
};

const chainWebpackDev = (config: any) => {
  /** dayjs替换momentjs */
  config.plugin("AntdDayjsWebpackPlugin").use(AntdDayjsWebpackPlugin);
  config.module
    .rule("stylus")
    .test(/\.styl$/)
    .use("style-loader!css-loader!stylus-loader")
    .loader("style-loader!css-loader!stylus-loader");
  return config;
};

const chainWebpackPro = (config: any) => {
  /** 打包优化 */
  config.merge({
    optimization: {
      minimize: true,
      splitChunks: {
        chunks: "all",
        minSize: 30000,
        minChunks: 3,
        automaticNameDelimiter: ".",
        cacheGroups: {
          vendor: {
            name: "vendors",
            test(testConfit: any) {
              return /[\\/]node_modules[\\/]/.test(testConfit.resource);
            },
            priority: 10,
          },
          icons: {
            name: "icons",
            chunks: "all",
            test: /[\\/]node_modules[\\/](@ant-design)[\\/]/,
          },
          commons: {
            name: "commons",
            chunks: "async",
            minChunks: 2,
            minSize: 0,
          },
        },
      },
    },
  });
  return { ...chainWebpackDev(config), ...config };
};

if (env === "production") {
  configParams = {
    ...configParams,
    chunks: ["vendors", "umi"],
    chainWebpack: (config: any) => chainWebpackPro(config),
  };
}

let config = defineConfig(configParams);
export default config;
```

## haoyinag

@xiaohuoni
**需求是通过登录成功后请求路由，折腾了好久，终于大致实现了**
下面是修改过后的`app.tsx`

```tsx
/** 库 */
import React, { useEffect } from "react";
import { UseRequestProvider } from "ahooks";
import { history, useDispatch, useSelector } from "umi";

import ProLayout from "@ant-design/pro-layout";

/** 国际化，不需要在config配置，否则需要在 src/locales 中配置对应路由等变量 */
import zhCN from "antd/es/locale/zh_CN";
import { ConfigProvider } from "antd";

/** 组件--antd优先 */
import { RightRender } from "@/layouts/RightRender";

/** 本地utils、模块 */

// import logo from "@/assets/logo-small.png";
import defaultSettings, { DefaultSettings } from "../config/defaultSettings";
import { getRoutePathMap } from "@/utils/getMap";

export async function getInitialState(): Promise<{
  currentUser?: any;
  settings?: DefaultSettings;
}> {
  // 如果是登录页面，不执行
  if (history.location.pathname !== "/user/login") {
    try {
      return {
        settings: defaultSettings,
      };
    } catch (error) {
      history.push("/user/login");
    }
  }
  return {
    settings: defaultSettings,
  };
}

// export function patchRoutes({ routes }: any) {
//   return routes;
// }

/** 在初始加载和路由切换时做一些事情--比如用于做埋点统计/比如用于设置标题 */
export async function onRouteChange({
  // matchedRoutes,
  location,
  routes,
}: // action,
{
  // matchedRoutes: any;
  location: any;
  routes: any;
  // action: any;
}) {
  // 页面title配置
  document.title = "昂司配送后台管理系统";
  try {
    const { pathname } = location;
    const patern = getRoutePathMap(routes).filter(
      (path: string) => path === pathname,
    );

    /** 地址不完全匹配跳转404 */
    if (patern.length === 0) {
      history.push("/404");
    }
  } catch (error) {
    console.log(error);
  }
}

/** render覆写 render，会直接阻断所有的运行时 */
export function render(oldRender: any) {
  const userInfo = JSON.parse(sessionStorage.getItem("userInfo") || "{}");
  if (userInfo.token) {
    oldRender();
  } else {
    history.push("/user/login");
    oldRender();
  }
}

function Tes(children: any) {
  const dispatch = useDispatch();
  const { router } = useSelector<any, any>((state: any) => {
    return state.login;
  });

  const { hash } = window.location;
  useEffect(() => {
    if (!hash?.split("/")[1] && router?.length === 0) {
      dispatch({
        type: "login/getRouter",
      });
    }
  }, []);

  if (router?.length > 0) {
    return (
      <ProLayout
        // layout={"topmenu"}
        // navTheme={"light"}
        rightContentRender={() => <RightRender />}
        menuDataRender={(routes: any[]) => {
          return routes?.concat(router);
        }}
        onCollapse={(location: any) => {
          console.log(location);
        }}
        onPageChange={(location: any) => {
          console.log(location);
        }}
        menuProps={{
          onSelect: (routeItem: any) => {
            console.log(routeItem);
            // const { key } = routeItem;
            // key && history.push(key);
          },
          onClick: (routeItem: any) => {
            const { key } = routeItem;
            console.log(key);

            key && history.push(key);
          },
        }}
      >
        {children}
      </ProLayout>
    );
  }
  if (
    hash !== "/user/login" &&
    hash !== "#/user/login" &&
    router?.length === 0
  ) {
    console.log("进入子页面而且路由表为 [] 并刷新页面，回到登录页");
    dispatch({
      type: "login/saveLoginState",
      payload: "leaveIndex",
    });
    history.push("/user/login");
    return;
  }
  // 登录页
  return children;
}

/** 修改交给 react-dom 渲染时的根组件 */
// export function rootContainer(container,args:{routes，全量路由配置,plugin，运行时插件机制，history，history 实例}) {
export function rootContainer(container: any) {
  // 比如用于在外面包一个 Provider
  const ThemeProvider = () => (
    <UseRequestProvider
      value={{
        manual: true, // 手动才触发
        // loadingDelay: 500, // loading 延时
        debounceInterval: 350, // 防抖
        // refreshOnWindowFocus: true,
        onError: (err) => {
          console.log(err);
        },
        onSuccess: (res) => {
          console.log(res);
        },
      }}
    >
      <ConfigProvider locale={zhCN}>{Tes(container)}</ConfigProvider>
    </UseRequestProvider>
  );
  return React.createElement(ThemeProvider, null, container);
}
```

##### 这样有一个小问题

就是登录之后进入首页，渲染layout+index内容，
但是按返回上一页之后，layout还是在，同时渲染login内容
所以在上面`Tes`组件写了一堆逻辑去修复，但总感觉这方法有点别扭
**不知道有没有更好的方法，或者我从开始的思路就是错的？**

## haoyinag

`ProLayout`的`onPageChange`并不会执行

## xiaohuoni

配置了 routes 就不会生效。约定式的才会默认生效。

## xiaohuoni

pro 相关的去 pro 提 issues 会好一些。帅帅在那边。

## haoyinag

OK

获取 Outlook for iOS<https://aka.ms/o0ukef>

---

发件人: 小虎oni <notifications@github.com>
发送时间: Wednesday, September 23, 2020 5:42:45 PM
收件人: umijs/umi <umi@noreply.github.com>
抄送: ChenHaoYin <haoyinag0@hotmail.com>; Author <author@noreply.github.com>
主题: Re: [umijs/umi] layouts/index.tsx无效 (#5448)

pro 相关的去 pro 提 issues 会好一些。帅帅在那边。

―
You are receiving this because you authored the thread.
Reply to this email directly, view it on GitHub<https://github.com/umijs/umi/issues/5448#issuecomment-697254536>, or unsubscribe<https://github.com/notifications/unsubscribe-auth/AFZYZ6ZP5ABKCBPQV2OZO3TSHG7JLANCNFSM4RT7PHKQ>.
