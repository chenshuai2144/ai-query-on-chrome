# [Bug] 使用refresh刷新initialState后,access数据已更新但路由状态没有随之更新

`type(bug)`

## What happens?

我正在写一个具有权限控制的管理后台,在登陆成功后,需要获取权限信息配置权限路由. 我研究了脚手架,它也展示了相似的权限控制功能. 而我仿照其功能进行改写时,出现了access文件返回数据已经更新但是路由权限依然没有变化的情况.

我发现其原因是脚手架在登陆页成功登陆后使用以下代码进行跳转
/src/pages/usr/login
`    replaceGoto();
        setTimeout(() => {
          refresh();
     }, 0);`
replaceGoto方法使用了window.location.href进行页面跳转,页面进行了刷新从而获得了最新的权限状态. refresh方法即使注释掉也不会有任何的影响.但是在使用hash路由的菜单中,更换hash后面的路由并不会刷新页面,我的项目使用了window.location.href = ‘'/'跳转到首页的方式可以强制刷新获取最新的权限菜单, 它是目前的替代方案.但我仍然希望能够使用refesh更新access的数据能够生效.

## 期望效果

使用这种代码更新的access数据可以被更新到菜单上
`    await refresh();
    replaceGoto();
    // setTimeout(() => {replaceGoto()}, 100} 这种也不生效`
在调试中发现access文件返回的数据已经更新,但是菜单并没有变化 (使用哈希路由,登陆跳转没有刷新页面)

## 最小可复现仓库

[https://github.com/tingrabbit/umi-refesh-demo](url)

## 复现步骤，错误日志以及相关配置

1. 登陆admin用户,进入菜单管理页->二级管理页,可见权限路由,该用户在权限内
2. 登出
3. 登陆user用户,查看菜单,菜单管理页->二级管理页可见,该用户应不在权限内
4. 按F5进行刷新,路由恢复正常,菜单管理页->二级管理不可见

## 相关环境信息

- **Umi 版本**：^3.2.14
- **Node 版本**：14.7.0
- **操作系统**： mac OS

  ## ycjcl868

  Fast Refresh？

  ## tingrabbit

  > Fast Refresh？

是@umijs/plugin-initial-state的refresh API,我期望用refresh来重新执行 getInitialState 方法，并获取新数据并达到更新权限文件access.ts返回的数据,进而更新菜单权限的功能

## laozhu

遇到同样的问题，现在登录后不得不使用 `window.location.href = '/'` 来刷新权限。

## XSmarter

我也遇到了，升级了umi 到 3.3.2 refresh就正常使用了，可以升级一下试试

## sorrycc

@tingrabbit @laozhu 还有问题吗？

## ouzhou

用的pro-layout, 在refresh后，onPageChange触发时间更快，这个时候拿不到InitialState更新的用户数据，导致虽然登录成功了还是会跳转到登录页面

## ouzhou

@sorrycc

await refresh后, 再跳转页面，拿不到新的state, 必须要await refresh();setTimeout(()=>{ history.push('/') }, 100)

```
// 登录页面
async login() {
   假设这里登录成功了
   await refresh();
   history.push('/')
}

// app.jsx
// getInitialState函数
() => {
  拉取用户数据返回
  return {
       currentUser: {xx:xx},
   };
}

// app.jsx
// layout函数
onPageChange: (e) => {
  const { currentUser } = initialState;
  const { location } = history;
  // 如果没有登录，重定向到 login
  if (!currentUser && location.pathname !== '/login') {
    history.push('/login');
  }
},
```

## okilled

+1

## mumu-baba

+1，因为权限数据是登录完去请求，如果登录完再调用权限接口，等接口值回来，去setInitialState会导致登录页面卡顿，导致权限数据没有返回，onPageChange触发时间太快（因为权限是页面级别等。只能等数据回来才能渲染页面），期待登录成功增加中间过度页，处理项目基础数据等拉取。目前也是用window.location.href 去刷新的。

## mumu-baba

@sorrycc 期待大佬有个好的优化。umi 3.4.7

## AmorDiamond

目前使用的4.0.68版本，仍然存在这个情况，登录后await refresh initialState，然后history.push()进入需要权限的页面，系统会进入403页面。
发现initialState是同步更新了，但是access并没有，onRouteChange之后才会执行access.ts内export的方法

## fz6m

`access` 是静态一次性的，如果需要动态权限变化，要用 [`<Access></Access>`](https://umijs.org/docs/max/access#access-1) 包起来。

## AmorDiamond

@fz6m

>

```
export const routes: Route[] = [
    {
        key: 'dashboard',
        path: '/dashboard',
        component: '@/pages/dashboard/index',
        name: '工作看板',
        icon: 'DashboardOutlined',
        access: 'DASHBOARD',
    },
]
```

这种是直接设置在路由上的。
然后登录成功的时候，通过以下方式处理初始状态数据和跳转系统页面

```
const { refresh } = useModel('@@initialState')
await refresh()
history.replace('/dashboard')
```

![image](https://github.com/umijs/umi/assets/22789550/3abaa76e-a476-48c7-b605-ad363c84ab25)

就会出现进入页面后显示403界面，可能是渲染页面的时候Access的状态数据没有更新。
重新刷新页面就是正常的啦。
