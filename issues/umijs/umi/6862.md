# dumi使用mfsu后， less文件热更新失败

我使用dumi时开户mfsu功能后，更改less文件热更新失败

```
hotModuleReplacement.js:532 Uncaught TypeError: punycode.toASCII is not a function
    at Url.parse (hotModuleReplacement.js:532)
    at Object.urlParse [as parse] (hotModuleReplacement.js:417)
    at module2.exports (hotModuleReplacement.js:1429)
    at getReloadUrl (hotModuleReplacement.js:1586)
    at hotModuleReplacement.js:1601
    at NodeList.forEach (<anonymous>)
    at reloadStyle (hotModuleReplacement.js:1597)
    at update (hotModuleReplacement.js:1638)
    at functionCall2 (hotModuleReplacement.js:1510)
```

这个错误是在浏览器是出现的

断点看了了 punycode 此时是个 {} 空对象

.umirc.ts 文件如下

```
export default {
  mfsu: {},
  webpack5: {},
  dynamicImport: {}
}
```

没有其他任何配置了

- **Umi Version**: 3.5.2
- **Node Version**: v14.15.1
- **Platform**: macOs
- **dumi**: 1.1.23

punycode 看了一下版本

```
├─┬ dumi-theme-mobile@1.1.6
│ └─┬ @umijs/preset-dumi@1.1.23
│   └─┬ rehype-mathjax@3.1.0
│     └─┬ jsdom@16.6.0
│       ├─┬ data-urls@2.0.0
│       │ └─┬ whatwg-url@8.7.0
│       │   └─┬ tr46@2.1.0
│       │     └── punycode@2.1.1 deduped
│       ├─┬ tough-cookie@4.0.0
│       │ └── punycode@2.1.1 deduped
│       └─┬ whatwg-url@8.7.0
│         └─┬ tr46@2.1.0
│           └── punycode@2.1.1 deduped
├─┬ dumi@1.1.23
│ └─┬ umi@3.5.2
│   └─┬ @umijs/bundler-webpack@3.5.2
│     └─┬ node-libs-browser@2.2.1
│       ├── punycode@1.4.1
│       └─┬ url@0.11.0
│         └── punycode@1.3.2
├─┬ fabric@4.5.1 extraneous
│ ├─┬ data-urls@1.1.0 extraneous
│ │ └─┬ whatwg-url@7.1.0
│ │   └─┬ tr46@1.0.1
│ │     └── punycode@2.1.1 deduped
│ ├─┬ jsdom@15.2.1 extraneous
│ │ └─┬ request-promise-native@1.0.9
│ │   └─┬ tough-cookie@2.5.0
│ │     └── punycode@2.1.1 deduped
│ └─┬ tough-cookie@3.0.1 extraneous
│   └── punycode@2.1.1
└─┬ father-build@1.19.6
  └─┬ ajv@6.10.0
    └─┬ uri-js@4.4.1
      └── punycode@2.1.1 deduped
```

## Superman-wc

# 此问题必现的 步骤如下：

## 1.创建一个dumi的项目

`npx @umijs/create-dumi-lib `
安装完依赖后

## 2.修改.umirc.ts文件 如下

```
import { defineConfig } from 'dumi';

export default defineConfig({
  title: 'umi-mfsu-bug',
  favicon: 'https://user-images.githubusercontent.com/9554297/83762004-a0761b00-a6a9-11ea-83b4-9c8ff721d4b8.png',
  logo: 'https://user-images.githubusercontent.com/9554297/83762004-a0761b00-a6a9-11ea-83b4-9c8ff721d4b8.png',
  outputPath: 'docs-dist',
  // more config: https://d.umijs.org/config
  //新增以下三行
  mfsu:{},
  webpack5: {},
  dynamicImport: {},
});
```

## 3.新增一个less文件

src/Foo/index.less

```
.index{
  background-color: #f00;
  font-size:12px;
}
```

## 4. 修改原有的src/Foo/index.tsx文件

```
import React from 'react';
import styles from './index.less'; // 引入样式文件

export default ({ title }: { title: string }) => <h1 className={styles['index']} >{title}</h1>;  // 应用样式到组件上

```

## 5.启动项目

`npm start `

## 6.打开 Food页面

`http://localhost:8000/foo`

## 7.再去修改 src/Foo/index.less文件，保存后就会出现BUG了

```
Uncaught TypeError: punycode.toASCII is not a function
    at Url.parse (hotModuleReplacement.js:532)
    at Object.urlParse [as parse] (hotModuleReplacement.js:417)
    at module2.exports (hotModuleReplacement.js:1429)
    at getReloadUrl (hotModuleReplacement.js:1586)
    at hotModuleReplacement.js:1601
    at NodeList.forEach (<anonymous>)
    at reloadStyle (hotModuleReplacement.js:1597)
    at update (hotModuleReplacement.js:1638)
    at functionCall2 (hotModuleReplacement.js:1510)
```

## Superman-wc

这个问题就是出在umi3.5.2上， 就是不开户mfsu也是如此

## Superman-wc

问题好像找到关键点了
https://github.com/umijs/umi/blob/master/packages/bundler-webpack/bundled/css/hotModuleReplacement.js
这个文件中定义了两次 punycode 的代码，来自两个不同的版本
![image](https://user-images.githubusercontent.com/11311755/124393833-fdba2100-dd2e-11eb-8b60-67d4c74c076a.png)

![image](https://user-images.githubusercontent.com/11311755/124393865-2e9a5600-dd2f-11eb-9853-f78e87e14f41.png)

出错的时候是引用了 "version": "1.3.2", 的并且代码也是以 amd的形式引入的
![image](https://user-images.githubusercontent.com/11311755/124393982-d021a780-dd2f-11eb-9b02-74260b1b8688.png)

建议更新依赖 @sorrycc

## Superman-wc

@sorrycc 我尝试将
https://github.com/umijs/umi/blob/master/packages/bundler-webpack/bundled/css/hotModuleReplacement.js
218行-221行去除后就完美解决了这个问题
同时MFSU的进度条也正常了
![image](https://user-images.githubusercontent.com/11311755/124395027-7bccf680-dd34-11eb-982f-443de9ef3a6d.png)

## RoyRao2333

@sorrycc

所以你们自始自终没有出来回复过一句，别人提个issue还顺带帮你们解决问题？看别人貌似解决了直接close？
