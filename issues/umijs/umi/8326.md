# [Bug] umi@4 开发模式与生产模式下页面样式的表现不一致

`type(mfsu)`

## What happens?

`umi@4`下在配置中开启`antd:{}`，在`global.less`里写一段覆盖`antd`的样式，在开发模式下显示正常（即global里的样式会覆盖antd的样式），但打包后的代码，实际表现为`antd`的样式覆盖`global`的样式

## How To Reproduce

开发模式下
![image](https://user-images.githubusercontent.com/18651667/176639529-d494f1f3-d825-4f26-9da0-bda766b7c8e1.png)

---

生产模式下
![image](https://user-images.githubusercontent.com/18651667/176639828-0de0fb42-086e-4fe7-ae25-cd5dfb8538ea.png)

**Steps to reproduce the behavior:** 1. 2.

1. 用`create-umi`脚手架新建一个项目
2. 在`.umirc.ts`里新增 `antd: {}`配置
3. 在`src/pages/index.tsx`下新增 `<mark>this is a mark</mark>`
4. 新建`src/global.less`，并新增 `mark { padding: 0;  background-color: #ffcf008c; }`

表现为：

1. 开发模式下 `<mark/>`标签应用了`global.less`的样式
2. 生产模式下 `<mark/>`标签应用了`antd`的样式

**Expected behavior** 1. 2.
**希望都表现为用户样式覆盖`antd`样式
至少希望开发模式和生产模式下表现一致**

<!-- 请提供复现链接/步骤，错误日志以及相关配置 -->

## Context

- **Umi Version**: **"@umijs/max": "4.0.3"**
- **Node Version**: **16.15.1**
- **Platform**: **macos**

umi@3下没有此问题，目前个人正在寻找问题出处，尚无结果

## xierenyuan

问题的原因是 目前global.less 默认是在最顶层挂载, 而antd 样式挂载在global.less 之后, 所以生产模式下的表现是正确的, 开发环境之所以覆盖是因为 走了 mfsu 模式 提了三方依赖在global.less 之前(这个可能的@stormslowly 老师 想想有没有解), 可以通过样式权重来确保覆盖, 比如 `.xx-design .ant-btn` 给根节点挂载 .xx-design 类。

## xierenyuan

> 问题的原因是 目前global.less 默认是在最顶层挂载, 而antd 样式挂载在global.less 之后, 所以生产模式下的表现是正确的, 开发环境之所以覆盖是因为 走了 mfsu 模式 提了三方依赖在global.less 之前(这个可能的@stormslowly 老师 想想有没有解), 可以通过样式权重来确保覆盖, 比如 `.xx-design .ant-btn` 给根节点挂载 .xx-design 类。

在补充下 就算调整了global.less 的顺序, 如果antd 开启按需加载 样式依然覆盖不了, 所以还是推荐 通过样式权重来确保覆盖吧.

## qiujie8092916

> 问题的原因是 目前global.less 默认是在最顶层挂载, 而antd 样式挂载在global.less 之后, 所以生产模式下的表现是正确的, 开发环境之所以覆盖是因为 走了 mfsu 模式 提了三方依赖在global.less 之前(这个可能的@stormslowly 老师 想想有没有解), 可以通过样式权重来确保覆盖, 比如 `.xx-design .ant-btn` 给根节点挂载 .xx-design 类。

我想我懂你说的意思了。

1. 貌似只能通过css权重来覆盖antd样式吗？
2. 至少希望开发模式和生产模式下表现一致哦

## xierenyuan

> > 问题的原因是 目前global.less 默认是在最顶层挂载, 而antd 样式挂载在global.less 之后, 所以生产模式下的表现是正确的, 开发环境之所以覆盖是因为 走了 mfsu 模式 提了三方依赖在global.less 之前(这个可能的@stormslowly 老师 想想有没有解), 可以通过样式权重来确保覆盖, 比如 `.xx-design .ant-btn` 给根节点挂载 .xx-design 类。
>
> 我想我懂你说的意思了。
>
> 1. 貌似只能通过css权重来覆盖antd样式吗？
> 2. 至少希望开发模式和生产模式下表现一致哦

如果只是主题色之类的可以通过 theme 来修改, 别的可能通过css 权重来覆盖比较靠谱, 开发模式与生产模板表现不一致的问题 @stormslowly老师在跟, 后续有结论在同步吧.

## phoema

关注+1

## wangzhengbo

关注+1，碰到了类似的问题。开发模式下封装的antd Button的样式不生效，直接被antd内置的样式覆盖了

## wangzhengbo

umi 3没问题，umi 4就有问题

## congwa

关注+1

## congwa

在使用tailwindcss时候 tailwindcss会构建的umi.css最下面，所以一些默认样式会覆盖三方ui库的button组件

## jk4235

之前也遇到过,我直接取消了使用antd插件,自己直接在项目里使用antd

一切都正常了

antd已经支持tree shaking,所以也不需要这个插件来动态引入了

如果你是用的@umi/preset的话,需要自己写个插件,跳过内置的antd插件

```js
export default (api) => {
  api.describe({ ...something });
  // 跳过内置的antd插件
  api.skipPlugins(["@umijs/plugin-antd"]);
};
```

## crazyechoaoo

这个问题没有解法吗

## fz6m

> 这个问题没有解法吗

通过关闭 `mfsu: false` 尝试解决该问题。

## dadazhouRenee

umi 3也有类似的问题呢

## ghost

持续关注 + 1

## lbyupup

umi4 持续关注，字体设置也被覆盖了

## ianccy

got the same issue.
Global.less content will be put before antd.less. so the override style will not work.

## conorzhong

用 tailwindcss 添加在 antd 组件的 className 上面也可能会出现不一致

## lyan-ap

not work
