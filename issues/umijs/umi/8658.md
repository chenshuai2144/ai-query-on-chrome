# [discussion] solution for legacy browsers compatibility

`help wanted`,`type(discussion)`,`Browser Compatibility`

## Background

ç›®å‰ Umi 4 ä¸»è¦ç¢°åˆ°ä¸¤ä¸ªæµè§ˆå™¨å…¼å®¹çš„é—®é¢˜ï¼š

1. `esbuild` ä½œä¸ºå‹ç¼©å™¨ä¼šå¯¹ ES5 ä»£ç åšåå‘ä¼˜åŒ–å˜æˆ ES6ï¼Œå¯¼è‡´é…ç½® `targets` ä»¥åä¸æ”¹å‹ç¼©å™¨ä¹Ÿä¸èƒ½å·¥ä½œï¼Œç”¨æˆ·æ’æŸ¥åŠä½¿ç”¨æˆæœ¬è¾ƒé«˜ï¼Œ from @xiaohuoni
2. ç¤¾åŒºè¶Šæ¥è¶Šå¤šåŒ…åªå‘å¸ƒ ES6 äº§ç‰©ï¼Œä½† Umi 4 é»˜è®¤ä¸ç”¨ babel ç¼–è¯‘ `node_modules`ï¼Œå¯¼è‡´äº§ç‰©é‡Œå‡ºç°é«˜çº§è¯­æ³•ï¼Œæ·»åŠ  `extraBabelIncludes` ä¸€æ—¦æ•°é‡å˜å¤§ç»´æŠ¤æˆæœ¬ä¹Ÿä¼šå˜é«˜ï¼Œfrom @fz6m

## Proposal

æ ¹æ® `targets` è‡ªåŠ¨åˆ‡æ¢æ¡†æ¶é…ç½®ï¼Ÿä¾‹å¦‚ `targets` çš„æœ€ä½æµè§ˆå™¨å¦‚æœä¸å…¼å®¹ ES6ï¼Œé‚£ä¹ˆé»˜è®¤å°±åˆ‡å‹ç¼©å™¨ + `node_modules` èµ°ç¼–è¯‘ã€‚

å¦‚æœæœ‰å…¶ä»–å»ºè®®æˆ–æ–¹æ¡ˆï¼Œè¯·ç›´æ¥åœ¨ä¸‹æ–¹è®¨è®ºã€‚

## fz6m

#### esbuild çš„ â€ä¼˜åŒ–â€œ ç›®å‰é‡åˆ°çš„ä¾‹å­

1. æ¨¡æ¿å­—ç¬¦ä¸²æ¢è¡Œçš„å­—èŠ‚æ•°æ¯” `\n` å°‘ï¼Œæ‰€ä»¥ä¼šä¼˜åŒ–æˆ es6 æ¨¡æ¿å­—ç¬¦ä¸²ï¼š

   ```ts
   `
   `;
   ```

2. chrome 60 ä»¥ä¸Šçš„ targets ä¼šå¯¼è‡´ `rgba()` å˜æˆ `#rrggbbaa` ï¼Œçœå­—èŠ‚

3. å’Œ `parcel-css` ä¸€è‡´ï¼Œåœ¨ä¸æŒ‡å®šä½ targets æ—¶ï¼Œå››è¾¹ `0` å°†è½¬æ¢ä¸º `inset` :

   ```css
   .a {
     left: 0;
     right: 0;
     top: 0;
     bottom: 0;
   }
   .a-transformed {
     inset: 0;
   }
   ```

## fz6m

### ä»…ä¾›å‚è€ƒï¼šæ—§ legacy bundle ä¸€é”®å›å½’ es5 æ‰“åŒ…çš„æ€è·¯æ•´ç†

1. babel å…¨é‡å¤„ç† `node_modules`

2. `srcTranspiler` åªèƒ½ä½¿ç”¨ `babel`

3. `jsMinifier` åªèƒ½ä½¿ç”¨ `terser`

4. `cssMinifier` åªèƒ½ä½¿ç”¨ `cssnano`

5. svgr å¤„ç†æ—¶ï¼Œéœ€è¦æ”¹ä¸º babel è§£æ svg ï¼ˆç°åœ¨æ˜¯ esbuildï¼Œä¸æ”¯æŒ es5 ï¼‰

FYIï¼š

- https://github.com/umijs/umi-next/pull/793

## xiaorong61

è¿˜æœ‰äººéœ€è¦å…¼å®¹ä¸æ”¯æŒ es6 çš„æµè§ˆå™¨ï¼Œå¤ªæƒ¨å•¦ã€‚ğŸ˜‚

## jounzhang

ä½œä¸ºä¸€ä¸ªæ–°æ‰‹ï¼Œæˆ‘å°±æƒ³çŸ¥é“ï¼Œumi4åˆ›å»ºçš„è„šæ‰‹æ¶ï¼Œèƒ½ä¸èƒ½é»˜è®¤é…ç½®æˆä¸æ”¯æŒieï¼Œç°åœ¨ä¸€buildå°±æŠ¥é”™å•Šï¼Œå¤§ç¥äº›ï¼
æ²¡æ³•buildï¼Œä¹Ÿä¸çŸ¥é“æ”¹å“ªé‡Œï¼

## drizzlesconsin

IE å…¼å®¹æ€§é—®é¢˜
IE è¢«æ·˜æ±°ï¼Œç°ä»£æµè§ˆå™¨ä¸»æµèƒŒæ™¯ä¸‹ï¼Œumi4 é»˜è®¤ä¸å…¼å®¹ IE ï¼Œåœ¨ https://github.com/umijs/umi/issues/8658 å¯ä»¥å‚ä¸ç›¸å…³è®¨è®ºã€‚

è‹¥ä½ éœ€è¦å…¼å®¹ es5 ï¼Œç›®å‰çš„ç¼“è§£æ–¹æ³•æ˜¯ï¼š è°ƒæ•´ js ä¸ css çš„å‹ç¼©å™¨

```ts
// .umirc.ts
export default {
  jsMinifier: "terser",
  cssMinifier: "cssnano",
};
```

https://github.com/umijs/umi/issues/8930

## jounzhang

> IE å…¼å®¹æ€§é—®é¢˜ IE è¢«æ·˜æ±°ï¼Œç°ä»£æµè§ˆå™¨ä¸»æµèƒŒæ™¯ä¸‹ï¼Œumi4 é»˜è®¤ä¸å…¼å®¹ IE ï¼Œåœ¨ #8658 å¯ä»¥å‚ä¸ç›¸å…³è®¨è®ºã€‚
>
> è‹¥ä½ éœ€è¦å…¼å®¹ es5 ï¼Œç›®å‰çš„ç¼“è§£æ–¹æ³•æ˜¯ï¼š è°ƒæ•´ js ä¸ css çš„å‹ç¼©å™¨
>
> ```ts
> // .umirc.ts
> export default {
>   jsMinifier: "terser",
>   cssMinifier: "cssnano",
> };
> ```
>
> #8930

æˆ‘ç°åœ¨çš„é—®é¢˜æ˜¯ä½¿ç”¨antdproåˆå§‹åŒ–è„šæ‰‹æ¶åï¼ŒbuildæŠ¥é”™ä¸å…¼å®¹ieï¼Œä¸çŸ¥é“æ€ä¹ˆå¤„ç†ã€‚æˆ‘ä¸éœ€è¦å…¼å®¹ieï¼

## fz6m

## é»˜è®¤çš„å…¼å®¹è¯´æ˜

é»˜è®¤ä¸æ”¯æŒ IE ï¼Œ`targets` ä¸º `chrome: 80` ï¼Œå¦‚éœ€è°ƒæ•´ï¼Œè¯·æŒ‡å®šæ˜ç¡®çš„ [targets](https://umijs.org/docs/api/config#targets) ï¼š

```ts
// .umirc.ts

export default {
  targets: { chrome: 67 },
};
```

## å…¼å®¹æ—§æ—¶ä»£æµè§ˆå™¨ ( IE 11 ) çš„è¯´æ˜

### ä¸€ã€ä¸€ç§è‡ªå¸¦çš„å…¼å®¹è§£æ³•

æ¡†æ¶è‡ªå¸¦æä¾›ä¸€ä¸ª `legacy` é…ç½®ç”¨äºæ„å»ºé™çº§ï¼ˆä½¿ç”¨é™åˆ¶ç­‰è¯¦è§ [config > legacy](https://umijs.org/docs/api/config#legacy) ï¼‰ï¼š

```ts
// .umirc.ts

export default {
  legacy: {},
};
```

é»˜è®¤ä»…åœ¨æ„å»ºæ—¶ç”Ÿæ•ˆï¼Œå°†å°è¯•æ„å»ºèƒ½ä½¿ IE å…¼å®¹çš„äº§ç‰©ã€‚

### äºŒã€legacy mode çš„æ›´å¤šè‡ªå®šä¹‰

`legacy` å¼€å¯æ—¶ï¼Œé»˜è®¤ä¼šè½¬è¯‘å…¨éƒ¨ `node_modules` ï¼Œè¿™åœ¨å¤§å‹é¡¹ç›®ä¸­ï¼Œä¼šæå¤§çš„å¢åŠ æ„å»ºæ—¶é—´ã€‚

è‹¥ä½ äº†è§£å½“å‰é¡¹ç›®ä½¿ç”¨çš„ç¬¬ä¸‰æ–¹ä¾èµ–æƒ…å†µï¼ˆçŸ¥é“å“ªäº›ä¸å†æä¾› `es5` äº§ç‰©äº†ï¼‰ï¼Œå¯ä»¥å…³é—­ `node_modules` çš„è½¬æ¢ï¼Œæ”¹ä¸ºä½¿ç”¨ [`extraBabelIncludes`](https://umijs.org/docs/api/config#extrababelincludes) å®šç‚¹é…ç½®é‚£äº›éœ€è¦é¢å¤–çº³å…¥è½¬æ¢èŒƒå›´çš„åŒ…ã€‚

ä¸€ä¸ªä¾‹å­ï¼š

```ts
// .umirc.ts

export default {
  legacy: {
    nodeModulesTransform: false,
  },
  extraBabelIncludes: ["some-es6-pkg", /@scope\//],
};
```

### ä¸‰ã€æé«˜å…¼å®¹çš„é²æ£’æ€§

`legacy` é€‰é¡¹å¹¶ä¸èƒ½ 100% ä¿è¯äº§ç‰© **æ²¡æœ‰è¾¹ç•Œæƒ…å†µ** çš„è¿è¡Œåœ¨è¢«æ·˜æ±°çš„æµè§ˆå™¨å†…ï¼Œä½ å¯èƒ½è¿˜éœ€è¦æ·»åŠ  **å‰ç½®çš„** å…¨é‡ polyfill æ¥å¢å¼ºé¡¹ç›®çš„ [é²æ£’æ€§](https://baike.baidu.com/item/%E9%B2%81%E6%A3%92%E6%80%A7/832302) ã€‚

```ts
// .umirc.ts

export default {
  headScripts: [
    "http://polyfill.alicdn.com/v3/polyfill.min.js", // or https://polyfill.io/v3/polyfill.min.js
  ],
  legacy: {},
};
```

å‚è€ƒçš„æ€è·¯æœ‰ï¼š

| æ–¹æ¡ˆ               | è¯´æ˜                                                                                                                                                                                                                                                                                                                                                  |
| :----------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| CDN å¼•å…¥           | ä»¥ cdn å½¢å¼å¼•å…¥ **script å½¢å¼ä¸”å‰ç½®çš„** ã€ç›®æ ‡æµè§ˆå™¨ç¯å¢ƒç¼ºå°‘çš„ polyfill js æ–‡ä»¶ï¼Œå¦‚ [es6-shim](https://github.com/paulmillr/es6-shim) ã€‚                                                                                                                                                                                                              |
| äººå·¥ core-js       | åˆ©ç”¨ [core-js](https://github.com/zloirock/core-js) ç³»å·¥å…·ï¼Œå¦‚é€šè¿‡ [core-js-builder](https://github.com/zloirock/core-js/tree/master/packages/core-js-builder) æ„å»ºè‡ªå·±éœ€è¦çš„ polyfill äº§ç‰©ï¼Œå†ä»¥ **å‰ç½® script è„šæœ¬** å½¢å¼å¼•å…¥é¡¹ç›®ã€‚                                                                                                                 |
| åŠ¨æ€ polyfill æœåŠ¡ | ä½¿ç”¨æ ¹æ®å½“å‰æµè§ˆå™¨è¯·æ±‚ UA åŠ¨æ€ä¸‹å‘æ‰€éœ€ polyfill çš„æœåŠ¡ï¼Œæ¯”å¦‚ [polyfill.io](https://polyfill.io/v3/polyfill.min.js) ï¼Œè€ƒè™‘åˆ°é€Ÿåº¦ï¼Œå¯ä½¿ç”¨å›½å†…çš„ [alicdn polyfill.io](http://polyfill.alicdn.com/v3/polyfill.min.js) æœåŠ¡ã€‚å¦å¤–ï¼Œä½ è¿˜å¯ä»¥ä½¿ç”¨ [polyfill-service](https://github.com/Financial-Times/polyfill-service) è‡ªå»ºç›¸åŒçš„åŠ¨æ€ polyfill ä¸‹å‘æœåŠ¡ã€‚ |

æ³¨ï¼š

1. å½“ä½ å¤„äºå†…å¤–ç½‘éš”ç¦»å¼€å‘ç¯å¢ƒæ—¶ï¼Œå¯ä»¥è€ƒè™‘å°†å…¨éƒ¨ polyfill çš„ js å†…å®¹è·³æ¿ä¼ å…¥å†…ç½‘ï¼Œåœ¨å†…ç½‘çš„ CDN ä½¿ç”¨ï¼Œæˆ–æ”¾å…¥ public ç›®å½•ç­‰æ–¹å¼ä½¿ç”¨ã€‚

2. ä½¿ç”¨ script å‰ç½®å¼•å…¥çš„æ„ä¹‰åœ¨äºï¼Œåœ¨é¡¹ç›® js èµ„æºè¿è¡Œå‰å°±å‡†å¤‡å¥½ä¸€ä¸ªå®Œæ•´çš„ã€è¢« polyfill è¿‡ api çš„ç¯å¢ƒã€‚

### å››ã€åœ¨å¼€å‘ç¯å¢ƒéªŒè¯

æ¨èçš„åšæ³•æ˜¯ï¼šæ„å»ºååœ¨æœ¬åœ°é€šè¿‡ [`umi preview`](https://umijs.org/docs/api/commands#preview) æˆ– [`serve`](https://www.npmjs.com/package/serve) ã€nginx ç­‰å¯åŠ¨æœåŠ¡ï¼Œæ¥éªŒè¯äº§ç‰©çš„ IE 11 è¿è¡Œå¯è¡Œæ€§ã€‚

å½“ä½ éœ€è¦åœ¨å¼€å‘ç¯å¢ƒéªŒè¯æ—¶ï¼š

1. å°† `legacy.buildOnly` ç½®ä¸º `false` ã€‚

2. ç”±äº react fresh ã€hmr ç­‰å¼€å‘æ³¨å…¥çš„ es6 ä»£ç å§‹ç»ˆåœ¨ç¬¬ä¸€ä½è¿è¡Œï¼Œä½ éœ€è¦ä»¥ script å½¢å¼æ·»åŠ ä¸€ä¸ªå‰ç½®çš„ polyfill ï¼Œæå‰å‡†å¤‡å¥½ç¯å¢ƒã€‚

```ts
// .umirc.ts

const isProd = process.env.NODE_ENV === "production";
export default {
  legacy: {
    buildOnly: false,
  },
  headScripts: isProd ? [] : ["http://polyfill.alicdn.com/v3/polyfill.min.js"],
};
```

æ³¨ï¼šIE 11 å¹¶ä¸èƒ½å®Œæ•´æ”¯æŒå¼€å‘æ—¶çš„çƒ­æ›´æ–°ï¼Œä¸”ç¼“å­˜å¯èƒ½éœ€è¦äººä¸ºåœ¨æ§åˆ¶å°è¿›è¡Œæ¸…é™¤åæ‰èƒ½çœ‹åˆ°æœ€æ–°çš„é¡µé¢ï¼Œè¯·åšå¥½å‡†å¤‡ã€‚

## xiaohuoni

ä½æµè§ˆå™¨ç›¸å…³çš„å…¼å®¹ï¼Œå¯ä»¥ä½¿ç”¨é…ç½® [legacy](https://umijs.org/docs/api/config#legacy)
æœ‰å…¶ä»–å¼‚å¸¸æ¬¢è¿æ–°å¼€ issues è®¨è®º

## caoxuccc

![WechatIMG8](https://github.com/umijs/umi/assets/51979013/08c0e80c-4551-4bba-9e31-27e77a687403)
<img width="549" alt="image" src="https://github.com/umijs/umi/assets/51979013/bb2224fd-1c02-4d11-a7a0-6ae9f59e7c20">
æ±‚å¸®åŠ©ï¼Œè¿™ä¸ªæ€ä¹ˆå¤„ç†ğŸ˜‚

## fz6m

è¿™ä¸ªæ˜¯ä½ çš„é€»è¾‘é—®é¢˜ï¼Œè‡ªå·±ä¿®æ­£ä¸‹ï¼Œlegacy åªæ˜¯å¸®åŠ©æä¾› es6 åˆ° es5 çš„è½¬æ¢è€Œå·²ï¼Œä»£ç é€»è¾‘é”™äº†éœ€è¦è‡ªå·±æ’æŸ¥ã€‚

## caoxuccc

@fz6m è°¢è°¢æé†’ï¼Œä½ è¯´çš„æ˜¯å¯¹çš„ï¼Œä¸€ä¸ªä¸‰æ–¹åº“çš„é—®é¢˜
