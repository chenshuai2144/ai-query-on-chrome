# [Bug] umi4 monorepo å­åŒ…æ‰¾ä¸åˆ°ä¾èµ–

<!--
æ„Ÿè°¢æ‚¨å‘æˆ‘ä»¬åé¦ˆé—®é¢˜ï¼Œä¸ºäº†é«˜æ•ˆçš„è§£å†³é—®é¢˜ï¼Œæˆ‘ä»¬æœŸæœ›ä½ èƒ½æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š
-->

## What happens?

app ä¸ºåº”ç”¨ï¼Œlib ä¸ºåº“ï¼Œapp å¼•ç”¨äº† libï¼Œapp æ‰“åŒ…çš„æ—¶å€™ï¼ŒæŠ¥é”™ï¼Œæ‰¾ä¸åˆ° lib çš„ä¾èµ– axiosï¼Œè€Œçœ‹ lib ä¸‹çš„ node_modulesï¼Œaxios æ˜¯å­˜åœ¨çš„

<img width="1611" alt="image" src="https://user-images.githubusercontent.com/17792166/190861374-ec21fc6b-dd2f-4fb1-86b1-9c429ca31c68.png">

<!-- A clear and concise description of what the bug is. -->
<!-- æ¸…æ™°çš„æè¿°ä¸‹é‡åˆ°çš„é—®é¢˜ã€‚-->

## Mini Showcase Repository(REQUIRED)

https://github.com/twinkle77/umi4-monorepo

> Please provide a [minimal reproduction](https://stackoverflow.com/help/minimal-reproducible-example) then upload to your GitHub. è¯·æä¾› [æœ€å°é‡ç°](https://stackoverflow.com/help/minimal-reproducible-example)ï¼Œå¹¶ä¸Šä¼ åˆ°ä½ çš„ GitHub ä»“åº“

<!-- ä¸ºèŠ‚çº¦å¤§å®¶çš„æ—¶é—´ï¼Œæ— å¤ç°æ­¥éª¤çš„ ISSUE ä¼šè¢«å…³é—­ï¼Œæä¾›ä¹‹åå† REOPEN -->
<!-- YOUR_REPOSITORY_URL on github or stackbliz -->

## How To Reproduce

**Steps to reproduce the behavior:** 1. 2.

**Expected behavior** 1. 2.

<!-- è¯·æä¾›å¤ç°é“¾æ¥/æ­¥éª¤ï¼Œé”™è¯¯æ—¥å¿—ä»¥åŠç›¸å…³é…ç½® -->

## Context

- **Umi Version**: 4.0.7
- **Node Version**: 14.x
- **Platform**: mac

## fz6m

mfsu çš„é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡ `mfsu: false` è§£å†³ã€‚

è¿™ä¸ªé—®é¢˜æˆ‘è®°å¾—å¾ˆä¹…ä»¥å‰å°±æœ‰äº†ï¼Œ @stormslowly æœ‰ç©ºå¯ä»¥è¾›è‹¦çœ‹ä¸‹æœ‰æ²¡æœ‰è§£æ³•ã€‚

## twinkle77

å¸Œæœ›èƒ½æœ‰ mfsu çš„èƒ½åŠ› å“ˆå“ˆå“ˆ

## xierenyuan

> å¸Œæœ›èƒ½æœ‰ mfsu çš„èƒ½åŠ› å“ˆå“ˆå“ˆ

å¯ä»¥ä¸´æ—¶é€šè¿‡ externals æ¥è§£å†³ æˆ‘ç›®å‰æ˜¯è¿™æ ·æçš„

## twinkle77

> > å¸Œæœ›èƒ½æœ‰ mfsu çš„èƒ½åŠ› å“ˆå“ˆå“ˆ
>
> å¯ä»¥ä¸´æ—¶é€šè¿‡ externals æ¥è§£å†³ æˆ‘ç›®å‰æ˜¯è¿™æ ·æçš„

<img width="704" alt="image" src="https://user-images.githubusercontent.com/17792166/190941810-fe7c4c8e-f506-4d69-8866-d871193d3bde.png">

å¤§ä½¬ï¼Œç»™ web é…ç½® externals: { axios } ä¹ˆï¼Œé—®é¢˜æ˜¯ï¼Œé™¤äº† axios è¿˜æœ‰éå¸¸å¤šçš„å…¶ä»–ä¾èµ–

## xierenyuan

é…ç½®è¿™ä¸ªå§ https://umijs.org/docs/api/config#alias è¿™ä¸ªä»¥å¯ä»¥è§£å†³

## twinkle77

> é…ç½®è¿™ä¸ªå§ https://umijs.org/docs/api/config#alias è¿™ä¸ªä»¥å¯ä»¥è§£å†³

å¤§ä½¬ï¼ŒæŒ‡çš„æ˜¯ï¼Ÿ

1.  alias: {
    lib: '../packages/lib/src'
    }

2.  alias: {
    axios: '../packages/lib/node_modules'
    }

@xierenyuan

## xierenyuan

æ˜¯çš„ axios å†™æˆ require.resolve(â€™axiosâ€˜) åº”è¯¥å°±å¯ä»¥ ä½ è¯•è¯•

## twinkle77

> æ˜¯çš„ axios å†™æˆ require.resolve(â€™axiosâ€˜) åº”è¯¥å°±å¯ä»¥ ä½ è¯•è¯•

<img width="1010" alt="image" src="https://user-images.githubusercontent.com/17792166/190943014-5929398e-2ba6-408b-9f4d-533de5cd243b.png">

è€å“¥ï¼Œä¸ºä»€ä¹ˆ app çš„ .umirc.ts æ–‡ä»¶ require.resolve('axios')ï¼Œè¿™ä¸ª axios ç¼ºä¼šæŒ‡å‘ lib/node_modules ä¸‹çš„ axios ?

å¦‚æœæƒ³æ‰¹é‡æ³¨å†Œçš„è¯ï¼Œéœ€è¦åœ¨ .umirc.ts å®ç°ä¸€ä¸ªé€»è¾‘ï¼Œæ”¶é›†æ‰€æœ‰ lib ç±»çš„ä¾èµ–ï¼Œç”Ÿæˆä¸€ä¸ª alias æ ¼å¼çš„å¯¹è±¡ ï¼Ÿ

@xierenyuan
æŠŠä½ éå­åŒ…çš„ä¾èµ–çš„æ˜ å°„ä¸‹ å°±æ²¡é—®é¢˜å‘¢

## twinkle77

> æ˜¯çš„ axios å†™æˆ require.resolve(â€™axiosâ€˜) åº”è¯¥å°±å¯ä»¥ ä½ è¯•è¯•

ç¡®è®¤ä¸æŠ¥é”™äº†

## zjfresh

è¯•äº†ä¸‹ï¼Œåº”è¯¥æ˜¯ mfsu çš„é—®é¢˜ï¼Œlib ä¸­çš„ä¾èµ– axios åœ¨è®¾ç½®å umi config [monorepoRedirect](https://umijs.org/docs/api/config#monoreporedirect) ä¼šæå‡åˆ° app åº“çš„ buildDep ä¸­ï¼ˆä¸ªäººçŒœæµ‹ï¼‰

å¯ä»¥é€šè¿‡åœ¨ app ä¸­å®‰è£… dep: axiosï¼Œlibä¸­æ”¹æˆ devDep: axios, peerDep: axios

## twinkle77

> è¯•äº†ä¸‹ï¼Œåº”è¯¥æ˜¯ mfsu çš„é—®é¢˜ï¼Œlib ä¸­çš„ä¾èµ– axios åœ¨è®¾ç½®å umi config [monorepoRedirect](https://umijs.org/docs/api/config#monoreporedirect) ä¼šæå‡åˆ° app åº“çš„ buildDep ä¸­ï¼ˆä¸ªäººçŒœæµ‹ï¼‰
>
> å¯ä»¥é€šè¿‡åœ¨ app ä¸­å®‰è£… dep: axiosï¼Œlibä¸­æ”¹æˆ devDep: axios, peerDep: axios

å®‰è£…åˆ° app ä¸è¡Œçš„ï¼Œ lib å¾ˆå¤šï¼Œappä¼šéå¸¸è‡ƒè‚¿

## zjfresh

> > è¯•äº†ä¸‹ï¼Œåº”è¯¥æ˜¯ mfsu çš„é—®é¢˜ï¼Œlib ä¸­çš„ä¾èµ– axios åœ¨è®¾ç½®å umi config [monorepoRedirect](https://umijs.org/docs/api/config#monoreporedirect) ä¼šæå‡åˆ° app åº“çš„ buildDep ä¸­ï¼ˆä¸ªäººçŒœæµ‹ï¼‰
> > å¯ä»¥é€šè¿‡åœ¨ app ä¸­å®‰è£… dep: axiosï¼Œlibä¸­æ”¹æˆ devDep: axios, peerDep: axios
>
> å®‰è£…åˆ° app ä¸è¡Œçš„ï¼Œ lib å¾ˆå¤šï¼Œappä¼šéå¸¸è‡ƒè‚¿

é‚£å¯ä»¥è€ƒè™‘æ”¾å¼ƒ [monorepoRedirect](https://umijs.org/docs/api/config#monoreporedirect) ï¼Œé€šè¿‡ umi@4.0.21 config mfsu:exclude ['@mono/lib'] æ¥å®ç°ï¼Œè¿™ç§éœ€è¦ father æ„å»º Bundless åŒ…ï¼Œ src ç›®å½•ä¸èƒ½ç»è¿‡ umi çš„æºç ç¼–è¯‘ï¼ˆå¦åˆ™ä¼šè¿›å…¥ mfsu çš„é€»è¾‘ï¼Œç„¶å lib çš„ç›¸å…³ dep å¦‚ axios ä¸åœ¨ app çš„ä¾èµ–ä¼šæŠ¥é”™ï¼‰

lib/package.json

```json
{
  "name": "@mono/lib",
  "version": "1.0.0",
  "main": "dist/index.js",
  "module": "dist/index.js",
  "types": "dist/index.d.js",
  "files": ["dist", "compiled"],
  "scripts": {
    "dev": "father dev",
    "build": "father build",
    "postinstall": "pnpm run build",
    "build:deps": "father prebundle",
    "prepublishOnly": "father doctor && npm run build"
  },
  "dependencies": {
    "axios": "^0.27.2"
  },
  "devDependencies": {
    "father": "^4.0.0",
    "webpack": ">=5.11.0 <6.0.0"
  }
}
```

lib/.fatherrc.ts

```ts
import { defineConfig } from "father";

export default defineConfig({
  esm: {
    output: "dist",
  },
});
```

lib/tsconfig.json

```json
{
  "compilerOptions": {
    "strict": true,
    "declaration": true,
    "skipLibCheck": true,
    "baseUrl": ".",
    "jsx": "react-jsx"
  }
}
```

## twinkle77

> > > è¯•äº†ä¸‹ï¼Œåº”è¯¥æ˜¯ mfsu çš„é—®é¢˜ï¼Œlib ä¸­çš„ä¾èµ– axios åœ¨è®¾ç½®å umi config [monorepoRedirect](https://umijs.org/docs/api/config#monoreporedirect) ä¼šæå‡åˆ° app åº“çš„ buildDep ä¸­ï¼ˆä¸ªäººçŒœæµ‹ï¼‰
> > > å¯ä»¥é€šè¿‡åœ¨ app ä¸­å®‰è£… dep: axiosï¼Œlibä¸­æ”¹æˆ devDep: axios, peerDep: axios
> >
> > å®‰è£…åˆ° app ä¸è¡Œçš„ï¼Œ lib å¾ˆå¤šï¼Œappä¼šéå¸¸è‡ƒè‚¿
>
> é‚£å¯ä»¥è€ƒè™‘æ”¾å¼ƒ [monorepoRedirect](https://umijs.org/docs/api/config#monoreporedirect) ï¼Œé€šè¿‡ umi@4.0.21 config mfsu:exclude ['@mono/lib'] æ¥å®ç°ï¼Œè¿™ç§éœ€è¦ father æ„å»º Bundless åŒ…ï¼Œ src ç›®å½•ä¸èƒ½ç»è¿‡ umi çš„æºç ç¼–è¯‘ï¼ˆå¦åˆ™ä¼šè¿›å…¥ mfsu çš„é€»è¾‘ï¼Œç„¶å lib çš„ç›¸å…³ dep å¦‚ axios ä¸åœ¨ app çš„ä¾èµ–ä¼šæŠ¥é”™ï¼‰
>
> lib/package.json
>
> ```json
> {
>   "name": "@mono/lib",
>   "version": "1.0.0",
>   "main": "dist/index.js",
>   "module": "dist/index.js",
>   "types": "dist/index.d.js",
>   "files": ["dist", "compiled"],
>   "scripts": {
>     "dev": "father dev",
>     "build": "father build",
>     "postinstall": "pnpm run build",
>     "build:deps": "father prebundle",
>     "prepublishOnly": "father doctor && npm run build"
>   },
>   "dependencies": {
>     "axios": "^0.27.2"
>   },
>   "devDependencies": {
>     "father": "^4.0.0",
>     "webpack": ">=5.11.0 <6.0.0"
>   }
> }
> ```
>
> lib/.fatherrc.ts
>
> ```ts
> import { defineConfig } from "father";
>
> export default defineConfig({
>   esm: {
>     output: "dist",
>   },
> });
> ```
>
> lib/tsconfig.json
>
> ```json
> {
>   "compilerOptions": {
>     "strict": true,
>     "declaration": true,
>     "skipLibCheck": true,
>     "baseUrl": ".",
>     "jsx": "react-jsx"
>   }
> }
> ```

æˆ‘è¯•è¯• æ„Ÿè°¢

## fz6m

### ç°çŠ¶

ç°åœ¨ä»¥æœ€æ–°ç‰ˆæœ¬ umi ( `^4.0.30` ) éªŒè¯ï¼Œå·²ä¸å­˜åœ¨å¦‚é¢˜æ‰€è¿°çš„é—®é¢˜ã€‚

### å‘ç”Ÿçš„æ–°é—®é¢˜

@stormslowly æœ‰æ—¶é—´å¯ä»¥è¾›è‹¦çœ‹ä¸‹è¿™ä¸ªé—®é¢˜ ğŸŒ¹

è™½ç„¶ä¸ä¼šå‘ç”Ÿå¦‚é¢˜æ‰€è¿°çš„é—®é¢˜ï¼Œä½†æ˜¯åœ¨ **æ”¹åŠ¨å¼•ç”¨å­åŒ…å†…å®¹** çš„æ—¶å€™ï¼Œmfsu ä¼šæŠ¥ä¾èµ–é”™è¯¯ï¼š

```bash
error - MFSU[eager] analyze dependencies failed with error Error: ENOENT: no such file or directory, open '.../umi4-monorepo/packages/app/node_modules/.cache/lib/src/index.js'
```

å°†å­åŒ…æ·»åŠ åˆ° `mfsu.exclude` ä¹Ÿæ— æ³•è§£å†³ï¼š

```ts
// .umirc.ts

export default {
  // å½“æ”¹åŠ¨å­åŒ…å†…å®¹æ—¶ï¼Œä»ç„¶ä¼šå‡ºç°ä¾èµ–é”™è¯¯
  mfsu: {
    exclude: ["@mono/lib"],
  },
};
```

### å¤ç°æ–¹æ³•

1. æ‹‰ä¸‹æœ¬ issue ä¸­çš„ä»“åº“ https://github.com/twinkle77/umi4-monorepo

2. å°†åº”ç”¨ `packages/app/package.json` çš„ umi ç‰ˆæœ¬æ”¹ä¸ºæœ€æ–°ï¼š

   ```diff
   // packages/app/package.json
   +  "umi": "^4.0.30",
   ```

3. å¯åŠ¨é¡¹ç›®

   ```bash
     pnpm i
     cd ./packages/app && pnpm dev
   ```

4. æ”¹åŠ¨å­åŒ… `packages/lib/src/index.ts` ä»£ç ï¼Œå³å¯å¤ç°ã€‚

## stormslowly

ç›®å‰è¿˜æ˜¯å»ºè®® ä½¿ç”¨ normal strategy é…åˆ monorepo ä½¿ç”¨

## fz6m

`normal` ç­–ç•¥çš„é—®é¢˜åœ¨äºæ˜¯ä¼šæŠ¥ `axios` æ‰¾ä¸åˆ°ï¼ˆå¦‚æœ¬ issue ä¸­çš„é—®é¢˜ï¼‰ğŸ˜­ ï¼š

```bash
error - Can not resolve dependence : 'axios', please install it
error - AssertionError [ERR_ASSERTION]: dependence not found: axios
```

## stormslowly

@twinkle77 https://github.com/umijs/umi/releases/tag/v4.0.33 åº”è¯¥è§£å†³æ­¤é—®é¢˜äº†

## buquan

@fz6m `"@umijs/max": "4.0.64"`, devæ²¡é—®é¢˜ï¼Œä½†buildè¿˜æ˜¯æç¤ºæ‰¾ä¸åˆ°`packages/components`é‡Œé¢çš„ä¾èµ–`classnames antd`ï¼Œmfsué…ç½®æ˜¯ `strategy: 'normal'`, è¯·æŒ‡ç‚¹ï½

<img width="994" alt="image" src="https://user-images.githubusercontent.com/23711051/230750625-5d656384-8449-42c8-90f8-9c074a0f63f3.png">

[å¤ç°ä»“åº“](https://github.com/buquan/ifss)

- `pnpm i`
- `pnpm build:umi4app`

## fz6m

`packages/components/src/InnerButton/index.jsx` è¿™ä¸ªæ–‡ä»¶é‡Œç”¨åˆ°äº† `antd` å’Œ `classnames` è¿™ä¿©ä¾èµ–ï¼Œéƒ½æ²¡æœ‰åœ¨ `package.json` é‡Œå£°æ˜ï¼Œè¿™æ˜¯ä¸è§„èŒƒçš„ã€‚

è¦æŠŠå­åŒ…å½“æˆçœŸæ­£çš„ç»„ä»¶åº“å¼€å‘ï¼Œä¾èµ–ä¸èƒ½æ˜¯éšå½¢çš„ï¼Œç”¨åˆ°çš„ä¾èµ–å¿…é¡»è¦æ»¡è¶³å¦‚ä¸‹å…¶ä¸€çš„æ¡ä»¶ï¼š

1. åœ¨ `dependencies` é‡Œï¼Œå¦‚æœè¯¥åŒ…è¢«å‘åˆ° npm ä¸Šï¼Œå®‰è£…è¯¥åŒ…çš„äººä¹Ÿä¼šå®‰è£… `dependencies` é‡Œé¢çš„ä¾èµ–ï¼Œä»è€Œç¡®ä¿è¿™ä¸ªä¾èµ–ä¸€å®šå­˜åœ¨ã€‚

2. åœ¨ `devDependencies` å’Œ `peerDependencies` é‡Œï¼Œåœ¨ `devDependencies` æ˜¯ä¸ºäº†å¼€å‘æ—¶çš„ç±»å‹å’Œè°ƒè¯•å¼€å‘ï¼Œä½†æˆ‘ä»¬ä¸å¸Œæœ›ä»–å¤šä¸ªå®ä¾‹ï¼Œè€Œæ˜¯å¤ç”¨ä¸»é¡¹ç›®çš„ï¼Œé‚£å°±å¿…é¡»ä¹Ÿå£°æ˜åˆ° `peerDependencies` é‡Œï¼Œè¯´æ˜è¿™ä¸ªä¾èµ–éœ€è¦å¼•ç”¨è¿™ä¸ªåŒ…çš„é¡¹ç›®å®‰è£…å“ªäº›ä¾èµ–ã€‚

æŒ‰è¿™ä¸ªåœºæ™¯ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±å†³ç­–ï¼Œ`antd` å¾ˆå¤§ï¼Œä¸åº”è¯¥å¤šå®ä¾‹ï¼Œåº”è¯¥æ˜¯ `2` çš„å£°æ˜æ³•ï¼Œ`classnames` å¾ˆå°ï¼Œå¤šå®ä¾‹ä¹Ÿä¸ä¼šäº§ç”Ÿé¢„æœŸå¤–çš„é—®é¢˜ï¼ˆä¸€èˆ¬å·¥å…·åº“å¤šå®ä¾‹æ˜¯æ— æ‰€è°“çš„ï¼Œä½†ç»„ä»¶åº“å¤šå®ä¾‹æœ‰é£é™©ï¼Œæ¯”å¦‚ context ä¸ä¸€è‡´ï¼Œæ¶ˆæ¯ä¸æˆé˜Ÿåˆ—ç­‰ï¼‰ï¼Œæ‰€ä»¥ `1` / `2` éƒ½å¯ä»¥ã€‚

```diff
{
  "name": "@ifss/components",
  "version": "0.0.0",
  "private": true,
  "main": "src/index.ts",
  "typings": "index.d.ts",
  "scripts": {
    "format": "prettier --write \"src/**/*.{js,jsx,tsx,ts,less,json}\"",
    "lint": "eslint 'src/**/*.{js,jsx,ts,tsx}'",
    "lint:fix": "eslint --fix 'src/**/*.{js,jsx,ts,tsx}'"
  },
+ "dependencies": {
+   "classnames": "^2.3.2"
+ },
  "devDependencies": {
    "eslint": "^8.35.0",
    "@ifss/eslint-config-custom": "workspace:*",
    "@ifss/tsconfig": "workspace:*",
+   "antd": "4.18.9"
  },
+ "peerDependencies": {
+   "antd": "^4"
+ }
}
```

ç°åœ¨æˆ‘ä»¬å·²ç»æŒ‰ç…§ npm åŒ…å¼€å‘è§„èŒƒå£°æ˜å®Œäº†ä¾èµ–ï¼Œä¸‹ä¸€æ­¥éœ€è¦è§£å†³ monorepo peer deps é—®é¢˜ï¼Œè¯¦è§ [`monorepoRedirect`](https://umijs.org/docs/api/config#monoreporedirect) ï¼Œè¿™æ˜¯ monorepo å†…éƒ¨å¼•ç”¨ä¸ npm å®‰è£…ä¸‹æ¥ä¸ä¸€æ ·çš„åœ°æ–¹ï¼Œé€šè¿‡æ·»åŠ  `monorepoRedirect.peerDeps: true` è§£å†³ï¼Œå°±å¯ä»¥æ„å»ºæˆåŠŸäº†ã€‚

æ³¨ï¼šä¸Šé¢è¯´åˆ°çš„ `classnames` ä¹‹æ‰€ä»¥é€‰æ‹©äº† `1` ï¼Œå·¥å…·åº“ä¸€èˆ¬ä¼šè¿™ä¹ˆä¾èµ–ï¼Œå¤šå®ä¾‹æ²¡æœ‰é£é™©ï¼Œè¿™æ ·å³ä½¿è¯¥åŒ…è¢«å‘å¸ƒåˆ° npm ï¼Œå®‰è£…è¯¥åŒ…çš„é¡¹ç›®ä¹Ÿæ— éœ€æ¯ä¸ªéƒ½å®‰è£…ä¸€é `classnames` ï¼Œç‰¹åˆ«æ˜¯è¿™ç§å·¥å…·åº“å¾ˆå¤šçš„æƒ…å†µï¼Œå‡å®šæœ‰ 10 ä¸ªï¼Œå®‰è£…è¿™ä¸ªåŒ…çš„é¡¹ç›®éƒ½è¦å®‰è£…è¿™ 10 ä¸ª peer deps ï¼Œæ˜¯ä¸åˆç†çš„ã€‚

## buquan

@fz6m æ„Ÿè°¢æŒ‡ç‚¹ï¼Œä¹‹å‰çœ‹è¿‡[ä½ çš„è¿™ç¯‡æ–‡ç« ](https://blog.csdn.net/qq_21567385/article/details/121088506)ï¼Œä½†éšå½¢ä¾èµ–åœ¨devå¯ä»¥è·‘è¿˜æ˜¯æŒºå›°æƒ‘çš„ï¼Œå› ä¸ºdevå¯ä»¥è·‘å°±è¯¯ä»¥ä¸ºumiåšäº†é­”æ³•å¤„ç†ï¼Œå¯ä»¥ä¸ç”¨å£°æ˜ä¾èµ–çš„

## fz6m

è¿™ä¸ªæ˜¯ MFSU çš„é—®é¢˜ï¼Œ`mfsu: false` è¡Œä¸ºæ˜¯æ­£å¸¸çš„ã€‚
