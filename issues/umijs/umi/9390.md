# [Bug] ç»„ä»¶ä¸­æœ‰å›¾ç‰‡å¼•å…¥ ,jestæŠ¥é”™

<!--
æ„Ÿè°¢æ‚¨å‘æˆ‘ä»¬åé¦ˆé—®é¢˜ï¼Œä¸ºäº†é«˜æ•ˆçš„è§£å†³é—®é¢˜ï¼Œæˆ‘ä»¬æœŸæœ›ä½ èƒ½æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š
-->

## What happens?

<!-- A clear and concise description of what the bug is. -->
<!-- æ¸…æ™°çš„æè¿°ä¸‹é‡åˆ°çš„é—®é¢˜ã€‚-->

å¦‚æœä¸€ä¸ªç»„ä»¶ä¸­æœ‰å›¾ç‰‡å¼•å…¥, jest æŠ¥é”™
<img width="1152" alt="image" src="https://user-images.githubusercontent.com/15773714/191220060-5eac840d-7782-4a1d-a97a-f76061c9dd0e.png">

## Mini Showcase Repository(REQUIRED)

> Please provide a [minimal reproduction](https://stackoverflow.com/help/minimal-reproducible-example) then upload to your GitHub. è¯·æä¾› [æœ€å°é‡ç°](https://stackoverflow.com/help/minimal-reproducible-example)ï¼Œå¹¶ä¸Šä¼ åˆ°ä½ çš„ GitHub ä»“åº“
> https://github.com/kokiy/umi4-demo

<!-- ä¸ºèŠ‚çº¦å¤§å®¶çš„æ—¶é—´ï¼Œæ— å¤ç°æ­¥éª¤çš„ ISSUE ä¼šè¢«å…³é—­ï¼Œæä¾›ä¹‹åå† REOPEN -->
<!-- YOUR_REPOSITORY_URL on github or stackbliz -->

## How To Reproduce

**Steps to reproduce the behavior:** 1. 2.

**Expected behavior** 1. 2.

<!-- è¯·æä¾›å¤ç°é“¾æ¥/æ­¥éª¤ï¼Œé”™è¯¯æ—¥å¿—ä»¥åŠç›¸å…³é…ç½® -->

## Context

- **Umi Version**: 4.0.21
- **Node Version**:
- **Platform**: mac & windows

## fz6m

#### æ–¹æ³•ä¸€ï¼š mock image import

```ts
// index.test.tsx

import { render, screen } from "@testing-library/react";
import Index from "../index";

jest.mock("@/assets/yay.jpg", () => "yay.jpg");

describe("test page", () => {
  it("init", async () => {
    render(<Index />);
    const img = await screen.findAllByRole('img')
    expect(img[0].getAttribute('src')).toEqual('yay.jpg')
  });
});
```

#### æ–¹æ³•äºŒï¼štransform image assets

```ts
// jest.config.ts

import { Config, configUmiAlias, createConfig } from "umi/test";

export default async () => {
  const config = createConfig({
    target: "browser",
    jsTransformer: "esbuild",
    // config opts for esbuild , it will pass to esbuild directly
    jsTransformerOpts: { jsx: "automatic" },
  });

  // ğŸŸ¢ Add image transform
  config.transform![
    "\\.(jpg|jpeg|png|gif|eot|otf|webp|svg|ttf|woff|woff2|mp4|webm|wav|mp3|m4a|aac|oga)$"
  ] = "<rootDir>/jest-image-proxy.js";

  return (await configUmiAlias({
    ...config,
    setupFilesAfterEnv: ["<rootDir>/jest-setup.ts"],
    collectCoverageFrom: [
      "src/**/*.{ts,js,tsx,jsx}",
      "!src/.umi/**",
      "!src/.umi-test/**",
      "!src/.umi-production/**",
    ],
    // if you require some es-module npm package, please uncomment below line and insert your package name
    // transformIgnorePatterns: ['node_modules/(?!.*(lodash-es|your-es-pkg-name)/)']
    transformIgnorePatterns: [
      "/node_modules/(?!antd|@ant-design|rc-.+?|@babel/runtime|@umijs/renderer-react|@umijs/preset-umi|umi).+(js|jsx)$",
    ],
  })) as Config.InitialOptions;
};
```

```js
// jest-image-proxy.js

const path = require("path");

module.exports = {
  process(src, filename, config, options) {
    return `module.exports = ${JSON.stringify(path.basename(filename))};`;
  },
};
```

FYI ï¼š

- [Mocking CSS Modules](https://jestjs.io/docs/27.x/webpack#mocking-css-modules)

å…¶ä»–çš„æ–¹æ³•è‡ªå·±æœç´¢å§ã€‚

## kokiy

cool ,ä¸è¿‡æ„Ÿè§‰è¿™ä¸ªå¯ä»¥é›†æˆåˆ°umi å†…ç½®
