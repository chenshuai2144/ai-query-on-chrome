# [Bug] 组件中有图片引入 ,jest报错

<!--
感谢您向我们反馈问题，为了高效的解决问题，我们期望你能提供以下信息：
-->

## What happens?

<!-- A clear and concise description of what the bug is. -->
<!-- 清晰的描述下遇到的问题。-->

如果一个组件中有图片引入, jest 报错
<img width="1152" alt="image" src="https://user-images.githubusercontent.com/15773714/191220060-5eac840d-7782-4a1d-a97a-f76061c9dd0e.png">

## Mini Showcase Repository(REQUIRED)

> Please provide a [minimal reproduction](https://stackoverflow.com/help/minimal-reproducible-example) then upload to your GitHub. 请提供 [最小重现](https://stackoverflow.com/help/minimal-reproducible-example)，并上传到你的 GitHub 仓库
> https://github.com/kokiy/umi4-demo

<!-- 为节约大家的时间，无复现步骤的 ISSUE 会被关闭，提供之后再 REOPEN -->
<!-- YOUR_REPOSITORY_URL on github or stackbliz -->

## How To Reproduce

**Steps to reproduce the behavior:** 1. 2.

**Expected behavior** 1. 2.

<!-- 请提供复现链接/步骤，错误日志以及相关配置 -->

## Context

- **Umi Version**: 4.0.21
- **Node Version**:
- **Platform**: mac & windows

## fz6m

#### 方法一： mock image import

```ts
// index.test.tsx

import { render, screen } from "@testing-library/react";
import Index from "../index";

jest.mock("@/assets/yay.jpg", () => "yay.jpg");

describe("test page", () => {
  it("init", async () => {
    render(<Index />);
    const img = await screen.findAllByRole('img')
    expect(img[0].getAttribute('src')).toEqual('yay.jpg')
  });
});
```

#### 方法二：transform image assets

```ts
// jest.config.ts

import { Config, configUmiAlias, createConfig } from "umi/test";

export default async () => {
  const config = createConfig({
    target: "browser",
    jsTransformer: "esbuild",
    // config opts for esbuild , it will pass to esbuild directly
    jsTransformerOpts: { jsx: "automatic" },
  });

  // 🟢 Add image transform
  config.transform![
    "\\.(jpg|jpeg|png|gif|eot|otf|webp|svg|ttf|woff|woff2|mp4|webm|wav|mp3|m4a|aac|oga)$"
  ] = "<rootDir>/jest-image-proxy.js";

  return (await configUmiAlias({
    ...config,
    setupFilesAfterEnv: ["<rootDir>/jest-setup.ts"],
    collectCoverageFrom: [
      "src/**/*.{ts,js,tsx,jsx}",
      "!src/.umi/**",
      "!src/.umi-test/**",
      "!src/.umi-production/**",
    ],
    // if you require some es-module npm package, please uncomment below line and insert your package name
    // transformIgnorePatterns: ['node_modules/(?!.*(lodash-es|your-es-pkg-name)/)']
    transformIgnorePatterns: [
      "/node_modules/(?!antd|@ant-design|rc-.+?|@babel/runtime|@umijs/renderer-react|@umijs/preset-umi|umi).+(js|jsx)$",
    ],
  })) as Config.InitialOptions;
};
```

```js
// jest-image-proxy.js

const path = require("path");

module.exports = {
  process(src, filename, config, options) {
    return `module.exports = ${JSON.stringify(path.basename(filename))};`;
  },
};
```

FYI ：

- [Mocking CSS Modules](https://jestjs.io/docs/27.x/webpack#mocking-css-modules)

其他的方法自己搜索吧。

## kokiy

cool ,不过感觉这个可以集成到umi 内置
