# [Bug] Invalid command openapi, it's not registered

添加了umi-openapi插件，在配置中增加：
openAPI: [
{
......
},
],
package.json中增加script:
"openapi": "umi openapi"

执行 npm run openpai 报错：
fatal - AssertionError [ERR_ASSERTION]: Invalid command openapi, it's not registered.
at Service.run (D:\Code\IdeaProjects\house-paper\frontend-blockchain\node_modules\@umijs\core\dist\service\service.js:226:31)
at processTicksAndRejections (node:internal/process/task_queues:96:5)
at async Service.run2 (D:\Code\IdeaProjects\house-paper\frontend-blockchain\node_modules\umi\dist\service\service.js:58:12)  
 at async Object.run (D:\Code\IdeaProjects\house-paper\frontend-blockchain\node_modules\umi\dist\cli\cli.js:55:7) {
generatedMessage: false,
code: 'ERR_ASSERTION',
actual: undefined,
expected: true,
operator: '=='
}

运行项目报错：
fatal - AssertionError [ERR_ASSERTION]: Invalid config keys: openAPI
at Function.validateConfig (D:\Code\IdeaProjects\house-paper\frontend-blockchain\node_modules\@umijs\core\dist\config\config.js:182:31)
at Config.getConfig (D:\Code\IdeaProjects\house-paper\frontend-blockchain\node_modules\@umijs\core\dist\config\config.js:60:12)  
 at Service.resolveConfig (D:\Code\IdeaProjects\house-paper\frontend-blockchain\node_modules\@umijs\core\dist\service\service.js:280:97)
at Service.run (D:\Code\IdeaProjects\house-paper\frontend-blockchain\node_modules\@umijs\core\dist\service\service.js:237:50)
at processTicksAndRejections (node:internal/process/task_queues:96:5)
at async Service.run2 (D:\Code\IdeaProjects\house-paper\frontend-blockchain\node_modules\umi\dist\service\service.js:58:12)

## fz6m

umi4 不再自动加载插件，需要手动添加到配置：

```ts
// .umirc.ts

export default {
  plugins: ["..."],
};
```

给一个最小复现。

## Longder

> umi4 不再自动加载插件，需要手动添加到配置：
>
> ```ts
> // .umirc.ts
>
> export default {
>   plugins: ["..."],
> };
> ```
>
> 给一个最小复现。

加上了 现在是报：
![image](https://user-images.githubusercontent.com/7322594/199947143-9cf5bd4e-f978-4b82-acc4-b317e2bc6571.png)

## fz6m

这个是旧版插件，不支持 umi4 ，你可能需要这个 https://github.com/umijs/umi-presets-pro/tree/master/packages/max-plugin-openapi

## Longder

> 这个是旧版插件，不支持 umi4 ，你可能需要这个 https://github.com/umijs/umi-presets-pro/tree/master/packages/max-plugin-openapi

更换了max-plugin-openapi，项目本身启动没问题，不过umi openapi生成时候会报错：

```
Cannot read properties of undefined (reading 'split')
    at D:\Code\IdeaProjects\house-paper\frontend-blockchain\node_modules\@umijs\max-plugin-openapi\dist\index.js:158:105
    at Generator.next (<anonymous>)
    at D:\Code\IdeaProjects\house-paper\frontend-blockchain\node_modules\@umijs\max-plugin-openapi\dist\index.js:8:71
    at new Promise (<anonymous>)
    at __awaiter (D:\Code\IdeaProjects\house-paper\frontend-blockchain\node_modules\@umijs\max-plugin-openapi\dist\index.js:4:12)
    at genAllFiles (D:\Code\IdeaProjects\house-paper\frontend-blockchain\node_modules\@umijs\max-plugin-openapi\dist\index.js:146:44)
    at D:\Code\IdeaProjects\house-paper\frontend-blockchain\node_modules\@umijs\max-plugin-openapi\dist\index.js:170:13
    at Generator.next (<anonymous>)
    at D:\Code\IdeaProjects\house-paper\frontend-blockchain\node_modules\@umijs\max-plugin-openapi\dist\index.js:8:71
    at new Promise (<anonymous>)
```

config.js中openApi配置如下：

```
export default defineConfig({
  npmClient: 'yarn',
  routes,
  hash: true,
  history: {
    type: 'hash',
  },
  plugins: ['@umijs/max-plugin-openapi'],
  openAPI: {
    requestLibPath: "import { request } from 'umi'",
    schemaPath: 'http://localhost:8080/api-doc/openapi.json',
    projectName: 'house-paper',
    namespace: 'housePaper',
  },
});
```

## Longder

> > 这个是旧版插件，不支持 umi4 ，你可能需要这个 https://github.com/umijs/umi-presets-pro/tree/master/packages/max-plugin-openapi
>
> 更换了max-plugin-openapi，项目本身启动没问题，不过umi openapi生成时候会报错：
>
> ```
> Cannot read properties of undefined (reading 'split')
>     at D:\Code\IdeaProjects\house-paper\frontend-blockchain\node_modules\@umijs\max-plugin-openapi\dist\index.js:158:105
>     at Generator.next (<anonymous>)
>     at D:\Code\IdeaProjects\house-paper\frontend-blockchain\node_modules\@umijs\max-plugin-openapi\dist\index.js:8:71
>     at new Promise (<anonymous>)
>     at __awaiter (D:\Code\IdeaProjects\house-paper\frontend-blockchain\node_modules\@umijs\max-plugin-openapi\dist\index.js:4:12)
>     at genAllFiles (D:\Code\IdeaProjects\house-paper\frontend-blockchain\node_modules\@umijs\max-plugin-openapi\dist\index.js:146:44)
>     at D:\Code\IdeaProjects\house-paper\frontend-blockchain\node_modules\@umijs\max-plugin-openapi\dist\index.js:170:13
>     at Generator.next (<anonymous>)
>     at D:\Code\IdeaProjects\house-paper\frontend-blockchain\node_modules\@umijs\max-plugin-openapi\dist\index.js:8:71
>     at new Promise (<anonymous>)
> ```
>
> config.js中openApi配置如下：
>
> ```
> export default defineConfig({
>   npmClient: 'yarn',
>   routes,
>   hash: true,
>   history: {
>     type: 'hash',
>   },
>   plugins: ['@umijs/max-plugin-openapi'],
>   openAPI: {
>     requestLibPath: "import { request } from 'umi'",
>     schemaPath: 'http://localhost:8080/api-doc/openapi.json',
>     projectName: 'house-paper',
>     namespace: 'housePaper',
>   },
> });
> ```
>
> 搞定了，需要在package.json中增加name配置~

```
"name": "project-name"
```

## zhengtan2003

如果出现
`api.addBeforeMiddlewares is not a function`
就把
`    "openapi": "umi openapi"` 改为 `"openapi": "max openapi"`
