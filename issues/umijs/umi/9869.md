# [Bug] Max é¡¹ç›®æ¨¡æ¿ Vite æ¨¡å¼å¯åŠ¨å¤±è´¥

#### é”™è¯¯æè¿°

        å‡çº§å®ŒæŠ¥è¿™ä¸ªé”™è¯¯ï¼Œvite æ¨¡å¼æŠ¥é”™

<img width="1171" alt="image" src="https://user-images.githubusercontent.com/12510482/203898601-663b2d6b-a03d-48f5-9098-625ec51dda86.png">

_Originally posted by @zengqingzhuang in https://github.com/umijs/umi/issues/9850#issuecomment-1326997545_

#### å¦‚ä½•å¤ç°

åˆ›å»ºä¸€ä¸ª max æ¨¡æ¿æ–°é¡¹ç›®ï¼Œå¼€å¯ `vite: {}` æ¨¡å¼å³å¯å¤ç°ã€‚

## zjfresh

åŸå› æ˜¯åœ¨ç”Ÿæˆ .umiç›®å½•çš„ runtime ä»£ç æ—¶ï¼Œç»Ÿä¸€ç”¨è‡ªå®šä¹‰çš„ @fs/ æŒ‡å‘äº† node_moduels ä¸­å®é™…çš„åŒ…ï¼Œè€Œæœ‰éƒ¨åˆ†åŒ…æ˜¯ Vite optimizeDeps.include é¢„å¤„ç† cjs çš„åŒ…ï¼Œè¿™é‡Œæ˜¯ `@ant-design/pro-components`ï¼Œå¯ä»¥æŸ¥çœ‹ `node_modules/.vite/deps/`ï¼Œé€ æˆæŸäº›ä¾èµ– import äº† cjs ä»£ç 

https://github.com/umijs/umi/blob/87854d8d467959b5aa2a5a9eeb51e05358eed464/packages/preset-umi/src/utils/transformIEAR.ts#L101-L103

éªŒè¯æ–¹æ³•ï¼š
src/.umi/plugin-layout/Layout.tsx

```diff
import {
  ProLayout,
- } from "@fs/node_modules/@ant-design/pro-components";
+ } from "@ant-design/pro-components";
```

å¤„ç†ï¼š

æ‰¾äº†ä¸‹ï¼Œæ²¡æ‰¾åˆ°ç›¸å…³ api æ¥åˆ¤æ–­å“ªäº›åŒ…æ˜¯è¢« Vite optimizeDeps.include é¢„å¤„ç†çš„åŒ…

æˆ–è®¸å¯ä»¥å…ˆç»™åœ¨ plugin-layout è·³è¿‡ï¼Ÿ

https://github.com/umijs/umi/blob/87854d8d467959b5aa2a5a9eeb51e05358eed464/packages/plugins/src/layout.ts#L110

```diff
    const hasInitialStatePlugin = api.config.initialState;
+    const realPkgPath = api.appData.vite ? require(`${pkgPath}/package.json`).name : pkgPath;
    // Layout.tsx
    api.writeTmpFile({
      path: 'Layout.tsx',
      content: `
${PKG_TYPE_REFERENCE}
import { Link, useLocation, useNavigate, Outlet, useAppData, useRouteData, matchRoutes } from 'umi';
import type { IRoute } from 'umi';
import React, { useMemo } from 'react';
import {
  ProLayout,
- } from "${pkgPath || '@ant-design/pro-components'}";
+ } from "${realPkgPath || '@ant-design/pro-components'}";

```

æ­¤é—®é¢˜ç›¸å…³æµç¨‹é€»è¾‘

```ts
// packages/plugins/src/layout.ts
api.writeTmpFile({
  path: "Layout.tsx",
  content: `xxx`,
});
// packages/preset-umi/src/registerMethods.ts
if (api.appData.vite && isJsFile) {
  content = transformIEAR({ content, path: absPath }, api);
}
```

ä¸´æ—¶å¤„ç†æ–¹æ³•ï¼šå¯ç”¨ pnpm@7.4+ patch ä¿®æ”¹ node_moduels/@umijs/plugins

```bash
pnpm patch @umijs/plugins@4.0.36
#  You can now edit the following folder:  <PATH>
code <PATH>
# edit dist/layout.js: add realPkgPath
pnpm patch-commit <PATH>
pnpm dev
```

## fz6m

@xierenyuan æœ‰ç©ºçš„æ—¶å€™å¯ä»¥è¾›è‹¦çœ‹ä¸‹æ˜¯ä¸æ˜¯æŸäº›åŒ…å¯ä»¥è·³è¿‡ `optimize` ğŸŒ¹ ã€‚

## xierenyuan

> @xierenyuan æœ‰ç©ºçš„æ—¶å€™å¯ä»¥è¾›è‹¦çœ‹ä¸‹æ˜¯ä¸æ˜¯æŸäº›åŒ…å¯ä»¥è·³è¿‡ `optimize` ğŸŒ¹ ã€‚

3.x åˆå…¥åæˆ‘å¥½å¥½éªŒè¯ä¸‹å§

## fz6m

åœ¨æœ€æ–°ç‰ˆæœ¬ `4.0.41` ä¸­ max é¡¹ç›®å¯ä»¥ç”¨ `vite: {}` æ¨¡å¼å¯åŠ¨äº†ã€‚
